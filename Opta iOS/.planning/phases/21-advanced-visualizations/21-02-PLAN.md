---
phase: 21-advanced-visualizations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/components/charts/CpuFlameGraph.tsx, src/components/charts/index.ts, src/hooks/useProcessCpuAttribution.ts]
autonomous: true
---

<objective>
Implement CPU attribution flame graph using Visx for detailed process-level CPU breakdown visualization.

Purpose: Enable users to see which processes are consuming CPU at a glance with an interactive flame graph showing hierarchical attribution (system → category → individual processes).
Output: CpuFlameGraph component showing real-time CPU attribution with drill-down capability.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Research findings (from 20-RESEARCH.md):**
- Visx for custom visualizations (flame graphs, treemaps)
- Modular - only import what you need
- D3-based but React-friendly
- Don't hand-roll D3 charts - use Visx

**Existing process data:**
@src/hooks/useProcesses.ts
@src/components/ProcessList.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Visx dependencies</name>
  <files>package.json</files>
  <action>
Install Visx modules needed for flame graph:
```bash
npm install @visx/hierarchy @visx/scale @visx/group @visx/tooltip @visx/responsive
```

Visx is modular - only install what we need:
- @visx/hierarchy: Treemap/flame layouts
- @visx/scale: Color and position scales
- @visx/group: SVG grouping
- @visx/tooltip: Interactive tooltips
- @visx/responsive: Container sizing

Do NOT install full @visx/visx bundle (too large).
  </action>
  <verify>npm ls @visx/hierarchy shows installed</verify>
  <done>Visx hierarchy and supporting modules installed</done>
</task>

<task type="auto">
  <name>Task 2: Create CPU attribution hook</name>
  <files>src/hooks/useProcessCpuAttribution.ts</files>
  <action>
Create hook that transforms process list into hierarchical CPU attribution data:

```typescript
interface CpuAttributionNode {
  name: string;
  value: number; // CPU percentage
  children?: CpuAttributionNode[];
  color?: string;
  pid?: number;
}

interface UseProcessCpuAttributionReturn {
  root: CpuAttributionNode;
  totalCpu: number;
  loading: boolean;
}
```

Hierarchy structure:
```
Root (Total CPU)
├── System (category)
│   ├── kernel_task
│   └── WindowServer
├── User Apps (category)
│   ├── Chrome
│   └── VS Code
├── Background (category)
│   ├── Spotlight
│   └── Time Machine
└── Other
```

Requirements:
- Use existing useProcesses hook as data source
- Group processes by category (from existing categorization)
- Sort children by CPU usage (highest first)
- Filter out processes with <0.1% CPU (noise reduction)
- Aggregate "Other" category for tiny processes
- Assign colors based on category using design system palette
- Update every 3 seconds (matches process polling)
  </action>
  <verify>Hook returns hierarchical data structure with categories and processes</verify>
  <done>useProcessCpuAttribution hook transforms flat process list into hierarchical CPU attribution tree</done>
</task>

<task type="auto">
  <name>Task 3: Create CpuFlameGraph component</name>
  <files>src/components/charts/CpuFlameGraph.tsx, src/components/charts/index.ts</files>
  <action>
Create flame graph component using Visx hierarchy:

```typescript
interface CpuFlameGraphProps {
  height?: number; // Default 300
  showLabels?: boolean; // Default true
  onProcessClick?: (pid: number) => void;
  className?: string;
}
```

Implementation requirements:
- Use `@visx/hierarchy` treemap layout in "slice" mode (horizontal bars)
- Flame graph orientation: root at bottom, leaves at top
- Each bar width = CPU percentage
- Color by category using design system semantic colors
- Labels show process name if bar width > 60px
- Tooltip on hover shows: name, CPU%, category
- Click handler for drill-down (expand category to show children)
- Use ParentSize from @visx/responsive for container sizing
- Apply glass background to container
- Animate transitions with Framer Motion (respecting reduced motion)

Accessibility:
- ARIA labels on bars
- Keyboard navigation between bars
- Focus visible states
  </action>
  <verify>npm run build succeeds, flame graph renders with process data</verify>
  <done>CpuFlameGraph component renders hierarchical CPU attribution with tooltips and click interaction</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Flame graph renders with real process data
- [ ] Categories are grouped correctly (System, User Apps, Background)
- [ ] Tooltip shows process details on hover
- [ ] Click on category expands to show children
- [ ] Colors match design system
- [ ] Glass styling applied
- [ ] ARIA labels present
</verification>

<success_criteria>
- All tasks completed
- CpuFlameGraph component functional
- Hierarchical CPU attribution visible
- Interactive tooltips and click handlers work
- Accessibility requirements met
</success_criteria>

<output>
After completion, create `.planning/phases/21-advanced-visualizations/21-02-SUMMARY.md`
</output>
