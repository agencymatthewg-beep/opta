---
phase: 19-native-macos
plan: 04
type: execute
wave: 2
depends_on: ["19-01"]
files_modified: [OptaNative/Helper/, OptaNative/Scripts/]
autonomous: false
---

<objective>
Create privileged helper tool for elevated operations (process termination, system modifications).

Purpose: Enable Stealth Mode and process management features that require root privileges, using Apple's SMJobBless pattern.
Output: Installable privileged helper with XPC communication.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-native-macos/19-RESEARCH.md
@.planning/phases/19-native-macos/19-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create helper tool target and protocol</name>
  <files>OptaNative/Helper/HelperProtocol.swift, OptaNative/Helper/HelperTool.swift, OptaNative/Helper/Info.plist</files>
  <action>
Create new command-line tool target in Xcode named "com.opta.native.helper":

1. HelperProtocol.swift (shared between app and helper):
```swift
import Foundation

@objc protocol HelperProtocol {
    func terminateProcess(pid: Int32, reply: @escaping (Bool, String?) -> Void)
    func setProcessPriority(pid: Int32, priority: Int32, reply: @escaping (Bool) -> Void)
    func getVersion(reply: @escaping (String) -> Void)
}
```

2. HelperTool.swift (helper main):
```swift
import Foundation

class HelperTool: NSObject, NSXPCListenerDelegate, HelperProtocol {
    func terminateProcess(pid: Int32, reply: @escaping (Bool, String?) -> Void) {
        var result = kill(pid, SIGTERM)
        if result != 0 {
            result = kill(pid, SIGKILL)
        }
        reply(result == 0, result != 0 ? String(cString: strerror(errno)) : nil)
    }

    func setProcessPriority(pid: Int32, priority: Int32, reply: @escaping (Bool) -> Void) {
        let result = setpriority(PRIO_PROCESS, UInt32(pid), priority)
        reply(result == 0)
    }

    func getVersion(reply: @escaping (String) -> Void) {
        reply("1.0.0")
    }
}
```

3. Info.plist for helper with SMAuthorizedClients and SMPrivilegedExecutables

Reference SwiftAuthorizationSample (https://github.com/trilemma-dev/SwiftAuthorizationSample) for exact plist structure.
  </action>
  <verify>Helper target compiles as separate executable</verify>
  <done>Helper binary builds with proper protocol</done>
</task>

<task type="auto">
  <name>Task 2: Implement helper installation using Blessed</name>
  <files>OptaNative/Services/HelperManager.swift</files>
  <action>
Create HelperManager to install and communicate with helper:

```swift
import Blessed
import SecureXPC

class HelperManager {
    private let helperID = "com.opta.native.helper"
    private var connection: XPCConnection?

    func installHelper() async throws {
        try await Blessed.installPrivilegedHelper(
            bundleIdentifier: helperID,
            promptUser: true
        )
    }

    func isHelperInstalled() -> Bool {
        // Check if helper is already installed via launchd
        let process = Process()
        process.executableURL = URL(fileURLWithPath: "/bin/launchctl")
        process.arguments = ["print", "system/\(helperID)"]
        // ...
    }

    func terminateProcess(pid: Int32) async throws -> Bool {
        // Use SecureXPC to call helper
    }
}
```

Use Blessed library (single function call) instead of manual SMJobBless - research says "don't hand-roll".
Use SecureXPC for type-safe communication instead of raw NSXPCConnection.
  </action>
  <verify>HelperManager compiles, installHelper() triggers authorization prompt</verify>
  <done>Helper can be installed via authorization prompt</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Privileged helper installation and process termination capability</what-built>
  <how-to-verify>
    1. Run: Build and run OptaNative from Xcode
    2. Trigger: Call HelperManager().installHelper()
    3. Verify: macOS authorization dialog appears asking for admin password
    4. Enter: Admin credentials
    5. Check: Helper installs without error
    6. Test: terminateProcess() can kill a test process (open Terminal, get its PID, terminate it)
    7. Verify: Terminal closes when process terminated
  </how-to-verify>
  <resume-signal>Type "approved" if helper installs and can terminate processes, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodebuild -scheme OptaNative build` succeeds
- [ ] `xcodebuild -scheme com.opta.native.helper build` succeeds
- [ ] Helper target properly code-signed
- [ ] Authorization dialog appears on install
- [ ] Process termination works via helper
</verification>

<success_criteria>
- All tasks completed
- Helper installs via authorization prompt
- Process termination works
- XPC communication stable
- Ready for ProcessService to use in Stealth Mode
</success_criteria>

<output>
After completion, create `.planning/phases/19-native-macos/19-04-SUMMARY.md`
</output>
