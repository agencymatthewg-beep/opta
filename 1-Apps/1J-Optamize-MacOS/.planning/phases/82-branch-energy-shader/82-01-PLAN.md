# Plan 82-01: Branch Energy Shader

## Metadata

```yaml
phase: 82
plan: 01
name: Branch Energy Shader
wave: 1
autonomous: true
estimated_tasks: 3
```

## Objective

Replace the uniform internal plasma noise with a directional branch energy system. Branches originate from the tube equator (UV v=0.5), grow outward along the tube surface, and are revealed by a threshold that scales with energy level. Each branch has its own phase offset for organic, non-synchronized pulsing. The tri-axis response controls length (reach from equator), width (thickness), and brightness independently based on intensity.

## Design Spec

```
Pattern: fBm ridged noise → branch-like veins
Origin: Tube equator (v=0.5 in UV space)
Direction: Branches grow from equator toward v=0 and v=1 (around the tube cross-section)
Revelation: threshold-based (high threshold = few branches, low = many)
  → threshold decreases as energy_level increases
Tri-axis response:
  - Length: reach = mix(0.15, 1.0, energy)  → how far from equator branches extend
  - Width:  width = mix(0.02, 0.12, energy) → thickness of each branch
  - Brightness: intensity * mix(0.4, 1.5, energy) → emission strength
Per-branch phase: hash(floor(u * branch_count)) * TAU → unique timing per branch
Color: Electric Violet #8B5CF6 (0.545, 0.361, 0.965) base, hot-white cores at high energy
Noise: 3D ridged turbulence (from noise_hd.wgsl) for sharp vein-like structures
```

## Execution Context

```
@opta-native/opta-render/shaders/includes/noise_hd.wgsl   (3D noise functions - REFERENCE, DO NOT MODIFY)
@opta-native/opta-render/shaders/includes/noise.wgsl       (2D noise functions - REFERENCE, DO NOT MODIFY)
@opta-native/opta-render/shaders/includes/obsidian.wgsl    (obsidian material - REFERENCE, DO NOT MODIFY)
@opta-native/opta-render/shaders/ring.wgsl                  (ring shader - MODIFY: replace plasma with branches)
@opta-native/opta-render/src/components/ring.rs             (Rust component - MODIFY: add branch uniforms)
@opta-native/opta-render/src/components/mod.rs              (module exports - UPDATE if new types added)
@opta-native/opta-render/tests/ring_test.rs                 (integration tests - UPDATE for new fields)
```

## Tasks

### Task 1: Create branch_energy.wgsl shader include

**Action**: Create a new WGSL include file that generates the branch energy pattern using 3D ridged turbulence, equator origin masking, threshold revelation, tri-axis scaling, and per-branch phase offsets.

**File**: `opta-native/opta-render/shaders/includes/branch_energy.wgsl`

**Implementation**:

1. Create `BranchParams` struct:
   ```wgsl
   struct BranchParams {
       threshold: f32,      // Revelation threshold (0-1, derived from energy)
       scale: f32,          // Noise frequency (default ~4.0)
       speed: f32,          // Time animation multiplier (default ~0.3)
       branch_count: f32,   // Number of major branches around ring (default ~8.0)
       energy: f32,         // Current energy level [0,1]
   }
   ```

2. Create `branch_equator_mask(v: f32, reach: f32) -> f32`:
   - Compute distance from equator: `equator_dist = abs(v - 0.5) * 2.0` → [0,1]
   - Return smoothstep falloff: `1.0 - smoothstep(0.0, reach, equator_dist)`
   - Branches are strongest AT equator, fade with distance

3. Create `branch_phase_offset(u: f32, branch_count: f32) -> f32`:
   - Compute branch index: `idx = floor(u * branch_count)`
   - Return per-branch phase: `hash31(vec3(idx, idx * 7.31, idx * 13.17)) * TAU`
   - Each branch pulses at its own phase

4. Create `branch_noise_field(uv: vec2<f32>, time: f32, params: BranchParams) -> f32`:
   - Include `noise_hd.wgsl` dependency (already available in ring.wgsl)
   - Compute per-branch phase offset from u
   - Create 3D sample point: `p = vec3(uv.x * params.scale, equator_dist * 3.0, (time + phase_offset) * params.speed)`
   - Sample ridged turbulence: `ridged_turbulence_3d(p, 4)` for sharp vein structures
   - Apply threshold revelation: `smoothstep(params.threshold - 0.05, params.threshold + 0.05, noise_value)`
   - Return branch intensity [0,1]

5. Create `branch_tri_axis(energy: f32) -> vec3<f32>`:
   - Returns (length_reach, width_factor, brightness_factor):
     - length: `mix(0.15, 1.0, energy)` — at low energy, branches are short
     - width: `mix(0.02, 0.12, energy)` — at low energy, branches are thin
     - brightness: `mix(0.4, 1.5, energy)` — at low energy, branches are dim

6. Create `branch_width_mask(u: f32, branch_count: f32, width: f32) -> f32`:
   - Compute fractional position within branch cell: `fract(u * branch_count)`
   - Create width mask: `1.0 - smoothstep(0.0, width, abs(cell_frac - 0.5) * 2.0)`
   - Concentrates energy into narrow veins

7. Create `branch_energy(uv: vec2<f32>, time: f32, params: BranchParams) -> f32`:
   - Main entry point combining all above functions:
     a. Compute tri-axis: `axes = branch_tri_axis(params.energy)`
     b. Compute equator mask with length: `eq_mask = branch_equator_mask(uv.y, axes.x)`
     c. Compute width mask: `w_mask = branch_width_mask(uv.x, params.branch_count, axes.y)`
     d. Compute noise field: `noise = branch_noise_field(uv, time, params)`
     e. Combine: `noise * eq_mask * w_mask * axes.z`
     f. Return final branch intensity [0, ~1.5]

8. Create `branch_color(intensity: f32, energy: f32) -> vec3<f32>`:
   - Base: Electric Violet (0.545, 0.361, 0.965) * intensity
   - Hot core: At high intensity (>0.8), blend toward white-hot (1.0, 0.9, 1.0)
   - `mix(base_violet * intensity, white_hot, smoothstep(0.8, 1.2, intensity) * energy)`

**Dependencies**: Requires `noise_hd.wgsl` for `ridged_turbulence_3d()` and `hash31_hd()`

**Verification**: File exists, no syntax errors in WGSL patterns

---

### Task 2: Integrate branch energy into ring.wgsl

**Action**: Replace the `internal_plasma()` and `plasma_color()` functions with branch energy calls. Add `noise_hd.wgsl` include. Update all three fragment shader entry points.

**File**: `opta-native/opta-render/shaders/ring.wgsl`

**Implementation**:

1. Add includes:
   - Add: `#include "noise_hd.wgsl"` (for ridged_turbulence_3d used by branch_energy)
   - Add: `#include "branch_energy.wgsl"`
   - Keep: `math.wgsl`, `noise.wgsl`, `obsidian.wgsl`, `color.wgsl`

2. Update `RingUniforms` struct in WGSL:
   - Add after `_padding: f32`:
     ```wgsl
     /// Branch revelation threshold (0-1, lower = more branches visible).
     branch_threshold: f32,
     /// Branch noise frequency scale.
     branch_scale: f32,
     /// Branch animation speed multiplier.
     branch_speed: f32,
     /// Number of major branches around the ring.
     branch_count: f32,
     ```
   - These 4 f32s = 16 bytes, total struct = 192 bytes (still 16-byte aligned)

3. Remove `internal_plasma()` function (lines 101-117)

4. Remove `plasma_color()` function (lines 119-135)

5. Rewrite `fs_main()` emission section:
   ```wgsl
   // Branch Energy (replaces internal plasma)
   var emission = vec3<f32>(0.0);
   if uniforms.plasma_intensity > 0.001 {
       let params = BranchParams(
           uniforms.branch_threshold,
           uniforms.branch_scale,
           uniforms.branch_speed,
           uniforms.branch_count,
           uniforms.energy_level
       );
       let branch_value = branch_energy(in.uv, uniforms.time, params);
       let branch_col = branch_color(branch_value, uniforms.energy_level);
       emission = branch_col * uniforms.plasma_intensity;
   }
   ```
   - The `obsidian_emission_blend()` call stays unchanged

6. Rewrite `fs_main_hq()` emission section:
   - Same as fs_main but with enhanced parameters:
     - Apply `domain_warp()` to UV before branch sampling for organic movement
     - Use slightly higher noise scale for more detail
   ```wgsl
   if uniforms.plasma_intensity > 0.001 {
       let params = BranchParams(
           uniforms.branch_threshold,
           uniforms.branch_scale * 1.5,  // More detail in HQ
           uniforms.branch_speed,
           uniforms.branch_count,
           uniforms.energy_level
       );
       // Warp UVs for organic feel
       let warped_uv = in.uv + vec2<f32>(
           simplex_noise_2d(in.uv * 3.0 + uniforms.time * 0.1) * 0.02,
           simplex_noise_2d(in.uv * 3.0 + 5.0 + uniforms.time * 0.1) * 0.02
       );
       let branch_value = branch_energy(warped_uv, uniforms.time, params);
       let branch_col = branch_color(branch_value, uniforms.energy_level);
       emission = branch_col * uniforms.plasma_intensity;
   }
   ```

7. Update `fs_main_lq()`:
   - Keep simple: no branch computation (too expensive for low quality)
   - Current simple energy glow is fine (just Fresnel + flat energy color)
   - No changes needed

**Verification**:
- No `internal_plasma` or `plasma_color` references remain
- Branch energy functions are called in fs_main and fs_main_hq
- All fragment shaders still return alpha = 1.0
- `noise_hd.wgsl` included for ridged_turbulence_3d

---

### Task 3: Update Rust RingUniforms, RingConfig, and tests

**Action**: Add branch control fields to the Rust-side structs. Update the render method to drive branch parameters from energy level. Update tests for new struct size and fields.

**File**: `opta-native/opta-render/src/components/ring.rs`

**Implementation**:

1. Update `RingUniforms` struct:
   - Add after `_padding: f32`:
     ```rust
     /// Branch revelation threshold (0-1, lower = more visible).
     pub branch_threshold: f32,
     /// Branch noise frequency scale.
     pub branch_scale: f32,
     /// Branch animation speed multiplier.
     pub branch_speed: f32,
     /// Number of major branches around the ring.
     pub branch_count: f32,
     ```
   - New struct size: 192 bytes (176 + 16)

2. Update `RingUniforms::default()`:
   ```rust
   branch_threshold: 0.85,  // High threshold = few branches at default energy
   branch_scale: 4.0,
   branch_speed: 0.3,
   branch_count: 8.0,
   ```

3. Update `RingConfig`:
   - Add fields:
     ```rust
     /// Noise frequency for branch pattern.
     pub branch_scale: f32,
     /// Animation speed for branch pulsing.
     pub branch_speed: f32,
     /// Number of major branches around the ring.
     pub branch_count: f32,
     ```

4. Update `RingConfig::default()`:
   ```rust
   branch_scale: 4.0,
   branch_speed: 0.3,
   branch_count: 8.0,
   ```

5. Update `RingConfig::with_quality()` — branch count may vary by quality:
   - Low: `branch_count: 6.0` (fewer branches, simpler)
   - Medium: `branch_count: 8.0`
   - High/Ultra: `branch_count: 10.0` (more branches for detail)

6. Update `render()` method uniforms construction:
   ```rust
   // Branch threshold derived from energy level:
   // High energy → low threshold (more branches visible)
   // Low energy → high threshold (few branches)
   branch_threshold: 1.0 - self.current_energy * 0.7,
   branch_scale: self.config.branch_scale,
   branch_speed: self.config.branch_speed,
   branch_count: self.config.branch_count,
   ```

7. Update `RingUniforms` size test:
   - Change assertion from 176 to 192 bytes

8. Update existing tests in `ring_test.rs`:
   - `test_ring_config_defaults()`: Add assertions for branch_scale, branch_speed, branch_count
   - `test_ring_uniforms_layout()`: Update size assertion to 192
   - `test_ring_uniforms_defaults()`: Add branch_threshold/scale/speed/count assertions
   - `test_generate_torus_geometry_basic()`: Add branch fields to RingConfig literal
   - `test_generate_torus_geometry_bounds()`: Add branch fields to RingConfig literal
   - `test_ring_config_custom()`: Add branch fields

9. Update `mod.rs` exports if `BranchConfig` or similar types are added (likely not needed — branch params are just f32 fields on existing structs)

10. Run `cargo build --release -p opta-render` and `cargo test -p opta-render`

**Verification**:
- `cargo build --release -p opta-render` succeeds
- `cargo test -p opta-render` all pass
- Struct size test passes with 192
- branch_threshold at default energy (0.2) → ~0.86 (few branches)
- branch_threshold at max energy (1.0) → 0.3 (many branches)

## Verification

```bash
# Build check
cargo build --release -p opta-render

# All tests pass
cargo test -p opta-render

# Branch energy include exists
test -f opta-native/opta-render/shaders/includes/branch_energy.wgsl

# No plasma functions remain in ring.wgsl
! grep -q "internal_plasma\|plasma_color" opta-native/opta-render/shaders/ring.wgsl

# Branch energy is used
grep -q "branch_energy" opta-native/opta-render/shaders/ring.wgsl

# noise_hd.wgsl included
grep -q "noise_hd.wgsl" opta-native/opta-render/shaders/ring.wgsl

# Ring still outputs alpha 1.0
grep "1.0)" opta-native/opta-render/shaders/ring.wgsl | grep -q "vec4"

# New struct size
grep -q "192" opta-native/opta-render/tests/ring_test.rs
```

## Success Criteria

- [ ] `branch_energy.wgsl` created with fBm ridged noise branch pattern
- [ ] Branch equator origin (v=0.5 strongest, fades outward)
- [ ] Threshold revelation (fewer branches at low energy, many at high)
- [ ] Tri-axis response (length + width + brightness scale with energy)
- [ ] Per-branch phase offsets for non-synchronized organic pulsing
- [ ] `ring.wgsl` uses branch energy (no internal_plasma/plasma_color references)
- [ ] HQ mode has domain-warped UV for organic feel
- [ ] LQ mode unchanged (simple Fresnel glow, no branch computation)
- [ ] `RingUniforms` carries branch_threshold/scale/speed/count (192 bytes)
- [ ] `RingConfig` carries branch_scale/speed/count
- [ ] branch_threshold derived from energy_level in render()
- [ ] `cargo build --release -p opta-render` succeeds
- [ ] `cargo test -p opta-render` all pass
- [ ] Electric Violet color preserved for branch emission
- [ ] Hot-white cores at high branch intensity for visual depth

## Output

```yaml
files_created:
  - opta-native/opta-render/shaders/includes/branch_energy.wgsl

files_modified:
  - opta-native/opta-render/shaders/ring.wgsl
  - opta-native/opta-render/src/components/ring.rs
  - opta-native/opta-render/tests/ring_test.rs

files_removed: []

apis_added:
  - BranchParams (WGSL struct)
  - branch_energy() (WGSL function)
  - branch_equator_mask() (WGSL function)
  - branch_noise_field() (WGSL function)
  - branch_tri_axis() (WGSL function)
  - branch_width_mask() (WGSL function)
  - branch_phase_offset() (WGSL function)
  - branch_color() (WGSL function)

apis_modified:
  - RingUniforms (+branch_threshold, +branch_scale, +branch_speed, +branch_count → 192 bytes)
  - RingConfig (+branch_scale, +branch_speed, +branch_count)
  - ring.wgsl RingUniforms struct (+4 branch fields)

apis_removed:
  - internal_plasma() from ring.wgsl
  - plasma_color() from ring.wgsl
```
