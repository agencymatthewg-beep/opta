# Plan 62-03: Menu Bar Integration

## Wave: 2 (Depends on 62-01)

## Objective

Create native macOS Menu Bar Extra with live stats popover and quick actions.

## Execution Context

**Reference Documents:**
- Apple MenuBarExtra documentation
- Existing Opta telemetry patterns

**Key Insights:**
- MenuBarExtra available in SwiftUI on macOS 13+
- Can show both window and popover styles
- Ideal for system monitoring at-a-glance

## Context

**Depends on:**
- Plan 62-01 (SwiftUI shell foundation)

**Builds foundation for:**
- Quick access to Opta from anywhere in macOS
- Background monitoring without main window

## Tasks

### Task 1: Create MenuBarExtraView

**File:** `opta-native/OptaApp/OptaApp/MenuBar/MenuBarView.swift`

```swift
import SwiftUI

/// Menu bar popover content
struct MenuBarPopoverView: View {
    @ObservedObject var coordinator: RenderCoordinator
    @Environment(\.openWindow) private var openWindow

    var body: some View {
        VStack(spacing: 16) {
            // Header
            HStack {
                Image(systemName: "circle.hexagongrid.fill")
                    .font(.title2)
                    .foregroundStyle(.purple)
                Text("Opta")
                    .font(.headline)
                Spacer()
                Text(String(format: "%.0f FPS", coordinator.fps))
                    .font(.caption)
                    .foregroundStyle(.secondary)
            }

            Divider()

            // Quick stats
            StatsGrid()

            Divider()

            // Quick actions
            HStack(spacing: 12) {
                QuickActionButton(
                    icon: "bolt.fill",
                    label: "Optimize",
                    action: { /* Trigger optimization */ }
                )

                QuickActionButton(
                    icon: "chart.bar.fill",
                    label: "Stats",
                    action: { openWindow(id: "main") }
                )

                QuickActionButton(
                    icon: "gearshape.fill",
                    label: "Settings",
                    action: { openWindow(id: "settings") }
                )
            }

            Divider()

            // Footer
            HStack {
                Text("v\(OptaRenderBridge.version)")
                    .font(.caption2)
                    .foregroundStyle(.tertiary)
                Spacer()
                Button("Quit") {
                    NSApplication.shared.terminate(nil)
                }
                .buttonStyle(.plain)
                .foregroundStyle(.red)
            }
        }
        .padding()
        .frame(width: 280)
    }
}

// MARK: - Supporting Views

struct StatsGrid: View {
    var body: some View {
        LazyVGrid(columns: [
            GridItem(.flexible()),
            GridItem(.flexible())
        ], spacing: 8) {
            StatCard(
                icon: "cpu",
                label: "CPU",
                value: "32%",
                color: .green
            )
            StatCard(
                icon: "memorychip",
                label: "Memory",
                value: "8.2 GB",
                color: .blue
            )
            StatCard(
                icon: "cpu.fill",
                label: "GPU",
                value: "45%",
                color: .purple
            )
            StatCard(
                icon: "thermometer.medium",
                label: "Temp",
                value: "62Â°C",
                color: .orange
            )
        }
    }
}

struct StatCard: View {
    let icon: String
    let label: String
    let value: String
    let color: Color

    var body: some View {
        HStack(spacing: 8) {
            Image(systemName: icon)
                .foregroundStyle(color)
            VStack(alignment: .leading, spacing: 2) {
                Text(label)
                    .font(.caption2)
                    .foregroundStyle(.secondary)
                Text(value)
                    .font(.caption)
                    .fontWeight(.medium)
            }
        }
        .frame(maxWidth: .infinity, alignment: .leading)
        .padding(8)
        .background(.ultraThinMaterial)
        .cornerRadius(8)
    }
}

struct QuickActionButton: View {
    let icon: String
    let label: String
    let action: () -> Void

    var body: some View {
        Button(action: action) {
            VStack(spacing: 4) {
                Image(systemName: icon)
                    .font(.title3)
                Text(label)
                    .font(.caption2)
            }
            .frame(maxWidth: .infinity)
            .padding(.vertical, 8)
            .background(.ultraThinMaterial)
            .cornerRadius(8)
        }
        .buttonStyle(.plain)
    }
}
```

### Task 2: Create animated menu bar icon

**File:** `opta-native/OptaApp/OptaApp/MenuBar/MenuBarIcon.swift`

```swift
import SwiftUI

/// Animated menu bar icon that pulses with system activity
struct MenuBarIcon: View {
    @ObservedObject var coordinator: RenderCoordinator
    @State private var isPulsing = false

    var body: some View {
        ZStack {
            // Base ring
            Circle()
                .strokeBorder(
                    AngularGradient(
                        colors: [.purple, .blue, .purple],
                        center: .center
                    ),
                    lineWidth: 2
                )
                .frame(width: 16, height: 16)

            // Inner glow (activity indicator)
            Circle()
                .fill(.purple.opacity(isPulsing ? 0.8 : 0.3))
                .frame(width: 8, height: 8)
                .animation(
                    .easeInOut(duration: 1.0).repeatForever(autoreverses: true),
                    value: isPulsing
                )
        }
        .onAppear {
            isPulsing = coordinator.isRendering
        }
        .onChange(of: coordinator.isRendering) { _, newValue in
            isPulsing = newValue
        }
    }
}
```

### Task 3: Integrate MenuBarExtra into app

**Update:** `opta-native/OptaApp/OptaApp/OptaAppApp.swift`

```swift
import SwiftUI

@main
struct OptaAppApp: App {
    @StateObject private var coordinator = RenderCoordinator()
    @StateObject private var haptics = HapticsManager()

    var body: some Scene {
        // Main window
        WindowGroup(id: "main") {
            ContentView(coordinator: coordinator, haptics: haptics)
                .onAppear {
                    coordinator.setupHaptics(haptics)
                    coordinator.resume()
                }
                .onDisappear {
                    coordinator.pause()
                }
        }
        .windowStyle(.hiddenTitleBar)
        .defaultSize(width: 1200, height: 800)

        // Settings window
        WindowGroup(id: "settings") {
            SettingsView()
        }
        .windowStyle(.automatic)
        .defaultSize(width: 500, height: 400)

        // Menu bar extra
        MenuBarExtra {
            MenuBarPopoverView(coordinator: coordinator)
        } label: {
            MenuBarIcon(coordinator: coordinator)
        }
        .menuBarExtraStyle(.window)
    }
}
```

### Task 4: Create settings view

**File:** `opta-native/OptaApp/OptaApp/Views/SettingsView.swift`

```swift
import SwiftUI

struct SettingsView: View {
    @AppStorage("launchAtLogin") private var launchAtLogin = false
    @AppStorage("showMenuBarIcon") private var showMenuBarIcon = true
    @AppStorage("hapticsEnabled") private var hapticsEnabled = true
    @AppStorage("qualityLevel") private var qualityLevel = 2

    var body: some View {
        Form {
            Section("General") {
                Toggle("Launch at Login", isOn: $launchAtLogin)
                Toggle("Show Menu Bar Icon", isOn: $showMenuBarIcon)
            }

            Section("Rendering") {
                Picker("Quality", selection: $qualityLevel) {
                    Text("Low").tag(0)
                    Text("Medium").tag(1)
                    Text("High").tag(2)
                    Text("Ultra").tag(3)
                }
                .pickerStyle(.segmented)

                Toggle("Enable Haptics", isOn: $hapticsEnabled)
            }

            Section("About") {
                LabeledContent("Version", value: OptaRenderBridge.version)
                LabeledContent("Render Engine", value: "wgpu + Metal")

                Link("View on GitHub", destination: URL(string: "https://github.com/opta")!)
            }
        }
        .formStyle(.grouped)
        .frame(minWidth: 400)
        .padding()
    }
}

#Preview {
    SettingsView()
}
```

### Task 5: Add launch at login support

**File:** `opta-native/OptaApp/OptaApp/Utilities/LaunchAtLogin.swift`

```swift
import Foundation
import ServiceManagement

enum LaunchAtLogin {
    static var isEnabled: Bool {
        get {
            SMAppService.mainApp.status == .enabled
        }
        set {
            do {
                if newValue {
                    try SMAppService.mainApp.register()
                } else {
                    try SMAppService.mainApp.unregister()
                }
            } catch {
                print("Failed to \(newValue ? "enable" : "disable") launch at login: \(error)")
            }
        }
    }
}
```

### Task 6: Add keyboard shortcuts

**Update:** `opta-native/OptaApp/OptaApp/OptaAppApp.swift`

Add commands for keyboard shortcuts:

```swift
// Add to OptaAppApp

var body: some Scene {
    // ... existing scenes ...
}
.commands {
    CommandGroup(after: .appInfo) {
        Button("Check for Updates...") {
            // Sparkle update check
        }
        .keyboardShortcut("U", modifiers: [.command])
    }

    CommandGroup(replacing: .newItem) {
        // Remove "New Window" since we manage windows ourselves
    }

    CommandMenu("Opta") {
        Button("Open Main Window") {
            NSApp.activate(ignoringOtherApps: true)
        }
        .keyboardShortcut("O", modifiers: [.command, .shift])

        Button("Quick Optimize") {
            // Trigger optimization
        }
        .keyboardShortcut("P", modifiers: [.command, .shift])

        Divider()

        Button("Pause Rendering") {
            coordinator.pause()
        }
        .keyboardShortcut(".", modifiers: [.command])
    }
}
```

## Verification

```bash
# Build and run
cd opta-native
./scripts/build-macos.sh
open OptaApp/OptaApp.xcodeproj

# Test:
# 1. Menu bar icon appears
# 2. Click icon shows popover with stats
# 3. Quick actions open windows
# 4. Settings persist across launches
# 5. Keyboard shortcuts work
```

## Success Criteria

- [ ] Menu bar icon shows and animates
- [ ] Popover displays live stats
- [ ] Quick actions work (optimize, stats, settings)
- [ ] Settings persist via @AppStorage
- [ ] Launch at login works
- [ ] Keyboard shortcuts functional

## Output

- Native menu bar extra with live monitoring
- Settings window with preferences
- Keyboard shortcuts for quick access
