# Plan 81-01: Obsidian Ring Material

## Metadata

```yaml
phase: 81
plan: 01
name: Obsidian Ring Material
wave: 1
autonomous: true
estimated_tasks: 3
```

## Objective

Replace the current glass ring material with opaque PBR obsidian. The ring is NOT transparent glass — it is a solid obsidian stone with Cook-Torrance BRDF (roughness 0.03, IOR 1.85, zero transmission). Energy is visible through a subsurface emission blend gated by Fresnel, not refraction.

## Design Spec (from Ring Visualization Work)

```
Material: Opaque HD obsidian (NOT glass)
Roughness: 0.03 (near-mirror obsidian)
IOR: 1.85 (volcanic glass)
Transmission: 0.0 (fully opaque)
Alpha: 1.0 (always)
Reflection: Cook-Torrance BRDF with GGX NDF
Energy blend: final = reflection + emission * (1 - fresnel)
  → Energy shows MORE at face-on angles (where fresnel is LOW)
  → Edges dominated by specular reflection (high fresnel)
Color: Electric Violet #8B5CF6 (0.545, 0.361, 0.965) for energy
Base: Near-black obsidian (0.02, 0.02, 0.03) with subtle deep purple
```

## Execution Context

```
@opta-native/opta-render/shaders/ring.wgsl           (ring shader - REWRITE)
@opta-native/opta-render/shaders/includes/glass.wgsl  (legacy glass - REMOVE from ring deps)
@opta-native/opta-render/shaders/includes/glass_hd.wgsl (Cook-Torrance BRDF - REFERENCE)
@opta-native/opta-render/src/components/ring.rs        (Rust ring component - UPDATE uniforms)
@opta-native/opta-render/src/components/mod.rs         (module exports - may need update)
```

## Tasks

### Task 1: Create obsidian.wgsl shader include

**Action**: Create a new WGSL include file for the obsidian material, adapted from the Cook-Torrance BRDF in `glass_hd.wgsl` but configured for opaque stone rather than transparent glass.

**File**: `opta-native/opta-render/shaders/includes/obsidian.wgsl`

**Implementation**:

1. Create `ObsidianMaterial` struct:
   ```wgsl
   struct ObsidianMaterial {
       roughness: f32,        // 0.03 for polished obsidian
       ior: f32,              // 1.85 for volcanic glass
       base_color: vec3<f32>, // Near-black (0.02, 0.02, 0.03)
       energy_color: vec3<f32>, // Electric Violet (0.545, 0.361, 0.965)
   }
   ```

2. Reuse `distribution_ggx()`, `geometry_schlick_ggx()`, `geometry_smith()` from glass_hd.wgsl (copy, don't include both — obsidian replaces glass for ring)

3. Create `obsidian_shade()` function:
   - Compute Cook-Torrance specular reflection (same BRDF as glass_hd)
   - Compute Fresnel using Schlick (f0 from IOR 1.85 = ~0.085)
   - **No transmission** — base color is the obsidian surface itself
   - Return `vec4<f32>(color, 1.0)` — always fully opaque

4. Create `obsidian_emission_blend()` function:
   - Takes: reflection color, emission color, emission intensity, fresnel
   - Returns: `reflection + emission * emission_intensity * (1.0 - fresnel)`
   - Energy is visible face-on (low fresnel), edges show reflection only

5. Create `obsidian_opta_ring()` factory with the fixed material values

**Verification**: File exists, no WGSL syntax errors (checked via string pattern matching in tests)

---

### Task 2: Rewrite ring.wgsl for obsidian material

**Action**: Replace the glass-based fragment shader with obsidian PBR rendering. Remove all alpha/transmission logic. Keep the vertex shader unchanged.

**File**: `opta-native/opta-render/shaders/ring.wgsl`

**Implementation**:

1. Change includes:
   - Remove: `#include "glass.wgsl"`
   - Add: `#include "obsidian.wgsl"`
   - Keep: `#include "math.wgsl"`, `#include "noise.wgsl"`, `#include "color.wgsl"`

2. Update `RingUniforms` struct in WGSL:
   - Remove: `ior: f32` (now hardcoded in material)
   - Remove: `tint_color: vec3<f32>` (replaced by obsidian base_color)
   - Add: `roughness: f32` (0.03 default)
   - Add: `emission_intensity: f32` (energy-driven emission strength)
   - Keep: `time`, `energy_level`, `plasma_intensity`, `fresnel_power`, `ring_rotation`, `tilt_angle`
   - Keep: model_matrix, view_proj_matrix
   - Maintain 16-byte alignment

3. Rewrite `fs_main()`:
   ```
   a) Create obsidian material from uniforms
   b) Compute Cook-Torrance reflection (ambient light direction from above)
   c) Generate internal plasma (keep existing plasma functions)
   d) Compute emission = plasma_color * plasma_intensity * energy_level
   e) Blend: final = obsidian_shade() + obsidian_emission_blend(emission, fresnel)
   f) Apply ACES tonemap
   g) Return vec4(color, 1.0)  ← ALWAYS OPAQUE
   ```

4. Update `fs_main_hq()` with same obsidian approach (more plasma octaves)

5. Update `fs_main_lq()`:
   - Simple Fresnel-based edge highlight on obsidian base color
   - No plasma, no emission blend
   - Still returns alpha = 1.0

6. Remove `energy_bloom()` function (will be reimplemented in Phase 82 as branch energy)

**Verification**:
- No `glass` references remain in ring.wgsl
- All fragment shaders return alpha = 1.0
- Plasma functions preserved for energy visibility

---

### Task 3: Update Rust RingUniforms and RingConfig

**Action**: Update the Rust-side structs to match the new WGSL uniforms. Replace glass properties with obsidian properties.

**File**: `opta-native/opta-render/src/components/ring.rs`

**Implementation**:

1. Update `RingUniforms`:
   - Remove: `ior: f32`
   - Remove: `tint_color: [f32; 3]`
   - Add: `roughness: f32` (at the ior position for alignment)
   - Add: `emission_intensity: f32`
   - Add: `base_color: [f32; 3]` (replacing tint_color, same offset)
   - Maintain same struct size (verify with `size_of` test)
   - Update padding as needed for 16-byte alignment

2. Update `RingUniforms::default()`:
   ```rust
   roughness: 0.03,
   emission_intensity: 0.0,
   base_color: [0.02, 0.02, 0.03], // Near-black obsidian
   ```

3. Update `RingConfig`:
   - Remove: `ior: f32`
   - Remove: `tint: [f32; 3]`
   - Add: `roughness: f32`
   - Add: `base_color: [f32; 3]`
   - Add: `energy_color: [f32; 3]` (Electric Violet)

4. Update `RingConfig::default()` and `with_quality()`:
   ```rust
   roughness: 0.03,
   base_color: [0.02, 0.02, 0.03],
   energy_color: [0.545, 0.361, 0.965], // #8B5CF6
   ```

5. Update `OptaRing::new()` and `update_uniforms()`:
   - Map new config fields to new uniform fields
   - `emission_intensity` driven by `energy_level * plasma_intensity`

6. Update existing tests:
   - `test_ring_uniforms_size()` — verify struct size unchanged (or document new size)
   - `test_ring_config_default()` — update assertions for obsidian values
   - Any test referencing `ior` or `tint` → replace with `roughness`/`base_color`

7. Run `cargo build --release -p opta-render` and `cargo test -p opta-render`

**Verification**:
- `cargo build --release -p opta-render` succeeds
- `cargo test -p opta-render` passes
- No references to `ior` or `tint` remain in ring.rs (except in comments explaining the change)
- Struct size test passes

## Verification

```bash
# Build check
cargo build --release -p opta-render

# All tests pass
cargo test -p opta-render

# No glass references in ring shader
! grep -q "glass" opta-native/opta-render/shaders/ring.wgsl

# Ring shader always outputs alpha 1.0
grep "1.0)" opta-native/opta-render/shaders/ring.wgsl | grep -q "vec4"

# Obsidian include exists
test -f opta-native/opta-render/shaders/includes/obsidian.wgsl
```

## Success Criteria

- [ ] `obsidian.wgsl` created with Cook-Torrance BRDF for opaque stone
- [ ] `ring.wgsl` uses obsidian material (zero glass references)
- [ ] All ring fragment shaders return alpha = 1.0 (fully opaque)
- [ ] Subsurface emission blend gates energy by inverse Fresnel
- [ ] `RingUniforms` carries roughness + emission_intensity (not ior + tint_color)
- [ ] `RingConfig` carries obsidian material properties
- [ ] `cargo build --release -p opta-render` succeeds
- [ ] `cargo test -p opta-render` all pass
- [ ] No regressions in existing ring functionality (geometry, springs, adaptive quality)

## Output

```yaml
files_created:
  - opta-native/opta-render/shaders/includes/obsidian.wgsl

files_modified:
  - opta-native/opta-render/shaders/ring.wgsl
  - opta-native/opta-render/src/components/ring.rs

files_removed: []
  # glass.wgsl and glass_hd.wgsl are NOT removed — they're still used by glass_panel shaders

apis_added:
  - ObsidianMaterial (WGSL struct)
  - obsidian_shade() (WGSL function)
  - obsidian_emission_blend() (WGSL function)

apis_modified:
  - RingUniforms (ior/tint → roughness/emission_intensity/base_color)
  - RingConfig (ior/tint → roughness/base_color/energy_color)

apis_removed:
  - energy_bloom() from ring.wgsl (replaced by branch energy in Phase 82)
```
