# Plan 97-01: Conflict Detection & Adaptive Learning Completion

## Overview

Complete the Phase 97 implementation by integrating pattern learning throughout the app, persisting user preferences, applying Obsidian design system, and expanding the conflict database.

**Foundation Status**: Core services exist (ConflictDetectionService, PatternLearningService, ConflictViewModel, ConflictView) but lack integration and design compliance.

## Tasks

### Task 1: Pattern Learning Integration
**Goal**: Wire `trackEvent()` into game launches and optimization actions

**Files to modify**:
- `ViewModels/GamesViewModel.swift` or `Views/Games/GamesLibraryView.swift` — track game launches
- `ViewModels/OptimizationViewModel.swift` — track optimize on/off
- `Views/GameSession/GameSessionView.swift` — track session starts

**Implementation**:
```swift
// In game launch flow
await patternService.trackEvent(.gameLaunch, context: game.name)

// In optimization toggle
await patternService.trackEvent(.optimizeOn, context: currentGame?.name)
```

### Task 2: Persist Ignored Conflicts
**Goal**: Save ignored conflict IDs to UserDefaults so they persist across sessions

**Files to modify**:
- `ViewModels/ConflictViewModel.swift`

**Implementation**:
```swift
@AppStorage("ignoredConflictIds") private var ignoredIdsData: Data = Data()

private var ignoredIds: Set<String> {
    get { (try? JSONDecoder().decode(Set<String>.self, from: ignoredIdsData)) ?? [] }
    set { ignoredIdsData = (try? JSONEncoder().encode(newValue)) ?? Data() }
}

func ignoreConflict(id: String) {
    ignoredIds.insert(id)
    conflicts.removeAll { $0.id == id }
}

// Filter in refresh():
self.conflicts = foundConflicts.filter { !ignoredIds.contains($0.id) }
```

### Task 3: Auto-Suggest Prompts
**Goal**: Show optimization suggestion when launching frequently-optimized games

**Files to modify**:
- `Views/Games/GameDetailView.swift` or game launch flow

**Implementation**:
- Check `shouldSuggestOptimization(for: game.name)` before launch
- Show subtle prompt: "You usually optimize for this game. Enable Stealth Mode?"
- Quick action buttons: "Yes" / "Not now"

### Task 4: Obsidian Design System Update
**Goal**: Apply Void/Obsidian palette and ColorTemperature environment

**Files to modify**:
- `Views/Components/ConflictView.swift`

**Changes**:
- Replace `Color(nsColor: .controlBackgroundColor)` with `Color.optaSurface`
- Add `@Environment(\.colorTemperature) var colorTemp`
- Use `colorTemp.violetColor` for accents
- Apply `.glassPanel()` modifier where appropriate
- Use semantic colors from DesignSystem.swift

### Task 5: Expand Conflict Database
**Goal**: Add more common macOS optimization/monitoring tools

**Files to modify**:
- `Services/ConflictDetectionService.swift`

**New definitions**:
```swift
// Memory cleaners
ConflictDefinition(id: "memory_clean", name: "Memory Clean", ...)
ConflictDefinition(id: "dr_cleaner", name: "Dr. Cleaner", ...)

// Other monitors
ConflictDefinition(id: "stats", name: "Stats", ...)
ConflictDefinition(id: "menumeters", name: "MenuMeters", ...)
ConflictDefinition(id: "activity_monitor", name: "Activity Monitor", severity: .low, ...)

// Game overlays
ConflictDefinition(id: "gfxcardstatus", name: "gfxCardStatus", ...)
```

### Task 6: Time-Based Pattern Analysis (Enhancement)
**Goal**: Track time-of-day patterns for smarter suggestions

**Files to modify**:
- `Services/PatternLearningService.swift`

**Implementation**:
- Add `hour: Int` to UserEvent
- Add `getOptimalTimeSlots(for context:)` method
- Return hours when user most frequently optimizes

## Verification

- [ ] Game launches trigger `trackEvent(.gameLaunch, context:)`
- [ ] Optimization toggles trigger `trackEvent(.optimizeOn/Off, context:)`
- [ ] Ignored conflicts persist across app restarts
- [ ] ConflictView uses Obsidian design tokens
- [ ] At least 10 conflict definitions exist
- [ ] Build succeeds with no warnings

## Estimated Scope

| Task | Complexity | Files |
|------|------------|-------|
| Pattern integration | Medium | 3-4 |
| Persist ignored | Low | 1 |
| Auto-suggest | Medium | 1-2 |
| Design update | Medium | 1 |
| Expand database | Low | 1 |
| Time patterns | Low | 1 |

**Total**: ~6 files modified, ~150 lines added/changed
