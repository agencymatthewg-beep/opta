# Plan 79-02: SwiftUI Circular Menu Integration

## Metadata

```yaml
phase: 79
plan: 02
name: SwiftUI Circular Menu Integration
status: ready
wave: 2
autonomous: true
estimated_effort: medium
depends_on: [79-01]
```

## Objective

Create the SwiftUI integration layer for the circular menu including gesture handling, keyboard accessibility, navigation integration, and menu bar activation.

## Execution Context

Reference files:
- `opta-native/OptaApp/OptaApp/Views/Components/QuickActions.swift` - Gesture patterns
- `opta-native/OptaApp/OptaApp/MenuBar/MenuBarView.swift` - Menu bar integration
- `opta-native/OptaApp/OptaApp/Managers/OptaCoreManager.swift` - Navigation dispatch
- `opta-native/OptaApp/OptaApp/Bridge/RustBridge.swift` - FFI bridge patterns
- `opta-native/OptaApp/OptaApp/Haptics/HapticsManager.swift` - Haptic feedback

## Context

Plan 79-01 creates the wgpu circular menu component with FFI bindings. This plan creates the SwiftUI layer to activate the menu via gestures, handle keyboard navigation, integrate with the app's navigation system, and provide accessibility support.

## Tasks

### Task 1: Rust Bridge Extension
**Goal**: Add Swift bridge functions for circular menu FFI

**Implementation**:
1. Update `opta-native/OptaApp/OptaApp/Bridge/RustBridge.swift`
2. Add Swift wrappers for all circular menu FFI functions:
   - `CircularMenuBridge.create()` -> pointer
   - `CircularMenuBridge.setSectors(_ sectors: [MenuSector])`
   - `CircularMenuBridge.setHighlighted(_ index: Int32)`
   - `CircularMenuBridge.setOpen(_ open: Bool)`
   - `CircularMenuBridge.update(_ dt: Float)`
   - `CircularMenuBridge.pointToSector(_ point: CGPoint) -> Int32`
   - `CircularMenuBridge.destroy()`
3. Define Swift `MenuSector` struct matching Rust
4. Handle memory management with deinit

**Files**:
- Modify: `opta-native/OptaApp/OptaApp/Bridge/RustBridge.swift`

**Verification**: Bridge functions compile and link

---

### Task 2: CircularMenuView SwiftUI Component
**Goal**: Create SwiftUI view wrapping the wgpu circular menu

**Implementation**:
1. Create `opta-native/OptaApp/OptaApp/Views/Components/CircularMenuView.swift`
2. Define `CircularMenuView: View` with:
   - `@Binding var isOpen: Bool`
   - `@Binding var selectedSector: Int?`
   - `let sectors: [CircularMenuSector]`
   - `let onSectorSelected: (CircularMenuSector) -> Void`
3. Define `CircularMenuSector` struct:
   - `id: String`
   - `icon: String` (SF Symbol)
   - `label: String`
   - `color: Color`
   - `action: CircularMenuAction`
4. Define `CircularMenuAction` enum for navigation targets
5. Use `MetalRenderView` pattern for wgpu rendering
6. Add DisplayLink for smooth animation updates
7. Integrate with `accessibilityReduceMotion` preference

**Files**:
- Create: `opta-native/OptaApp/OptaApp/Views/Components/CircularMenuView.swift`

**Verification**: View renders without crashes

---

### Task 3: Gesture Activation System
**Goal**: Implement trackpad/mouse gestures to activate circular menu

**Implementation**:
1. Create `opta-native/OptaApp/OptaApp/Views/Components/CircularMenuGestureHandler.swift`
2. Support activation gestures:
   - **Two-finger circular gesture**: Trackpad rotation
   - **Right-click hold**: Mouse activation
   - **Keyboard shortcut**: Cmd+Space or configurable
3. Use `NSEvent` monitoring for global gestures
4. Track gesture state: `.idle`, `.activating`, `.open`, `.selecting`
5. Convert mouse position to sector selection
6. Add gesture sensitivity settings
7. Support cancellation via Escape or click outside

**Files**:
- Create: `opta-native/OptaApp/OptaApp/Views/Components/CircularMenuGestureHandler.swift`
- Modify: `opta-native/OptaApp/OptaApp/Views/Components/CircularMenuView.swift`

**Verification**: Menu opens via trackpad gesture

---

### Task 4: Keyboard Accessibility
**Goal**: Full keyboard navigation for circular menu

**Implementation**:
1. Add keyboard handling to `CircularMenuView`:
   - Arrow keys: Cycle through sectors (clockwise/counter-clockwise)
   - Tab: Move to next sector
   - Enter/Space: Select highlighted sector
   - Escape: Close menu
   - Number keys 1-9: Direct sector selection
2. Add `@FocusState` for keyboard focus management
3. Implement `accessibilityLabel` and `accessibilityHint` for each sector
4. Add VoiceOver announcements for sector changes
5. Respect `accessibilityReduceMotion`:
   - Instant open/close (no spring animation)
   - Immediate highlight transitions

**Files**:
- Modify: `opta-native/OptaApp/OptaApp/Views/Components/CircularMenuView.swift`

**Verification**: Menu fully navigable via keyboard only

---

### Task 5: Navigation Integration
**Goal**: Connect circular menu sectors to app navigation

**Implementation**:
1. Define standard menu sectors in `CircularMenuView+Sectors.swift`:
   - **Dashboard**: Navigate to home
   - **Games**: Navigate to games library
   - **Settings**: Navigate to settings
   - **Optimize**: Trigger stealth mode
   - **Score**: Show optimization score
   - **Profile**: Open profile manager
2. Add `navigate(to:)` calls via `OptaCoreManager`
3. Add haptic feedback on sector selection (via HapticsManager)
4. Add sound feedback (via SpatialAudioManager)
5. Close menu after selection with spring animation

**Files**:
- Create: `opta-native/OptaApp/OptaApp/Views/Components/CircularMenuView+Sectors.swift`
- Modify: `opta-native/OptaApp/OptaApp/Views/Components/CircularMenuView.swift`

**Verification**: Selecting sector navigates correctly

---

### Task 6: Menu Bar Quick Access
**Goal**: Add circular menu activation from menu bar

**Implementation**:
1. Update `opta-native/OptaApp/OptaApp/MenuBar/MenuBarView.swift`:
   - Add "Quick Menu" button or gesture zone
   - Show circular menu overlay on activation
2. Create `CircularMenuOverlay` view:
   - Full-screen transparent overlay
   - Centered circular menu
   - Click-outside-to-dismiss
3. Add menu bar keyboard shortcut (Ctrl+Option+O or configurable)
4. Position menu at cursor when activated from menu bar

**Files**:
- Modify: `opta-native/OptaApp/OptaApp/MenuBar/MenuBarView.swift`
- Create: `opta-native/OptaApp/OptaApp/Views/Components/CircularMenuOverlay.swift`

**Verification**: Menu activates from menu bar click

---

### Task 7: Sensory Feedback
**Goal**: Add haptics and audio for premium feel

**Implementation**:
1. Integrate with `HapticsManager`:
   - Light tap on menu open
   - Selection tap on sector highlight change
   - Medium tap on sector selection
2. Integrate with `SpatialAudioManager`:
   - Soft "whoosh" on menu open
   - Subtle tick on sector hover
   - Confirmation sound on selection
3. Add `SensoryManager` integration for coordinated feedback
4. Respect user preferences for haptics/sounds

**Files**:
- Modify: `opta-native/OptaApp/OptaApp/Views/Components/CircularMenuView.swift`
- Modify: `opta-native/OptaApp/OptaApp/Managers/SensoryManager.swift`

**Verification**: Haptics play on menu interactions

---

## Verification

```bash
# Build the app
cd opta-native/OptaApp && xcodebuild -scheme OptaApp -configuration Debug build

# Run the app and test:
# 1. Trackpad gesture activates menu
# 2. Keyboard navigation works
# 3. Sector selection navigates correctly
# 4. Menu bar integration works
# 5. Haptics and sounds play
```

## Success Criteria

- [ ] Rust bridge functions properly wrapped in Swift
- [ ] CircularMenuView renders via wgpu
- [ ] Trackpad/mouse gestures activate menu
- [ ] Full keyboard navigation with VoiceOver support
- [ ] Navigation integration routes to correct views
- [ ] Menu bar quick access working
- [ ] Haptic and audio feedback on interactions
- [ ] Respects reduced motion preference

## Output

On completion:
1. Create `79-02-SUMMARY.md` with commits and verification results
2. Complete circular menu feature ready for use
3. Accessible via gestures, keyboard, and menu bar
4. Premium sensory feedback integrated
