---
phase: 96
plan: 01
title: Game Session Tracking and Benchmark System
type: feature
wave: 1
depends_on: []
files_modified:
  - opta-native/OptaApp/OptaApp/Models/GameSessionModels.swift
  - opta-native/OptaApp/OptaApp/Services/GameSessionTracker.swift
  - opta-native/OptaApp/OptaApp/Services/BenchmarkManager.swift
  - opta-native/OptaApp/OptaApp/Views/Games/GameSessionDetailView.swift
  - opta-native/OptaApp/OptaApp/Views/Games/BenchmarkComparisonCard.swift
  - opta-native/OptaApp/OptaApp/Views/Games/GameDetailView.swift
  - opta-native/OptaApp/OptaApp.xcodeproj/project.pbxproj
autonomous: true
---

<objective>
Create a game session tracking system that monitors performance during gameplay and a benchmark
system for before/after optimization comparison. Includes a detailed session timeline view,
benchmark comparison cards, and integration with the existing GameDetailView.
Builds on the existing Game model (which already has PerformanceSnapshot and performanceHistory).
</objective>

<execution_context>
- Existing: Game.swift has PerformanceSnapshot (avgFps, avgCpuUsage, avgGpuUsage, sessionDuration)
- Existing: GameDetailView.swift has basic FPS chart (last 10 sessions)
- Existing: GameDetectionService.swift handles game scanning
- Existing: OptaViewModel has cpuUsage, gpuUsage, memoryUsage, thermalState telemetry
- Architecture: @Observable singleton managers, JSON persistence at ~/Library/Application Support/OptaApp/
- Charts: SwiftUI Charts framework (LineMark, AreaMark, PointAnnotation)
- Design: Obsidian panels (0A0A0F), Electric Violet (8B5CF6), dark bg (09090B)
- Session tracking: Poll telemetry every 5 seconds during active game session
- Benchmark: Snapshot system state before optimize, after optimize, compute deltas
- Process monitoring: Use NSWorkspace.shared.runningApplications to detect game launch/exit
</execution_context>

<context>
@opta-native/OptaApp/OptaApp/Models/Game.swift (Game struct, PerformanceSnapshot, GameOptimizationProfile)
@opta-native/OptaApp/OptaApp/Models/OptaViewModel.swift (telemetry fields, PageViewModel enum)
@opta-native/OptaApp/OptaApp/Views/Games/GameDetailView.swift (existing FPS chart, performance section)
@opta-native/OptaApp/OptaApp/Services/GameDetectionService.swift (game scanning, bundle paths)
@opta-native/OptaApp/OptaApp/Models/ScoreModels.swift (ScoreHistoryManager persistence pattern)
</context>

<tasks>

<task id="1" type="auto">
<title>Create Game Session Models, Session Tracker, and Benchmark Manager</title>
<description>
Define detailed session recording types, the GameSessionTracker that monitors telemetry
during gameplay, and BenchmarkManager for before/after optimization comparisons.
</description>
<files>
  - CREATE: opta-native/OptaApp/OptaApp/Models/GameSessionModels.swift
  - CREATE: opta-native/OptaApp/OptaApp/Services/GameSessionTracker.swift
  - CREATE: opta-native/OptaApp/OptaApp/Services/BenchmarkManager.swift
</files>
<action>
**GameSessionModels.swift:**

1. `TelemetrySample` struct (Codable, Identifiable):
   - `id: UUID`
   - `timestamp: Date`
   - `cpuUsage: Float` (0-100)
   - `gpuUsage: Float?` (0-100)
   - `memoryUsage: Float` (0-100)
   - `thermalState: String` (nominal/fair/serious/critical)
   - `fps: Float?` (estimated from GPU load, or nil)

2. `GameSession` struct (Codable, Identifiable):
   - `id: UUID`
   - `gameId: UUID` (links to Game)
   - `gameName: String`
   - `startTime: Date`
   - `endTime: Date?`
   - `samples: [TelemetrySample]` (recorded every 5 seconds)
   - `optimizedBefore: Bool` (was game optimized before this session?)
   - `var duration: TimeInterval` (computed from start/end)
   - `var avgCpu: Float` (computed average)
   - `var avgGpu: Float?` (computed average)
   - `var avgMemory: Float` (computed average)
   - `var peakCpu: Float` (computed max)
   - `var peakGpu: Float?` (computed max)
   - `var peakMemory: Float` (computed max)
   - `var thermalEvents: Int` (count of non-nominal thermal samples)
   - `var formattedDuration: String` (Xh Ym format)

3. `BenchmarkResult` struct (Codable, Identifiable):
   - `id: UUID`
   - `gameId: UUID`
   - `gameName: String`
   - `date: Date`
   - `beforeState: BenchmarkSnapshot`
   - `afterState: BenchmarkSnapshot`
   - `var cpuImprovement: Float` (before.cpu - after.cpu, positive = better)
   - `var memoryImprovement: Float`
   - `var thermalImproved: Bool`
   - `var overallImprovement: Float` (weighted average of improvements)

4. `BenchmarkSnapshot` struct (Codable):
   - `cpuUsage: Float`
   - `gpuUsage: Float?`
   - `memoryUsage: Float`
   - `thermalState: String`
   - `processCount: Int`
   - `timestamp: Date`

**GameSessionTracker.swift:**

`@Observable class GameSessionTracker`:
- `static let shared = GameSessionTracker()`
- Properties:
  - `var sessions: [GameSession]` (all recorded sessions)
  - `var activeSession: GameSession?` (currently recording)
  - `var isTracking: Bool` (whether monitoring is active)
  - `var trackedGameBundleIds: Set<String>` (games to watch for)
  - `private var timer: Timer?`
  - `private var processCheckTimer: Timer?`

- Methods:
  - `func startMonitoring(games: [Game])` - Begin watching for game launches
    - Stores bundle IDs from games list
    - Starts processCheckTimer (every 10 seconds, checks NSWorkspace.shared.runningApplications)
    - When a tracked game is detected running → startSession(for: game)
  - `func stopMonitoring()` - Stop watching, end any active session
  - `private func startSession(for game: Game)` - Create new GameSession, start telemetry timer
    - Timer fires every 5 seconds, records TelemetrySample from current telemetry
    - Gets telemetry from OptaViewModel: cpuUsage, gpuUsage, memoryUsage, thermalState
  - `private func endSession()` - Stop timer, set endTime, append to sessions, save
  - `private func recordSample()` - Read current telemetry, append TelemetrySample
  - `func sessionsForGame(_ gameId: UUID) -> [GameSession]` - Filter sessions by game
  - `func recentSessions(limit: Int = 10) -> [GameSession]` - Latest sessions across all games
  - `func load()` / `func save()` - JSON persistence
  - Storage: `~/Library/Application Support/OptaApp/game-sessions.json`
  - Max 50 sessions stored (trim oldest)

**BenchmarkManager.swift:**

`@Observable class BenchmarkManager`:
- `static let shared = BenchmarkManager()`
- Properties:
  - `var results: [BenchmarkResult]` (all benchmark results)
  - `var pendingBenchmark: BenchmarkSnapshot?` (before-state waiting for after)
  - `var isBenchmarking: Bool`

- Methods:
  - `func startBenchmark(for game: Game)` - Capture before-state snapshot
    - Record current CPU, GPU, memory, thermal, process count
    - Set isBenchmarking = true
  - `func completeBenchmark(for game: Game)` - Capture after-state, compute result
    - Record current state as afterState
    - Create BenchmarkResult with deltas
    - Append to results, save
    - Set isBenchmarking = false
  - `func cancelBenchmark()` - Clear pending state
  - `func resultsForGame(_ gameId: UUID) -> [BenchmarkResult]` - Filter by game
  - `func latestResult(for gameId: UUID) -> BenchmarkResult?` - Most recent
  - `func averageImprovement(for gameId: UUID) -> Float?` - Mean improvement across all benchmarks
  - `func load()` / `func save()` - JSON persistence
  - Storage: `~/Library/Application Support/OptaApp/benchmarks.json`
  - Max 100 results stored
</action>
<verify>
Files compile. GameSessionTracker can start/stop monitoring.
BenchmarkManager can capture before/after snapshots.
Sessions and benchmarks persist to JSON.
</verify>
<done>GameSessionModels.swift, GameSessionTracker.swift, and BenchmarkManager.swift created with all types and persistence.</done>
</task>

<task id="2" type="auto">
<title>Create Game Session Detail View and Benchmark Comparison Card</title>
<description>
Build the session timeline view showing telemetry over time during a game session,
and the benchmark comparison card showing before/after optimization deltas.
</description>
<files>
  - CREATE: opta-native/OptaApp/OptaApp/Views/Games/GameSessionDetailView.swift
  - CREATE: opta-native/OptaApp/OptaApp/Views/Games/BenchmarkComparisonCard.swift
</files>
<action>
**GameSessionDetailView.swift:**
Detailed view of a single game session with timeline:
- Header: Game name + session date + duration badge
- Summary Row: Avg CPU, Avg GPU, Avg Memory, Thermal Events (4 stat cards)
- Timeline Chart (main feature): SwiftUI Charts with multi-series:
  - `import Charts`
  - X-axis: time offset from session start (seconds/minutes)
  - Y-axis: percentage (0-100)
  - LineMark series: CPU (violet), GPU (blue), Memory (green)
  - Each series uses `foregroundStyle(by: .value("Metric", name))`
  - PointAnnotation for thermal events (red dots on thermal state changes)
  - Chart height: 200pt
  - Vertical rule annotation at hover/tap position showing exact values
  - Time range: full session duration
  - Dark themed axes (.white.opacity(0.3))
- Peak Values Section: Cards showing peak CPU, GPU, Memory with timestamps
- Session Info: Start time, end time, optimized status, sample count
- Background: Color(hex: "09090B")
- @Environment(\.dismiss) for back navigation
- Takes `session: GameSession` as init parameter

**BenchmarkComparisonCard.swift:**
Before/after comparison card for embedding in GameDetailView:
- Card layout: Obsidian panel (Color(hex: "0A0A0F")), rounded corners, violet border
- Header: "Benchmark Results" + date
- Two-column layout: "Before" | "After" with colored indicators
- Metrics rows:
  - CPU Usage: before% → after% with delta (green if improved, red if worse)
  - GPU Usage: before% → after% with delta
  - Memory Usage: before% → after% with delta
  - Thermal: state name with colored dot
  - Processes: count with delta
- Overall Improvement: large percentage with arrow indicator
  - Green upward arrow + positive %: improvement
  - Red downward arrow + negative %: regression
- Animated reveal: metrics slide in from left/right on appear
- "Run Benchmark" button if no pending result (triggers startBenchmark flow)
- Takes `result: BenchmarkResult?` and game binding
- Uses BenchmarkManager.shared for actions
</action>
<verify>
Files compile. GameSessionDetailView renders timeline chart with sample data.
BenchmarkComparisonCard shows before/after with correct delta colors.
</verify>
<done>GameSessionDetailView.swift and BenchmarkComparisonCard.swift created with timeline charts and comparison UI.</done>
</task>

<task id="3" type="auto">
<title>Integrate Session Tracking into GameDetailView, Wire Navigation, Register Files</title>
<description>
Enhance the existing GameDetailView with session list, benchmark card, and session tracking
toggle. Start monitoring on game library load. Register all new files in Xcode project.
</description>
<files>
  - MODIFY: opta-native/OptaApp/OptaApp/Views/Games/GameDetailView.swift
  - MODIFY: opta-native/OptaApp/OptaApp/Views/Games/GamesLibraryView.swift
  - MODIFY: opta-native/OptaApp/OptaApp.xcodeproj/project.pbxproj
</files>
<action>
**GameDetailView.swift modifications:**

1. Add new sections AFTER the existing Performance History section:

   a. **Benchmark Section** (after optimization section):
      ```swift
      // Benchmark Comparison
      if let result = BenchmarkManager.shared.latestResult(for: game.id) {
          BenchmarkComparisonCard(result: result, game: $game)
      } else {
          BenchmarkComparisonCard(result: nil, game: $game)
      }
      ```

   b. **Session History Section** (after performance history):
      - Header: "Game Sessions" + session count badge
      - List of recent sessions (last 5) as tappable rows:
        - Each row: date + duration + avg CPU/GPU mini-stats
        - Tap navigates to GameSessionDetailView via sheet
      - "View All Sessions" button if > 5 sessions
      - Empty state: "No sessions recorded yet. Play with tracking enabled."

   c. **Session Tracking Toggle**:
      - In the Quick Actions section, add:
        ```swift
        Toggle("Track Sessions", isOn: trackingBinding)
        ```
      - Binding: starts/stops GameSessionTracker monitoring for this game

2. Add benchmark flow to "Optimize Now" button:
   - Before optimization: `BenchmarkManager.shared.startBenchmark(for: game)`
   - After optimization completes: `BenchmarkManager.shared.completeBenchmark(for: game)`

3. Add @State for session detail sheet:
   ```swift
   @State private var selectedSession: GameSession?
   @State private var showSessionDetail: Bool = false
   ```

4. Add sheet modifier:
   ```swift
   .sheet(isPresented: $showSessionDetail) {
       if let session = selectedSession {
           GameSessionDetailView(session: session)
       }
   }
   ```

**GamesLibraryView.swift modifications:**

1. On appear, start session monitoring with detected games:
   ```swift
   .onAppear {
       // After games are loaded, enable session tracking
       GameSessionTracker.shared.startMonitoring(games: games)
   }
   .onDisappear {
       GameSessionTracker.shared.stopMonitoring()
   }
   ```

2. After successful scan, update tracker:
   ```swift
   // In scanForGames() completion:
   GameSessionTracker.shared.startMonitoring(games: games)
   ```

**project.pbxproj:**
- Add GameSessionModels.swift to Models group
- Add GameSessionTracker.swift to Services group
- Add BenchmarkManager.swift to Services group
- Add GameSessionDetailView.swift to Views/Games group
- Add BenchmarkComparisonCard.swift to Views/Games group
- PBXBuildFile, PBXFileReference, PBXGroup entries with unique IDs
- Add to PBXSourcesBuildPhase

Verify build: `xcodebuild -project opta-native/OptaApp/OptaApp.xcodeproj -scheme OptaApp build`
</action>
<verify>
Build passes. GameDetailView shows benchmark card and session list.
Session tracking starts when games library is loaded.
Tapping a session row shows GameSessionDetailView with timeline chart.
Optimize button triggers benchmark before/after flow.
</verify>
<done>GameDetailView enhanced with sessions and benchmarks. Tracking wired. All files in Xcode. Build passes.</done>
</task>

</tasks>

<verification>
1. Build passes: `xcodebuild -project opta-native/OptaApp/OptaApp.xcodeproj -scheme OptaApp build`
2. GameSessionTracker detects game launches and records telemetry samples
3. BenchmarkManager captures before/after optimization snapshots
4. GameDetailView shows benchmark comparison card with deltas
5. GameDetailView shows session history list with tappable rows
6. GameSessionDetailView shows multi-series timeline chart (CPU, GPU, Memory)
7. Session data persists to game-sessions.json across app restarts
8. Benchmark results persist to benchmarks.json across app restarts
9. Optimize button triggers benchmark flow (before/after capture)
</verification>

<success_criteria>
- [ ] GameSessionModels.swift with TelemetrySample, GameSession, BenchmarkResult, BenchmarkSnapshot
- [ ] GameSessionTracker.swift with process monitoring, telemetry recording, JSON persistence
- [ ] BenchmarkManager.swift with before/after capture, delta computation, JSON persistence
- [ ] GameSessionDetailView.swift with multi-series timeline chart and peak values
- [ ] BenchmarkComparisonCard.swift with before/after comparison and delta indicators
- [ ] GameDetailView enhanced with benchmark section, session list, tracking toggle
- [ ] GamesLibraryView starts session monitoring on appear
- [ ] All files registered in Xcode project
- [ ] Build passes
</success_criteria>

<output>
SUMMARY.md documenting:
- Files created and session tracking architecture
- Benchmark flow (before → optimize → after → compare)
- Telemetry sampling approach (5-second intervals)
- Process detection strategy (NSWorkspace polling)
- Persistence paths and data limits
- Build verification results
</output>
