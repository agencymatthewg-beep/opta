# Opta Local iOS — Architecture

> System design for the SwiftUI iOS client.

---

## Overview

A native SwiftUI iOS app that connects directly to Opta LMX servers via HTTP/SSE. Uses Bonjour for zero-config LAN discovery and Cloudflare Tunnel for WAN access. Single-user, no backend beyond LMX.

## Tech Stack

| Layer | Technology | Why |
|-------|-----------|-----|
| UI | SwiftUI (iOS 17+) | Native performance, Opta design system compatibility |
| State | Observation framework | Modern, efficient, replaces ObservableObject |
| Networking | URLSession async/await | Built-in, no dependencies, streaming support |
| Discovery | Network framework (NWBrowser) | Native Bonjour/mDNS support |
| Storage | SwiftData | Local session cache, connection history |
| Credentials | Keychain Services | Secure admin key storage |
| Camera | AVFoundation | QR code scanning for tunnel pairing |

## Components

### Bonjour Discovery Service
**Purpose:** Auto-discover LMX servers on local network via mDNS
**Owns:** Network browser, discovered server list, connection candidates
**Communicates with:** Connection Manager (provides discovered servers)

### Connection Manager
**Purpose:** Manage active server connection, handle LAN/WAN switching
**Owns:** Active connection, auth credentials, connection state
**Communicates with:** All services (provides authenticated URLSession)

### SSE Engine
**Purpose:** Subscribe to server events stream, parse and dispatch updates
**Owns:** EventSource connection, reconnection logic, event parsing
**Communicates with:** Dashboard ViewModel (metric updates)

### Chat Engine
**Purpose:** Manage streaming chat completions via OpenAI-compatible API
**Owns:** Message buffer, streaming state, model selection
**Communicates with:** Connection Manager (API calls), Session Store (persistence)

### Session Store
**Purpose:** Cache sessions locally, sync with LMX Session API
**Owns:** SwiftData model container, session list, search index
**Communicates with:** Chat Engine (session data), Connection Manager (API sync)

## Data Flow

```
iPhone
  ├── NWBrowser (Bonjour)
  │     └── Discovers _opta-lmx._tcp services on LAN
  │
  ├── URLSession.bytes → /admin/events (SSE)
  │     └── AsyncStream feeds DashboardViewModel
  │
  ├── URLSession (stream) → /v1/chat/completions
  │     └── AsyncStream feeds ChatViewModel token-by-token
  │
  ├── URLSession → /admin/models/*
  │     └── Model management actions
  │
  └── AVCaptureSession → QR code
        └── Captures tunnel URL + auth token
```

## Key Abstractions

### `LMXClientProtocol`

```swift
protocol LMXClientProtocol: Sendable {
    func chatStream(_ params: ChatParams) -> AsyncThrowingStream<String, Error>
    func getStatus() async throws -> ServerStatus
    func subscribeEvents() -> AsyncThrowingStream<ServerEvent, Error>
    func listModels() async throws -> [Model]
    func loadModel(_ id: String) async throws
    func unloadModel(_ id: String) async throws
}
```

### `ConnectionConfig`

```swift
struct ConnectionConfig: Codable, Identifiable {
    let id: UUID
    var name: String
    var type: ConnectionType   // .lan or .wan
    var host: String
    var port: Int
    var isActive: Bool

    enum ConnectionType: String, Codable {
        case lan, wan
    }
}
```

## Performance Constraints

- App launch to dashboard: <2 seconds (including connection)
- Bonjour discovery: <1 second on same subnet
- Memory budget: <100MB during active chat
- Background SSE: Suspended when app backgrounded (battery preservation)

---

*Generated by OPIS v2.0 — 2026-02-18*
