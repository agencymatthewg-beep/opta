# Opta Local iOS — CLAUDE.md

> Coding rules for the SwiftUI iOS client. Read APP.md and SHARED.md first.

---

## Stack

- **Framework:** SwiftUI (iOS 17+)
- **Concurrency:** Swift strict concurrency (async/await, Sendable)
- **State:** Observation framework (`@Observable`)
- **Networking:** URLSession with async/await
- **Storage:** SwiftData for sessions, Keychain for credentials
- **Build:** Xcode 16+

## Mandatory Rules

### UI/UX

- **ALL UI work MUST use the `/frontend-design` skill** — invoke before any view creation
- **Colors:** Opta semantic colors from asset catalog — never hex literals
  - Background: OLED-optimized `#09090b`
  - Primary: Violet `#8b5cf6`
  - Success: `#22c55e` / Warning: `#f59e0b` / Error: `#ef4444`
- **Icons:** SF Symbols only — no custom icon assets
- **Animations:** SwiftUI spring physics only — `.optaSpring` modifier
  - Standard: `.spring(response: 0.35, dampingFraction: 0.8)`
- **Glass effects:** `.ultraThinMaterial` + `RoundedRectangle(cornerRadius: 16)`
- **Haptics:** `OptaHaptics.shared` for all tactile feedback
- **Typography:** SF Pro (system default), `.sora` if custom font bundled

### Code

- Swift strict concurrency — all `@Observable` classes must be `@MainActor`
- No force unwraps (`!`) — use `guard let` or `if let`
- No `AnyView` — use `@ViewBuilder` and concrete types
- Protocol-oriented design — depend on protocols, not concrete types
- All network calls through `LMXClient` protocol
- Error handling: `Result` type or structured `throws`

### Networking

- `URLSession` for HTTP requests — no Alamofire or third-party HTTP
- SSE via custom `AsyncStream` over `URLSession.bytes`
- Admin key passed as `X-Admin-Key` header
- Always handle offline state gracefully
- Bonjour via `NWBrowser` (Network framework)

### Performance

- App launch to dashboard: <2 seconds
- Bonjour discovery: <1 second on same subnet
- Streaming chat: first token display <200ms after send
- No blocking main thread — all I/O is async

## File Structure

```
OptaLocal/
├── OptaLocalApp.swift           # App entry point, tab navigation
├── Models/
│   ├── ServerStatus.swift       # Codable server status types
│   ├── ChatMessage.swift        # Message model
│   ├── Session.swift            # Session model
│   └── ConnectionConfig.swift   # Server connection configuration
├── Services/
│   ├── LMXClient.swift          # Protocol + implementation
│   ├── SSEClient.swift          # Server-Sent Events async stream
│   ├── BonjourDiscovery.swift   # NWBrowser-based discovery
│   └── KeychainManager.swift    # Secure credential storage
├── ViewModels/
│   ├── DashboardViewModel.swift # Observable dashboard state
│   ├── ChatViewModel.swift      # Chat state and streaming
│   └── ConnectionViewModel.swift # Connection management
├── Views/
│   ├── Dashboard/
│   │   ├── DashboardView.swift
│   │   ├── VRAMGaugeView.swift
│   │   └── ModelListView.swift
│   ├── Chat/
│   │   ├── ChatView.swift
│   │   ├── MessageBubble.swift
│   │   └── StreamingIndicator.swift
│   ├── Discovery/
│   │   ├── DiscoveryView.swift
│   │   └── QRScannerView.swift
│   ├── Sessions/
│   │   └── SessionListView.swift
│   └── Settings/
│       └── SettingsView.swift
└── Utilities/
    ├── OptaHaptics.swift        # Haptic feedback patterns
    └── Extensions/              # SwiftUI view modifiers
```

## Patterns

### Observable ViewModel

```swift
@Observable @MainActor
final class DashboardViewModel {
    var status: ServerStatus?
    var isConnected = false

    func startMonitoring() async {
        // SSE subscription
    }
}
```

### Bonjour Discovery

```swift
let browser = NWBrowser(for: .bonjour(type: "_opta-lmx._tcp", domain: nil), using: .tcp)
// Discover LMX servers on local network
```

### Error Handling

```swift
enum LMXError: LocalizedError {
    case connectionFailed(String)
    case unauthorized
    case serverUnavailable
}
```

## Don'ts

- Don't use UIKit unless absolutely necessary (prefer SwiftUI)
- Don't use Combine — prefer async/await and Observation
- Don't use Alamofire or any third-party HTTP library
- Don't store admin keys in UserDefaults — Keychain only
- Don't use `.task` without cancellation handling
- Don't create views without invoking `/frontend-design` first

---

*Generated by OPIS v2.0 — 2026-02-18*
