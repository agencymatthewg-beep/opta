# Opta Local Web — CLAUDE.md

> Coding rules for the Next.js 16 web client. Read APP.md and SHARED.md first.

---

## Stack

- **Framework:** Next.js 16 (App Router)
- **UI:** React 19 + @opta/ui + Tailwind CSS
- **State:** React 19 `use()` + Context where needed
- **Animation:** Framer Motion only (no CSS transitions for interactive elements)
- **Icons:** Lucide React only
- **HTTP:** Native `fetch` with streaming support
- **Build:** `next build` → static export

## Mandatory Rules

### UI/UX

- **ALL UI work MUST use the `/frontend-design` skill** — invoke before any component creation
- **Glass panels:** Use `@opta/ui` `GlassPanel` component or `.glass` CSS class
- **Colors:** CSS variables only — never hex/rgb literals. See SHARED.md design tokens.
- **Typography:** Sora font family. Headings: 600-700 weight.
- **Conditional classes:** `cn()` helper from `@opta/ui` (clsx + tailwind-merge)
- **Dark mode only** — no light theme. OLED-optimized `#09090b` background.
- **Responsive:** Desktop-first, collapse to single-column at `md` breakpoint

### Code

- TypeScript strict mode (`strict: true`, `noUncheckedIndexedAccess: true`)
- ESLint + Prettier enforced
- Server Components by default, `'use client'` only when needed (state, effects, browser APIs)
- No `any` types — use `unknown` + type narrowing
- API calls wrapped in custom hooks (`useServerStatus`, `useChatStream`, etc.)
- Error boundaries around every page-level component

### Streaming

- Chat streaming via `fetch` + `ReadableStream` (not SSE for chat)
- Dashboard metrics via `EventSource` (SSE)
- Always show streaming indicator during token generation
- Handle connection drops gracefully with auto-reconnect

### Performance

- First Contentful Paint <1.5s
- SSE connection within 500ms of dashboard mount
- No layout shift during streaming token append
- Lazy-load non-critical routes (models, sessions, settings)

## File Structure

```
src/
├── app/
│   ├── layout.tsx           # Root layout with glass background
│   ├── page.tsx             # Dashboard (default route)
│   ├── chat/
│   │   ├── page.tsx         # New chat
│   │   └── [id]/page.tsx    # Resume session
│   ├── models/page.tsx      # Model library
│   ├── sessions/page.tsx    # Session history
│   └── settings/
│       ├── page.tsx         # General settings
│       └── tunnel/page.tsx  # Tunnel configuration
├── components/
│   ├── dashboard/           # Dashboard-specific components
│   ├── chat/                # Chat-specific components
│   ├── models/              # Model management components
│   └── shared/              # Shared UI components
├── hooks/
│   ├── useServerStatus.ts   # SSE subscription to /admin/events
│   ├── useChatStream.ts     # Streaming chat completion
│   ├── useConnection.ts     # Connection manager (LAN/WAN)
│   └── useModels.ts         # Model listing and management
├── lib/
│   ├── lmx-client.ts        # Opta LMX API client
│   ├── sse.ts               # SSE helper with reconnect
│   └── storage.ts           # Local storage helpers
└── types/
    └── lmx.ts               # Shared LMX API types
```

## Patterns

### API Client

```typescript
// Always use the connection manager's base URL
const response = await lmxClient.chat({
  model: selectedModel,
  messages,
  stream: true,
});
```

### SSE Subscription

```typescript
// Auto-reconnect on disconnect
const { status, disconnect } = useServerStatus({
  onStatus: (data) => setMetrics(data),
  reconnectInterval: 3000,
});
```

### Error Handling

- Network errors: Show connection status indicator, auto-retry
- API errors: Toast notification with error message
- Auth errors: Redirect to settings to re-enter admin key

## Don'ts

- Don't use `axios` — native `fetch` only
- Don't use CSS-in-JS — Tailwind + CSS variables only
- Don't import from `@opta/ui` without checking component exists first
- Don't store admin keys in plain localStorage — use `crypto.subtle` encryption
- Don't poll when SSE is available

---

*Generated by OPIS v2.0 — 2026-02-18*
