---
phase: 05-web-sessions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - 1-Apps/1J-Opta-LMX/src/opta_lmx/sessions/__init__.py
  - 1-Apps/1J-Opta-LMX/src/opta_lmx/sessions/store.py
  - 1-Apps/1J-Opta-LMX/src/opta_lmx/sessions/models.py
  - 1-Apps/1J-Opta-LMX/src/opta_lmx/api/sessions.py
  - 1-Apps/1J-Opta-LMX/src/opta_lmx/main.py
autonomous: true
---

<objective>
Add session CRUD endpoints to the LMX server so the web client can browse and resume CLI sessions.

Purpose: LMX currently has ZERO session endpoints. CLI stores sessions as JSON files on Mac Studio at ~/.config/opta/sessions/. LMX runs on the same machine and can read these files. This plan adds the server-side session API that the web client needs.
Output: /admin/sessions (list), /admin/sessions/:id (get/delete), /admin/sessions/search (search) endpoints in LMX.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-web-sessions/05-RESEARCH.md

# LMX server structure:
@1-Apps/1J-Opta-LMX/src/opta_lmx/main.py
@1-Apps/1J-Opta-LMX/src/opta_lmx/api/deps.py
@1-Apps/1J-Opta-LMX/src/opta_lmx/config.py

# CLI session format (source of truth):
# See 05-RESEARCH.md Pattern 2 for CLI Session schema
# Sessions stored at ~/.config/opta/sessions/<id>.json with index.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SessionStore class that reads CLI session files</name>
  <files>
    1-Apps/1J-Opta-LMX/src/opta_lmx/sessions/__init__.py,
    1-Apps/1J-Opta-LMX/src/opta_lmx/sessions/store.py,
    1-Apps/1J-Opta-LMX/src/opta_lmx/sessions/models.py
  </files>
  <action>
    1. Create `sessions/` package with __init__.py

    2. Create `sessions/models.py` — Pydantic models matching CLI schema:
       - SessionSummary: id, title, model, tags (list[str]), created (str), updated (str), message_count (int)
       - SessionMessage: role (str), content (str | list | None), tool_calls (list | None), tool_call_id (str | None)
       - SessionFull: id, title, model, tags, created, updated, cwd (str), messages (list[SessionMessage]), tool_call_count (int), compacted (bool)
       - SessionListResponse: sessions (list[SessionSummary]), total (int)

    3. Create `sessions/store.py` — SessionStore class:
       - Constructor: sessions_dir parameter (default: ~/.config/opta/sessions/)
       - list_sessions(limit=50, offset=0, model=None, tag=None, since=None) -> SessionListResponse:
         - Read index.json if it exists (fast path — contains title, model, tags, created, messageCount per session)
         - If no index.json, scan *.json files and read first few fields from each
         - Sort by updated/created descending
         - Support filtering by model (case-insensitive substring), tag (exact match), since (ISO date cutoff)
         - Return paginated results
       - get_session(id: str) -> SessionFull | None:
         - Read ~/.config/opta/sessions/{id}.json
         - Parse and return full session with all messages
         - Return None if not found
       - delete_session(id: str) -> bool:
         - Remove the session JSON file
         - Update index.json if it exists
         - Return True if deleted, False if not found
       - search_sessions(query: str, limit=20) -> list[SessionSummary]:
         - Search across title, model, tags, and optionally first user message
         - Simple case-insensitive substring matching (server-side search as fallback to client-side Fuse.js)
       - Handle malformed JSON files gracefully (skip with warning, don't crash)
       - Use pathlib.Path for file operations
       - IMPORTANT: Read-only access to CLI session files (except delete). Never modify message content.
  </action>
  <verify>Python type-checks (if pyright available); SessionStore can be instantiated with a test directory</verify>
  <done>SessionStore reads CLI session files, supports list/get/delete/search with pagination and filtering; Pydantic models match CLI schema</done>
</task>

<task type="auto">
  <name>Task 2: Create session API endpoints and wire into LMX router</name>
  <files>
    1-Apps/1J-Opta-LMX/src/opta_lmx/api/sessions.py,
    1-Apps/1J-Opta-LMX/src/opta_lmx/main.py
  </files>
  <action>
    1. Create `api/sessions.py` — FastAPI router:
       - GET /admin/sessions — List session summaries (paginated)
         - Query params: limit (int, default 50), offset (int, default 0), model (str, optional), tag (str, optional), since (str, optional)
         - Returns SessionListResponse
         - Requires admin key authentication (follow existing pattern from other /admin/* routes)
       - GET /admin/sessions/{session_id} — Get full session with messages
         - Returns SessionFull
         - 404 if not found
       - DELETE /admin/sessions/{session_id} — Delete a session
         - Returns { deleted: true }
         - 404 if not found
       - GET /admin/sessions/search — Search sessions
         - Query params: q (str, required), limit (int, default 20)
         - Returns list[SessionSummary]
       - IMPORTANT: The search endpoint path must come BEFORE the {session_id} path in the router to avoid "search" being interpreted as a session ID
       - All endpoints require X-Admin-Key header (use existing admin key dependency from deps.py)
       - Use response_model parameter on decorators (not union return types — see MEMORY.md lesson)

    2. Update `main.py` to:
       - Import and include the sessions router: app.include_router(sessions_router, prefix="/admin")
       - Create SessionStore instance with configurable sessions_dir (from config or default path)
       - Add SessionStore to the dependency injection (follow existing patterns from deps.py)

    3. Test with curl:
       ```bash
       curl -H "X-Admin-Key: $KEY" http://192.168.188.11:1234/admin/sessions
       curl -H "X-Admin-Key: $KEY" http://192.168.188.11:1234/admin/sessions/search?q=test
       ```
  </action>
  <verify>LMX server starts without errors after adding session routes; curl GET /admin/sessions returns JSON (even if empty list when no sessions exist)</verify>
  <done>LMX has /admin/sessions, /admin/sessions/:id, /admin/sessions/search endpoints; all require admin key auth; returns CLI session data</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] LMX server starts without import errors
- [ ] GET /admin/sessions returns valid JSON (list of session summaries or empty list)
- [ ] GET /admin/sessions/{id} returns full session or 404
- [ ] GET /admin/sessions/search?q=test returns search results
- [ ] DELETE /admin/sessions/{id} removes the session file
- [ ] All endpoints require X-Admin-Key header (401 without it)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Session API endpoints follow existing LMX patterns (admin key auth, Pydantic models)
- SessionStore handles missing/malformed files gracefully
- No modification of existing LMX functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-web-sessions/05-01-SUMMARY.md`
</output>
