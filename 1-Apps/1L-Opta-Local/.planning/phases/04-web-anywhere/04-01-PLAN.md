---
phase: 04-web-anywhere
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - 1-Apps/1L-Opta-Local/web/src/hooks/useConnection.ts
  - 1-Apps/1L-Opta-Local/web/src/lib/connection.ts
  - 1-Apps/1L-Opta-Local/web/src/app/settings/page.tsx
  - 1-Apps/1L-Opta-Local/web/src/app/settings/tunnel/page.tsx
  - 1-Apps/1L-Opta-Local/web/src/app/settings/layout.tsx
autonomous: true
---

<objective>
Implement tunnel URL configuration and LAN/WAN connection type detection.

Purpose: Enable users to configure a Cloudflare Tunnel URL and automatically detect whether they're on LAN or WAN, selecting the optimal connection path to the LMX server.
Output: Settings page for tunnel configuration, useConnection hook with state machine (lan/wan/offline), and enhanced connection.ts with health check logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-anywhere/04-RESEARCH.md

# Phase 1 connection infrastructure:
@1-Apps/1L-Opta-Local/web/src/lib/connection.ts
@1-Apps/1L-Opta-Local/web/src/lib/storage.ts
@1-Apps/1L-Opta-Local/web/src/lib/lmx-client.ts
@1-Apps/1L-Opta-Local/web/src/types/lmx.ts

# Design rules:
@1-Apps/1L-Opta-Local/web/CLAUDE.md
@1-Apps/1L-Opta-Local/web/src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance connection manager with LAN health check and state machine</name>
  <files>
    1-Apps/1L-Opta-Local/web/src/lib/connection.ts,
    1-Apps/1L-Opta-Local/web/src/hooks/useConnection.ts
  </files>
  <action>
    1. Enhance `src/lib/connection.ts`:
       - Add ConnectionType enum: 'lan' | 'wan' | 'offline'
       - Add checkLanHealth(lanUrl: string) function:
         - Uses fetch with AbortSignal.timeout(1500) to hit LMX /v1/models on LAN URL
         - Returns true if response OK within 1.5s, false on timeout/error
         - 1.5s timeout is the proven pattern â€” fast enough to not annoy, long enough for slow LAN
       - Add getOptimalBaseUrl(settings: ConnectionSettings) function:
         - If LAN health check passes: return LAN URL (type: 'lan')
         - If tunnel configured and LAN fails: return tunnel URL (type: 'wan')
         - If neither works: return null (type: 'offline')
       - ConnectionSettings interface should already have useTunnel flag and tunnelUrl field from Phase 1; verify and add if missing

    2. Create `src/hooks/useConnection.ts` ('use client'):
       - State machine with 3 states: 'lan' | 'wan' | 'offline'
       - On mount: run LAN health check
       - If LAN up: set 'lan', use LAN URL
       - If LAN down + tunnel configured: try tunnel URL, set 'wan' if reachable
       - If nothing reachable: set 'offline'
       - Periodic LAN re-check every 30 seconds when in 'wan' mode (auto-upgrade back to LAN when it comes back)
       - No re-check when in 'lan' mode (already optimal)
       - Expose: { connectionType, baseUrl, isConnected, latencyMs, recheckNow }
       - Measure latency from health check response time
       - Use navigator.onLine as a quick pre-check before probing (skip probe if browser says offline)
  </action>
  <verify>pnpm run build passes; useConnection hook compiles without TypeScript errors</verify>
  <done>Connection manager detects LAN vs WAN via health check with 1.5s timeout; useConnection provides reactive connection state with auto-failover</done>
</task>

<task type="auto">
  <name>Task 2: Create tunnel settings page</name>
  <files>
    1-Apps/1L-Opta-Local/web/src/app/settings/page.tsx,
    1-Apps/1L-Opta-Local/web/src/app/settings/tunnel/page.tsx,
    1-Apps/1L-Opta-Local/web/src/app/settings/layout.tsx
  </files>
  <action>
    1. Create `src/app/settings/layout.tsx`:
       - Settings shell with sidebar navigation (glass-subtle panel)
       - Links: General, Tunnel, (future: Appearance)
       - Lucide icons: Settings (general), Globe (tunnel)
       - Desktop: sidebar + content area; Mobile: stack

    2. Create `src/app/settings/page.tsx`:
       - General settings: LMX host/port configuration
       - Admin key input (password type, stored encrypted via existing storage.ts)
       - "Test Connection" button that runs health check and shows result
       - Current connection status display

    3. Create `src/app/settings/tunnel/page.tsx`:
       - Tunnel URL input (e.g., "https://lmx.optamize.biz")
       - Enable/disable tunnel toggle
       - "Test Tunnel" button that probes the tunnel URL
       - Explanation text: when to use tunnels (accessing LMX from outside home network)
       - Save button that persists to ConnectionSettings via existing connection.ts
       - Show current connection type (LAN/WAN/Offline) after test
       - All UI: glass panels, Opta design system, cn() for classes
  </action>
  <verify>pnpm run build passes; /settings page renders with sidebar; /settings/tunnel page shows tunnel configuration form</verify>
  <done>Settings pages created with LMX connection config, admin key management, and tunnel URL configuration; test connection buttons verify reachability</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd 1-Apps/1L-Opta-Local/web && pnpm run build` succeeds without errors
- [ ] /settings page renders with general settings
- [ ] /settings/tunnel page renders with tunnel configuration
- [ ] useConnection hook detects LAN (when Mac Studio reachable) or offline (when not)
- [ ] Connection settings persist across page refresh
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- LAN health check works with 1.5s timeout
- Tunnel URL is configurable and persisted
- Settings pages follow Opta glass design system
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-anywhere/04-01-SUMMARY.md`
</output>
