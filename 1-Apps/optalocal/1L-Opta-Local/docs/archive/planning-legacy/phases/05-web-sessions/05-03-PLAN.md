---
phase: 05-web-sessions
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - 1-Apps/1L-Opta-Local/web/src/lib/session-mapper.ts
  - 1-Apps/1L-Opta-Local/web/src/hooks/useSessionResume.ts
  - 1-Apps/1L-Opta-Local/web/src/components/chat/ToolCallBlock.tsx
  - 1-Apps/1L-Opta-Local/web/src/app/chat/[id]/page.tsx
autonomous: true
status: review
---

<objective>
Enable resuming CLI sessions in the browser — load message history and continue chatting.

Purpose: Complete the CLI-to-Web continuity story: a user starts a conversation in the terminal, then continues it from their phone or laptop browser.
Output: /chat/[id] dynamic page that loads a CLI session's full history and enables continued chat with the same model.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-web-sessions/05-RESEARCH.md
@.planning/phases/05-web-sessions/05-02-SUMMARY.md

# Chat UI from Phase 2:
@1-Apps/1L-Opta-Local/web/src/components/chat/ChatContainer.tsx
@1-Apps/1L-Opta-Local/web/src/components/chat/ChatMessage.tsx
@1-Apps/1L-Opta-Local/web/src/hooks/useChatStream.ts

# Types:
@1-Apps/1L-Opta-Local/web/src/types/lmx.ts

# Design rules:
@1-Apps/1L-Opta-Local/web/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session message mapper and resume hook</name>
  <files>
    1-Apps/1L-Opta-Local/web/src/lib/session-mapper.ts,
    1-Apps/1L-Opta-Local/web/src/hooks/useSessionResume.ts
  </files>
  <action>
    1. Create `src/lib/session-mapper.ts`:
       - mapSessionToChat(session: SessionFull) -> ChatMessage[]:
         - Converts CLI's SessionMessage[] to Web's ChatMessage[]
         - Skip 'system' role messages (don't display system prompts)
         - For content that is string: use directly
         - For content that is ContentPart[]: extract text parts, join with newline
         - For content that is null: use empty string
         - For 'tool' role messages: create a special ChatMessage with metadata for rendering as tool call blocks
         - For assistant messages with tool_calls: attach tool_calls metadata for display
         - Generate stable IDs from session ID + message index (not random — must be stable across renders)
         - Set created_at from session.created for all messages (CLI doesn't track per-message timestamps)
         - Set model from session.model on assistant messages

    2. Create `src/hooks/useSessionResume.ts` ('use client'):
       - Uses SWR to fetch full session from LMXClient.getSession(id)
       - Maps session messages to ChatMessage[] via session-mapper
       - Provides resume flow:
         a. Fetch session by ID
         b. Map messages
         c. Set as initial messages in useChatStream
         d. Set model from session.model
         e. Scroll to bottom of message history
       - Handle session not found (404 from LMX)
       - Return { session, messages, isLoading, error, model }
  </action>
  <verify>pnpm run build passes; session-mapper handles all ContentPart variants without TypeScript errors</verify>
  <done>Session mapper converts CLI AgentMessage to Web ChatMessage; useSessionResume fetches and hydrates session data</done>
</task>

<task type="auto">
  <name>Task 2: Create tool call display and /chat/[id] resume page</name>
  <files>
    1-Apps/1L-Opta-Local/web/src/components/chat/ToolCallBlock.tsx,
    1-Apps/1L-Opta-Local/web/src/app/chat/[id]/page.tsx
  </files>
  <action>
    1. Create `src/components/chat/ToolCallBlock.tsx` ('use client'):
       - Displays tool call information from CLI sessions as collapsible blocks
       - Props: { toolCalls: ToolCall[], toolResult?: string }
       - Collapsed state: "Used tool: {function.name}" with chevron
       - Expanded state: shows function arguments (JSON formatted) and result
       - Glass-subtle background, monospace font for arguments
       - Framer Motion for expand/collapse animation
       - Lucide icons: Wrench (tool), ChevronDown/ChevronUp (expand/collapse)
       - This is read-only display of historical tool usage — users cannot invoke tools from web

    2. Create `src/app/chat/[id]/page.tsx` ('use client'):
       - Dynamic route that loads and displays a CLI session
       - Use useSessionResume hook with the [id] param
       - Reuse ChatContainer from Phase 2 but pre-populate with session messages
       - Show session metadata header: title, model, created date, message count
       - After loading history, user can continue chatting (new messages append to the loaded history)
       - New messages use the session's original model by default (changeable via ModelPicker)
       - Loading state: glass skeleton with loading spinner
       - Error state (session not found): friendly message with link back to /sessions
       - Handle edge cases:
         - Very long sessions: virtual scroll should handle this (messages are in a scrollable container)
         - Sessions with tool calls: render ToolCallBlock components inline
         - Compacted sessions (compacted: true): show info badge that some messages were compacted
  </action>
  <verify>pnpm run build passes; /chat/[id] page compiles; navigating from /sessions to a session ID loads the page</verify>
  <done>CLI sessions can be loaded and continued in the browser; tool calls display as collapsible blocks; session resume preserves full conversation history</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd 1-Apps/1L-Opta-Local/web && pnpm run build` succeeds without errors
- [ ] /chat/[id] page renders with session history
- [ ] Session messages display correctly (user, assistant, tool calls)
- [ ] Tool call blocks are collapsible
- [ ] User can continue chatting after loading session history
- [ ] 404 session shows friendly error
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Full CLI-to-Web session continuity works end-to-end
- Tool calls from CLI render as readable, collapsible blocks
- User can seamlessly continue a CLI conversation in the browser
- Session resume page follows Opta glass design system
</success_criteria>

<output>
After completion, create `.planning/phases/05-web-sessions/05-03-SUMMARY.md`
</output>
