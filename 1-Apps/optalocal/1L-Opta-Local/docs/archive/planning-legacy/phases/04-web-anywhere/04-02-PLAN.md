---
phase: 04-web-anywhere
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - 1-Apps/1L-Opta-Local/web/src/components/shared/ConnectionBadge.tsx
  - 1-Apps/1L-Opta-Local/web/src/app/layout.tsx
  - 1-Apps/1L-Opta-Local/web/src/app/page.tsx
  - 1-Apps/1L-Opta-Local/web/src/hooks/useConnection.ts
autonomous: true
status: review
---

<objective>
Implement auto-failover logic and visual connection status indicators across the app.

Purpose: Make the connection type visible to users everywhere in the app, and implement the full LAN→WAN→Offline failover strategy with automatic LAN re-check when on WAN.
Output: Global ConnectionBadge in the layout header showing LAN (green) / WAN (amber) / Offline (red), and auto-failover integrated into all LMX-connecting hooks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-anywhere/04-RESEARCH.md
@.planning/phases/04-web-anywhere/04-01-SUMMARY.md

# Source files from Plan 04-01:
@1-Apps/1L-Opta-Local/web/src/hooks/useConnection.ts
@1-Apps/1L-Opta-Local/web/src/lib/connection.ts
@1-Apps/1L-Opta-Local/web/src/app/layout.tsx
@1-Apps/1L-Opta-Local/web/src/app/page.tsx

# Design rules:
@1-Apps/1L-Opta-Local/web/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConnectionBadge and integrate into layout</name>
  <files>
    1-Apps/1L-Opta-Local/web/src/components/shared/ConnectionBadge.tsx,
    1-Apps/1L-Opta-Local/web/src/app/layout.tsx
  </files>
  <action>
    1. Create `src/components/shared/ConnectionBadge.tsx` ('use client'):
       - Props: { type: 'lan' | 'wan' | 'offline', latencyMs?: number }
       - Visual states:
         - LAN: emerald dot + "LAN" text + latency (e.g., "12ms") — fast/local
         - WAN: amber dot + "WAN" text + latency (e.g., "85ms") — tunnel/slower
         - Offline: red dot + "Offline" text — no connection
       - Animated dot: Framer Motion pulse for connecting, solid for established
       - Compact pill shape: glass-subtle background, small text
       - Click to expand: show full connection details (host, port, tunnel URL, latency)
       - Lucide icons: Wifi (LAN), Globe (WAN), WifiOff (Offline)
       - @radix-ui/react-tooltip for hover details (already installed from Phase 2)

    2. Update `src/app/layout.tsx`:
       - Add a thin global header bar at the top with:
         - "Opta Local" branding (left)
         - Navigation links: Dashboard (/), Chat (/chat), Sessions (/sessions), Settings (/settings) — Lucide icons
         - ConnectionBadge (right)
       - Header uses glass-subtle background
       - ConnectionBadge consumes useConnection hook for live state
       - Wrap children in a ConnectionProvider context that makes connection state available globally
       - Ensure the header is fixed/sticky so it's always visible during scroll
  </action>
  <verify>pnpm run build passes; layout shows global header with ConnectionBadge; navigation links work</verify>
  <done>Global header with navigation and ConnectionBadge showing LAN/WAN/Offline state; connection context available to all pages</done>
</task>

<task type="auto">
  <name>Task 2: Wire dashboard and chat to use connection-aware LMXClient</name>
  <files>
    1-Apps/1L-Opta-Local/web/src/app/page.tsx,
    1-Apps/1L-Opta-Local/web/src/hooks/useConnection.ts
  </files>
  <action>
    1. Enhance useConnection hook:
       - Add createConnectionClient() method that returns an LMXClient configured with the current optimal base URL
       - When connection type changes (LAN↔WAN), the client should automatically use the new URL
       - Add onConnectionChange callback option for components that need to react (e.g., reconnect SSE)
       - Ensure the periodic LAN re-check (every 30s when on WAN) auto-upgrades gracefully:
         - When LAN comes back: switch to LAN URL, notify listeners
         - DO NOT interrupt active streaming — wait for current request to complete

    2. Update dashboard page to use connection-aware client:
       - Get LMXClient from useConnection context instead of creating directly
       - SSE endpoint URL should come from useConnection (adapts to LAN/WAN automatically)
       - When connection type changes, reconnect SSE to the new base URL
       - Replace any hardcoded "192.168.188.11:1234" references with dynamic base URL
       - Remove the old ConnectionIndicator from dashboard (now in global header as ConnectionBadge)
  </action>
  <verify>pnpm run build passes; dashboard uses dynamic connection URL; ConnectionBadge reflects current connection type</verify>
  <done>All LMX connections use the connection-aware client; auto-failover from LAN to WAN is seamless; dashboard SSE reconnects on connection type change</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd 1-Apps/1L-Opta-Local/web && pnpm run build` succeeds without errors
- [ ] Global header shows on all pages with navigation and ConnectionBadge
- [ ] ConnectionBadge shows LAN (when Mac Studio reachable) or Offline (when not)
- [ ] Dashboard SSE uses dynamic base URL from connection manager
- [ ] No hardcoded LMX URLs remain in the codebase
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Connection-aware LMXClient used throughout the app
- Auto-failover from LAN to WAN works when tunnel is configured
- Auto-upgrade back to LAN when it becomes available
- Global navigation header present on all pages
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-anywhere/04-02-SUMMARY.md`
</output>
