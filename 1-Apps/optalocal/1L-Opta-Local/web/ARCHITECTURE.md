# Opta Local Web — Architecture

> System design for the Next.js 16 web client.

---

## Overview

A Next.js 16 static web app that connects directly to Opta LMX servers via HTTP/SSE. No intermediate backend — the browser talks directly to the Mac Studio. All state is either server-side (LMX) or client-side (localStorage).

## Tech Stack

| Layer | Technology | Why |
|-------|-----------|-----|
| Framework | Next.js 16 | Ecosystem consistency, static export, App Router |
| UI | React 19 + @opta/ui | Shared component library across Opta web apps |
| Styling | Tailwind CSS | Utility-first, consistent with Opta design system |
| Animation | Framer Motion | Required by Opta design system (no alternatives) |
| Icons | Lucide React | Required by Opta design system |
| HTTP | Native fetch | Streaming support, no bundled HTTP library |
| SSE | EventSource | Browser-native, auto-reconnect wrapper |
| State | React 19 hooks + Context | No external state library needed |
| Build | Vite (via Next.js) | Fast dev, static export |

## Components

### Connection Manager
**Purpose:** Manage server connections (LAN + WAN), auto-detect, persist credentials
**Owns:** Server URL, admin key, connection state, Cloudflare Tunnel config
**Communicates with:** All other components (provides base URL + auth headers)

### Dashboard Engine
**Purpose:** Subscribe to SSE stream, parse metrics, feed to visualization components
**Owns:** VRAM gauge, model list, throughput chart, temperature display
**Communicates with:** Connection Manager (SSE endpoint), Model Manager (load/unload actions)

### Chat Engine
**Purpose:** Manage streaming chat completions, message history, session persistence
**Owns:** Message list, input state, streaming state, model selection
**Communicates with:** Connection Manager (chat API), Session Manager (save/resume)

### Model Manager
**Purpose:** List models, estimate VRAM, load/unload, display benchmarks
**Owns:** Model catalog, VRAM estimates, load/unload state
**Communicates with:** Connection Manager (admin API), Dashboard Engine (VRAM updates)

### Session Manager
**Purpose:** List, search, resume, and manage chat sessions
**Owns:** Session list, search index, active session state
**Communicates with:** Chat Engine (resume session), Connection Manager (session API)

## Data Flow

```
Browser
  ├── EventSource → /admin/events (SSE)
  │     └── Dashboard components update on each event
  │
  ├── fetch (stream) → /v1/chat/completions
  │     └── Chat component appends tokens as they arrive
  │
  ├── fetch → /admin/models/load | /admin/models/unload
  │     └── Model manager updates, dashboard reflects change
  │
  └── fetch → /admin/sessions/* (future)
        └── Session manager displays/resumes sessions
```

## Key Abstractions

### `LMXClient`

```typescript
interface LMXClient {
  baseUrl: string;
  adminKey: string;

  // Chat
  chatStream(params: ChatParams): AsyncGenerator<string>;

  // Admin
  getStatus(): Promise<ServerStatus>;
  subscribeEvents(handler: (event: ServerEvent) => void): () => void;

  // Models
  listModels(): Promise<Model[]>;
  loadModel(id: string): Promise<void>;
  unloadModel(id: string): Promise<void>;

  // Sessions (future)
  listSessions(): Promise<Session[]>;
  getSession(id: string): Promise<Session>;
}
```

### `ConnectionConfig`

```typescript
interface ConnectionConfig {
  id: string;
  name: string;           // "Mac Studio" or custom label
  type: 'lan' | 'wan';
  host: string;           // IP or tunnel URL
  port: number;
  adminKey: string;       // Encrypted in storage
  isActive: boolean;
}
```

## Performance Constraints

- Static export — no server-side rendering (SSR) needed
- SSE connections are persistent — manage lifecycle carefully
- Streaming chat tokens must append without layout shift
- Bundle size target: <200KB first-load JS (gzipped)

---

*Generated by OPIS v2.0 — 2026-02-18*
