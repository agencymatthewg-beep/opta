# Plan: UniFFI Interface Definition

```yaml
phase: 59
plan: 01
name: uniffi-interface-definition
wave: 1
depends_on: []
files_modified:
  - opta-native/opta-core/src/opta.udl
  - opta-native/opta-core/build.rs
  - opta-native/opta-core/src/lib.rs
autonomous: true
estimated_context: 40%
```

## Objective

Create the UniFFI interface definition (.udl file) that exposes the Opta core library to Swift and Kotlin. This is the foundation for all FFI bindings.

## Context

The opta-native workspace already has:
- `opta-core` with Crux-like architecture (Event, Effect, Model, OptaApp)
- UniFFI as a dependency in Cargo.toml
- `crate-type = ["cdylib", "staticlib", "rlib"]` configured

Missing:
- No `.udl` file defining the public interface
- No `build.rs` for scaffolding generation
- No `#[uniffi::export]` attributes on functions

## Tasks

### Task 1: Create UniFFI Interface Definition (opta.udl)

Create `opta-native/opta-core/src/opta.udl` with:

```udl
namespace opta {
    // Initialize the core library
    void init();

    // Get library version
    string version();
};

// Core application interface
interface OptaCore {
    constructor();

    // Process an event and return effects
    sequence<Effect> process_event([ByRef] string event_json);

    // Get current view model as JSON
    string get_view_model();

    // Get current model state as JSON
    string get_model_json();
};

// Effect types the shell must handle
[Enum]
interface Effect {
    Render();
    CollectTelemetry(string id);
    LoadSettings(string id);
    SaveSettings(string id, string settings_json);
    PlayHaptic(string pattern);
    PlayAudio(string sound, string? position);
    // Add more as needed
};
```

**Verification:** File exists and follows UDL syntax.

### Task 2: Create build.rs for Scaffolding Generation

Create `opta-native/opta-core/build.rs`:

```rust
fn main() {
    uniffi::generate_scaffolding("src/opta.udl").unwrap();
}
```

Update `Cargo.toml` build-dependencies if needed (already has uniffi with "build" feature).

**Verification:** `cargo build` generates scaffolding without errors.

### Task 3: Add UniFFI Exports and Verify Compilation

1. Add to `lib.rs`:
```rust
uniffi::include_scaffolding!("opta");
```

2. Add `#[uniffi::export]` to key functions:
```rust
#[uniffi::export]
pub fn init() { ... }

#[uniffi::export]
pub fn version() -> String { ... }
```

3. Create `OptaCore` struct that wraps `OptaApp` for FFI.

**Verification:**
```bash
cd opta-native && cargo build --features typegen
cargo run --bin uniffi-bindgen generate opta-core/src/opta.udl --language swift --out-dir ./generated
```

## Success Criteria

- [ ] `opta.udl` file exists with complete interface definition
- [ ] `build.rs` generates scaffolding on build
- [ ] `cargo build` succeeds with UniFFI integration
- [ ] Swift bindings can be generated via uniffi-bindgen
- [ ] Kotlin bindings can be generated via uniffi-bindgen

## Output

- UniFFI interface definition at `opta-core/src/opta.udl`
- Build script at `opta-core/build.rs`
- Generated Swift/Kotlin bindings (for verification, not committed)
