# Plan: Cross-Compilation Setup

```yaml
phase: 59
plan: 03
name: cross-compilation-setup
wave: 2
depends_on: [59-01, 59-02]
files_modified:
  - opta-native/.cargo/config.toml
  - opta-native/scripts/build-xcframework.sh
  - opta-native/scripts/build-android.sh
  - opta-native/Makefile
autonomous: true
estimated_context: 35%
```

## Objective

Configure the Rust workspace for cross-compilation to iOS and Android targets. Create build scripts that generate XCFramework for Apple platforms and AAR for Android.

## Context

The opta-native workspace needs to compile for:
- **macOS**: aarch64-apple-darwin (Apple Silicon), x86_64-apple-darwin (Intel)
- **iOS**: aarch64-apple-ios (device), aarch64-apple-ios-sim (simulator), x86_64-apple-ios (older simulators)
- **Android** (future): aarch64-linux-android, armv7-linux-androideabi, x86_64-linux-android

Phase 59 focuses on macOS and iOS (aligns with Opta iOS project). Android support is foundational but not primary target.

## Tasks

### Task 1: Configure Cargo for Cross-Platform Targets

Create `opta-native/.cargo/config.toml`:

```toml
[build]
# Default to native macOS
target = "aarch64-apple-darwin"

[target.aarch64-apple-darwin]
rustflags = ["-C", "link-arg=-mmacosx-version-min=13.0"]

[target.x86_64-apple-darwin]
rustflags = ["-C", "link-arg=-mmacosx-version-min=13.0"]

[target.aarch64-apple-ios]
rustflags = ["-C", "link-arg=-mios-version-min=17.0"]

[target.aarch64-apple-ios-sim]
rustflags = ["-C", "link-arg=-mios-simulator-version-min=17.0"]

[target.x86_64-apple-ios]
rustflags = ["-C", "link-arg=-mios-simulator-version-min=17.0"]

# Android targets (future use)
[target.aarch64-linux-android]
linker = "aarch64-linux-android24-clang"

[target.armv7-linux-androideabi]
linker = "armv7a-linux-androideabi24-clang"

[target.x86_64-linux-android]
linker = "x86_64-linux-android24-clang"

[alias]
# Convenience aliases
build-ios = "build --target aarch64-apple-ios --release"
build-ios-sim = "build --target aarch64-apple-ios-sim --release"
build-macos = "build --target aarch64-apple-darwin --release"
```

Install required targets:
```bash
rustup target add aarch64-apple-ios aarch64-apple-ios-sim x86_64-apple-ios
rustup target add aarch64-apple-darwin x86_64-apple-darwin
```

**Verification:** `cargo build --target aarch64-apple-darwin` succeeds.

### Task 2: Create XCFramework Build Script

Create `opta-native/scripts/build-xcframework.sh`:

```bash
#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
OUTPUT_DIR="$PROJECT_DIR/target/xcframework"

echo "Building Opta Core XCFramework..."

# Clean output directory
rm -rf "$OUTPUT_DIR"
mkdir -p "$OUTPUT_DIR"

# Build for all Apple platforms
echo "Building for macOS (Apple Silicon)..."
cargo build --manifest-path "$PROJECT_DIR/Cargo.toml" -p opta-core --release --target aarch64-apple-darwin

echo "Building for macOS (Intel)..."
cargo build --manifest-path "$PROJECT_DIR/Cargo.toml" -p opta-core --release --target x86_64-apple-darwin

echo "Building for iOS (device)..."
cargo build --manifest-path "$PROJECT_DIR/Cargo.toml" -p opta-core --release --target aarch64-apple-ios

echo "Building for iOS Simulator (Apple Silicon)..."
cargo build --manifest-path "$PROJECT_DIR/Cargo.toml" -p opta-core --release --target aarch64-apple-ios-sim

# Create universal macOS binary
echo "Creating universal macOS binary..."
mkdir -p "$OUTPUT_DIR/macos"
lipo -create \
    "$PROJECT_DIR/target/aarch64-apple-darwin/release/libopta_core.a" \
    "$PROJECT_DIR/target/x86_64-apple-darwin/release/libopta_core.a" \
    -output "$OUTPUT_DIR/macos/libopta_core.a"

# Create iOS Simulator binary (currently just arm64)
mkdir -p "$OUTPUT_DIR/ios-simulator"
cp "$PROJECT_DIR/target/aarch64-apple-ios-sim/release/libopta_core.a" "$OUTPUT_DIR/ios-simulator/"

# Create iOS device binary
mkdir -p "$OUTPUT_DIR/ios"
cp "$PROJECT_DIR/target/aarch64-apple-ios/release/libopta_core.a" "$OUTPUT_DIR/ios/"

# Generate Swift bindings
echo "Generating Swift bindings..."
cargo run --manifest-path "$PROJECT_DIR/Cargo.toml" --bin uniffi-bindgen generate \
    "$PROJECT_DIR/opta-core/src/opta.udl" \
    --language swift \
    --out-dir "$OUTPUT_DIR/swift"

# Create XCFramework
echo "Creating XCFramework..."
xcodebuild -create-xcframework \
    -library "$OUTPUT_DIR/macos/libopta_core.a" \
    -headers "$OUTPUT_DIR/swift" \
    -library "$OUTPUT_DIR/ios/libopta_core.a" \
    -headers "$OUTPUT_DIR/swift" \
    -library "$OUTPUT_DIR/ios-simulator/libopta_core.a" \
    -headers "$OUTPUT_DIR/swift" \
    -output "$OUTPUT_DIR/OptaCore.xcframework"

echo "XCFramework created at: $OUTPUT_DIR/OptaCore.xcframework"
```

**Verification:** `./scripts/build-xcframework.sh` creates OptaCore.xcframework.

### Task 3: Create Makefile with Build Commands

Create `opta-native/Makefile`:

```makefile
.PHONY: all clean build-macos build-ios build-xcframework build-android check test

# Default target
all: check build-macos

# Clean all build artifacts
clean:
	cargo clean
	rm -rf target/xcframework
	rm -rf target/android

# Run checks
check:
	cargo check --all-features
	cargo clippy --all-features -- -D warnings

# Run tests
test:
	cargo test --all-features

# Build for macOS (native)
build-macos:
	cargo build --release --target aarch64-apple-darwin

# Build for iOS device
build-ios:
	cargo build --release --target aarch64-apple-ios

# Build for iOS Simulator
build-ios-sim:
	cargo build --release --target aarch64-apple-ios-sim

# Build XCFramework (macOS + iOS)
build-xcframework:
	./scripts/build-xcframework.sh

# Generate Swift bindings only
gen-swift:
	cargo run --bin uniffi-bindgen generate opta-core/src/opta.udl --language swift --out-dir generated/swift

# Generate Kotlin bindings only
gen-kotlin:
	cargo run --bin uniffi-bindgen generate opta-core/src/opta.udl --language kotlin --out-dir generated/kotlin

# Install required Rust targets
setup:
	rustup target add aarch64-apple-darwin x86_64-apple-darwin
	rustup target add aarch64-apple-ios aarch64-apple-ios-sim x86_64-apple-ios
	rustup target add aarch64-linux-android armv7-linux-androideabi x86_64-linux-android

# Development build (fast, debug)
dev:
	cargo build
```

**Verification:** `make check` and `make build-macos` succeed.

## Success Criteria

- [ ] `.cargo/config.toml` created with all platform targets
- [ ] Required Rust targets installed via rustup
- [ ] `cargo build --target aarch64-apple-darwin` succeeds
- [ ] `cargo build --target aarch64-apple-ios` succeeds
- [ ] `scripts/build-xcframework.sh` creates valid XCFramework
- [ ] Makefile provides convenient build commands

## Output

- `.cargo/config.toml` with cross-compilation configuration
- `scripts/build-xcframework.sh` for XCFramework generation
- `Makefile` with build commands
- Verified cross-compilation for macOS and iOS targets
