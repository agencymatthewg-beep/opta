---
phase: 95
plan: 01
title: Gamification System
type: feature
wave: 1
depends_on: []
files_modified:
  - opta-native/OptaApp/OptaApp/Models/GamificationModels.swift
  - opta-native/OptaApp/OptaApp/Services/GamificationManager.swift
  - opta-native/OptaApp/OptaApp/Views/Gamification/BadgeCollectionView.swift
  - opta-native/OptaApp/OptaApp/Views/Gamification/GamificationDashboard.swift
  - opta-native/OptaApp/OptaApp/Views/Gamification/AchievementUnlockOverlay.swift
  - opta-native/OptaApp/OptaApp/Models/OptaViewModel.swift
  - opta-native/OptaApp/OptaApp/OptaAppApp.swift
  - opta-native/OptaApp/OptaApp/Models/CommandPaletteModels.swift
  - opta-native/OptaApp/OptaApp.xcodeproj/project.pbxproj
autonomous: true
---

<objective>
Create a complete gamification system with badges, achievements, streaks, XP progression,
and daily challenges. Includes a dedicated Gamification Dashboard accessible from navigation,
badge collection view, streak indicators, and achievement unlock overlay animations.
All progress persists to disk via JSON file storage.
</objective>

<execution_context>
- Architecture: @Observable GamificationManager singleton, JSON persistence
- Design: Obsidian panels with violet accents, gold/violet badge colors
- Navigation: Add `.gamification` page to PageViewModel
- Achievements unlock based on user actions (optimize count, score thresholds, streaks)
- Daily challenges refresh at midnight, provide XP rewards
- Streaks track consecutive days of app usage/optimization
- XP/Level system: 100 XP per level, earned from optimizations, challenges, achievements
- Storage: ~/Library/Application Support/OptaApp/gamification.json
</execution_context>

<context>
@opta-native/OptaApp/OptaApp/Models/OptaViewModel.swift (PageViewModel enum, score fields)
@opta-native/OptaApp/OptaApp/Models/ScoreModels.swift (ScoreHistoryManager pattern)
@opta-native/OptaApp/OptaApp/Views/Score/ScoreDetailView.swift (view structure pattern)
@opta-native/OptaApp/OptaApp/OptaAppApp.swift (navigation switch)
@opta-native/OptaApp/OptaApp/Models/CommandPaletteModels.swift (registerDefaults)
</context>

<tasks>

<task id="1" type="auto">
<title>Create Gamification Models and Manager</title>
<description>
Define all gamification types (badges, achievements, streaks, XP, challenges) and
the GamificationManager that tracks progress, unlocks achievements, and persists state.
</description>
<files>
  - CREATE: opta-native/OptaApp/OptaApp/Models/GamificationModels.swift
  - CREATE: opta-native/OptaApp/OptaApp/Services/GamificationManager.swift
  - MODIFY: opta-native/OptaApp/OptaApp/Models/OptaViewModel.swift
</files>
<action>
**GamificationModels.swift:**

1. `Badge` struct (Identifiable, Codable):
   - `id: String` (unique identifier)
   - `name: String`
   - `description: String`
   - `icon: String` (SF Symbol)
   - `tier: BadgeTier` (.bronze, .silver, .gold, .diamond)
   - `category: BadgeCategory`
   - `unlockedDate: Date?` (nil if locked)
   - `var isUnlocked: Bool` (computed from unlockedDate)

2. `BadgeTier` enum (Codable): `.bronze`, `.silver`, `.gold`, `.diamond`
   - `var color: String` (hex color for tier)
   - `var xpReward: Int` (10, 25, 50, 100)

3. `BadgeCategory` enum (Codable):
   - `.optimization` - Optimize-related badges
   - `.streak` - Streak milestones
   - `.score` - Score achievements
   - `.exploration` - Feature discovery

4. `Achievement` struct (Identifiable, Codable):
   - `id: String`
   - `name: String`
   - `description: String`
   - `icon: String`
   - `requirement: AchievementRequirement`
   - `progress: Int` (current progress count)
   - `target: Int` (target to unlock)
   - `unlockedDate: Date?`
   - `xpReward: Int`

5. `AchievementRequirement` enum (Codable):
   - `.optimizeCount(Int)` - Run N optimizations
   - `.scoreReached(Int)` - Reach score of N
   - `.streakDays(Int)` - Maintain N day streak
   - `.pagesVisited(Int)` - Visit N different pages
   - `.chatMessages(Int)` - Send N chat messages

6. `Streak` struct (Codable):
   - `currentStreak: Int`
   - `longestStreak: Int`
   - `lastActiveDate: Date?`
   - `var isActiveToday: Bool` (computed)
   - `mutating func recordActivity()`

7. `XPProgress` struct (Codable):
   - `totalXP: Int`
   - `var level: Int` (computed: totalXP / 100 + 1)
   - `var currentLevelXP: Int` (computed: totalXP % 100)
   - `var xpToNextLevel: Int` (computed: 100 - currentLevelXP)
   - `mutating func addXP(_ amount: Int)`

8. `DailyChallenge` struct (Identifiable, Codable):
   - `id: String`
   - `title: String`
   - `description: String`
   - `icon: String`
   - `type: ChallengeType`
   - `target: Int`
   - `progress: Int`
   - `xpReward: Int`
   - `date: Date`
   - `var isComplete: Bool` (computed)

9. `ChallengeType` enum (Codable):
   - `.optimize` - Run optimizations
   - `.checkScore` - Check your score
   - `.useChat` - Ask AI a question
   - `.visitPages` - Visit different pages

**GamificationManager.swift:**

`@Observable class GamificationManager`:
- `static let shared = GamificationManager()`
- Properties:
  - `var badges: [Badge]` (all badges, locked or unlocked)
  - `var achievements: [Achievement]`
  - `var streak: Streak`
  - `var xp: XPProgress`
  - `var dailyChallenges: [DailyChallenge]`
  - `var recentUnlock: Badge?` (for unlock animation trigger)
  - `var showUnlockOverlay: Bool = false`

- Badge definitions (static list of ~15 badges):
  - Optimization: "First Optimize" (bronze), "Power User" (5 optimizes, silver),
    "Optimization Master" (25, gold), "Unstoppable" (100, diamond)
  - Streaks: "Getting Started" (3 days, bronze), "Committed" (7 days, silver),
    "Dedicated" (30 days, gold), "Legendary" (100 days, diamond)
  - Score: "Rising Star" (score 50, bronze), "High Achiever" (75, silver),
    "Elite" (90, gold), "Perfect" (100, diamond)
  - Exploration: "Explorer" (visit all pages, silver), "Conversationalist" (10 chats, silver),
    "Analyst" (view score 5 times, bronze)

- Methods:
  - `func recordOptimization()` - increment optimize count, check badges
  - `func recordScoreCheck(score: Int)` - check score badges
  - `func recordDailyActivity()` - update streak, refresh challenges if new day
  - `func recordPageVisit(_ page: PageViewModel)` - track exploration
  - `func recordChatMessage()` - track chat usage
  - `func checkAchievements()` - evaluate all achievement conditions
  - `private func unlockBadge(_ badge: Badge)` - set date, award XP, trigger overlay
  - `private func generateDailyChallenges() -> [DailyChallenge]` - 3 random daily challenges
  - `func load()` / `func save()` - JSON file persistence
  - Storage path: `~/Library/Application Support/OptaApp/gamification.json`

**OptaViewModel.swift modification:**
- Add `.gamification` case to PageViewModel enum:
  ```swift
  case gamification = "Gamification"
  ```
</action>
<verify>
Files compile. GamificationManager can be instantiated, badges loaded, streak recorded.
PageViewModel has .gamification case.
</verify>
<done>GamificationModels.swift and GamificationManager.swift created with all types, badge definitions, and persistence.</done>
</task>

<task id="2" type="auto">
<title>Create Gamification Dashboard and Badge Collection Views</title>
<description>
Build the main gamification page with XP progress, streak display, daily challenges,
badge collection grid, and achievement progress list.
</description>
<files>
  - CREATE: opta-native/OptaApp/OptaApp/Views/Gamification/GamificationDashboard.swift
  - CREATE: opta-native/OptaApp/OptaApp/Views/Gamification/BadgeCollectionView.swift
</files>
<action>
**GamificationDashboard.swift:**
Main gamification page (ScrollView + VStack):
- Header: "Achievements" title + back button (same pattern as other views)
- XP Section: Level badge + XP progress bar + "Level N" label
  - Progress bar: violet gradient fill, shows currentLevelXP/100
  - Level number in circle badge
- Streak Section: flame icon + current streak days + longest streak
  - Active today: green checkmark
  - Visual: row of 7 dots (last 7 days, filled = active)
- Daily Challenges Section: "Today's Challenges" header + 3 challenge cards
  - Each card: icon + title + progress bar + XP reward badge
  - Complete challenges: green checkmark overlay, strikethrough
- Badge Summary: "X/Y Badges Unlocked" + "View All" button
  - Shows latest 4 unlocked badges in a row
  - Button navigates to full BadgeCollectionView (or scrolls down)
- Achievement Progress: List of next 3 closest-to-unlock achievements
  - Progress bar + name + description + target indicator
- Background: Color(hex: "09090B")
- @Bindable var coreManager: OptaCoreManager for navigation
- Uses GamificationManager.shared for all data
- Records daily activity on appear

**BadgeCollectionView.swift:**
Grid view of all badges:
- LazyVGrid (3 columns) showing all badges
- Each badge cell:
  - Circular icon with tier-colored ring (bronze/silver/gold/diamond colors)
  - Badge name below
  - Locked badges: grayscale, lock icon overlay, opacity 0.4
  - Unlocked: full color, slight glow, unlock date tooltip
- Filter tabs: "All" / "Unlocked" / category filters
- Sort: by tier, by unlock date, by category
- Empty state for each category if none unlocked
- Tapping unlocked badge: shows detail popover (name, description, unlock date, XP earned)
- This can be embedded in GamificationDashboard or standalone
  (embed as a section within GamificationDashboard for simplicity)
</action>
<verify>
Files compile. GamificationDashboard renders with mock data.
Badge grid shows locked/unlocked states correctly.
Streak and challenge displays are functional.
</verify>
<done>GamificationDashboard.swift and BadgeCollectionView.swift created with full gamification UI.</done>
</task>

<task id="3" type="auto">
<title>Create Achievement Unlock Overlay, Wire Navigation, Register Files</title>
<description>
Build the celebratory unlock overlay animation, wire the gamification page into
navigation and command palette, and register all files in Xcode.
</description>
<files>
  - CREATE: opta-native/OptaApp/OptaApp/Views/Gamification/AchievementUnlockOverlay.swift
  - MODIFY: opta-native/OptaApp/OptaApp/OptaAppApp.swift
  - MODIFY: opta-native/OptaApp/OptaApp/Models/CommandPaletteModels.swift
  - MODIFY: opta-native/OptaApp/OptaApp.xcodeproj/project.pbxproj
</files>
<action>
**AchievementUnlockOverlay.swift:**
Celebratory overlay when a badge is unlocked:
- Full-screen semi-transparent backdrop (black at 0.6 opacity)
- Centered card: obsidian panel with violet glow border
- Badge icon: large (80pt), tier-colored ring, scale-up animation
- "Badge Unlocked!" title in gold/violet
- Badge name + description
- XP reward: "+50 XP" with counting animation
- Tier indicator pill (bronze/silver/gold/diamond colored)
- Dismiss button: "Awesome!" or auto-dismiss after 4 seconds
- Entrance animation: scale 0.5â†’1.0 + opacity spring, slight rotation
- Particle-like effect: 6-8 small circles expanding outward (simple radial animation)
- Uses GamificationManager.shared.recentUnlock for badge data
- Binding to GamificationManager.shared.showUnlockOverlay for presentation

**OptaAppApp.swift modifications:**
1. Add `.gamification` case in navigation switch:
   ```swift
   case .gamification:
       GamificationDashboard(coreManager: coreManager)
   ```

2. Add AchievementUnlockOverlay in the ZStack (after CommandPaletteView):
   ```swift
   if GamificationManager.shared.showUnlockOverlay {
       AchievementUnlockOverlay()
   }
   ```

3. Add .task to record daily activity:
   ```swift
   .task {
       GamificationManager.shared.recordDailyActivity()
   }
   ```

**CommandPaletteModels.swift:**
Add "View Achievements" command:
```swift
CommandAction(id: "nav-gamification", title: "View Achievements",
              subtitle: "Badges, streaks & challenges",
              icon: "trophy.fill", category: .navigation, shortcut: nil) {
    navigate(.gamification)
}
```

**project.pbxproj:**
- Create Gamification group under Views
- Add GamificationModels.swift to Models group
- Add GamificationManager.swift to Services group
- Add GamificationDashboard.swift, BadgeCollectionView.swift,
  AchievementUnlockOverlay.swift to Views/Gamification group
- PBXBuildFile, PBXFileReference, PBXGroup entries with unique IDs

Verify build: `xcodebuild -project ... -scheme OptaApp build`
</action>
<verify>
Build passes. Navigation to .gamification shows GamificationDashboard.
Achievement unlock overlay can be triggered and dismisses properly.
Command palette includes "View Achievements" command.
</verify>
<done>AchievementUnlockOverlay created. Navigation wired. All files in Xcode. Build passes.</done>
</task>

</tasks>

<verification>
1. Build passes: `xcodebuild -project opta-native/OptaApp/OptaApp.xcodeproj -scheme OptaApp build`
2. Gamification page accessible from command palette ("View Achievements")
3. XP progress bar and level display correct
4. Streak tracking records daily activity
5. Daily challenges show with progress bars
6. Badge grid shows locked/unlocked states
7. Achievement unlock overlay animates on badge unlock
8. Data persists across app restarts
</verification>

<success_criteria>
- [ ] GamificationModels.swift with Badge, Achievement, Streak, XP, DailyChallenge types
- [ ] GamificationManager.swift with tracking, unlock logic, JSON persistence
- [ ] GamificationDashboard.swift with XP, streaks, challenges, badge summary
- [ ] BadgeCollectionView.swift with grid, filters, locked/unlocked states
- [ ] AchievementUnlockOverlay.swift with celebratory animation
- [ ] PageViewModel.gamification case and navigation wired
- [ ] Command palette includes gamification navigation
- [ ] All files registered in Xcode project
- [ ] Build passes
</success_criteria>

<output>
SUMMARY.md documenting:
- Files created and gamification architecture
- Badge definitions and unlock conditions
- Persistence approach
- Build verification results
</output>
