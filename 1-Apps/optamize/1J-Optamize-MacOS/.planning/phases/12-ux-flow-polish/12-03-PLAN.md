# Plan 12-03: Session Flow Improvements

wave: 2
autonomous: true

## Overview

Improve game session tracking with real telemetry and session history.

## Tasks

### 1. Fix Game Session Telemetry
**File**: `src/hooks/useGameSession.ts` (lines 150-184)

Session summary uses hardcoded placeholder values.

**Current (fake)**:
```tsx
stealthModeSavingsMb: sess.config.runStealthMode ? 512 : 0,  // Hardcoded
optimizationsApplied: sess.config.applyOptimizations ? 1 : 0,
gpuPercent: null,
fps: null,
```

**Fix**: Connect to actual telemetry:
```tsx
// Track during session
const [sessionMetrics, setSessionMetrics] = useState({
  memoryFreedMb: 0,
  avgGpuPercent: 0,
  optimizationsCount: 0,
});

// Update from StealthMode result
const handleStealthModeResult = (result: StealthModeResult) => {
  setSessionMetrics(prev => ({
    ...prev,
    memoryFreedMb: result.totalMemoryFreedMb,
  }));
};

// Use real values in summary
stealthModeSavingsMb: sessionMetrics.memoryFreedMb,
```

### 2. Connect LaunchConfirmationModal to Optimization Flow
**File**: `src/components/LaunchConfirmationModal.tsx`

Currently launches game without applying optimizations.

**Fix**: Add pre-launch optimization step:
```tsx
const handleLaunch = async () => {
  setLoading(true);
  try {
    // 1. Run Stealth Mode if enabled
    if (config.runStealthMode) {
      const result = await runStealthMode();
      onStealthModeComplete?.(result);
    }

    // 2. Apply optimizations if enabled
    if (config.applyOptimizations) {
      await applyGameOptimizations(game.id);
    }

    // 3. Launch game
    await launchGame(game);
    onLaunch(config);
  } catch (err) {
    setError(err.message);
  } finally {
    setLoading(false);
  }
};
```

### 3. Add Session History Persistence
**File**: `src/hooks/useGameSession.ts`

Sessions are lost on app restart.

**Fix**: Persist to localStorage:
```tsx
const SESSION_HISTORY_KEY = 'opta-session-history';

// Load history on mount
const [sessionHistory, setSessionHistory] = useState<GameSessionSummary[]>(() => {
  const saved = localStorage.getItem(SESSION_HISTORY_KEY);
  return saved ? JSON.parse(saved) : [];
});

// Save when session ends
const endSession = () => {
  const summary = createSessionSummary(currentSession);
  const updatedHistory = [...sessionHistory, summary].slice(-50);  // Keep last 50
  setSessionHistory(updatedHistory);
  localStorage.setItem(SESSION_HISTORY_KEY, JSON.stringify(updatedHistory));
};
```

## Verification

1. Enable Stealth Mode + launch game → See actual memory saved in summary
2. End session → Restart app → Session history persists
3. View session history → Shows real metrics, not placeholders

## Files Modified

- `src/hooks/useGameSession.ts`
- `src/components/LaunchConfirmationModal.tsx`
- `src/components/SessionSummaryModal.tsx`

## Estimated Duration

20-25 minutes
