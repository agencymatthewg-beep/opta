---
phase: 06-rich-text
plan: 03
title: Expandable/Collapsible Sections
subsystem: chat-ui
wave: 2
autonomous: true
tags: [expandable, collapsible, disclosure, swiftui, animation]

# Dependency graph
requires:
  - phase: 06-01
    provides: MarkdownContent view, ContentBlock parsing
  - phase: 06-02
    provides: CodeBlockView component
provides:
  - CollapsibleSection SwiftUI view component
  - HTML-style details/summary detection
  - Animated expand/collapse transitions
  - Long code block auto-collapse
  - Nested section support
affects: [07-rich-visual]
---

# Phase 06-03: Expandable/Collapsible Sections

**Implement collapsible sections for organizing long content with smooth animations**

## Objective

Add expandable/collapsible sections to MarkdownContent using `<details>` / `<summary>` HTML-style tags. Automatically collapse long code blocks (>15 lines) with a "Show more" option. Use spring animations from the design system.

## Execution Context

@.planning/phases/06-rich-text/06-01-PLAN.md
@.planning/phases/06-rich-text/06-02-PLAN.md
@Sources/ClawdbotKit/Design/ClawdbotAnimations.swift

## Context

**Depends on 06-01 and 06-02:**
- ContentBlock enum needs `.collapsible(summary: String, content: [ContentBlock])` case
- parseBlocks() needs to detect `<details>` sections
- MarkdownContent body needs to call renderCollapsible()
- CodeBlockView needs auto-collapse for long code

**Design patterns to follow:**
- `clawdbotSpring` animation (0.3s response, 0.7 damping)
- SF Symbols for chevron: `chevron.right` / `chevron.down`
- Surface elevation for header: `clawdbotSurfaceElevated`

**Markdown/HTML syntax:**
```
<details>
<summary>Click to expand</summary>
Hidden content here...
</details>
```

## Tasks

### Task 1: Add CollapsibleSection case to ContentBlock

Update `MarkdownContent.swift`:

Add case to ContentBlock enum:
```swift
enum ContentBlock {
    case paragraph(String)
    case bulletList([String])
    case codeBlock(code: String, language: String?)
    case collapsible(summary: String, content: [ContentBlock], isOpen: Bool)
}
```

Detect details/summary blocks:
```swift
// Pattern: <details>\n<summary>Title</summary>\nContent\n</details>
private func extractCollapsibleBlocks(_ content: String) -> [ContentBlock] {
    let pattern = #"<details>\s*<summary>(.*?)</summary>([\s\S]*?)</details>"#
    // Extract summary and nested content
    // Parse nested content recursively
}
```

Handle nested structures:
- Details can contain code blocks, lists, other details
- Parse inner content recursively through parseBlocks()

**Commit after completion:** `feat(06-03): add collapsible section detection to ContentBlock`

### Task 2: Create CollapsibleSection view component

Create `Sources/ClawdbotKit/Chat/CollapsibleSection.swift`:

```swift
import SwiftUI

/// An expandable/collapsible content section
public struct CollapsibleSection<Content: View>: View {
    let summary: String
    let defaultExpanded: Bool
    @ViewBuilder let content: () -> Content

    @State private var isExpanded: Bool

    public init(
        summary: String,
        defaultExpanded: Bool = false,
        @ViewBuilder content: @escaping () -> Content
    ) {
        self.summary = summary
        self.defaultExpanded = defaultExpanded
        self._isExpanded = State(initialValue: defaultExpanded)
        self.content = content
    }

    public var body: some View {
        VStack(alignment: .leading, spacing: 0) {
            // Tappable header
            header
                .onTapGesture { toggle() }

            // Animated content reveal
            if isExpanded {
                content()
                    .transition(.opacity.combined(with: .move(edge: .top)))
            }
        }
        .background(Color.clawdbotSurface)
        .clipShape(RoundedRectangle(cornerRadius: 12))
    }

    private func toggle() {
        withAnimation(.clawdbotSpring) {
            isExpanded.toggle()
        }
    }
}
```

**Commit after completion:** `feat(06-03): create CollapsibleSection view component`

### Task 3: Implement animated header with chevron

Add header view to CollapsibleSection:

```swift
private var header: some View {
    HStack(spacing: 8) {
        Image(systemName: "chevron.right")
            .font(.caption.weight(.semibold))
            .foregroundColor(.clawdbotTextSecondary)
            .rotationEffect(.degrees(isExpanded ? 90 : 0))

        Text(summary)
            .font(.subheadline.weight(.medium))
            .foregroundColor(.clawdbotTextPrimary)

        Spacer()

        if !isExpanded {
            Text("Tap to expand")
                .font(.caption)
                .foregroundColor(.clawdbotTextMuted)
        }
    }
    .padding(.horizontal, 12)
    .padding(.vertical, 10)
    .background(Color.clawdbotSurfaceElevated)
    .contentShape(Rectangle())  // Full area tappable
}
```

Animation details:
- Chevron rotates 90Â° on expand
- Content fades in and slides down
- Use `clawdbotSpring` for natural feel
- `contentShape(Rectangle())` ensures full header is tappable

**Commit after completion:** `feat(06-03): add animated header with chevron rotation`

### Task 4: Add auto-collapse for long code blocks

Update `CodeBlockView.swift` to auto-collapse when lines > threshold:

```swift
public struct CodeBlockView: View {
    // ... existing properties

    let autoCollapseThreshold: Int = 15
    @State private var isExpanded: Bool = false

    private var shouldAutoCollapse: Bool {
        code.components(separatedBy: .newlines).count > autoCollapseThreshold
    }

    private var displayedCode: String {
        if shouldAutoCollapse && !isExpanded {
            return truncatedCode
        }
        return code
    }

    private var truncatedCode: String {
        let lines = code.components(separatedBy: .newlines)
        return lines.prefix(autoCollapseThreshold).joined(separator: "\n")
    }

    // Add expand/collapse footer when auto-collapsed
    private var expandFooter: some View {
        Button(action: { toggleExpand() }) {
            HStack(spacing: 4) {
                Text(isExpanded ? "Show less" : "Show more")
                Image(systemName: isExpanded ? "chevron.up" : "chevron.down")
            }
            .font(.caption)
            .foregroundColor(.clawdbotPurple)
        }
        .padding(.horizontal, 12)
        .padding(.vertical, 8)
        .frame(maxWidth: .infinity)
        .background(Color.clawdbotSurfaceElevated)
    }

    private func toggleExpand() {
        withAnimation(.clawdbotSpring) {
            isExpanded.toggle()
        }
    }
}
```

Add footer to CodeBlockView body when applicable:
```swift
if shouldAutoCollapse {
    expandFooter
}
```

**Commit after completion:** `feat(06-03): add auto-collapse for long code blocks`

### Task 5: Integrate CollapsibleSection into MarkdownContent

Update MarkdownContent to render collapsible sections:

```swift
@ViewBuilder
private func renderBlock(_ block: ContentBlock) -> some View {
    switch block {
    case .paragraph(let text):
        renderParagraph(text)
    case .bulletList(let items):
        renderBulletList(items)
    case .codeBlock(let code, let language):
        CodeBlockView(code: code, language: language, isStreaming: isStreaming)
    case .collapsible(let summary, let nestedBlocks, let isOpen):
        CollapsibleSection(summary: summary, defaultExpanded: isOpen) {
            VStack(alignment: .leading, spacing: 8) {
                ForEach(nestedBlocks.indices, id: \.self) { index in
                    renderBlock(nestedBlocks[index])
                }
            }
            .padding(12)
        }
    }
}
```

Recursive nesting:
- Collapsible can contain any ContentBlock
- Including other collapsibles (nested)
- Max depth should be reasonable (3-4 levels)

**Commit after completion:** `feat(06-03): integrate CollapsibleSection into MarkdownContent`

### Task 6: Handle streaming collapsible sections

Add streaming resilience for incomplete `<details>` blocks:

1. Unclosed details during streaming:
```swift
// <details>\n<summary>Title</summary>\ncontent...
// No closing </details> yet
private func isPartialCollapsible(_ content: String) -> Bool {
    let openCount = content.components(separatedBy: "<details>").count - 1
    let closeCount = content.components(separatedBy: "</details>").count - 1
    return openCount > closeCount
}
```

2. Render partial as expandable with streaming indicator:
- Show summary if available
- Mark content as "Loading..." if incomplete
- Don't allow collapse during streaming (content still arriving)

```swift
// In CollapsibleSection during streaming
if isStreaming && !isExpanded {
    Text("Content loading...")
        .font(.caption)
        .foregroundColor(.clawdbotTextMuted)
        .padding(12)
}
```

**Commit after completion:** `feat(06-03): add streaming support for collapsible sections`

### Task 7: Add collapsible section tests

Create/update `Tests/ClawdbotKitTests/CollapsibleSectionTests.swift`:

Test cases:
1. Details/summary tags detected correctly
2. Summary text extracted from `<summary>` tag
3. Nested content parsed recursively
4. CollapsibleSection starts collapsed by default
5. Tap toggles expansion state
6. Chevron rotates on expansion
7. Long code blocks (>15 lines) auto-collapse
8. "Show more" button expands long code
9. Nested collapsible sections render correctly
10. Incomplete `<details>` during streaming handled gracefully

**Commit after completion:** `test(06-03): add collapsible section unit tests`

## Verification

```bash
cd apps/ios/ClawdbotKit
swift test --filter Collapsible
swift test --filter CodeBlock  # Re-run for auto-collapse tests
swift build
```

Expected: All tests pass, no warnings

## Success Criteria

- [ ] `<details>/<summary>` tags detected and rendered as collapsible
- [ ] CollapsibleSection animates open/close with spring animation
- [ ] Chevron rotates smoothly on expand/collapse
- [ ] Long code blocks (>15 lines) auto-collapse with "Show more"
- [ ] Nested collapsible sections supported
- [ ] Streaming collapsibles show loading state
- [ ] 10+ new tests for collapsible functionality
- [ ] All existing tests pass

## Output

Files created:
- `Sources/ClawdbotKit/Chat/CollapsibleSection.swift`
- `Tests/ClawdbotKitTests/CollapsibleSectionTests.swift`

Files modified:
- `Sources/ClawdbotKit/Chat/MarkdownContent.swift`
- `Sources/ClawdbotKit/Chat/CodeBlockView.swift`

---
*Phase: 06-rich-text*
*Plan: 03 of 03*
*Wave: 2*
