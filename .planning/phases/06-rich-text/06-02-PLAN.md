---
phase: 06-rich-text
plan: 02
title: Code Block Syntax Highlighting
subsystem: chat-ui
wave: 2
autonomous: true
tags: [code-blocks, syntax-highlighting, swiftui, design-tokens]

# Dependency graph
requires:
  - phase: 06-01
    provides: MarkdownContent view, ContentBlock parsing, inline code styling
provides:
  - CodeBlock SwiftUI view component
  - Fenced code block detection (```)
  - Language-aware syntax highlighting
  - Copy-to-clipboard action
  - Code block streaming support
affects: [06-03-expandable]
---

# Phase 06-02: Code Block Syntax Highlighting

**Render fenced code blocks with syntax highlighting, language labels, and copy functionality**

## Objective

Extend MarkdownContent to detect and render fenced code blocks (``` markers) with syntax highlighting using the existing design token colors. Include language detection, a copy button, and proper rendering during streaming.

## Execution Context

@.planning/phases/06-rich-text/06-01-PLAN.md
@Sources/ClawdbotKit/Chat/MarkdownContent.swift
@Sources/ClawdbotKit/Design/ClawdbotColors.swift

## Context

**Depends on 06-01:**
- ContentBlock enum needs `.codeBlock(String, language: String?)` case
- parseBlocks() needs to detect ``` fenced code blocks
- MarkdownContent body needs to call renderCodeBlock()

**Design tokens for syntax highlighting:**
- Background: `clawdbotSurface` (#18181b)
- Border: `clawdbotBorder` (#3f3f46)
- Text: `clawdbotTextPrimary` (#fafafa)
- Keywords: `clawdbotPurple` (#8b5cf6)
- Strings: `clawdbotBlue` (#3b82f6)
- Functions/Types: `clawdbotGreen` (#22c55e)
- Comments: `clawdbotTextSecondary` (#a1a1aa)
- Numbers: `clawdbotAmber` (#f59e0b)

**No third-party dependencies** - implement lightweight highlighting using regex patterns

## Tasks

### Task 1: Add CodeBlock case to ContentBlock parsing

Update `MarkdownContent.swift` parseBlocks():

Add case to ContentBlock enum:
```swift
enum ContentBlock {
    case paragraph(String)
    case bulletList([String])
    case codeBlock(code: String, language: String?)
}
```

Detect fenced code blocks:
```swift
// Pattern: ```language\ncode\n```
// Or: ```\ncode\n```
private func extractCodeBlocks(_ content: String) -> [ContentBlock] {
    let pattern = #"```(\w*)\n([\s\S]*?)```"#
    // Extract language hint and code content
    // Return remaining text as paragraphs
}
```

Handle unclosed code blocks during streaming:
- If ``` opens but doesn't close, render as partial code block
- Add visual indicator that more code is coming

**Commit after completion:** `feat(06-02): add code block detection to ContentBlock parsing`

### Task 2: Create CodeBlockView component

Create `Sources/ClawdbotKit/Chat/CodeBlockView.swift`:

```swift
import SwiftUI

/// Renders a fenced code block with syntax highlighting
public struct CodeBlockView: View {
    let code: String
    let language: String?
    let isStreaming: Bool

    public init(code: String, language: String? = nil, isStreaming: Bool = false) {
        self.code = code
        self.language = language
        self.isStreaming = isStreaming
    }

    public var body: some View {
        VStack(alignment: .leading, spacing: 0) {
            // Header with language label + copy button
            header

            // Code content with syntax highlighting
            ScrollView(.horizontal, showsIndicators: false) {
                codeContent
            }
        }
        .background(Color.clawdbotSurface)
        .clipShape(RoundedRectangle(cornerRadius: 12))
        .overlay(
            RoundedRectangle(cornerRadius: 12)
                .stroke(Color.clawdbotBorder, lineWidth: 1)
        )
    }
}
```

Header component:
```swift
private var header: some View {
    HStack {
        if let lang = language, !lang.isEmpty {
            Text(lang.lowercased())
                .font(.caption)
                .foregroundColor(.clawdbotTextSecondary)
        }
        Spacer()
        copyButton
    }
    .padding(.horizontal, 12)
    .padding(.vertical, 8)
    .background(Color.clawdbotSurfaceElevated)
}
```

**Commit after completion:** `feat(06-02): create CodeBlockView component`

### Task 3: Implement copy-to-clipboard functionality

Add copy button with visual feedback:

```swift
@State private var copied = false

private var copyButton: some View {
    Button(action: copyToClipboard) {
        HStack(spacing: 4) {
            Image(systemName: copied ? "checkmark" : "doc.on.doc")
            Text(copied ? "Copied" : "Copy")
        }
        .font(.caption)
        .foregroundColor(copied ? .clawdbotGreen : .clawdbotTextSecondary)
    }
    .buttonStyle(.plain)
}

private func copyToClipboard() {
    #if os(iOS)
    UIPasteboard.general.string = code
    #elseif os(macOS)
    NSPasteboard.general.clearContents()
    NSPasteboard.general.setString(code, forType: .string)
    #endif

    withAnimation(.clawdbotSpring) {
        copied = true
    }
    // Reset after 2 seconds
    DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
        withAnimation(.clawdbotSpring) {
            copied = false
        }
    }
}
```

**Commit after completion:** `feat(06-02): add copy-to-clipboard for code blocks`

### Task 4: Implement lightweight syntax highlighting

Create `Sources/ClawdbotKit/Chat/SyntaxHighlighter.swift`:

```swift
import SwiftUI

/// Lightweight regex-based syntax highlighting
enum SyntaxHighlighter {
    /// Highlights code and returns attributed string
    static func highlight(_ code: String, language: String?) -> AttributedString {
        var result = AttributedString(code)

        // Apply patterns based on language
        let patterns = getPatterns(for: language)
        for pattern in patterns {
            applyHighlighting(&result, pattern: pattern)
        }

        return result
    }
}
```

Pattern categories to support:
1. **Keywords** (purple): `func`, `var`, `let`, `if`, `else`, `return`, `import`, etc.
2. **Strings** (blue): `"..."` and `'...'`
3. **Comments** (secondary): `//...` and `/* ... */`
4. **Numbers** (amber): `\d+`, `0x[0-9a-f]+`
5. **Types** (green): `[A-Z][a-zA-Z0-9]+` (PascalCase)

Language detection heuristics:
- `swift`, `kotlin`, `java` → C-family patterns
- `python`, `ruby` → Script patterns
- `json` → No keywords, strings only
- `bash`, `sh` → Shell patterns
- Unknown → Generic patterns

**Commit after completion:** `feat(06-02): implement lightweight syntax highlighting`

### Task 5: Integrate CodeBlockView into MarkdownContent

Update MarkdownContent to render code blocks:

```swift
@ViewBuilder
private func renderBlock(_ block: ContentBlock) -> some View {
    switch block {
    case .paragraph(let text):
        renderParagraph(text)
    case .bulletList(let items):
        renderBulletList(items)
    case .codeBlock(let code, let language):
        CodeBlockView(code: code, language: language, isStreaming: isStreaming)
            .padding(.vertical, 4)
    }
}
```

Add `isStreaming` parameter to MarkdownContent:
```swift
public struct MarkdownContent: View {
    let content: String
    let baseTextColor: Color
    let isStreaming: Bool

    public init(
        content: String,
        textColor: Color = .clawdbotTextPrimary,
        isStreaming: Bool = false
    ) { ... }
}
```

Update MessageBubble to pass streaming state.

**Commit after completion:** `feat(06-02): integrate CodeBlockView into MarkdownContent`

### Task 6: Handle streaming code blocks

Add streaming support to CodeBlockView:

1. Partial code block detection:
```swift
// Detect opening ``` without closing
private func isPartialCodeBlock(_ content: String) -> Bool {
    let openCount = content.components(separatedBy: "```").count - 1
    return openCount % 2 == 1  // Odd number means unclosed
}
```

2. Streaming visual indicator:
```swift
private var codeContent: some View {
    VStack(alignment: .leading, spacing: 0) {
        Text(highlightedCode)
            .font(.system(.body, design: .monospaced))

        if isStreaming {
            HStack(spacing: 4) {
                ForEach(0..<3) { i in
                    Circle()
                        .fill(Color.clawdbotTextMuted)
                        .frame(width: 4, height: 4)
                }
            }
            .padding(.top, 4)
        }
    }
    .padding(12)
}
```

3. Don't show copy button while streaming (code is incomplete)

**Commit after completion:** `feat(06-02): add streaming support for code blocks`

### Task 7: Add code block tests

Create/update `Tests/ClawdbotKitTests/CodeBlockTests.swift`:

Test cases:
1. Single code block detection and extraction
2. Code block with language hint parsed correctly
3. Code block without language hint
4. Multiple code blocks in content
5. Unclosed code block during streaming
6. Copy button triggers clipboard write
7. Syntax highlighting applies colors correctly
8. Swift keywords highlighted as purple
9. String literals highlighted as blue
10. Mixed content: paragraphs + code blocks

**Commit after completion:** `test(06-02): add code block unit tests`

## Verification

```bash
cd apps/ios/ClawdbotKit
swift test --filter CodeBlock
swift test --filter SyntaxHighlight
swift build
```

Expected: All tests pass, no warnings

## Success Criteria

- [ ] Fenced code blocks (```) detected and rendered
- [ ] Language labels displayed when provided
- [ ] Copy button copies code to clipboard with visual feedback
- [ ] Syntax highlighting applies to keywords, strings, comments, numbers
- [ ] Streaming code blocks show loading indicator
- [ ] Copy button hidden during streaming
- [ ] 10+ new tests for code blocks
- [ ] All existing tests pass

## Output

Files created:
- `Sources/ClawdbotKit/Chat/CodeBlockView.swift`
- `Sources/ClawdbotKit/Chat/SyntaxHighlighter.swift`
- `Tests/ClawdbotKitTests/CodeBlockTests.swift`

Files modified:
- `Sources/ClawdbotKit/Chat/MarkdownContent.swift`
- `Sources/ClawdbotKit/Chat/MessageBubble.swift`

---
*Phase: 06-rich-text*
*Plan: 02 of 03*
*Wave: 2*
