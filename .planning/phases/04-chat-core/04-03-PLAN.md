---
phase: 04-chat-core
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/MessageStore.swift
  - apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/ChatViewModel.swift
  - apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/Chat.swift
  - apps/ios/ClawdbotKit/Tests/ClawdbotKitTests/MessageStoreTests.swift
autonomous: true
---

<objective>
Add message persistence and history loading for conversation continuity.

Purpose: Messages survive app restarts. Users return to their conversation where they left off.
Output: MessageStore actor with file-based persistence, integrated into ChatViewModel.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Required - modifies ChatViewModel from 04-01
@.planning/phases/04-chat-core/04-01-SUMMARY.md

# Research findings
@.planning/phases/04-chat-core/04-RESEARCH.md

# Existing message types
@apps/ios/ClawdbotKit/Sources/ClawdbotKit/Protocol/MessageTypes.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MessageStore actor</name>
  <files>apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/MessageStore.swift</files>
  <action>
Create MessageStore as an actor for thread-safe message persistence:

1. Storage strategy:
   - Use JSON file in Application Support directory
   - One file per conversation (prepare for multi-bot in Phase 9)
   - File name: "messages_{conversationId}.json"

2. Properties:
   - private let fileManager = FileManager.default
   - private let encoder = JSONEncoder()
   - private let decoder = JSONDecoder()
   - private var cachedMessages: [ChatMessage] = []

3. Initialization:
   - init(conversationId: String = "default")
   - Configure encoder/decoder for ISO8601 dates (same as ProtocolCodec)
   - Load existing messages from disk on init

4. Public API:
   ```swift
   public func loadMessages() async -> [ChatMessage]
   public func save(_ message: ChatMessage) async
   public func saveAll(_ messages: [ChatMessage]) async
   public func clearHistory() async
   ```

5. File operations:
   - Get Application Support URL: fileManager.urls(for: .applicationSupportDirectory, in: .userDomainMask)
   - Create directory if needed
   - Read/write using Data and Codable

6. Error handling:
   - Log errors but don't throw - persistence failures shouldn't crash chat
   - Return empty array if file doesn't exist (new conversation)

7. Memory management:
   - Keep cachedMessages in memory after load
   - Write-through cache: update cache AND disk on save
   - Consider limiting history size (e.g., last 1000 messages) for Phase 4
  </action>
  <verify>swift build compiles MessageStore</verify>
  <done>MessageStore actor with file-based JSON persistence and in-memory cache</done>
</task>

<task type="auto">
  <name>Task 2: Integrate MessageStore into ChatViewModel</name>
  <files>apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/ChatViewModel.swift</files>
  <action>
Modify ChatViewModel to use MessageStore for persistence:

1. Add dependency:
   - private let messageStore: MessageStore

2. Update init:
   - Accept MessageStore as parameter (with default value for convenience)
   - Call loadHistory() during setup

3. Add loadHistory() method:
   ```swift
   private func loadHistory() {
       Task {
           isLoading = true
           let stored = await messageStore.loadMessages()
           messages = stored
           isLoading = false
       }
   }
   ```

4. Modify send() to persist:
   - After appending message to array, also save to store
   ```swift
   messages.append(message)
   Task { await messageStore.save(message) }
   ```

5. Persist incoming messages:
   - In the Combine sink for incomingMessages:
   - After appending, save to store

6. Handle loading state:
   - ChatView should show loading indicator while isLoading == true
   - Use ProgressView() or similar

7. Deduplication on load:
   - Messages from store might overlap with Combine stream on reconnect
   - Use Set<MessageID> or check before appending
  </action>
  <verify>swift build compiles modified ChatViewModel</verify>
  <done>ChatViewModel loads history on init and persists all messages</done>
</task>

<task type="auto">
  <name>Task 3: Update Chat module exports</name>
  <files>apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/Chat.swift</files>
  <action>
Update Chat.swift to export MessageStore:

1. Add MessageStore to public exports
2. Ensure all public types from Chat folder are accessible

This is a small change but ensures the module is properly organized.
  </action>
  <verify>Import ClawdbotKit and access MessageStore</verify>
  <done>MessageStore exported from ClawdbotKit module</done>
</task>

<task type="auto">
  <name>Task 4: Add MessageStore tests</name>
  <files>apps/ios/ClawdbotKit/Tests/ClawdbotKitTests/MessageStoreTests.swift</files>
  <action>
Create comprehensive tests for MessageStore:

1. Test save and load:
   - Save a message, create new store instance, load messages
   - Verify message content matches

2. Test persistence across instances:
   - Create store, save messages, deallocate
   - Create new store with same conversationId
   - Verify messages load correctly

3. Test empty state:
   - New store with unknown conversationId
   - loadMessages() should return empty array, not error

4. Test clearHistory:
   - Save messages, call clearHistory(), verify empty

5. Test date encoding:
   - Save message with specific timestamp
   - Load and verify timestamp matches (ISO8601 precision)

6. Use temp directory for tests:
   - Don't pollute actual Application Support
   - Create temp directory, pass to store, clean up after

Use XCTest, follow existing test patterns.
  </action>
  <verify>swift test --filter MessageStoreTests</verify>
  <done>At least 4 tests covering save/load, persistence, empty state, and clearHistory</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] swift build succeeds in ClawdbotKit
- [ ] swift test passes for MessageStoreTests
- [ ] Messages persist to Application Support directory
- [ ] App restart loads previous messages
- [ ] No data loss on normal app lifecycle
</verification>

<success_criteria>

- All tasks completed with passing builds/tests
- MessageStore correctly persists to JSON file
- ChatViewModel loads history on initialization
- All sent/received messages are persisted
- Deduplication prevents double messages on reconnect
- File operations don't block UI (actor isolation)
</success_criteria>

<output>
After completion, create `.planning/phases/04-chat-core/04-03-SUMMARY.md`
</output>
