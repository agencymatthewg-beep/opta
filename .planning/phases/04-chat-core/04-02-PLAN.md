---
phase: 04-chat-core
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/ChatInputBar.swift
  - apps/ios/Clawdbot iOS/Views/ChatView.swift
autonomous: false
---

<objective>
Add message input with keyboard handling and send functionality.

Purpose: Complete the send-receive loop. Users can type and send messages with proper keyboard behavior.
Output: ChatInputBar component with focus management, integrated into ChatView with safeAreaInset.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Required - builds on 04-01
@.planning/phases/04-chat-core/04-01-SUMMARY.md

# Research findings for keyboard patterns
@.planning/phases/04-chat-core/04-RESEARCH.md

# Files we're modifying
@apps/ios/Clawdbot iOS/Views/ChatView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChatInputBar component</name>
  <files>apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/ChatInputBar.swift</files>
  <action>
Create ChatInputBar as a focused, minimal input component:

1. Properties:
   - @Binding var text: String
   - @FocusState.Binding var isFocused: Bool
   - let onSend: () -> Void
   - let isEnabled: Bool (for connection state)

2. Layout (HStack):
   - TextField("Message", text: $text)
   - Send button with arrow.up.circle.fill icon

3. TextField configuration:
   - .focused($isFocused)
   - .onSubmit { guard !text.isEmpty else { return }; onSend() }
   - .submitLabel(.send)
   - .textInputAutocapitalization(.sentences)
   - .autocorrectionDisabled(false)

4. Send button:
   - Button(action: { guard !text.isEmpty else { return }; onSend() })
   - Image(systemName: "arrow.up.circle.fill")
   - .disabled(text.isEmpty || !isEnabled)
   - .font(.title2) for good tap target
   - Color: OptaColors.Brand.teal when enabled, OptaColors.Text.tertiary when disabled

5. Styling:
   - .padding(.horizontal, 12)
   - .padding(.vertical, 8)
   - .background(.bar) for system blur effect
   - NO explicit height - let content determine

Keep focus after sending for rapid messaging (don't dismiss keyboard).
  </action>
  <verify>swift build compiles ChatInputBar</verify>
  <done>ChatInputBar component with TextField, FocusState binding, and styled send button</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ChatInputBar into ChatView</name>
  <files>apps/ios/Clawdbot iOS/Views/ChatView.swift</files>
  <action>
Modify ChatView to add the input bar using safeAreaInset:

1. Add new state properties:
   - @State private var inputText = ""
   - @FocusState private var isInputFocused: Bool

2. Add safeAreaInset modifier to ScrollView:
   ```swift
   .safeAreaInset(edge: .bottom, spacing: 0) {
       VStack(spacing: 0) {
           Divider()
           ChatInputBar(
               text: $inputText,
               isFocused: $isInputFocused,
               onSend: sendMessage,
               isEnabled: viewModel.connectionState == .connected
           )
       }
   }
   ```

3. Create sendMessage() function:
   ```swift
   private func sendMessage() {
       let text = inputText.trimmingCharacters(in: .whitespacesAndNewlines)
       guard !text.isEmpty else { return }
       inputText = ""
       Task {
           await viewModel.send(text)
       }
   }
   ```

4. Keep input focused after send:
   - Do NOT set isInputFocused = false after sending
   - Users should be able to send multiple messages rapidly

5. IMPORTANT - Keyboard safe area:
   - Do NOT use .ignoresSafeArea(.keyboard)
   - SwiftUI + safeAreaInset handles keyboard automatically
   - The scroll view will shrink and input bar stays above keyboard
  </action>
  <verify>xcodebuild -scheme "Clawdbot iOS" build succeeds</verify>
  <done>ChatView has working input bar with keyboard-aware layout</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Chat input with keyboard handling and send functionality</what-built>
  <how-to-verify>
    1. Run: Open Xcode, select "Clawdbot iOS" scheme, run on iOS Simulator
    2. Navigate to ChatView (may need to add to app entry point)
    3. Tap the input field - keyboard should appear
    4. Input bar should stay ABOVE keyboard (not hidden)
    5. Type a message and tap Send or press Return
    6. Message should appear in the list immediately (optimistic update)
    7. Keyboard should remain open after sending
    8. Verify messages scroll correctly when keyboard is open
    9. Tap outside input to dismiss keyboard - input bar should move down smoothly
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any keyboard/input issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] xcodebuild succeeds for Clawdbot iOS
- [ ] Input bar visible at bottom of chat
- [ ] Keyboard appears/dismisses smoothly
- [ ] Input bar stays above keyboard when typing
- [ ] Messages can be sent and appear in list
- [ ] Human verification checkpoint passed
</verification>

<success_criteria>

- All tasks completed with passing builds
- ChatInputBar is a reusable component in ClawdbotKit
- Keyboard handling works correctly on iOS Simulator
- No keyboard-related jank or input bar hiding
- User approved the input experience
</success_criteria>

<output>
After completion, create `.planning/phases/04-chat-core/04-02-SUMMARY.md`
</output>
