# Plan 07-01: Dynamic Table Component

**Phase**: 7 - Rich Output: Visual
**Wave**: 1
**Autonomous**: true
**Tests Required**: true

## Objective

Create a dynamic table rendering component that parses markdown tables and renders them as scrollable, styled SwiftUI views. Tables should support variable column widths, headers, alignment, and integrate seamlessly with the existing ContentBlock parsing system.

## Context

### Current State
- `ContentBlock` enum in `MarkdownContent.swift` handles: `.paragraph`, `.bulletList`, `.codeBlock`, `.collapsible`
- `parseBlocks()` method in `MarkdownContent` parses content into blocks
- Message content can contain markdown tables from bot responses

### Integration Point
Add `.table` case to `ContentBlock` enum and extend `parseBlocks()` to detect markdown table syntax.

## Tasks

### Task 1: Define TableData model and ContentBlock.table case
**File**: `Shared/Sources/OptaMolt/Chat/MarkdownContent.swift`

Add table case to ContentBlock:
```swift
case table(TableData)
```

Create TableData struct:
```swift
public struct TableData: Equatable {
    public let headers: [String]
    public let rows: [[String]]
    public let alignments: [TableAlignment]

    public enum TableAlignment: Equatable {
        case left, center, right
    }
}
```

### Task 2: Implement markdown table detection in parseBlocks
**File**: `Shared/Sources/OptaMolt/Chat/MarkdownContent.swift`

Extend `parseBlocks()` to detect markdown table syntax:
- Header row: `| Col1 | Col2 | Col3 |`
- Separator row: `|------|:----:|-----:|` (alignment indicators)
- Data rows: `| val1 | val2 | val3 |`

Handle:
- Variable number of columns
- Alignment detection (`:---` left, `:---:` center, `---:` right)
- Missing alignment row (default to left)
- Streaming resilience (partial tables during streaming)

### Task 3: Create TableView component
**File**: `Shared/Sources/OptaMolt/Chat/TableView.swift` (new file)

Create SwiftUI view for rendering tables:
```swift
public struct TableView: View {
    let data: TableData
    let textColor: Color

    public init(data: TableData, textColor: Color = .optaTextPrimary)
}
```

Features:
- Fixed header row with `.glassSubtle()` background
- Alternating row colors (odd/even)
- Horizontal scroll for wide tables
- Column width based on content (min 60pt, max 200pt)
- Cell padding (8pt horizontal, 6pt vertical)
- Thin border separators (0.5pt, `optaSurface` color)

### Task 4: Apply Opta styling to TableView
**File**: `Shared/Sources/OptaMolt/Chat/TableView.swift`

Apply design system:
- Header text: Sora medium, `optaTextPrimary`
- Cell text: Sora regular, `optaTextSecondary`
- Header background: `.glassSubtle()`
- Cell background: alternating `optaSurface.opacity(0.3)` / clear
- Border color: `optaSurface`
- Corner radius: 8pt (outer container)

### Task 5: Integrate TableView into MarkdownContent rendering
**File**: `Shared/Sources/OptaMolt/Chat/MarkdownContent.swift`

Add case to `renderBlock()`:
```swift
case .table(let data):
    TableView(data: data, textColor: baseTextColor)
        .padding(.vertical, 4)
```

### Task 6: Add streaming resilience for partial tables
**File**: `Shared/Sources/OptaMolt/Chat/MarkdownContent.swift`

Handle incomplete tables during streaming:
- Single header row without data: render header-only table
- Partial rows: render complete rows, ignore incomplete last row
- No separator row: treat as regular content

### Task 7: Add unit tests for table parsing and TableView
**File**: `Shared/Tests/OptaMoltTests/TableViewTests.swift` (new file)

Test cases:
- Parse simple 2x2 table
- Parse table with 5+ columns
- Parse table with alignment markers
- Parse table missing separator row
- Streaming partial table handling
- Empty table handling
- TableData equality
- TableView construction with various data

Minimum: 15 test cases

## Verification

```bash
cd apps/OptaMolt/Shared
swift build
swift build --build-tests
swift test --filter TableViewTests
```

## Success Criteria

- [ ] ContentBlock.table case added
- [ ] TableData model with headers, rows, alignments
- [ ] parseBlocks() detects markdown tables
- [ ] TableView renders with Opta styling
- [ ] Horizontal scroll for wide tables
- [ ] Streaming resilience for partial tables
- [ ] 15+ table tests passing
- [ ] All existing tests still pass

## Files

| File | Action |
|------|--------|
| `Shared/Sources/OptaMolt/Chat/MarkdownContent.swift` | Modify |
| `Shared/Sources/OptaMolt/Chat/TableView.swift` | Create |
| `Shared/Tests/OptaMoltTests/TableViewTests.swift` | Create |

## Output

- `TableView.swift` component (est. 150-200 lines)
- Extended `ContentBlock` with `.table` case
- Table parsing in `parseBlocks()`
- `TableViewTests.swift` (est. 200-250 lines)
