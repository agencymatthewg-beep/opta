# Plan 07-03: Inline Image Loading and Caching

**Phase**: 7 - Rich Output: Visual
**Wave**: 2
**Autonomous**: true
**Tests Required**: true

## Objective

Create an inline image component that loads, caches, and displays images from URLs within chat messages. Support progressive loading with placeholders, zoom interaction, and persistent disk caching for offline access.

## Context

### Current State
- Bot responses can include markdown images: `![alt text](url)`
- `ContentBlock` enum handles rich content types
- No current image handling in markdown parser

### Image Sources
- Remote URLs (https://...)
- Clawdbot-generated images (via DALL-E, Midjourney integrations)
- Inline base64 data URLs (data:image/png;base64,...)

### Integration Point
Add `.image` case to `ContentBlock` and detect markdown image syntax in parsing.

## Tasks

### Task 1: Define ImageData model and ContentBlock.image case
**File**: `Shared/Sources/OptaMolt/Chat/MarkdownContent.swift`

Add image case to ContentBlock:
```swift
case image(ImageData)
```

Create ImageData struct:
```swift
public struct ImageData: Equatable {
    public let url: URL
    public let altText: String
    public let caption: String?
}
```

### Task 2: Implement markdown image detection in parseBlocks
**File**: `Shared/Sources/OptaMolt/Chat/MarkdownContent.swift`

Extend parsing to detect image syntax:
- Standard: `![alt text](url)`
- With title: `![alt text](url "optional caption")`
- Inline in paragraphs or standalone

Handle:
- Extract alt text, URL, optional caption
- Validate URL format
- Fall back to showing raw markdown if invalid

### Task 3: Create ImageCache actor for disk caching
**File**: `Shared/Sources/OptaMolt/Chat/ImageCache.swift` (new file)

Create actor for thread-safe image caching:
```swift
public actor ImageCache {
    public static let shared = ImageCache()

    public func image(for url: URL) async throws -> Image
    public func prefetch(urls: [URL]) async
    public func clearCache() async
}
```

Implementation:
- Memory cache: `NSCache<NSString, CGImage>` (50 items max)
- Disk cache: `Application Support/OptaMolt/ImageCache/`
- Cache key: SHA256 hash of URL
- Max disk cache size: 100MB
- LRU eviction policy

### Task 4: Create AsyncImageView component
**File**: `Shared/Sources/OptaMolt/Chat/AsyncImageView.swift` (new file)

Create SwiftUI view for async image loading:
```swift
public struct AsyncImageView: View {
    let data: ImageData

    public init(data: ImageData)
}
```

States:
- Loading: Shimmer placeholder with `.glassSubtle()`
- Loaded: Image with smooth fade-in
- Error: Error icon with retry button

### Task 5: Apply Opta styling to AsyncImageView
**File**: `Shared/Sources/OptaMolt/Chat/AsyncImageView.swift`

Apply design system:
- Corner radius: 12pt
- Max width: fill container
- Max height: 300pt (aspect ratio preserved)
- Loading shimmer: gradient animation
- Caption text: Sora regular, `optaTextSecondary`, below image
- Error state: `optaRed` icon with retry

### Task 6: Add zoom/expand interaction
**File**: `Shared/Sources/OptaMolt/Chat/AsyncImageView.swift`

Implement image interaction:
- Tap to expand to fullscreen overlay
- Pinch-to-zoom in fullscreen
- Double-tap to toggle zoom level
- Swipe down to dismiss
- Share button in fullscreen

### Task 7: Integrate AsyncImageView into MarkdownContent rendering
**File**: `Shared/Sources/OptaMolt/Chat/MarkdownContent.swift`

Add case to `renderBlock()`:
```swift
case .image(let data):
    AsyncImageView(data: data)
        .padding(.vertical, 8)
```

### Task 8: Add prefetching for visible images
**File**: `Shared/Sources/OptaMolt/Chat/ChatViewModel.swift`

Add image prefetching:
- When messages load, scan for image URLs
- Prefetch visible + next 5 images
- Cancel prefetch for scrolled-away images

### Task 9: Add unit tests for image parsing and caching
**File**: `Shared/Tests/OptaMoltTests/AsyncImageViewTests.swift` (new file)

Test cases:
- Parse simple markdown image
- Parse image with caption
- Parse image in paragraph
- ImageData equality
- Invalid URL handling
- ImageCache memory operations
- ImageCache disk operations
- Cache key generation
- Multiple concurrent loads
- Error state handling

Minimum: 15 test cases

## Verification

```bash
cd apps/OptaMolt/Shared
swift build
swift build --build-tests
swift test --filter AsyncImageViewTests
```

## Success Criteria

- [ ] ContentBlock.image case added
- [ ] ImageData model with url, altText, caption
- [ ] parseBlocks() detects markdown images
- [ ] AsyncImageView renders with placeholder â†’ loaded states
- [ ] ImageCache with memory + disk caching
- [ ] Zoom/expand interaction works
- [ ] Prefetching improves perceived performance
- [ ] 15+ image tests passing
- [ ] All existing tests still pass

## Files

| File | Action |
|------|--------|
| `Shared/Sources/OptaMolt/Chat/MarkdownContent.swift` | Modify |
| `Shared/Sources/OptaMolt/Chat/ImageCache.swift` | Create |
| `Shared/Sources/OptaMolt/Chat/AsyncImageView.swift` | Create |
| `Shared/Sources/OptaMolt/Chat/ChatViewModel.swift` | Modify |
| `Shared/Tests/OptaMoltTests/AsyncImageViewTests.swift` | Create |

## Output

- `ImageCache.swift` actor (est. 120-150 lines)
- `AsyncImageView.swift` component (est. 200-250 lines)
- Extended `ContentBlock` with `.image` case
- Image parsing in `parseBlocks()`
- `AsyncImageViewTests.swift` (est. 220-280 lines)
