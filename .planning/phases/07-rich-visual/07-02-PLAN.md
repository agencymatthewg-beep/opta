# Plan 07-02: Interactive Graph Rendering

**Phase**: 7 - Rich Output: Visual
**Wave**: 2
**Autonomous**: true
**Tests Required**: true

## Objective

Create an interactive chart rendering component using Swift Charts that parses chart data from bot responses and renders bar charts, line charts, and pie charts. Charts should support touch interaction, legends, and integrate with the ContentBlock system.

## Context

### Current State
- Swift Charts is available in iOS 16+ / macOS 13+ (we target iOS 17+ / macOS 14+)
- `ContentBlock` enum handles rich content types
- Bot responses can include structured chart data in JSON or markdown format

### Chart Data Format
Bots will send chart data in a code block with `chart` language:
```chart
{
  "type": "bar",
  "title": "Monthly Sales",
  "data": [
    {"label": "Jan", "value": 100},
    {"label": "Feb", "value": 150}
  ]
}
```

### Integration Point
Add `.chart` case to `ContentBlock` and detect `chart` code blocks in parsing.

## Tasks

### Task 1: Define ChartData model and ContentBlock.chart case
**File**: `Shared/Sources/OptaMolt/Chat/MarkdownContent.swift`

Add chart case to ContentBlock:
```swift
case chart(ChartData)
```

Create ChartData struct:
```swift
public struct ChartData: Equatable, Codable {
    public let type: ChartType
    public let title: String?
    public let data: [ChartDataPoint]

    public enum ChartType: String, Codable, Equatable {
        case bar, line, pie
    }

    public struct ChartDataPoint: Equatable, Codable {
        public let label: String
        public let value: Double
        public let color: String?  // Optional hex color
    }
}
```

### Task 2: Implement chart block detection in parseBlocks
**File**: `Shared/Sources/OptaMolt/Chat/MarkdownContent.swift`

Extend code block handling to detect `chart` language:
- When `codeBlockLanguage == "chart"`, parse JSON content
- Decode into `ChartData` using JSONDecoder
- Fall back to regular code block if parsing fails

### Task 3: Create ChartView component with Swift Charts
**File**: `Shared/Sources/OptaMolt/Chat/ChartView.swift` (new file)

Create SwiftUI view using Swift Charts:
```swift
import Charts

public struct ChartView: View {
    let data: ChartData

    public init(data: ChartData)
}
```

Implement chart types:
- **Bar Chart**: `BarMark` with category labels
- **Line Chart**: `LineMark` with `PointMark` overlays
- **Pie Chart**: `SectorMark` with percentages

### Task 4: Apply Opta styling to ChartView
**File**: `Shared/Sources/OptaMolt/Chat/ChartView.swift`

Apply design system:
- Chart title: Sora semibold, `optaTextPrimary`
- Axis labels: Sora regular, `optaTextSecondary`
- Default bar color: `optaPurple`
- Line color: `optaCyan` with gradient fill
- Pie colors: Cycle through `optaPurple`, `optaCyan`, `optaGreen`, `optaIndigo`
- Background: `.glassSubtle()` container
- Corner radius: 12pt
- Min height: 200pt
- Max height: 300pt

### Task 5: Add touch interaction and legends
**File**: `Shared/Sources/OptaMolt/Chat/ChartView.swift`

Implement interactivity:
- `chartOverlay` for touch detection
- Show value tooltip on tap/hover
- Legend for pie charts showing label + percentage
- Axis labels with proper formatting

### Task 6: Add animation for chart appearance
**File**: `Shared/Sources/OptaMolt/Chat/ChartView.swift`

Apply Opta animations:
- Use `.ignition()` modifier for chart entrance
- Animate bar heights from 0
- Animate line drawing path
- Animate pie sector expansion

### Task 7: Integrate ChartView into MarkdownContent rendering
**File**: `Shared/Sources/OptaMolt/Chat/MarkdownContent.swift`

Update `parseBlocks()` to handle chart code blocks.
Add case to `renderBlock()`:
```swift
case .chart(let data):
    ChartView(data: data)
        .padding(.vertical, 8)
```

### Task 8: Add unit tests for chart parsing and ChartView
**File**: `Shared/Tests/OptaMoltTests/ChartViewTests.swift` (new file)

Test cases:
- Parse bar chart JSON
- Parse line chart JSON
- Parse pie chart JSON
- ChartData decoding with all fields
- ChartData decoding with optional fields
- Invalid JSON falls back to code block
- ChartType enum cases
- ChartDataPoint equality
- ChartView construction for each type

Minimum: 12 test cases

## Verification

```bash
cd apps/OptaMolt/Shared
swift build
swift build --build-tests
swift test --filter ChartViewTests
```

## Success Criteria

- [ ] ContentBlock.chart case added
- [ ] ChartData model with type, title, data points
- [ ] parseBlocks() detects `chart` code blocks
- [ ] Bar chart renders with Swift Charts
- [ ] Line chart renders with Swift Charts
- [ ] Pie chart renders with Swift Charts
- [ ] Touch interaction shows tooltips
- [ ] Opta styling applied (colors, glass, animations)
- [ ] 12+ chart tests passing
- [ ] All existing tests still pass

## Files

| File | Action |
|------|--------|
| `Shared/Sources/OptaMolt/Chat/MarkdownContent.swift` | Modify |
| `Shared/Sources/OptaMolt/Chat/ChartView.swift` | Create |
| `Shared/Tests/OptaMoltTests/ChartViewTests.swift` | Create |

## Dependencies

- Swift Charts framework (built into iOS 16+/macOS 13+)

## Output

- `ChartView.swift` component (est. 250-350 lines)
- Extended `ContentBlock` with `.chart` case
- Chart JSON parsing in `parseBlocks()`
- `ChartViewTests.swift` (est. 180-220 lines)
