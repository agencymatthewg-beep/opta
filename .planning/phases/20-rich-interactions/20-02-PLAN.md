# Plan 20-02: Drag & Drop Process Management

**Phase:** 20 - Rich Interactions
**Feature:** Accessible Drag-Drop for ProcessList
**Scope:** Medium (2-3 days)
**Dependencies:** None

---

## Summary

Add accessible drag-and-drop to ProcessList using dnd-kit. Users can drag processes to a "quarantine zone" to terminate them, or reorder priority. Full keyboard support included for accessibility.

---

## Why This Matters

- **Direct manipulation** - Dragging feels more natural than clicking buttons
- **Accessibility** - dnd-kit includes keyboard navigation (HTML5 drag API doesn't)
- **Visual feedback** - Drag preview shows what's happening
- **Power user efficiency** - Bulk operations via multi-select drag

---

## Implementation Tasks

### Task 1: Install dnd-kit packages
**File:** `package.json`

**Actions:**
1. Install core dnd-kit packages: `npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities`
2. Verify installation succeeds

**Verification:** Packages appear in package.json, no install errors

---

### Task 2: Create DndContext wrapper component
**File:** `src/components/DragDrop/DragDropContext.tsx`

**Actions:**
1. Create `src/components/DragDrop/` directory
2. Create context wrapper that provides DndContext
3. Add collision detection strategy (closestCenter for lists)
4. Add sensors (pointer, keyboard with activationConstraint)

**Code pattern:**
```tsx
// src/components/DragDrop/DragDropContext.tsx
import {
  DndContext,
  DragEndEvent,
  DragOverEvent,
  DragStartEvent,
  PointerSensor,
  KeyboardSensor,
  useSensor,
  useSensors,
  closestCenter,
} from '@dnd-kit/core';
import { sortableKeyboardCoordinates } from '@dnd-kit/sortable';

interface DragDropContextProps {
  children: React.ReactNode;
  onDragStart?: (event: DragStartEvent) => void;
  onDragOver?: (event: DragOverEvent) => void;
  onDragEnd?: (event: DragEndEvent) => void;
}

export function DragDropContext({ children, onDragStart, onDragOver, onDragEnd }: DragDropContextProps) {
  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: { distance: 8 }, // Prevent accidental drags
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={closestCenter}
      onDragStart={onDragStart}
      onDragOver={onDragOver}
      onDragEnd={onDragEnd}
    >
      {children}
    </DndContext>
  );
}
```

**Verification:** Context renders children, no console errors

---

### Task 3: Create DraggableProcess component
**File:** `src/components/DragDrop/DraggableProcess.tsx`

**Actions:**
1. Create draggable wrapper using useDraggable hook
2. Apply transform styles during drag
3. Add drag handle (grip icon) that triggers drag
4. Style drag state with elevated appearance

**Code pattern:**
```tsx
// src/components/DragDrop/DraggableProcess.tsx
import { useDraggable } from '@dnd-kit/core';
import { CSS } from '@dnd-kit/utilities';
import { GripVertical } from 'lucide-react';
import { cn } from '@/lib/utils';

interface DraggableProcessProps {
  id: string;
  children: React.ReactNode;
  disabled?: boolean;
}

export function DraggableProcess({ id, children, disabled }: DraggableProcessProps) {
  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id,
    disabled,
  });

  const style = {
    transform: CSS.Translate.toString(transform),
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={cn(
        'relative',
        isDragging && 'z-50 opacity-90 shadow-lg shadow-primary/20 scale-[1.02]'
      )}
    >
      <button
        {...attributes}
        {...listeners}
        className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-full px-1 py-2 opacity-0 group-hover:opacity-100 transition-opacity cursor-grab active:cursor-grabbing"
        aria-label="Drag to reorder"
      >
        <GripVertical className="w-4 h-4 text-muted-foreground" />
      </button>
      {children}
    </div>
  );
}
```

**Verification:** Drag handle appears on hover, dragging works with mouse and keyboard

---

### Task 4: Create DroppableZone component (Quarantine)
**File:** `src/components/DragDrop/DroppableZone.tsx`

**Actions:**
1. Create droppable zone using useDroppable hook
2. Style with destructive appearance when process hovers
3. Show visual feedback (border glow, icon change)
4. Include ARIA description for screen readers

**Code pattern:**
```tsx
// src/components/DragDrop/DroppableZone.tsx
import { useDroppable } from '@dnd-kit/core';
import { Ban } from 'lucide-react';
import { cn } from '@/lib/utils';
import { motion, AnimatePresence } from 'framer-motion';

interface DroppableZoneProps {
  id: string;
  label: string;
  icon?: React.ReactNode;
  variant?: 'default' | 'destructive';
}

export function DroppableZone({ id, label, icon, variant = 'default' }: DroppableZoneProps) {
  const { isOver, setNodeRef } = useDroppable({ id });

  const variants = {
    default: 'border-border/30 hover:border-primary/50',
    destructive: cn(
      'border-danger/30',
      isOver && 'border-danger bg-danger/10 shadow-[0_0_20px_rgba(239,68,68,0.15)]'
    ),
  };

  return (
    <motion.div
      ref={setNodeRef}
      className={cn(
        'glass-subtle rounded-lg border-2 border-dashed p-4 flex items-center justify-center gap-2',
        'transition-colors duration-200',
        variants[variant]
      )}
      animate={{ scale: isOver ? 1.02 : 1 }}
      transition={{ duration: 0.15 }}
      role="region"
      aria-label={label}
      aria-dropeffect="execute"
    >
      {icon || <Ban className={cn('w-5 h-5', isOver ? 'text-danger' : 'text-muted-foreground')} />}
      <span className={cn('text-sm font-medium', isOver ? 'text-danger' : 'text-muted-foreground')}>
        {label}
      </span>
    </motion.div>
  );
}
```

**Verification:** Zone highlights when dragging over, correct ARIA attributes

---

### Task 5: Integrate with ProcessList
**File:** `src/components/ProcessList.tsx`

**Actions:**
1. Wrap ProcessList table with DragDropContext
2. Wrap each ProcessRow with DraggableProcess
3. Add quarantine DroppableZone below table
4. Handle onDragEnd to terminate dropped processes
5. Add confirmation before terminating system processes

**Integration pattern:**
```tsx
// In ProcessList.tsx
import { DragDropContext } from './DragDrop/DragDropContext';
import { DraggableProcess } from './DragDrop/DraggableProcess';
import { DroppableZone } from './DragDrop/DroppableZone';

function ProcessList() {
  const { processes, killProcess } = useProcesses();

  const handleDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;

    if (over?.id === 'quarantine' && active.id) {
      const process = processes.find(p => p.pid.toString() === active.id);
      if (process?.category === 'system') {
        // Show confirmation modal
        return;
      }
      await killProcess(Number(active.id));
    }
  };

  return (
    <DragDropContext onDragEnd={handleDragEnd}>
      <Table>
        {processes.map(process => (
          <DraggableProcess
            key={process.pid}
            id={process.pid.toString()}
            disabled={process.category === 'system'}
          >
            <ProcessRow process={process} />
          </DraggableProcess>
        ))}
      </Table>

      <DroppableZone
        id="quarantine"
        label="Drop to terminate"
        variant="destructive"
      />
    </DragDropContext>
  );
}
```

**Verification:** Processes draggable, dropping on quarantine terminates process

---

### Task 6: Add drag overlay for better visual feedback
**File:** `src/components/DragDrop/DragDropContext.tsx`

**Actions:**
1. Add DragOverlay component from dnd-kit
2. Render dragged item preview in overlay
3. Style overlay with glass effect and shadow

**Code pattern:**
```tsx
import { DragOverlay } from '@dnd-kit/core';

// Inside DragDropContext:
const [activeId, setActiveId] = useState<string | null>(null);

const handleDragStart = (event: DragStartEvent) => {
  setActiveId(event.active.id as string);
  onDragStart?.(event);
};

const handleDragEnd = (event: DragEndEvent) => {
  setActiveId(null);
  onDragEnd?.(event);
};

return (
  <DndContext {...}>
    {children}
    <DragOverlay>
      {activeId ? renderOverlay(activeId) : null}
    </DragOverlay>
  </DndContext>
);
```

**Verification:** Dragged item shows floating preview, original dims

---

### Task 7: Add keyboard accessibility instructions
**File:** `src/components/DragDrop/DraggableProcess.tsx`

**Actions:**
1. Add screen reader instructions via aria-describedby
2. Include keyboard instructions (Space to pick up, arrows to move, Space to drop)
3. Add live region announcements for drag actions

**Code pattern:**
```tsx
// Hidden instructions for screen readers
<div id="dnd-instructions" className="sr-only">
  Press Space to start dragging. Use arrow keys to move. Press Space to drop.
</div>

// On draggable element:
aria-describedby="dnd-instructions"
```

**Verification:** Screen reader announces drag instructions and state changes

---

### Task 8: Create barrel exports
**File:** `src/components/DragDrop/index.ts`

**Actions:**
1. Export all drag-drop components
2. Export types if any custom types defined

**Verification:** Clean imports work: `import { DragDropContext } from '@/components/DragDrop'`

---

## Verification Checklist

- [ ] dnd-kit packages install successfully
- [ ] Process rows show drag handle on hover
- [ ] Clicking drag handle starts drag (pointer sensor)
- [ ] Space bar on drag handle starts drag (keyboard sensor)
- [ ] Arrow keys move dragged item (keyboard)
- [ ] Dropping on quarantine terminates process
- [ ] System processes cannot be dragged (disabled)
- [ ] User processes can be dragged
- [ ] Quarantine zone highlights red when process hovers
- [ ] Drag overlay shows floating preview
- [ ] Screen reader announces drag state
- [ ] Drag respects reduced motion preference
- [ ] `npm run build` passes with no errors

---

## Files Created/Modified

| File | Action |
|------|--------|
| `package.json` | Add dnd-kit dependencies |
| `src/components/DragDrop/DragDropContext.tsx` | Create |
| `src/components/DragDrop/DraggableProcess.tsx` | Create |
| `src/components/DragDrop/DroppableZone.tsx` | Create |
| `src/components/DragDrop/index.ts` | Create |
| `src/components/ProcessList.tsx` | Modify - add drag support |

---

## Research Reference

From 20-RESEARCH.md:
- Use dnd-kit (not HTML5 Drag API) - keyboard accessible
- Use PointerSensor + KeyboardSensor for dual input
- Use closestCenter collision detection for lists
- Add activation constraint (8px) to prevent accidental drags
- Include ARIA live regions for screen reader announcements

---

*Plan created: 2026-01-17*
*Ready for execution: yes*
