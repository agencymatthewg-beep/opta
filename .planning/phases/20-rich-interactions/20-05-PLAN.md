# Plan 20-05: Accessibility Audit

**Phase:** 20 - Rich Interactions
**Feature:** Comprehensive Accessibility Audit & Fixes
**Scope:** Medium (2-3 days)
**Dependencies:** Plans 20-01 through 20-04 (reviews their implementations)

---

## Summary

Conduct a comprehensive accessibility audit of Opta, focusing on the new rich interaction features and existing components. Ensure WCAG 2.1 AA compliance, VoiceOver support, keyboard navigation, and system preference respect.

---

## Why This Matters

- **Inclusive design** - ~15% of users have some form of disability
- **Legal compliance** - WCAG 2.1 AA is often a requirement
- **Better UX for all** - Accessibility improvements benefit everyone
- **Power users** - Keyboard navigation is accessibility AND efficiency

---

## Implementation Tasks

### Task 1: Create useHighContrast hook
**File:** `src/hooks/useHighContrast.ts`

**Actions:**
1. Create hook that detects prefers-contrast: more
2. Return boolean for high contrast mode
3. Document usage pattern

**Code pattern:**
```typescript
// src/hooks/useHighContrast.ts
import { useState, useEffect } from 'react';

/**
 * Hook to detect if the user prefers high contrast mode.
 * Respects the `prefers-contrast: more` media query.
 *
 * Usage:
 * ```tsx
 * const highContrast = useHighContrast();
 * const borderClass = highContrast ? 'border-white' : 'border-white/10';
 * ```
 */
export function useHighContrast(): boolean {
  const [highContrast, setHighContrast] = useState(false);

  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-contrast: more)');
    setHighContrast(mediaQuery.matches);

    const handler = (event: MediaQueryListEvent) => {
      setHighContrast(event.matches);
    };

    mediaQuery.addEventListener('change', handler);
    return () => mediaQuery.removeEventListener('change', handler);
  }, []);

  return highContrast;
}

export default useHighContrast;
```

**Verification:** Hook returns true when system high contrast enabled

---

### Task 2: Audit and fix useReducedMotion integration
**Files:** All animated components

**Actions:**
1. Verify useReducedMotion is used in all Framer Motion animations
2. Add instant transitions (duration: 0) when reduced motion preferred
3. Check AnimatePresence components
4. Test with System Preferences > Accessibility > Display > Reduce Motion

**Components to audit:**
- CommandPalette (20-01)
- DraggableProcess (20-02)
- DroppableZone (20-02)
- PinchZoomContainer (20-03)
- All existing motion components

**Pattern to apply:**
```tsx
const prefersReducedMotion = useReducedMotion();

<motion.div
  initial={{ opacity: 0, y: prefersReducedMotion ? 0 : 20 }}
  animate={{ opacity: 1, y: 0 }}
  transition={{ duration: prefersReducedMotion ? 0 : 0.3 }}
>
```

**Verification:** Animations disabled when "Reduce Motion" enabled in system

---

### Task 3: Add high contrast style overrides
**File:** `src/index.css`

**Actions:**
1. Add @media (prefers-contrast: more) overrides
2. Increase border contrast for glass elements
3. Increase text contrast for muted elements
4. Test with System Preferences > Accessibility > Display > Increase Contrast

**CSS pattern:**
```css
/* High contrast mode overrides */
@media (prefers-contrast: more) {
  .glass,
  .glass-subtle,
  .glass-strong {
    border-color: rgba(255, 255, 255, 0.3);
  }

  .text-muted-foreground {
    color: rgba(255, 255, 255, 0.8);
  }

  [cmdk-item][data-selected="true"] {
    border: 2px solid var(--primary);
  }

  .border-border\/30 {
    border-color: rgba(255, 255, 255, 0.3);
  }
}
```

**Verification:** Elements more visible with increased contrast enabled

---

### Task 4: Audit ARIA attributes on interactive elements
**Files:** All interactive components

**Actions:**
1. Ensure all buttons have accessible names
2. Add aria-labels to icon-only buttons
3. Verify form inputs have labels
4. Check dialog components have proper ARIA roles
5. Add aria-live regions for dynamic content

**Components to audit:**
- CommandPalette (dialog role, live region)
- DraggableProcess (drag handle aria-label)
- DroppableZone (drop zone aria-dropeffect)
- ProcessList (table accessibility)
- Navigation (nav landmarks)

**Common fixes:**
```tsx
// Icon-only button needs aria-label
<button aria-label="Close dialog">
  <X className="w-4 h-4" />
</button>

// Live region for status updates
<div aria-live="polite" aria-atomic="true">
  {statusMessage}
</div>

// Dialog accessibility
<Dialog aria-labelledby="dialog-title" aria-describedby="dialog-description">
  <h2 id="dialog-title">Title</h2>
  <p id="dialog-description">Description</p>
</Dialog>
```

**Verification:** All interactive elements have accessible names, VoiceOver reads them

---

### Task 5: Audit keyboard navigation
**Files:** All interactive components

**Actions:**
1. Test Tab key navigation through all focusable elements
2. Ensure focus order is logical (top to bottom, left to right)
3. Add visible focus indicators (focus-visible styles)
4. Verify Enter/Space activate buttons
5. Test arrow key navigation in lists
6. Ensure Escape closes modals/dialogs

**Focus indicator pattern:**
```css
/* Visible focus indicator for keyboard users */
*:focus-visible {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

/* Remove default outline, rely on focus-visible */
*:focus:not(:focus-visible) {
  outline: none;
}
```

**Verification:** Tab through entire app, focus always visible, logical order

---

### Task 6: VoiceOver testing and fixes
**Testing checklist**

**Actions:**
1. Enable VoiceOver (Cmd+F5 on Mac)
2. Navigate through app using VO+arrow keys
3. Document any confusing or missing announcements
4. Fix issues found
5. Test with NVDA on Windows if available

**Test scenarios:**
- [ ] Open app, VoiceOver announces page title
- [ ] Navigate to Dashboard, content announced
- [ ] Open Command Palette, input focused and announced
- [ ] Type command, results announced via live region
- [ ] Select command, action announced
- [ ] Navigate ProcessList, each row announced with name/CPU/memory
- [ ] Initiate drag with keyboard, instructions announced
- [ ] Drop on quarantine, result announced
- [ ] Close dialog, focus returns to trigger element

**Verification:** Complete VoiceOver navigation without visual reference

---

### Task 7: Add skip navigation link
**File:** `src/App.tsx` or `src/components/Layout.tsx`

**Actions:**
1. Add "Skip to main content" link at start of DOM
2. Style to be visible only on focus
3. Link to main content area

**Code pattern:**
```tsx
// At the very start of App.tsx body
<a
  href="#main-content"
  className="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:glass focus:rounded-md"
>
  Skip to main content
</a>

// On main content area
<main id="main-content" tabIndex={-1}>
  {/* Page content */}
</main>
```

**Verification:** Tab once from page load reveals skip link, Enter skips to content

---

### Task 8: Document accessibility features
**File:** `src/components/Accessibility/AccessibilityStatement.tsx` (or Settings page)

**Actions:**
1. Create accessibility statement component
2. Document supported features
3. Add to Settings or About page
4. Include instructions for common assistive technologies

**Content to document:**
- Keyboard shortcuts available
- Screen reader support (VoiceOver, NVDA)
- Reduced motion support
- High contrast support
- Focus management approach

**Verification:** Users can find accessibility information

---

### Task 9: Create accessibility test utility
**File:** `src/lib/a11y-test.ts` (development only)

**Actions:**
1. Create development-only accessibility checker
2. Warn about missing ARIA attributes
3. Warn about low contrast colors
4. Run automatically in development mode

**Code pattern:**
```typescript
// src/lib/a11y-test.ts
// Only runs in development
export function initA11yTests() {
  if (import.meta.env.DEV) {
    // Check for images without alt text
    const images = document.querySelectorAll('img:not([alt])');
    if (images.length) {
      console.warn('[A11y] Images without alt text:', images);
    }

    // Check for buttons without accessible names
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
      if (!btn.textContent?.trim() && !btn.getAttribute('aria-label')) {
        console.warn('[A11y] Button without accessible name:', btn);
      }
    });
  }
}
```

**Verification:** Console warnings appear for accessibility issues in dev mode

---

## Verification Checklist

### System Preferences Tests
- [ ] Reduce Motion (macOS): Animations disabled
- [ ] Increase Contrast (macOS): Borders and text more visible
- [ ] VoiceOver (macOS): Full navigation possible
- [ ] Keyboard-only: All features accessible without mouse

### WCAG 2.1 AA Criteria
- [ ] 1.4.3 Contrast (Minimum): Text has 4.5:1 ratio
- [ ] 2.1.1 Keyboard: All functionality via keyboard
- [ ] 2.1.2 No Keyboard Trap: Can always Tab out of components
- [ ] 2.4.3 Focus Order: Logical focus sequence
- [ ] 2.4.7 Focus Visible: Focus indicator always visible
- [ ] 4.1.2 Name, Role, Value: ARIA attributes correct

### Component-Specific Tests
- [ ] CommandPalette: Keyboard navigable, announced by screen reader
- [ ] DraggableProcess: Keyboard drag works, instructions announced
- [ ] DroppableZone: Drop action announced
- [ ] PinchZoomContainer: + and - keys as keyboard fallback
- [ ] ProcessList: Table semantics correct
- [ ] Navigation: Landmarks identified

### Build Verification
- [ ] `npm run build` passes
- [ ] No new console errors
- [ ] No accessibility regressions from previous components

---

## Files Created/Modified

| File | Action |
|------|--------|
| `src/hooks/useHighContrast.ts` | Create |
| `src/hooks/useReducedMotion.ts` | Verify/update |
| `src/index.css` | Add high contrast styles |
| `src/App.tsx` | Add skip link |
| `src/components/Accessibility/AccessibilityStatement.tsx` | Create |
| `src/lib/a11y-test.ts` | Create (dev only) |
| Various components | ARIA fixes |

---

## Research Reference

From 20-RESEARCH.md:
- dnd-kit includes KeyboardSensor and screen reader instructions
- cmdk handles focus management automatically
- framer-motion has useReducedMotion hook
- prefers-contrast: more for high contrast mode
- Always provide keyboard alternatives for gesture-based features

---

## Testing Resources

- **macOS VoiceOver:** Cmd+F5 to toggle
- **Accessibility Inspector:** Xcode > Open Developer Tool > Accessibility Inspector
- **WAVE Extension:** Chrome/Firefox browser extension
- **axe DevTools:** Chrome extension for automated WCAG testing

---

*Plan created: 2026-01-17*
*Ready for execution: yes*
*Execute after: 20-01, 20-02, 20-03, 20-04*
