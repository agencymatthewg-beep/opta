---
phase: 05-streaming-state
plan: 02
name: Thinking State Visualization
wave: 2
autonomous: true
scope: small
estimated-tasks: 4
subsystem: chat-ui

# Dependencies
requires:
  - phase: 05-01
    provides: ChatViewModel streaming state management
  - phase: 03-01
    provides: BotState enum (idle, thinking, typing, toolUse), BotStateUpdate
  - phase: 03-04
    provides: ProtocolHandler botStateUpdates publisher
provides:
  - Bot thinking state visualization in chat
  - ThinkingIndicator SwiftUI component
  - ChatViewModel bot state tracking
affects: [05-03-typing-indicator, 09-multi-bot]
---

# Objective

Implement thinking state visualization so users see when the bot is processing their request before streaming begins. This provides immediate feedback that the bot received the message and is working on a response.

# Execution Context

## Relevant Files
- `apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/ChatViewModel.swift` - Add botState tracking
- `apps/ios/ClawdbotKit/Sources/ClawdbotKit/Protocol/StreamingTypes.swift` - BotState enum already exists
- `apps/ios/ClawdbotMobile/ClawdbotMobile/Views/ChatView.swift` - Display thinking indicator
- New: `apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/ThinkingIndicator.swift`

## Patterns to Follow
- **Design system colors**: Use ClawdbotColors for indicator styling
- **SwiftUI animations**: iOS 17+ animation APIs
- **Observable state**: ChatViewModel exposes state for SwiftUI binding

# Context

## Architecture Decision
The ProtocolHandler already:
1. Receives `BotStateUpdate` messages from server
2. Publishes via `botStateUpdates` Combine subject
3. ChatViewModel subscribes but `handleBotStateUpdate` is empty stub

What's needed:
1. **ChatViewModel tracks current bot state** - `currentBotState: BotState?`
2. **ThinkingIndicator component** - Shows "thinking..." with animation
3. **ChatView displays indicator** - When botState is `.thinking` or `.toolUse`

## Design
Bot state flow:
1. User sends message → bot state becomes `.thinking`
2. Bot starts generating → bot state becomes `.typing` (Phase 5.03)
3. Response streams in → chunks arrive
4. Response complete → bot state becomes `.idle`

ThinkingIndicator design:
- Appears in message list area (not overlay)
- Three animated dots or pulsing animation
- Shows tool detail when `state == .toolUse` (e.g., "Searching web...")
- Matches bot message styling (left-aligned, surface color)

# Tasks

## Task 1: Add bot state tracking to ChatViewModel
**File:** `apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/ChatViewModel.swift`

Add properties:
```swift
/// Current bot processing state
public private(set) var botState: BotState = .idle

/// Detail message for tool use (e.g., "Searching web...")
public private(set) var botStateDetail: String?
```

Implement `handleBotStateUpdate(_ state: BotStateUpdate)`:
```swift
private func handleBotStateUpdate(_ state: BotStateUpdate) {
    botState = state.state
    botStateDetail = state.detail
}
```

**Verification:** Unit test verifying bot state updates propagate.

## Task 2: Create ThinkingIndicator component
**File:** `apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/ThinkingIndicator.swift`

Create SwiftUI view with:
- Three animated dots (bounce or fade animation)
- Optional detail text below dots
- Use `ClawdbotColors.clawdbotSurface` for background
- Match MessageBubble styling (rounded corners, left-aligned)

```swift
import SwiftUI

public struct ThinkingIndicator: View {
    public let detail: String?

    @State private var animationPhase: Int = 0

    public init(detail: String? = nil) {
        self.detail = detail
    }

    public var body: some View {
        // Three dots with staggered animation
        // Optional detail text
    }
}
```

Use `withAnimation` and `.animation(.easeInOut.repeatForever())` for smooth looping.

**Verification:** SwiftUI Preview showing animated indicator.

## Task 3: Export ThinkingIndicator from Chat module
**File:** `apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/Chat.swift`

Add public export:
```swift
public typealias ThinkingIndicator = ClawdbotKit.ThinkingIndicator
```

Or if using namespace enum pattern, add to ClawdbotChat.

**Verification:** Build succeeds, ThinkingIndicator accessible from app.

## Task 4: Display ThinkingIndicator in ChatView
**File:** `apps/ios/ClawdbotMobile/ClawdbotMobile/Views/ChatView.swift`

After streaming messages, conditionally show thinking indicator:
```swift
if viewModel.botState == .thinking || viewModel.botState == .toolUse {
    ThinkingIndicator(detail: viewModel.botStateDetail)
        .padding(.horizontal)
}
```

The indicator should appear at bottom of message list (after last message).

**Verification:** Manual test - indicator appears when bot is thinking.

# Verification

```bash
# Run tests
cd apps/ios/ClawdbotKit
swift test

# Build app
cd ../ClawdbotMobile
xcodebuild -scheme ClawdbotMobile -destination 'platform=iOS Simulator,name=iPhone 16' build
```

# Success Criteria

- [ ] ChatViewModel tracks botState and botStateDetail
- [ ] ThinkingIndicator component created with smooth animation
- [ ] Indicator displays in ChatView when bot is thinking/toolUse
- [ ] Indicator shows tool detail text when available
- [ ] Auto-scroll works when indicator appears
- [ ] All existing tests pass
- [ ] New tests for bot state tracking

# Output

Files created/modified:
- `apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/ChatViewModel.swift` - Add botState properties
- `apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/ThinkingIndicator.swift` - New component
- `apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/Chat.swift` - Export ThinkingIndicator
- `apps/ios/ClawdbotMobile/ClawdbotMobile/Views/ChatView.swift` - Display indicator
- `apps/ios/ClawdbotKit/Tests/ClawdbotKitTests/ChatViewModelTests.swift` - Bot state tests
