---
phase: 05-streaming-state
plan: 03
name: Typing Indicator Animation
wave: 2
autonomous: true
scope: small
estimated-tasks: 3
subsystem: chat-ui

# Dependencies
requires:
  - phase: 05-01
    provides: Streaming message rendering, ChatViewModel streaming state
  - phase: 05-02
    provides: ThinkingIndicator component, botState tracking
provides:
  - Typing state visualization (distinct from thinking)
  - Cursor/caret animation during active streaming
  - Smooth state transitions between thinking → typing → idle
affects: [06-rich-text]
---

# Objective

Implement typing indicator that shows when the bot is actively generating text (distinct from thinking). This creates a visual distinction between "processing your request" (thinking) and "writing response" (typing), matching familiar chat app patterns.

# Execution Context

## Relevant Files
- `apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/MessageBubble.swift` - Add typing cursor
- `apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/ChatViewModel.swift` - Already has botState from 05-02
- `apps/ios/ClawdbotMobile/ClawdbotMobile/Views/ChatView.swift` - State transitions

## Patterns to Follow
- **Design system colors**: ClawdbotColors.clawdbotPurple for cursor
- **SwiftUI animations**: Blinking cursor effect
- **Observable state**: ChatViewModel botState drives UI

# Context

## State Machine
```
idle → thinking → typing → idle
              ↘ streaming chunks arrive during typing
```

When `botState == .typing`:
- Hide ThinkingIndicator
- Show streaming message with cursor animation
- Cursor appears at end of streaming content

When streaming chunks stop arriving (isFinal or timeout):
- `botState` returns to `.idle`
- Cursor disappears
- Message transitions to completed state

## Design
The typing indicator is a blinking cursor (|) at the end of the streaming message bubble, not a separate component. This matches how modern chat apps (iMessage, WhatsApp, Telegram) show typing during streaming responses.

Implementation:
1. **05-01 already renders streaming messages** - `streamingMessages[messageID]`
2. **Add cursor view to streaming MessageBubble** - Shows when botState is `.typing`
3. **Blinking animation** - `withAnimation(.easeInOut.repeatForever())` toggle opacity

# Tasks

## Task 1: Add cursor to streaming MessageBubble
**File:** `apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/MessageBubble.swift`

Update streaming initializer/view to accept cursor state:
```swift
public var showTypingCursor: Bool = false
```

Add cursor view at end of text:
```swift
if showTypingCursor {
    TypingCursor()
}
```

Create TypingCursor as a simple blinking vertical bar:
```swift
private struct TypingCursor: View {
    @State private var isVisible = true

    var body: some View {
        Rectangle()
            .fill(ClawdbotColors.clawdbotPurple)
            .frame(width: 2, height: 18)
            .opacity(isVisible ? 1 : 0)
            .onAppear {
                withAnimation(.easeInOut(duration: 0.5).repeatForever()) {
                    isVisible.toggle()
                }
            }
    }
}
```

**Verification:** SwiftUI Preview showing cursor animation.

## Task 2: Update ChatView state transitions
**File:** `apps/ios/ClawdbotMobile/ClawdbotMobile/Views/ChatView.swift`

Modify streaming message rendering to show cursor when typing:
```swift
ForEach(Array(viewModel.streamingMessages.keys), id: \.self) { messageID in
    if let content = viewModel.streamingMessages[messageID] {
        MessageBubble(
            streamingContent: content,
            sender: .bot(name: "Clawdbot"),
            showTypingCursor: viewModel.botState == .typing
        )
    }
}
```

Update ThinkingIndicator visibility:
```swift
// Only show thinking indicator when thinking (not typing or idle)
if viewModel.botState == .thinking || viewModel.botState == .toolUse {
    ThinkingIndicator(detail: viewModel.botStateDetail)
}
```

This ensures:
- Thinking shows animated dots (no streaming content yet)
- Typing shows streaming message with cursor
- Idle shows completed message (no cursor)

**Verification:** Manual test - state transitions work correctly.

## Task 3: Add state transition tests
**File:** `apps/ios/ClawdbotKit/Tests/ClawdbotKitTests/ChatViewModelTests.swift`

Add tests for state transitions:
```swift
func testBotStateTransitions() async {
    // thinking → typing → idle flow
    // Verify cursor visibility logic
}

func testTypingCursorVisibilityLogic() {
    // showTypingCursor only when botState == .typing
}
```

**Verification:** All tests pass.

# Verification

```bash
# Run tests
cd apps/ios/ClawdbotKit
swift test

# Build app
cd ../ClawdbotMobile
xcodebuild -scheme ClawdbotMobile -destination 'platform=iOS Simulator,name=iPhone 16' build
```

# Success Criteria

- [ ] TypingCursor component with blinking animation
- [ ] Cursor appears at end of streaming message when botState == .typing
- [ ] ThinkingIndicator hidden when typing (replaced by streaming message)
- [ ] Smooth transitions: thinking → typing → idle
- [ ] All existing tests pass
- [ ] New tests for state transitions

# Output

Files created/modified:
- `apps/ios/ClawdbotKit/Sources/ClawdbotKit/Chat/MessageBubble.swift` - Add TypingCursor, showTypingCursor property
- `apps/ios/ClawdbotMobile/ClawdbotMobile/Views/ChatView.swift` - Wire up cursor visibility
- `apps/ios/ClawdbotKit/Tests/ClawdbotKitTests/ChatViewModelTests.swift` - State transition tests
