# Plan: Process Management View

---
phase: 91
plan: 02
title: Process Management View
wave: 1
autonomous: true
---

## Objective

Build the **ProcessesView** — a sortable, filterable process table showing running processes with CPU/memory usage, multi-select capabilities, and terminate actions. This view provides visibility into what Stealth Mode would optimize.

## Execution Context

- **Project root**: `/Users/matthewbyrden/Documents/Opta/opta-native`
- **SwiftUI views**: `OptaApp/OptaApp/Views/`
- **View model**: `OptaApp/OptaApp/Models/OptaViewModel.swift`
- **Core manager**: `OptaApp/OptaApp/Managers/OptaCoreManager.swift`
- **App entry**: `OptaApp/OptaApp/OptaAppApp.swift`
- **Design**: Obsidian base (#0A0A0F) + Electric Violet (#8B5CF6), color temperature environment

## Context

### What Exists

**Rust Core (ready)**:
- `ProcessState` with `processes: Vec<ProcessInfo>`, `selected_pids: Vec<u32>`
- `ProcessInfo` (from opta-shared): pid, name, cpu_percent, memory_bytes, user, is_killable
- `ProcessFilter`: search, min_cpu, only_killable, sort_by (Cpu/Memory/Name/Pid), sort_ascending
- Events:
  - `RefreshProcesses` → triggers `Effect::get_processes(None)`
  - `ProcessesReceived(Vec<ProcessInfo>)` → updates model
  - `ToggleProcessSelection(u32)` → select/deselect by pid
  - `ClearProcessSelection` → clear all selections
  - `TerminateSelected` → terminate all selected processes
  - `UpdateProcessFilter { search, min_cpu, only_killable, sort_by, sort_ascending }`

**Swift ViewModel (ready)**:
- `viewModel.processCount: Int`
- `viewModel.selectedProcessCount: Int`
- `viewModel.loadingProcesses: Bool`

**SwiftUI ViewModel (needs extension)**:
- Process list is NOT currently in the Swift ViewModel (only count)
- Need to add process list, filter state, and selected PIDs to OptaViewModel

**Navigation**:
- `PageViewModel.processes` exists in enum
- `OptaAppApp.swift` line 179 currently shows placeholder
- Not in circular menu (Dashboard, Games, Profiles, Settings only)
- Accessible from OptimizeView "View All Processes" button

### What Needs Building

1. Extend `OptaViewModel` with process list data
2. Extend `OptaEvent` with process filter/selection events (already exists in Rust but not Swift)
3. Create `ProcessesView.swift` with sortable table
4. Create `ProcessRowView.swift` for individual process rows
5. Wire into navigation

## Tasks

### Task 1: Extend OptaViewModel with Process Data

**File**: `OptaApp/OptaApp/Models/OptaViewModel.swift`

Add to `OptaViewModel` struct:
```swift
// MARK: - Process List (for ProcessesView)

/// List of running processes (populated when on Processes page)
var processes: [ProcessViewModel] = []

/// Current process filter state
var processFilter: ProcessFilterViewModel = ProcessFilterViewModel()

/// PIDs of selected processes
var selectedPids: [UInt32] = []
```

Add new supporting types:
```swift
/// Individual process for display
struct ProcessViewModel: Codable, Identifiable {
    var id: UInt32 { pid }
    var pid: UInt32
    var name: String
    var cpuPercent: Float
    var memoryBytes: UInt64
    var user: String
    var isKillable: Bool

    /// Memory in MB for display
    var memoryMb: Float {
        Float(memoryBytes) / 1_000_000.0
    }
}

/// Process filter state
struct ProcessFilterViewModel: Codable {
    var search: String = ""
    var minCpu: Float = 0
    var onlyKillable: Bool = false
    var sortBy: ProcessSortViewModel = .cpu
    var sortAscending: Bool = false
}

/// Process sort options
enum ProcessSortViewModel: String, Codable, CaseIterable {
    case cpu = "Cpu"
    case memory = "Memory"
    case name = "Name"
    case pid = "Pid"

    var displayName: String {
        switch self {
        case .cpu: return "CPU"
        case .memory: return "Memory"
        case .name: return "Name"
        case .pid: return "PID"
        }
    }

    var icon: String {
        switch self {
        case .cpu: return "cpu"
        case .memory: return "memorychip"
        case .name: return "textformat"
        case .pid: return "number"
        }
    }
}
```

### Task 2: Extend OptaEvent with Process Actions

**File**: `OptaApp/OptaApp/Models/OptaViewModel.swift`

Add to `OptaEvent` enum:
```swift
// MARK: - Process Management Events

case refreshProcesses
case toggleProcessSelection(pid: UInt32)
case clearProcessSelection
case terminateSelected
case updateProcessFilter(
    search: String?,
    minCpu: Float?,
    onlyKillable: Bool?,
    sortBy: ProcessSortViewModel?,
    sortAscending: Bool?
)
```

Add corresponding `toJson()` cases:
```swift
case .refreshProcesses:
    return "\"RefreshProcesses\""
case .toggleProcessSelection(let pid):
    return "{\"ToggleProcessSelection\":\(pid)}"
case .clearProcessSelection:
    return "\"ClearProcessSelection\""
case .terminateSelected:
    return "\"TerminateSelected\""
case .updateProcessFilter(let search, let minCpu, let onlyKillable, let sortBy, let sortAscending):
    var fields: [String] = []
    if let s = search { fields.append("\"search\":\"\(s)\"") }
    if let cpu = minCpu { fields.append("\"min_cpu\":\(cpu)") }
    if let k = onlyKillable { fields.append("\"only_killable\":\(k)") }
    if let sort = sortBy { fields.append("\"sort_by\":\"\(sort.rawValue)\"") }
    if let asc = sortAscending { fields.append("\"sort_ascending\":\(asc)") }
    return "{\"UpdateProcessFilter\":{\(fields.joined(separator: ","))}}"
```

### Task 3: Create ProcessesView.swift

**File**: `OptaApp/OptaApp/Views/ProcessesView.swift`

Layout:
- **Header**: "Processes" title with back button and process count badge
- **Toolbar**: Search field, sort picker, filter toggles
  - Search TextField with "Filter processes..." placeholder
  - Sort by: Picker with CPU/Memory/Name/PID options
  - Toggle: "Killable only" switch
  - Sort direction button (ascending/descending)
- **Process Table**: Scrollable list of ProcessRowView
  - Shows all processes from `viewModel.processes`
  - Multi-select via checkboxes
  - Sorted and filtered per filter state
- **Action Bar**: Fixed bottom bar (appears when processes selected)
  - "X selected" label
  - "Clear Selection" button
  - "Terminate Selected" button (destructive, violet glow)
  - Confirmation modal before terminate

**Key structure**:
```swift
struct ProcessesView: View {
    @Bindable var coreManager: OptaCoreManager
    @Environment(\.colorTemperature) private var colorTemp
    @Environment(\.accessibilityReduceMotion) private var reduceMotion

    @State private var searchText = ""
    @State private var sortBy: ProcessSortViewModel = .cpu
    @State private var sortAscending = false
    @State private var onlyKillable = false
    @State private var showTerminateConfirm = false

    private let obsidianBase = Color(hex: "0A0A0F")
}
```

**On appear**: Dispatch `.refreshProcesses` to load process list
**Search debounce**: 300ms debounce before dispatching filter update

### Task 4: Create ProcessRowView

**File**: Within `ProcessesView.swift` or as separate component

Each row shows:
- Selection checkbox (toggle on tap)
- Process name (bold, white)
- PID (monospace, dimmed)
- CPU usage (color-coded: green <30%, yellow 30-60%, orange 60-85%, red >85%)
- Memory usage (formatted as MB)
- Killable indicator (lock icon if not killable)

**Design**:
- Obsidian row background with violet highlight on selection
- Hover effect with subtle violet glow
- Tap to toggle selection (only if killable)
- Non-killable processes visually dimmed

### Task 5: Wire ProcessesView into Navigation

**File**: `OptaApp/OptaApp/OptaAppApp.swift`

Replace the `.processes` placeholder case (line ~179) with:
```swift
case .processes:
    ProcessesView(coreManager: coreManager)
```

### Task 6: Add Navigation from OptimizeView

Add a button/link in OptimizeView (from 91-01) that navigates to Processes:
```swift
Button {
    coreManager.dispatch(.navigateTo(page: .processes))
} label: {
    HStack {
        Image(systemName: "gearshape.2")
        Text("View All Processes (\(coreManager.viewModel.processCount))")
        Spacer()
        Image(systemName: "chevron.right")
    }
}
```

This can be added as a simple navigation row at the bottom of OptimizeView.

## Verification

1. Build succeeds
2. ProcessesView shows when navigating to Processes page
3. Process list populates on appear (via RefreshProcesses event)
4. Sort picker changes sort order
5. Search filters processes by name
6. "Killable only" toggle filters correctly
7. Selecting processes highlights rows
8. "Terminate Selected" shows confirmation modal
9. After termination, list refreshes
10. Color temperature drives accents
11. Reduced motion: no row animations

## Success Criteria

- [ ] ProcessesView.swift created with full table layout
- [ ] ProcessRowView renders process data correctly
- [ ] OptaViewModel extended with process list types
- [ ] OptaEvent extended with process management events
- [ ] Placeholder in OptaAppApp.swift replaced
- [ ] Sort, filter, and search work correctly
- [ ] Multi-select with terminate action
- [ ] Confirmation before destructive action
- [ ] Obsidian + violet aesthetic with color temperature
- [ ] Build compiles without errors

## Output

- `OptaApp/OptaApp/Views/ProcessesView.swift` — New process management view
- `OptaApp/OptaApp/Models/OptaViewModel.swift` — Extended with process types and events
- `OptaApp/OptaApp/OptaAppApp.swift` — Updated navigation switch
