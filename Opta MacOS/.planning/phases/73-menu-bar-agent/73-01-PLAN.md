---
phase: 73-menu-bar-agent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - opta-native/OptaApp/OptaApp/MenuBar/MenuBarView.swift
  - opta-native/OptaApp/OptaApp/MenuBar/MenuBarIcon.swift
  - opta-native/OptaApp/OptaApp/Services/NotificationService.swift
  - opta-native/OptaApp/OptaApp/Services/AgentModeManager.swift
  - opta-native/OptaApp/OptaApp/OptaAppApp.swift
autonomous: true
---

<objective>
Polish menu bar agent with notifications, agent mode, and dynamic icon states.

Purpose: Transform menu bar from basic status display to intelligent background agent that proactively notifies users of optimization opportunities and provides seamless minimize-to-menu-bar workflow.
Output: Complete menu bar agent with notification system, agent mode toggle, contextual actions, and dynamic icon states reflecting system status.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Phase 72 games library:**
@.planning/phases/72-games-library/72-01-SUMMARY.md

**Existing menu bar components:**
@opta-native/OptaApp/OptaApp/MenuBar/MenuBarView.swift
@opta-native/OptaApp/OptaApp/MenuBar/MenuBarIcon.swift

**App entry point (for agent mode integration):**
@opta-native/OptaApp/OptaApp/OptaAppApp.swift

**Design reference:**
- OLED background (#09090B)
- Glass effects with .ultraThinMaterial
- Purple accent (#8B5CF6)
- Spring animations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NotificationService for optimization alerts</name>
  <files>
opta-native/OptaApp/OptaApp/Services/NotificationService.swift
  </files>
  <action>
Create actor-based notification service for optimization opportunity alerts:

1. Create NotificationService.swift:
   ```swift
   import UserNotifications
   import AppKit

   actor NotificationService {
       static let shared = NotificationService()

       private var isAuthorized = false

       // MARK: - Authorization

       func requestAuthorization() async -> Bool {
           let center = UNUserNotificationCenter.current()
           do {
               isAuthorized = try await center.requestAuthorization(
                   options: [.alert, .sound, .badge]
               )
               return isAuthorized
           } catch {
               print("[NotificationService] Authorization error: \(error)")
               return false
           }
       }

       // MARK: - Optimization Notifications

       enum OptimizationAlert: String {
           case highCpuUsage = "high-cpu"
           case highMemoryPressure = "high-memory"
           case gameDetected = "game-detected"
           case thermalThrottling = "thermal"
           case backgroundProcesses = "background"
       }

       func scheduleOptimizationAlert(
           _ alert: OptimizationAlert,
           title: String,
           body: String,
           actionTitle: String = "Optimize Now"
       ) async {
           guard isAuthorized else {
               _ = await requestAuthorization()
               guard isAuthorized else { return }
           }

           let content = UNMutableNotificationContent()
           content.title = title
           content.body = body
           content.sound = .default
           content.categoryIdentifier = "OPTIMIZATION"

           let trigger = UNTimeIntervalNotificationTrigger(
               timeInterval: 1,
               repeats: false
           )

           let request = UNNotificationRequest(
               identifier: alert.rawValue,
               content: content,
               trigger: trigger
           )

           do {
               try await UNUserNotificationCenter.current().add(request)
           } catch {
               print("[NotificationService] Failed to schedule: \(error)")
           }
       }

       func setupNotificationCategories() {
           let optimizeAction = UNNotificationAction(
               identifier: "OPTIMIZE_ACTION",
               title: "Optimize",
               options: [.foreground]
           )

           let dismissAction = UNNotificationAction(
               identifier: "DISMISS_ACTION",
               title: "Dismiss",
               options: []
           )

           let category = UNNotificationCategory(
               identifier: "OPTIMIZATION",
               actions: [optimizeAction, dismissAction],
               intentIdentifiers: [],
               options: []
           )

           UNUserNotificationCenter.current().setNotificationCategories([category])
       }

       // MARK: - Convenience Methods

       func notifyHighCpuUsage(percentage: Int) async {
           await scheduleOptimizationAlert(
               .highCpuUsage,
               title: "High CPU Usage Detected",
               body: "CPU at \(percentage)%. Optimize now to free up resources."
           )
       }

       func notifyGameDetected(gameName: String) async {
           await scheduleOptimizationAlert(
               .gameDetected,
               title: "Game Detected: \(gameName)",
               body: "Tap to apply optimization profile for best performance."
           )
       }

       func notifyThermalThrottling() async {
           await scheduleOptimizationAlert(
               .thermalThrottling,
               title: "System Running Hot",
               body: "Thermal throttling detected. Reduce workload to improve performance."
           )
       }
   }
   ```

2. Features:
   - UNUserNotificationCenter for native macOS notifications
   - Actionable notifications with "Optimize" and "Dismiss" buttons
   - Debounced alerts (don't spam same alert type)
   - Categories for different optimization opportunities
   - Integration hooks for telemetry thresholds

Key: Use actor for thread safety. Request authorization on first notification attempt.
  </action>
  <verify>
```bash
ls -la /Users/matthewbyrden/Documents/Opta/opta-native/OptaApp/OptaApp/Services/NotificationService.swift
```
Expected: File exists with NotificationService actor
  </verify>
  <done>NotificationService exists with optimization alerts and actionable notifications</done>
</task>

<task type="auto">
  <name>Task 2: Create AgentModeManager for minimize-to-menu-bar</name>
  <files>
opta-native/OptaApp/OptaApp/Services/AgentModeManager.swift
opta-native/OptaApp/OptaApp/OptaAppApp.swift
  </files>
  <action>
**AgentModeManager.swift:**
1. Create @Observable class for agent mode state:
   ```swift
   import SwiftUI
   import AppKit

   @Observable
   final class AgentModeManager {
       static let shared = AgentModeManager()

       // MARK: - State

       var isAgentMode: Bool = false {
           didSet {
               handleAgentModeChange()
           }
       }

       var showNotifications: Bool = true
       var autoMinimizeOnGameLaunch: Bool = true
       var monitoringInterval: TimeInterval = 5.0

       // MARK: - Persistence

       @AppStorage("agentModeEnabled") private var storedAgentMode = false
       @AppStorage("agentModeNotifications") private var storedNotifications = true
       @AppStorage("agentModeAutoMinimize") private var storedAutoMinimize = true

       private init() {
           // Restore state from storage
           isAgentMode = storedAgentMode
           showNotifications = storedNotifications
           autoMinimizeOnGameLaunch = storedAutoMinimize
       }

       // MARK: - Agent Mode Control

       func enterAgentMode() {
           isAgentMode = true
           storedAgentMode = true

           // Hide all windows
           for window in NSApp.windows {
               if window.identifier?.rawValue != "menuBarExtra" {
                   window.orderOut(nil)
               }
           }

           // Post notification for UI updates
           NotificationCenter.default.post(
               name: .agentModeDidChange,
               object: nil,
               userInfo: ["isAgentMode": true]
           )
       }

       func exitAgentMode() {
           isAgentMode = false
           storedAgentMode = false

           // Open main window
           NotificationCenter.default.post(name: .openMainWindow, object: nil)
           NSApp.activate(ignoringOtherApps: true)

           NotificationCenter.default.post(
               name: .agentModeDidChange,
               object: nil,
               userInfo: ["isAgentMode": false]
           )
       }

       func toggleAgentMode() {
           if isAgentMode {
               exitAgentMode()
           } else {
               enterAgentMode()
           }
       }

       private func handleAgentModeChange() {
           // Start/stop background monitoring based on mode
           if isAgentMode {
               startBackgroundMonitoring()
           } else {
               stopBackgroundMonitoring()
           }
       }

       // MARK: - Background Monitoring

       private var monitoringTask: Task<Void, Never>?

       private func startBackgroundMonitoring() {
           monitoringTask = Task { @MainActor in
               while !Task.isCancelled && isAgentMode {
                   await checkSystemStatus()
                   try? await Task.sleep(for: .seconds(monitoringInterval))
               }
           }
       }

       private func stopBackgroundMonitoring() {
           monitoringTask?.cancel()
           monitoringTask = nil
       }

       @MainActor
       private func checkSystemStatus() async {
           // Check for optimization opportunities
           // This would integrate with telemetry in a full implementation
           // For now, placeholder checks
       }
   }

   // MARK: - Notifications

   extension Notification.Name {
       static let agentModeDidChange = Notification.Name("agentModeDidChange")
   }
   ```

**OptaAppApp.swift update:**
1. Add AgentModeManager integration:
   - Add `@State private var agentModeManager = AgentModeManager.shared`
   - Subscribe to window close notifications to offer agent mode
   - Add keyboard shortcut ⌘⇧H for toggle show/hide

2. Update applicationShouldTerminateAfterLastWindowClosed:
   - Already returns false (keeps menu bar alive)
   - Add handling for agent mode state

Key: Agent mode minimizes to menu bar, continues background monitoring, and shows notifications for optimization opportunities.
  </action>
  <verify>
```bash
ls -la /Users/matthewbyrden/Documents/Opta/opta-native/OptaApp/OptaApp/Services/AgentModeManager.swift
grep -l "AgentModeManager" /Users/matthewbyrden/Documents/Opta/opta-native/OptaApp/OptaApp/OptaAppApp.swift
```
Expected: AgentModeManager exists and is referenced in OptaAppApp
  </verify>
  <done>AgentModeManager exists with minimize/restore functionality and OptaAppApp integrated</done>
</task>

<task type="auto">
  <name>Task 3: Enhance MenuBarView and MenuBarIcon with agent features</name>
  <files>
opta-native/OptaApp/OptaApp/MenuBar/MenuBarView.swift
opta-native/OptaApp/OptaApp/MenuBar/MenuBarIcon.swift
  </files>
  <action>
**MenuBarView.swift enhancements:**
1. Add agent mode section:
   ```swift
   // Agent Mode Toggle Row
   private var agentModeRow: some View {
       HStack {
           Image(systemName: agentModeManager.isAgentMode ? "eye.slash" : "eye")
               .foregroundColor(agentModeManager.isAgentMode ? .purple : .white.opacity(0.6))

           Text(agentModeManager.isAgentMode ? "Agent Mode Active" : "Agent Mode")
               .font(.system(size: 12, weight: .medium))
               .foregroundColor(.white)

           Spacer()

           Toggle("", isOn: $agentModeManager.isAgentMode)
               .toggleStyle(.switch)
               .scaleEffect(0.8)
       }
       .padding(.horizontal, 16)
       .padding(.vertical, 8)
   }
   ```

2. Add contextual quick actions based on current state:
   - If high CPU: Show "Kill Background Processes" action
   - If game running: Show "Optimize for [Game]" action
   - If agent mode: Show "Open Dashboard" action
   - Add "Notifications" toggle

3. Add mini optimization score indicator in header

4. Enhance footer:
   - Show "Agent Mode" badge when active
   - Add notifications bell icon with badge count
   - "Open Dashboard" replaces "Quit" when in agent mode

5. Integrate with OptaCoreManager for live telemetry (if available)

**MenuBarIcon.swift enhancements:**
1. Add status-based icon states:
   - Normal (blue/purple gradient): System healthy
   - Warning (orange glow): Optimization recommended
   - Critical (red pulse): Action needed
   - Agent (purple solid): Agent mode active
   - Paused (gray): Rendering paused

2. Add badge indicator:
   ```swift
   // Notification badge
   private var notificationBadge: some View {
       if pendingNotifications > 0 {
           Circle()
               .fill(.red)
               .frame(width: 6, height: 6)
               .offset(x: 6, y: -6)
       }
   }
   ```

3. Update icon appearance based on AgentModeManager state

4. Add haptic-like subtle pulse when status changes

Key: Menu bar becomes the control center when in agent mode. Icon provides at-a-glance system status.
  </action>
  <verify>
```bash
grep -l "agentMode" /Users/matthewbyrden/Documents/Opta/opta-native/OptaApp/OptaApp/MenuBar/MenuBarView.swift
grep -l "notificationBadge\|Warning\|Critical" /Users/matthewbyrden/Documents/Opta/opta-native/OptaApp/OptaApp/MenuBar/MenuBarIcon.swift
```
Expected: Both files contain agent mode and status state code
  </verify>
  <done>MenuBarView has agent mode section and contextual actions, MenuBarIcon has dynamic status states</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] NotificationService.swift exists with UNUserNotificationCenter integration
- [ ] Actionable notifications with "Optimize" and "Dismiss" buttons
- [ ] AgentModeManager.swift exists with minimize/restore functionality
- [ ] Agent mode persists via @AppStorage
- [ ] OptaAppApp.swift integrates AgentModeManager
- [ ] MenuBarView.swift has agent mode toggle and contextual actions
- [ ] MenuBarIcon.swift has dynamic states (normal, warning, critical, agent, paused)
- [ ] Background monitoring runs in agent mode
- [ ] ⌘⇧H keyboard shortcut for show/hide window
</verification>

<success_criteria>
- Notifications appear for optimization opportunities (high CPU, game detected, thermal)
- Agent mode minimizes app to menu bar and continues background monitoring
- Menu bar icon changes color/animation based on system status
- Contextual quick actions appear based on current state
- User can toggle notifications on/off from menu bar
- Open Dashboard action restores main window from agent mode
- All interactions have smooth animations
</success_criteria>

<output>
After completion, create `.planning/phases/73-menu-bar-agent/73-01-SUMMARY.md`
</output>
