---
phase: 86-navigation-energy-language
plan: 01
title: Obsidian Menu Shader & Branch Highlight
type: feature
wave: 1
autonomous: true
depends_on: [85-01, 82-01, 84-01]
files_modified:
  - opta-native/opta-render/shaders/circular_menu.wgsl
  - opta-native/opta-render/src/components/circular_menu.rs
  - opta-native/opta-render/src/ffi.rs
files_created: []
estimated_tasks: 3
---

<objective>
Rewrite the circular menu GPU shader to use obsidian material rendering with branch-energy sector highlights. Update Rust uniforms to support obsidian base color, branch energy parameters, and organic open/close animation. Add FFI export for branch energy level.
</objective>

<execution_context>
@opta-native/opta-render/shaders/circular_menu.wgsl
@opta-native/opta-render/shaders/includes/obsidian.wgsl
@opta-native/opta-render/shaders/includes/branch_energy.wgsl
@opta-native/opta-render/src/components/circular_menu.rs
@opta-native/opta-render/src/ffi.rs
</execution_context>

<context>
Phase 86 transforms the circular menu from its Phase 79 glass-styled SDF shader into
the Refined Obsidian Aesthetic established in Phases 81-85.

Current state:
- circular_menu.wgsl: Glass background, colored glow highlight, SDF ring+sectors
- circular_menu.rs: 96-byte CircularMenuUniforms, spring animations, sector geometry
- ffi.rs: 16 FFI functions for menu lifecycle, position, sectors, glow color, hit test

Target state:
- Obsidian background: Replace glass_base with obsidian dark (0.02, 0.02, 0.03), Cook-Torrance specular
- Branch-energy highlights: On hovered sector, branch veins grow radially from inner radius
- Organic open/close: Branches extend outward during open, retract during close (not just scale)
- Unified violet glow: Replace per-sector hue tint with Electric Violet (#8B5CF6) branch energy

Key patterns from prior phases:
- obsidian.wgsl: ObsidianMaterial, obsidian_shade(), obsidian_emission_blend()
- branch_energy.wgsl: BranchParams, branch_energy(), branch_color()
- Tri-axis response: reach/width/brightness scale with energy
- Cook-Torrance: roughness 0.03, IOR 1.85, near-black base
- Electric Violet: (0.545, 0.361, 0.965)
</context>

<tasks>
<task id="1" name="rewrite-circular-menu-shader">
<description>
Rewrite circular_menu.wgsl to replace glass styling with obsidian material and branch-energy highlights.

Changes to the shader:
1. Replace glass_base (0.05, 0.07, 0.12) with obsidian base (0.02, 0.02, 0.03)
2. Add simplified obsidian specular: Schlick Fresnel on ring edges for subtle highlight
3. Replace colored sector glow with branch-energy pattern on highlighted sector:
   - Map sector UV: u = angular position within sector, v = radial position (inner→outer)
   - Call branch_energy() with energy driven by highlight_progress
   - Branches grow FROM inner radius OUTWARD (reach extends with highlight animation)
4. Add branch_energy parameter to uniforms: `branch_energy_level` for global system energy
5. Organic open animation: branches extend radially (reach scales with open_progress)
6. Replace outer/inner edge glow with subtle obsidian Fresnel edge highlight
7. Remove per-sector hue shift (unified violet palette)
8. Keep SDF ring geometry, sector dividers, and anti-aliasing unchanged

Inline the necessary branch functions (ridged_turbulence, tri-axis, etc.) since circular_menu.wgsl
is a self-contained shader (no #include system in wgpu).

New uniforms to add:
- branch_energy_level: f32 (system energy 0-1, drives ambient branch visibility)
- obsidian_roughness: f32 (default 0.03)

Replace `glow_color` semantic with violet-only (hardcode Electric Violet in shader, remove
configurable glow_color from uniforms to simplify).
</description>
<verification>
- cargo build --release -p opta-render compiles without errors
- Shader compiles (tested by pipeline creation)
- Uniforms struct size assertion passes in tests
</verification>
</task>

<task id="2" name="update-rust-uniforms-and-config">
<description>
Update CircularMenuUniforms and CircularMenuConfig to match the new shader.

CircularMenuUniforms changes (keep 96 bytes total by replacing glow fields):
- Remove: glow_color [f32;3] + glow_intensity f32 (16 bytes freed)
- Add: branch_energy_level f32 + obsidian_roughness f32 + _pad3 [f32;2] (16 bytes)
- The base_color field stays but defaults change to obsidian (0.02, 0.02, 0.03)
- border_opacity → sector_divider_opacity (rename for clarity)

CircularMenuConfig changes:
- Remove: glow_color, glow_intensity
- Add: branch_energy_level: f32 (default 0.5), obsidian_roughness: f32 (default 0.03)
- Update base_color default to [0.02, 0.02, 0.03]
- Remove set_glow_color method

Update AnimatedCircularMenu:
- Add branch_reach_spring: Spring (controls how far branches extend during open)
- open() → also animates branch reach to 1.0
- close() → animates branch reach to 0.0
- update() includes branch_reach_spring
- Add branch_reach() getter returning spring value

Update from_config() to pass new uniform values.

Update all tests to reflect new struct layout.
</description>
<verification>
- cargo test -p opta-render -- circular_menu passes
- CircularMenuUniforms size remains 96 bytes
- Default config creates valid uniforms
</verification>
</task>

<task id="3" name="update-ffi-branch-energy">
<description>
Update FFI layer to expose branch energy control and remove glow color.

Changes to ffi.rs:
1. Remove: opta_circular_menu_set_glow_color (no longer needed, violet is hardcoded)
2. Add: opta_circular_menu_set_branch_energy(menu, energy: f32) → sets config.branch_energy_level
3. Update OptaCircularMenuConfig FFI struct:
   - Remove glow_color_r/g/b, glow_intensity fields
   - Add branch_energy_level: f32, obsidian_roughness: f32
4. Update opta_circular_menu_create to use new config fields
5. Update null-pointer safety tests

The hit test, position, sector count, and lifecycle functions remain unchanged.
</description>
<verification>
- cargo test -p opta-render -- circular_menu passes
- cargo test -p opta-render -- ffi passes
- All null-pointer safety tests pass
- New FFI function has proper null checks and returns OptaRenderResult
</verification>
</task>
</tasks>

<output>
After this plan:
- circular_menu.wgsl renders obsidian background with branch-energy sector highlights
- CircularMenuUniforms supports branch energy level and obsidian roughness
- FFI exposes branch energy control for Swift
- Ready for Plan 86-02 (Swift-side updates)
</output>
