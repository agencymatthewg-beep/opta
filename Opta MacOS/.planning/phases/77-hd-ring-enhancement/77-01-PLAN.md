# Plan 77-01: HD Ring Enhancement

## Metadata

```yaml
phase: 77
plan: 01
name: HD Ring Enhancement
wave: 1
autonomous: true
scope: medium
estimated_tasks: 6
```

## Objective

Upgrade the Opta Ring to HD quality with enhanced wgpu shaders, improved geometry, advanced visual effects, and 120Hz optimized rendering. Transform the ring from technically solid to visually stunning with HDR-quality glass material, premium plasma effects, and enhanced bloom post-processing.

## Execution Context

```
@.planning/ROADMAP.md
@.planning/STATE.md
@opta-native/opta-render/src/components/ring.rs
@opta-native/opta-render/shaders/ring.wgsl
@opta-native/opta-render/shaders/plasma.wgsl
@opta-native/opta-render/shaders/includes/noise.wgsl
@opta-native/opta-render/shaders/bloom_composite.wgsl
```

## Context

### Current Implementation

The existing ring implementation provides:
- **Geometry**: 64 major segments, 32 minor segments (2,145 vertices)
- **Shader Effects**: Fresnel edge glow, internal plasma, rim lighting, energy bloom
- **States**: Dormant, Waking, Active, Processing, Exploding, Recovering
- **Noise**: Perlin, Simplex, Worley, fbm (4-6 octaves)
- **Quality Tiers**: HQ, Standard, LQ shader variants
- **Post-Processing**: Bloom threshold, Gaussian blur, ACES tonemapping

### Enhancement Targets

From ROADMAP.md Key Deliverables:
- Enhanced ring geometry with smoother curves
- HDR-quality glass material with improved fresnel
- Premium plasma core with higher fidelity noise
- Enhanced particle systems around ring
- 120Hz optimized rendering path
- Ring state animations with improved physics

### Research Topics (from ROADMAP)

- HDR rendering
- Advanced fresnel (Cook-Torrance BRDF)
- Subsurface scattering simulation
- Bloom post-processing enhancements

## Tasks

### Task 1: Enhanced Ring Geometry

**Objective**: Increase ring geometry resolution for smoother curves at HD resolution.

**Implementation**:
1. Update `RingConfig` default values:
   - `major_segments`: 64 → 128 (smoother circumference)
   - `minor_segments`: 32 → 48 (smoother tube cross-section)
2. Add `QualityLevel` enum for geometry LOD:
   - `Ultra`: 128/48 segments (4,949 vertices)
   - `High`: 96/36 segments (3,553 vertices)
   - `Medium`: 64/32 segments (2,145 vertices)
   - `Low`: 48/24 segments (1,225 vertices)
3. Add method `regenerate_geometry(quality: QualityLevel)` to `OptaRing`
4. Ensure dynamic quality switching doesn't cause frame drops

**Files**:
- `opta-native/opta-render/src/components/ring.rs`

**Verification**:
- Ring renders with visibly smoother curves at Ultra quality
- Quality switching doesn't cause visible stutter

---

### Task 2: Advanced Fresnel and Glass Material

**Objective**: Implement Cook-Torrance BRDF for more physically accurate glass rendering.

**Implementation**:
1. Add new glass shader include: `shaders/includes/glass_hd.wgsl`
2. Implement Cook-Torrance specular:
   ```wgsl
   fn cook_torrance_specular(
       N: vec3<f32>, V: vec3<f32>, L: vec3<f32>,
       roughness: f32, F0: f32
   ) -> f32
   ```
3. Add GGX normal distribution function
4. Add Smith geometry shadowing function
5. Update ring shader uniforms:
   - Add `roughness: f32` (0.0 = mirror, 1.0 = diffuse)
   - Add `metallic: f32` (0.0 for glass)
6. Create subsurface scattering approximation:
   - Backlit translucency effect
   - Thickness-based light transmission
7. Add inner surface refraction hint (fake refraction via normal offset)

**Files**:
- `opta-native/opta-render/shaders/includes/glass_hd.wgsl` (new)
- `opta-native/opta-render/shaders/ring.wgsl` (update)
- `opta-native/opta-render/src/components/ring.rs` (update uniforms)

**Verification**:
- Glass appears more realistic with subtle specular highlights
- Subsurface scattering visible when backlit
- Edge fresnel smoother and more natural

---

### Task 3: Premium Plasma Core

**Objective**: Enhance internal plasma with 3D noise, domain warping, and volumetric simulation.

**Implementation**:
1. Add 3D simplex noise to `noise.wgsl`:
   ```wgsl
   fn simplex_noise_3d(p: vec3<f32>) -> f32
   fn fbm_simplex_3d(p: vec3<f32>, octaves: i32, lacunarity: f32, gain: f32) -> f32
   ```
2. Implement domain warping for organic flow:
   ```wgsl
   fn domain_warp(p: vec2<f32>, t: f32) -> vec2<f32>
   ```
3. Create volumetric plasma approximation:
   - Sample plasma at multiple depths (3-5 layers)
   - Blend with depth-based attenuation
   - Add parallax effect based on view angle
4. Add plasma color temperature system:
   - `dormant_color`: Deep purple (#3B1D5A)
   - `active_color`: Electric violet (#9333EA)
   - `hot_color`: White-hot pink (#FF6EC7)
5. Add plasma turbulence parameter for explosion state
6. Update fs_main_hq with enhanced plasma (8 octaves, domain warping)

**Files**:
- `opta-native/opta-render/shaders/includes/noise.wgsl` (add 3D noise)
- `opta-native/opta-render/shaders/ring.wgsl` (enhanced plasma)

**Verification**:
- Plasma has visible depth and organic flow
- Domain warping creates swirling patterns
- Color temperature shifts smoothly with energy level

---

### Task 4: HDR Bloom Enhancement

**Objective**: Upgrade bloom pipeline with multi-pass blur, lens flare hints, and chromatic aberration.

**Implementation**:
1. Create new bloom shader: `shaders/bloom_hd.wgsl`
2. Implement progressive downsample (4 levels):
   - Full → 1/2 → 1/4 → 1/8 resolution
3. Add Kawase blur (faster than Gaussian for large radii)
4. Implement bloom color tinting:
   - Ring tint color bleeds into bloom
   - Energy level affects bloom saturation
5. Add subtle chromatic aberration on high energy:
   ```wgsl
   fn chromatic_aberration(uv: vec2<f32>, strength: f32) -> vec3<f32>
   ```
6. Add lens flare hints (radial streaks from ring center)
7. Update BloomCompositeUniforms with new parameters:
   - `bloom_tint: vec3<f32>`
   - `chromatic_strength: f32`
   - `flare_intensity: f32`

**Files**:
- `opta-native/opta-render/shaders/bloom_hd.wgsl` (new)
- `opta-native/opta-render/shaders/bloom_composite.wgsl` (update)
- `opta-native/opta-render/src/components/mod.rs` (if bloom component exists)

**Verification**:
- Bloom has visible color tinting matching ring
- Chromatic aberration visible during explosion state
- Subtle lens flare adds cinematic quality

---

### Task 5: Ring State Animation Physics

**Objective**: Improve state transition animations with spring physics and overshoot.

**Implementation**:
1. Add spring physics parameters to `OptaRing`:
   ```rust
   struct SpringConfig {
       stiffness: f32,    // Spring constant (default: 100.0)
       damping: f32,      // Damping ratio (default: 10.0)
       mass: f32,         // Mass (default: 1.0)
   }
   ```
2. Implement critically damped spring interpolation:
   ```rust
   fn spring_interp(&mut self, current: f32, target: f32, velocity: &mut f32, dt: f32, config: &SpringConfig) -> f32
   ```
3. Add velocity tracking for:
   - `rotation_velocity`
   - `tilt_velocity`
   - `energy_velocity`
   - `plasma_velocity`
4. Create state-specific spring configs:
   - Dormant: Soft (stiffness: 50)
   - Waking: Medium (stiffness: 100)
   - Exploding: Snappy (stiffness: 200)
5. Add overshoot on wake transition (tilt overshoots then settles)
6. Add bounce on explosion completion

**Files**:
- `opta-native/opta-render/src/components/ring.rs`

**Verification**:
- State transitions have natural spring-like motion
- Wake animation overshoots slightly before settling
- No jittery or linear-feeling transitions

---

### Task 6: 120Hz Optimization

**Objective**: Ensure all enhancements maintain 120Hz on ProMotion displays.

**Implementation**:
1. Add frame timing instrumentation:
   ```rust
   struct FrameStats {
       frame_time_ms: f32,
       gpu_time_ms: f32,
       vertex_count: u32,
       draw_calls: u32,
   }
   ```
2. Implement adaptive quality system:
   - Target: 8.33ms per frame (120Hz)
   - If frame_time > 10ms for 5 consecutive frames: reduce quality
   - If frame_time < 6ms for 30 consecutive frames: increase quality
3. Create shader complexity tiers:
   - `fs_main_ultra`: Full effects (8 octave noise, domain warp, subsurface)
   - `fs_main_hq`: High quality (6 octave noise, domain warp)
   - `fs_main`: Standard (4 octave noise)
   - `fs_main_lq`: Low quality (2 octave noise, no plasma)
4. Add render state for quality tier tracking
5. Expose FFI function for Swift to query current quality tier
6. Add `#[cfg(debug_assertions)]` performance overlay

**Files**:
- `opta-native/opta-render/src/components/ring.rs`
- `opta-native/opta-render/shaders/ring.wgsl` (add fs_main_ultra)
- `opta-native/opta-render/src/ffi.rs` (if exists, add quality query)

**Verification**:
- Ring maintains 120fps on M1 Pro/Max at Ultra quality
- Adaptive quality kicks in appropriately on lower hardware
- No visible stutter during quality transitions

---

## Verification

After all tasks complete:

```bash
# Build opta-render crate
cd /Users/matthewbyrden/Documents/Opta/opta-native && cargo build --release -p opta-render

# Run tests
cargo test -p opta-render

# Check for clippy warnings
cargo clippy -p opta-render -- -D warnings
```

**Visual Verification** (requires app launch):
- [ ] Ring geometry visibly smoother than before
- [ ] Glass material has realistic highlights and subsurface glow
- [ ] Plasma swirls organically with depth
- [ ] Bloom has color tinting and chromatic aberration on explosion
- [ ] State transitions feel springy and natural
- [ ] 120Hz maintained on M1 Pro hardware

## Success Criteria

- [ ] All 6 tasks complete
- [ ] `cargo build --release -p opta-render` succeeds
- [ ] `cargo test -p opta-render` passes
- [ ] `cargo clippy -p opta-render -- -D warnings` clean
- [ ] Ring visual quality noticeably improved
- [ ] Performance maintained at 120Hz target

## Output

Upon completion:
1. Create `77-01-SUMMARY.md` with execution details
2. Update `STATE.md` with Phase 77 progress
3. Commit with: `feat(77-01): enhance ring to HD quality`
