---
phase: 89-color-temperature-refinement
plan: 01
title: Color Temperature Foundation
subsystem: design-system
wave: 1
depends_on: []
files_modified: [opta-native/OptaApp/OptaApp/Design/ColorTemperature.swift, opta-native/OptaApp/OptaApp/Design/ColorTemperatureEnvironment.swift]
autonomous: true
scope: small
tags: [swift, swiftui, color-system, state-machine, design-system]
---

# Plan 89-01: Color Temperature Foundation

## Objective

Create the ColorTemperature system — a state machine that maps ring phase + energy into discrete color temperature states (dormant/idle/active/processing/alert), each providing computed color properties (violet intensity, glow opacity, ambient brightness, tint color). Published via SwiftUI Environment for consumption by all views.

## Execution Context

### Patterns from Prior Phases
- `OrganicMotion` (Phase 88) — hash-based utility enum namespace pattern
- `RingPhaseViewModel` — existing ring states (idle/wakingUp/active/optimizing/celebrating/sleeping)
- `ring.energy` (Float 0-1) — current energy level driving visual intensity
- `OptaTextStyle` — already has `dormantViolet` and `activeViolet` static colors
- `branchViolet = Color(hex: "8B5CF6")` — 7 independent definitions across files (to be unified in 89-02/89-03)

### Key References
- `opta-native/OptaApp/OptaApp/Models/OptaViewModel.swift` — RingViewModel, RingPhaseViewModel
- `opta-native/OptaApp/OptaApp/Design/OptaTextStyle.swift` — existing color palette

## Context

### Current State
- **Color is static**: All components use hardcoded `Color(hex: "8B5CF6")` regardless of app state
- **Energy drives opacity only**: `energyLevel * 0.5` opacity multipliers, but base color never changes
- **No state machine**: Ring phase exists but doesn't drive visual temperature
- **7 duplicate branchViolet definitions**: Each view defines its own constant

### Design Goals
- **Dormant**: Pure obsidian, no energy visible, monochrome — ring sleeping/energy near 0
- **Idle**: Faint branch glow at equator only, very dim purple — ring idle/low energy
- **Active**: Full branch extension, bright Electric Violet — ring active/medium energy
- **Processing**: Rapid branch pulsing, increased brightness — ring optimizing
- **Alert**: Branches extend to maximum, warm amber tint — high thermal or memory pressure

## Tasks

### Task 1: ColorTemperature State Model

**Files:** `opta-native/OptaApp/OptaApp/Design/ColorTemperature.swift`

**Changes:**
Create a new file with:

1. `ColorTemperatureState` enum: `.dormant`, `.idle`, `.active`, `.processing`, `.alert`
   - Conforms to `Equatable`, `Hashable`

2. Each case provides computed properties via extension:
   - `violetColor: Color` — dormant: `Color(hex: "1A0A2E")` (near-black purple), idle: `Color(hex: "3B1D5A")`, active: `Color(hex: "8B5CF6")`, processing: `Color(hex: "A78BFA")` (brighter), alert: `Color(hex: "F59E0B")` (amber)
   - `glowOpacity: Double` — dormant: 0, idle: 0.15, active: 0.6, processing: 0.9, alert: 0.8
   - `ambientBrightness: Double` — dormant: 0, idle: 0.02, active: 0.05, processing: 0.08, alert: 0.06
   - `branchIntensity: Double` — dormant: 0, idle: 0.2, active: 0.7, processing: 1.0, alert: 0.9
   - `tintColor: Color` — dormant/idle/active/processing: electric violet variants, alert: amber
   - `pulseSpeed: Double` — dormant: 0, idle: 0.3, active: 0.6, processing: 1.2, alert: 0.8

3. `ColorTemperature` enum (namespace) with:
   - `static func resolve(ringPhase: RingPhaseViewModel, energy: Float, thermalState: ProcessInfo.ThermalState, memoryPressure: Bool) -> ColorTemperatureState`
     - Mapping: sleeping/energy<0.1 → dormant, idle/energy<0.3 → idle, active/wakingUp → active, optimizing/celebrating → processing, serious/critical thermal OR high memory → alert
   - `static func interpolatedColor(from: ColorTemperatureState, to: ColorTemperatureState, progress: Double) -> Color` — for smooth transitions
   - `static func transitionSpring(from: ColorTemperatureState, to: ColorTemperatureState) -> Animation` — organic spring for state transitions (use OrganicMotion.organicSpring pattern)

4. Reduce-motion: transitions are instant (no spring) when accessibility enabled

**Verification:** File compiles as part of Xcode project

### Task 2: ColorTemperature SwiftUI Environment

**Files:** `opta-native/OptaApp/OptaApp/Design/ColorTemperatureEnvironment.swift`

**Changes:**
Create a new file with:

1. `ColorTemperatureKey: EnvironmentKey` — default value `.idle`
2. `extension EnvironmentValues` — `colorTemperature` property
3. `extension View` — `.colorTemperature(_ state: ColorTemperatureState)` convenience modifier

4. `ColorTemperatureProvider` view modifier (or ObservableObject):
   - Reads `OptaCoreManager.shared.viewModel.ring` (phase + energy)
   - Reads `ThermalStateManager.shared` for thermal state
   - Computes `ColorTemperatureState` using `ColorTemperature.resolve()`
   - Publishes to environment with organic spring transition (from Phase 88)
   - Updates on ring state changes (`.onChange(of:)` or Combine)

5. `extension View` — `.withColorTemperature()` modifier that wraps content with `ColorTemperatureProvider`
   - Applied once at app root (OptaAppApp.swift) to make temperature available everywhere

6. Convenience computed properties on `ColorTemperatureState` accessible from `@Environment(\.colorTemperature)`:
   - Views read `colorTemperature.violetColor`, `colorTemperature.glowOpacity`, etc.

**Verification:** File compiles, environment key is accessible

## Verification

After all tasks:
```bash
cd opta-native && xcodebuild build -project OptaApp/OptaApp.xcodeproj -scheme OptaApp -destination 'platform=macOS' 2>&1 | tail -5
```

Expected: **BUILD SUCCEEDED**

## Success Criteria

- [ ] `ColorTemperatureState` enum with 5 states and computed color properties
- [ ] `ColorTemperature.resolve()` maps ring phase + energy + system state to temperature
- [ ] Spring-based transitions between states (organic, not linear)
- [ ] SwiftUI Environment key publishes current temperature to all views
- [ ] `ColorTemperatureProvider` reads ring state and resolves temperature
- [ ] Reduce-motion: instant transitions, no spring animation
- [ ] Build succeeds with no new errors

## Output

- SUMMARY.md with files created, patterns established
- Per-task atomic commits
