---
phase: 06-cloud-llm-integration
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: [mcp-server/src/opta_mcp/anonymizer.py, mcp-server/src/opta_mcp/router.py, src/components/PrivacyIndicator.tsx, src/pages/Settings.tsx]
autonomous: true
---

<objective>
Implement privacy-preserving context anonymization for cloud queries.

Purpose: Protect user privacy when sending system context to Claude API - anonymize hardware identifiers, paths, and sensitive data.
Output: Anonymizer module that scrubs PII before cloud transmission, with user visibility into what's shared.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Prior plans (Claude API and Router):
@.planning/phases/06-cloud-llm-integration/06-01-PLAN.md
@.planning/phases/06-cloud-llm-integration/06-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create anonymizer module</name>
  <files>mcp-server/src/opta_mcp/anonymizer.py</files>
  <action>
Create `anonymizer.py` module with privacy-preserving transformations:

1. `anonymize_context(context: dict) -> dict` function:
   ```python
   import re
   import hashlib

   def anonymize_context(context: dict) -> dict:
       """Anonymize system context before sending to cloud."""
       result = {}

       for key, value in context.items():
           if isinstance(value, str):
               result[key] = anonymize_string(value)
           elif isinstance(value, dict):
               result[key] = anonymize_context(value)
           else:
               result[key] = value

       return result
   ```

2. `anonymize_string(text: str) -> str`:
   - Replace usernames in paths: `/Users/john/` -> `/Users/[USER]/`
   - Replace MAC addresses: `AA:BB:CC:DD:EE:FF` -> `[MAC_ADDR]`
   - Replace IP addresses: `192.168.1.100` -> `[LOCAL_IP]`
   - Replace serial numbers: hash or redact
   - Keep hardware model names (useful for optimization advice)

3. `SENSITIVE_PATTERNS` list:
   ```python
   SENSITIVE_PATTERNS = [
       (r'/Users/[^/]+/', '/Users/[USER]/'),
       (r'/home/[^/]+/', '/home/[USER]/'),
       (r'C:\\Users\\[^\\]+\\', 'C:\\Users\\[USER]\\'),
       (r'([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}', '[MAC_ADDR]'),
       (r'\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b', '[IP_ADDR]'),
       (r'[A-Za-z0-9]{8,}-[A-Za-z0-9]{4,}-', '[SERIAL]'),
   ]
   ```

4. `get_anonymization_summary(original: dict, anonymized: dict) -> list`:
   - Return list of what was anonymized
   - For transparency in UI

Privacy is critical - err on the side of removing too much rather than too little.
  </action>
  <verify>
cd mcp-server && uv run python -c "from opta_mcp.anonymizer import anonymize_string; print(anonymize_string('/Users/john/Documents'))"
  </verify>
  <done>Anonymizer module created with pattern-based PII removal</done>
</task>

<task type="auto">
  <name>Task 2: Integrate anonymizer with router</name>
  <files>mcp-server/src/opta_mcp/router.py</files>
  <action>
Update `router.py` to anonymize context before cloud transmission:

1. Import anonymizer:
   ```python
   from opta_mcp.anonymizer import anonymize_context, get_anonymization_summary
   ```

2. Update `route_chat()` to anonymize when routing to cloud:
   ```python
   def route_chat(messages: list, context: dict = None, prefer: str = "auto") -> dict:
       destination = classify_query(messages[-1]["content"]) if prefer == "auto" else prefer

       if destination == "cloud" and context:
           # Anonymize context before sending to cloud
           anon_context = anonymize_context(context)
           anonymized_fields = get_anonymization_summary(context, anon_context)

           response = claude_chat(messages, context=anon_context)
           response["anonymized_fields"] = anonymized_fields
       elif destination == "cloud":
           response = claude_chat(messages)
       else:
           response = ollama_chat(messages, context=context)

       response["backend"] = destination
       return response
   ```

3. Add `get_privacy_preview(context: dict) -> dict`:
   - Show what would be sent to cloud
   - Show what was anonymized
   - For UI transparency

Local queries keep full context (no privacy concern with local model).
  </action>
  <verify>
cd mcp-server && uv run python -c "from opta_mcp.router import route_chat; print('route_chat with anonymization available')"
  </verify>
  <done>Router anonymizes context before cloud transmission</done>
</task>

<task type="auto">
  <name>Task 3: Create privacy indicator component</name>
  <files>src/components/PrivacyIndicator.tsx, src/pages/Settings.tsx</files>
  <action>
1. Create `PrivacyIndicator.tsx`:
   - Small badge/icon showing privacy status
   - Props: backend ("local" | "cloud"), anonymizedFields?: string[]
   - Local: "üè† Private" (green) - data stays on device
   - Cloud: "‚òÅÔ∏è Anonymized" (blue) - data anonymized before transmission
   - Tooltip shows what was anonymized

2. Design (shadcn + Tailwind):
   ```typescript
   interface PrivacyIndicatorProps {
     backend: "local" | "cloud";
     anonymizedFields?: string[];
   }

   // Local: Shield icon with "Private" label
   // Cloud: Cloud icon with "Anonymized" label
   // Hover reveals details
   ```

3. Integrate with ChatMessage.tsx:
   - Show privacy indicator on each message
   - Subtle but accessible for privacy-conscious users

4. Update Settings.tsx:
   - Add "Privacy" section
   - Explain local vs cloud privacy model
   - Show sample anonymization (what gets redacted)
   - Toggle for "Always show privacy indicators" (default: on)

Users should feel confident their data is protected.
  </action>
  <verify>npm run build</verify>
  <done>Privacy indicator shows data handling transparency</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Anonymizer removes usernames from paths
- [ ] Anonymizer removes IP/MAC addresses
- [ ] Router uses anonymizer for cloud queries
- [ ] Privacy indicator renders on messages
- [ ] Settings shows privacy information
- [ ] `npm run build` succeeds
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- User data is anonymized before cloud transmission
- Privacy handling is transparent to users
</success_criteria>

<output>
After completion, create `.planning/phases/06-cloud-llm-integration/06-03-SUMMARY.md`
</output>
