# Plan 67-01: Windows DX12 Backend

## Wave: 1 (Independent)

## Objective

Enable wgpu DX12 backend for Windows platform with native shell integration.

## Execution Context

**Reference Documents:**
- wgpu Windows documentation
- Windows App SDK patterns

**Key Insights:**
- DX12 is the primary Windows graphics API
- WinUI 3 or raw Win32 for window management
- DXGI for swap chain and presentation

## Context

**Depends on:**
- Phase 60-66 (Rust core complete)

**Builds foundation for:**
- Windows distribution
- Cross-platform feature parity

## Tasks

### Task 1: Configure wgpu for DX12

**Update:** `opta-native/opta-render/Cargo.toml`

```toml
[target.'cfg(target_os = "windows")'.dependencies]
wgpu = { version = "24.0", default-features = false, features = [
    "wgsl",
    "dx12",
] }

# Windows-specific
windows = { version = "0.58", features = [
    "Win32_Foundation",
    "Win32_Graphics_Direct3D12",
    "Win32_Graphics_Dxgi_Common",
    "Win32_System_Threading",
    "Win32_UI_WindowsAndMessaging",
] }
```

### Task 2: Create Windows surface provider

**File:** `opta-native/opta-render/src/platform/windows.rs`

```rust
//! Windows-specific rendering integration.

#[cfg(target_os = "windows")]
use raw_window_handle::{HasRawWindowHandle, RawWindowHandle};

/// Windows surface configuration.
#[cfg(target_os = "windows")]
pub struct WindowsSurface {
    hwnd: windows::Win32::Foundation::HWND,
    width: u32,
    height: u32,
}

#[cfg(target_os = "windows")]
impl WindowsSurface {
    pub fn new(hwnd: windows::Win32::Foundation::HWND, width: u32, height: u32) -> Self {
        Self { hwnd, width, height }
    }

    pub fn resize(&mut self, width: u32, height: u32) {
        self.width = width;
        self.height = height;
    }

    pub fn size(&self) -> (u32, u32) {
        (self.width, self.height)
    }
}

#[cfg(target_os = "windows")]
unsafe impl HasRawWindowHandle for WindowsSurface {
    fn raw_window_handle(&self) -> RawWindowHandle {
        let mut handle = raw_window_handle::Win32WindowHandle::empty();
        handle.hwnd = self.hwnd.0 as *mut std::ffi::c_void;
        RawWindowHandle::Win32(handle)
    }
}

/// Check DX12 availability.
#[cfg(target_os = "windows")]
pub fn is_dx12_available() -> bool {
    // Check for DX12 support
    let instance = wgpu::Instance::new(wgpu::InstanceDescriptor {
        backends: wgpu::Backends::DX12,
        ..Default::default()
    });

    // Try to enumerate adapters
    let adapters: Vec<_> = instance.enumerate_adapters(wgpu::Backends::DX12).collect();
    !adapters.is_empty()
}

/// Get recommended backend for Windows.
#[cfg(target_os = "windows")]
pub fn recommended_backend() -> wgpu::Backends {
    if is_dx12_available() {
        wgpu::Backends::DX12
    } else {
        wgpu::Backends::VULKAN
    }
}

#[cfg(not(target_os = "windows"))]
pub fn recommended_backend() -> wgpu::Backends {
    wgpu::Backends::PRIMARY
}
```

### Task 3: Create Windows build script

**File:** `opta-native/scripts/build-windows.ps1`

```powershell
# Windows build script for Opta

$ErrorActionPreference = "Stop"

# Check Rust toolchain
rustup target add x86_64-pc-windows-msvc

# Build release
Write-Host "Building Opta for Windows..."
cargo build --release --target x86_64-pc-windows-msvc

# Sign binary (if certificate available)
$cert = Get-ChildItem -Path Cert:\CurrentUser\My -CodeSigningCert
if ($cert) {
    Write-Host "Signing binary..."
    Set-AuthenticodeSignature -FilePath "target/x86_64-pc-windows-msvc/release/opta.exe" -Certificate $cert
}

# Create installer with WiX or NSIS
Write-Host "Creating installer..."
# Add installer creation here

Write-Host "Build complete!"
```

## Verification

```powershell
cd opta-native
.\scripts\build-windows.ps1

# Test DX12 backend
cargo test -p opta-render --target x86_64-pc-windows-msvc
```

## Success Criteria

- [ ] wgpu initializes with DX12 backend
- [ ] Rendering works on Windows 10/11
- [ ] Fallback to Vulkan if DX12 unavailable
- [ ] Build script produces signed executable

## Output

- Windows DX12 backend configuration
- Windows surface provider
- Windows build and signing scripts
