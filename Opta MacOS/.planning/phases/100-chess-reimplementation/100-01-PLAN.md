# Phase 100: Chess Game Enhancement

## Overview

Phase 100 focuses on enhancing the existing chess implementation with additional features. The core SwiftUI chess game is already complete with a robust native AI, move validation, and obsidian glass design.

**What Already Exists:**
- ✅ Native SwiftUI ChessBoardView with obsidian glass theme
- ✅ ChessEngine with full move validation (castling, en passant, promotion)
- ✅ ChessAI actor with minimax, alpha-beta pruning, iterative deepening
- ✅ OptaAI that learns from user PGN files
- ✅ Custom ChessPieceShapes (Path-based)
- ✅ ChessViewModel with game state, history, undo
- ✅ Check/checkmate/stalemate detection
- ✅ Adaptive difficulty
- ✅ AI mode selector (Standard/OptaAI)

**What This Phase Adds:**
1. PGN import/export for game sharing
2. Puzzle mode with Lichess database integration
3. Optional Stockfish engine support

---

## Deliverables

### 1. PGN Import/Export Service

**File:** `Services/PGNService.swift`

```swift
actor PGNService {
    // Parse PGN string into array of moves
    func parsePGN(_ pgn: String) async throws -> [ChessMove]

    // Export current game to PGN format
    func exportToPGN(moves: [String], metadata: PGNMetadata) async -> String

    // Import from file URL
    func importFromFile(_ url: URL) async throws -> ImportedGame

    // Save to file
    func saveToFile(_ pgn: String, at url: URL) async throws
}

struct PGNMetadata: Sendable {
    var event: String = "Opta Chess"
    var site: String = "Opta App"
    var date: Date = Date()
    var white: String = "Player"
    var black: String = "Opta AI"
    var result: String = "*"
}

struct ImportedGame: Sendable {
    let metadata: PGNMetadata
    let moves: [ChessMove]
    let fenStart: String?
}
```

**Integration Points:**
- ChessViewModel: Add `importGame(from:)` and `exportGame()` methods
- ChessBoardView: Add import/export buttons in side panel

---

### 2. Puzzle Mode

**Files:**
- `Models/ChessPuzzle.swift` - Puzzle data model
- `Services/PuzzleService.swift` - Lichess puzzle loading
- `ViewModels/PuzzleViewModel.swift` - Puzzle game logic
- `Views/Chess/PuzzleModeView.swift` - Puzzle UI

```swift
struct ChessPuzzle: Identifiable, Codable, Sendable {
    let id: String
    let fen: String
    let moves: [String]  // UCI notation
    let rating: Int
    let themes: [String]
    let gameUrl: String?
}

actor PuzzleService {
    // Load puzzles from bundled Lichess database
    func loadPuzzles(rating: ClosedRange<Int>, themes: [String]?) async throws -> [ChessPuzzle]

    // Get next puzzle based on user rating
    func getNextPuzzle(userRating: Int) async -> ChessPuzzle?

    // Track puzzle attempts
    func recordAttempt(puzzleId: String, solved: Bool, time: TimeInterval) async
}

@Observable @MainActor
class PuzzleViewModel {
    var currentPuzzle: ChessPuzzle?
    var solutionMoveIndex: Int = 0
    var isPuzzleComplete: Bool = false
    var streak: Int = 0
    var userRating: Int = 1500

    func loadNextPuzzle() async
    func submitMove(_ move: ChessMove) -> PuzzleMoveResult
}
```

**Data Source:**
- Bundle a subset of Lichess puzzle database (JSON format)
- ~10,000 puzzles covering 1000-2500 rating range
- Filter by themes: tactics, endgame, opening, mate-in-X

---

### 3. Stockfish Integration (Optional)

**File:** `Services/StockfishService.swift`

```swift
actor StockfishService {
    private var process: Process?
    private var inputPipe: Pipe?
    private var outputPipe: Pipe?

    // Initialize Stockfish process
    func start() async throws

    // Stop Stockfish
    func stop() async

    // Get best move for position
    func getBestMove(fen: String, depth: Int, timeMs: Int) async throws -> StockfishMove

    // Analyze position
    func analyzePosition(fen: String, depth: Int) async throws -> PositionAnalysis
}

struct StockfishMove: Sendable {
    let uci: String      // e2e4
    let score: Int       // centipawns
    let mate: Int?       // moves to mate
    let pv: [String]     // principal variation
}

struct PositionAnalysis: Sendable {
    let evaluation: Double
    let bestMove: StockfishMove
    let topMoves: [StockfishMove]
    let depth: Int
}
```

**Note:** Stockfish binary must be bundled with the app or installed separately. This is optional - the native ChessAI provides sufficient gameplay.

---

## Implementation Sequence

### Step 1: PGN Service (Core)
1. Create `PGNService.swift` with parsing/export logic
2. Add SAN (Standard Algebraic Notation) parsing
3. Integrate with ChessViewModel
4. Add UI buttons for import/export

### Step 2: Puzzle Mode
1. Create puzzle data model
2. Bundle Lichess puzzle subset
3. Create PuzzleService for loading/tracking
4. Create PuzzleViewModel for game logic
5. Create PuzzleModeView UI
6. Add navigation to puzzle mode from chess view

### Step 3: Stockfish (Optional)
1. Create StockfishService wrapper
2. Add UCI protocol communication
3. Integrate as optional AI mode
4. Handle binary bundling/availability

---

## File Changes Summary

| File | Action | Description |
|------|--------|-------------|
| `Services/PGNService.swift` | Create | PGN parsing and export |
| `Models/ChessPuzzle.swift` | Create | Puzzle data model |
| `Services/PuzzleService.swift` | Create | Lichess puzzle loading |
| `ViewModels/PuzzleViewModel.swift` | Create | Puzzle game logic |
| `Views/Chess/PuzzleModeView.swift` | Create | Puzzle UI |
| `Views/Chess/ChessBoardView.swift` | Modify | Add import/export buttons |
| `ViewModels/ChessViewModel.swift` | Modify | Add import/export methods |
| `Resources/puzzles.json` | Create | Bundled puzzle database |

---

## Design Alignment

All new UI follows the established obsidian glass design:
- Use `OptaChessTheme` colors
- Glass backgrounds with `Color.optaSurface`
- Neon purple accents for interactive elements
- Spring animations for transitions

---

## Success Criteria

- [ ] Can export current game to PGN file
- [ ] Can import PGN file and replay game
- [ ] Puzzle mode loads and displays puzzles
- [ ] Puzzle rating adjusts based on performance
- [ ] (Optional) Stockfish can be used as AI opponent

---

## Notes

The existing chess implementation is production-ready. This phase adds quality-of-life features rather than core functionality. Prioritize PGN support and puzzles; Stockfish is optional enhancement.
