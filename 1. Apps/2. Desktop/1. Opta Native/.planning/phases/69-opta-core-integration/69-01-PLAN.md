---
phase: 69-opta-core-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - opta-native/scripts/generate-swift-bindings.sh
  - opta-native/OptaApp/OptaApp/Generated/OptaCore.swift
  - opta-native/OptaApp/OptaApp/Generated/opta_coreFFI.h
autonomous: true
---

<objective>
Generate fresh Swift bindings from opta-core via UniFFI and integrate them into the OptaApp Xcode project.

Purpose: Provide type-safe Swift interfaces for OptaCore, enabling SwiftUI to interact with the Crux state management system.
Output: Generated Swift bindings (OptaCore.swift, opta_coreFFI.h) in OptaApp/Generated/ directory, ready for SwiftUI integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Rust UniFFI Setup (existing):**
@opta-native/opta-core/src/lib.rs
@opta-native/opta-core/src/opta.udl

**Existing build script:**
@opta-native/scripts/build-xcframework.sh

**Target location for bindings:**
@opta-native/OptaApp/OptaApp/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dedicated Swift bindings generation script</name>
  <files>opta-native/scripts/generate-swift-bindings.sh</files>
  <action>
Create a focused script for generating Swift bindings from opta-core:

1. Build opta-core for macOS (aarch64-apple-darwin) in release mode
2. Use `cargo run --bin uniffi-bindgen` to generate Swift bindings from the compiled library
3. Output to `target/swift-bindings/`:
   - `opta.swift` (Swift wrapper classes)
   - `opta_coreFFI.h` (C header for FFI)
   - `opta_coreFFI.modulemap` (module map)
4. Handle UniFFI 0.28+ which uses library-mode binding generation

Key: UniFFI proc-macros export `OptaCore` object with methods:
- `new()` constructor
- `processEvent(eventJson: String) -> [String]`
- `getViewModelJson() -> String`
- `getModelJson() -> String`
- `getModelSlice(sliceName: String) -> String`
- `isReady() -> Bool`

Also exports enums:
- `FfiHapticPattern` (Light, Medium, Heavy, Success, Warning, Error, OptimizingPulse, ScoreCelebration)
- `FfiSoundEffect` (Click, Transition, OptimizeStart, OptimizeComplete, ScoreUp, Alert, RingWake, RingSleep)
  </action>
  <verify>
```bash
cd opta-native && ./scripts/generate-swift-bindings.sh
ls -la target/swift-bindings/
```
Expected: opta.swift, opta_coreFFI.h, opta_coreFFI.modulemap exist
  </verify>
  <done>Script generates Swift bindings successfully</done>
</task>

<task type="auto">
  <name>Task 2: Copy bindings to OptaApp project</name>
  <files>
opta-native/OptaApp/OptaApp/Generated/OptaCore.swift
opta-native/OptaApp/OptaApp/Generated/opta_coreFFI.h
  </files>
  <action>
1. Create `OptaApp/OptaApp/Generated/` directory if not exists
2. Copy generated `opta.swift` to `Generated/OptaCore.swift`
3. Copy `opta_coreFFI.h` to `Generated/opta_coreFFI.h`
4. Copy modulemap to `Generated/opta_coreFFI.modulemap`
5. Update script to include automatic copy step

Verify the generated Swift code contains:
- `public class OptaCore` with UniFFI object wrapper
- `public enum FfiHapticPattern`
- `public enum FfiSoundEffect`
- Functions: `optaInit()`, `optaVersion()`
  </action>
  <verify>
```bash
grep -l "class OptaCore" opta-native/OptaApp/OptaApp/Generated/OptaCore.swift
grep -l "FfiHapticPattern" opta-native/OptaApp/OptaApp/Generated/OptaCore.swift
```
Expected: Both searches find matches
  </verify>
  <done>Swift bindings copied to OptaApp/Generated/ with correct content</done>
</task>

<task type="auto">
  <name>Task 3: Verify Xcode project integration</name>
  <files>opta-native/OptaApp/OptaApp.xcodeproj/project.pbxproj</files>
  <action>
Verify the Xcode project can find and compile the generated bindings:

1. Check if Generated/ folder is already included in build sources
2. If not, provide instructions for adding via Xcode:
   - Right-click OptaApp folder â†’ Add Files to "OptaApp"
   - Select Generated/ folder
   - Ensure "Copy items if needed" is unchecked
   - Ensure "Create groups" is selected

3. Verify bridging header or module import works:
   - Check if `OptaApp-Bridging-Header.h` imports `opta_coreFFI.h`
   - Or verify Swift Package Manager integration

4. Build the Xcode project to verify compilation
  </action>
  <verify>
```bash
cd opta-native/OptaApp && xcodebuild -scheme OptaApp -configuration Debug build 2>&1 | head -50
```
Expected: Build succeeds or shows only unrelated warnings (not Swift binding errors)
  </verify>
  <done>Xcode project compiles with generated Swift bindings</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `generate-swift-bindings.sh` script exists and is executable
- [ ] Running script produces Swift bindings in target/swift-bindings/
- [ ] OptaApp/Generated/ contains OptaCore.swift and opta_coreFFI.h
- [ ] Generated Swift code contains OptaCore class and FFI enums
- [ ] `xcodebuild` for OptaApp succeeds without Swift binding errors
</verification>

<success_criteria>
- Swift bindings generation is automated via script
- Generated bindings expose OptaCore class with all methods
- FfiHapticPattern and FfiSoundEffect enums available in Swift
- OptaApp Xcode project compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/69-opta-core-integration/69-01-SUMMARY.md`
</output>
