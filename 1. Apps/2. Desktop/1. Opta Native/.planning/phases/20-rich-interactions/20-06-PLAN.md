# Plan 20-06: Global Shortcuts & Haptics

**Phase:** 20 - Rich Interactions
**Feature:** Native Global Shortcuts + macOS Haptic Feedback
**Scope:** Medium (2-3 days)
**Dependencies:** Tauri backend modifications required

---

## Summary

Add global keyboard shortcuts that work even when Opta is in the background using Tauri's native plugin, and macOS haptic feedback for consequential actions. Users can trigger Quick Optimization with Cmd+Shift+O without bringing the app to focus.

---

## Why This Matters

- **System-level integration** - Global shortcuts feel native, like Spotlight
- **Background operation** - Trigger optimization while gaming
- **Tactile feedback** - Haptics confirm important actions completed
- **Power user efficiency** - Keyboard-first workflow

---

## Implementation Tasks

### Task 1: Add Tauri global-shortcut plugin (Rust)
**File:** `src-tauri/Cargo.toml`, `src-tauri/src/lib.rs`

**Actions:**
1. Add tauri-plugin-global-shortcut to Cargo.toml
2. Register plugin in Tauri builder
3. Grant permissions in capabilities

**Cargo.toml addition:**
```toml
[dependencies]
tauri-plugin-global-shortcut = "2"
```

**lib.rs modification:**
```rust
// src-tauri/src/lib.rs
pub fn run() {
    tauri::Builder::default()
        .plugin(tauri_plugin_global_shortcut::Builder::new().build())
        // ... other plugins
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

**Capability file (src-tauri/capabilities/default.json):**
```json
{
  "permissions": [
    "global-shortcut:default"
  ]
}
```

**Verification:** Tauri builds successfully with plugin

---

### Task 2: Create useGlobalShortcut hook (Frontend)
**File:** `src/hooks/useGlobalShortcut.ts`

**Actions:**
1. Create hook that wraps Tauri's global-shortcut API
2. Handle registration and cleanup
3. Type-safe shortcut definitions
4. Error handling for permission issues

**Code pattern:**
```typescript
// src/hooks/useGlobalShortcut.ts
import { register, unregister, isRegistered } from '@tauri-apps/plugin-global-shortcut';
import { useEffect, useCallback } from 'react';

type ShortcutKey = 'CommandOrControl+Shift+O' | 'CommandOrControl+Shift+S';

interface UseGlobalShortcutOptions {
  shortcut: ShortcutKey;
  handler: () => void | Promise<void>;
  enabled?: boolean;
}

export function useGlobalShortcut({
  shortcut,
  handler,
  enabled = true,
}: UseGlobalShortcutOptions) {
  const registerShortcut = useCallback(async () => {
    if (!enabled) return;

    try {
      const registered = await isRegistered(shortcut);
      if (registered) {
        await unregister(shortcut);
      }

      await register(shortcut, (event) => {
        if (event.state === 'Pressed') {
          handler();
        }
      });
    } catch (error) {
      console.warn(`Failed to register shortcut ${shortcut}:`, error);
    }
  }, [shortcut, handler, enabled]);

  useEffect(() => {
    registerShortcut();

    return () => {
      unregister(shortcut).catch(() => {
        // Shortcut may already be unregistered
      });
    };
  }, [registerShortcut, shortcut]);
}
```

**Verification:** Hook compiles, handles registration errors gracefully

---

### Task 3: Register Quick Optimization shortcut
**File:** `src/App.tsx` or `src/components/GlobalShortcuts.tsx`

**Actions:**
1. Create GlobalShortcuts component that registers all global shortcuts
2. Register Cmd+Shift+O for Quick Optimization
3. Show toast notification when triggered
4. Connect to existing optimization logic

**Code pattern:**
```tsx
// src/components/GlobalShortcuts.tsx
import { useGlobalShortcut } from '@/hooks/useGlobalShortcut';
import { useOptimizer } from '@/hooks/useOptimizer';
import { toast } from '@/components/ui/toast'; // or your toast system

export function GlobalShortcuts() {
  const { runQuickOptimization, isOptimizing } = useOptimizer();

  useGlobalShortcut({
    shortcut: 'CommandOrControl+Shift+O',
    handler: async () => {
      if (isOptimizing) return;

      toast({
        title: 'Quick Optimization',
        description: 'Running optimization...',
      });

      await runQuickOptimization();
    },
  });

  // Component renders nothing - just registers shortcuts
  return null;
}
```

**Verification:** Cmd+Shift+O triggers optimization even when app unfocused

---

### Task 4: Add macOS haptics plugin (Rust)
**File:** `src-tauri/Cargo.toml`, `src-tauri/src/haptics.rs`

**Actions:**
1. Add tauri-plugin-macos-haptics (community plugin)
2. Create Tauri command wrapper for haptic patterns
3. Conditionally compile for macOS only

**Cargo.toml (macOS only):**
```toml
[target.'cfg(target_os = "macos")'.dependencies]
tauri-plugin-macos-haptics = { git = "https://github.com/ItsEeleeya/tauri-plugin-macos-haptics" }
```

**haptics.rs:**
```rust
// src-tauri/src/haptics.rs
#[cfg(target_os = "macos")]
use tauri_plugin_macos_haptics::{haptics::*, HapticsExt};

#[tauri::command]
pub async fn trigger_haptic(app: tauri::AppHandle, pattern: String) -> Result<(), String> {
    #[cfg(target_os = "macos")]
    {
        let feedback = match pattern.as_str() {
            "alignment" => NSHapticFeedbackPattern::Alignment,
            "levelChange" => NSHapticFeedbackPattern::LevelChange,
            "generic" => NSHapticFeedbackPattern::Generic,
            _ => NSHapticFeedbackPattern::Generic,
        };

        app.haptics()
            .perform(feedback, None)
            .map_err(|e| e.to_string())?;
    }

    Ok(())
}
```

**Verification:** Tauri builds on macOS with haptics support

---

### Task 5: Create haptics utility (Frontend)
**File:** `src/lib/haptics.ts`

**Actions:**
1. Create platform-aware haptic trigger function
2. Define semantic haptic patterns (success, warning, error)
3. Silently no-op on non-macOS platforms

**Code pattern:**
```typescript
// src/lib/haptics.ts
import { invoke } from '@tauri-apps/api/core';
import { platform } from '@tauri-apps/plugin-os';

export type HapticPattern = 'generic' | 'alignment' | 'levelChange';
export type HapticIntent = 'success' | 'warning' | 'error' | 'selection';

// Map semantic intents to native patterns
const intentToPattern: Record<HapticIntent, HapticPattern> = {
  success: 'levelChange',
  warning: 'alignment',
  error: 'generic',
  selection: 'alignment',
};

let isMacOS: boolean | null = null;

async function checkPlatform(): Promise<boolean> {
  if (isMacOS === null) {
    try {
      const currentPlatform = await platform();
      isMacOS = currentPlatform === 'macos';
    } catch {
      isMacOS = false;
    }
  }
  return isMacOS;
}

export async function haptic(intent: HapticIntent): Promise<void> {
  const mac = await checkPlatform();
  if (!mac) return;

  const pattern = intentToPattern[intent];

  try {
    await invoke('trigger_haptic', { pattern });
  } catch (error) {
    // Silently fail - haptics are enhancement only
    console.debug('Haptic feedback unavailable:', error);
  }
}

// Convenience exports
export const hapticSuccess = () => haptic('success');
export const hapticWarning = () => haptic('warning');
export const hapticError = () => haptic('error');
export const hapticSelection = () => haptic('selection');
```

**Verification:** Function executes without errors on macOS and non-macOS

---

### Task 6: Integrate haptics with key actions
**Files:** Various action handlers

**Actions:**
1. Add haptic feedback to optimization completion
2. Add haptic feedback to errors/warnings
3. Add haptic feedback to game launch
4. Keep haptic usage sparse (3-4 triggers per session max)

**Integration points:**
```typescript
// In useOptimizer.ts - after successful optimization
await hapticSuccess();

// In error handlers
await hapticError();

// In game launcher
await hapticSelection();
```

**Verification:** Haptic feedback fires on MacBook for consequential actions

---

### Task 7: Add global shortcut settings UI
**File:** `src/pages/Settings.tsx`

**Actions:**
1. Add section for keyboard shortcuts
2. Show current shortcuts with ability to disable
3. Show haptic feedback toggle (macOS only)
4. Persist settings to user preferences

**UI pattern:**
```tsx
// In Settings page
<Section title="Keyboard Shortcuts">
  <SettingRow
    label="Quick Optimization"
    description="Cmd+Shift+O (works in background)"
    control={<Switch checked={shortcuts.quickOptimize} onChange={...} />}
  />
</Section>

{platform === 'macos' && (
  <Section title="Feedback">
    <SettingRow
      label="Haptic Feedback"
      description="Tactile feedback on Force Touch trackpad"
      control={<Switch checked={haptics.enabled} onChange={...} />}
    />
  </Section>
)}
```

**Verification:** Settings UI shows shortcuts, toggles work

---

### Task 8: Document shortcuts in help/about
**File:** `src/components/CommandPalette/commands.ts` (or separate help modal)

**Actions:**
1. Add all global shortcuts to command palette list
2. Mark which shortcuts work in background
3. Add help tooltip showing all shortcuts

**Verification:** Users can discover shortcuts through UI

---

## Verification Checklist

- [ ] Tauri builds with global-shortcut plugin
- [ ] Cmd+Shift+O works when app in background
- [ ] Cmd+Shift+O triggers Quick Optimization flow
- [ ] Toast notification shows when shortcut triggered
- [ ] Haptic feedback fires on optimization complete (macOS)
- [ ] Haptic feedback fires on errors (macOS)
- [ ] No errors on Windows/Linux (haptics silently skip)
- [ ] Settings page shows shortcut configuration
- [ ] Shortcuts can be disabled in settings
- [ ] Shortcuts don't conflict with system shortcuts
- [ ] `npm run build` passes
- [ ] `cargo build` passes

---

## Files Created/Modified

| File | Action |
|------|--------|
| `src-tauri/Cargo.toml` | Add plugins |
| `src-tauri/src/lib.rs` | Register plugins |
| `src-tauri/src/haptics.rs` | Create haptic command |
| `src-tauri/capabilities/default.json` | Add permissions |
| `src/hooks/useGlobalShortcut.ts` | Create |
| `src/lib/haptics.ts` | Create |
| `src/components/GlobalShortcuts.tsx` | Create |
| `src/App.tsx` | Add GlobalShortcuts |
| `src/pages/Settings.tsx` | Add shortcut settings |
| `src/hooks/useOptimizer.ts` | Add haptic calls |

---

## Research Reference

From 20-RESEARCH.md:
- Use tauri-plugin-global-shortcut (not manual keydown)
- Use CommandOrControl for cross-platform (Cmd on Mac, Ctrl on Windows)
- Haptics: Reserve for consequential actions (3-4 per session max)
- Haptic patterns: levelChange for success, alignment for selection

---

## Platform Notes

- **macOS:** Full support for global shortcuts and haptics
- **Windows:** Global shortcuts work, no haptic support
- **Linux:** Global shortcuts work (may need accessibility permissions), no haptics

---

*Plan created: 2026-01-17*
*Ready for execution: yes*
