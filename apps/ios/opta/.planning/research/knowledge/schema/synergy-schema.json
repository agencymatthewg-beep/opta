{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://opta.app/schemas/synergy-schema.json",
  "title": "Opta Hardware Synergy Schema",
  "description": "Schema for hardware component interactions, bottlenecks, and synergies in the Opta Hardware Synergy Database",
  "type": "object",
  "required": ["$schema", "domain", "lastUpdated", "interactions"],
  "properties": {
    "$schema": {
      "type": "string",
      "const": "synergy-schema.json"
    },
    "domain": {
      "type": "string",
      "enum": ["gpu-cpu", "memory", "thermal", "power", "storage", "general"],
      "description": "Primary interaction domain this file covers"
    },
    "subDomain": {
      "type": "string",
      "description": "Specific sub-domain (e.g., 'unified-memory', 'pcie-bandwidth')"
    },
    "lastUpdated": {
      "type": "string",
      "format": "date",
      "description": "ISO date of last update"
    },
    "lastVerified": {
      "type": "string",
      "format": "date",
      "description": "ISO date of last verification"
    },
    "confidence": {
      "type": "string",
      "enum": ["high", "medium", "low"],
      "description": "Overall confidence in this synergy file"
    },
    "sources": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/source"
      },
      "description": "Data sources for this synergy file"
    },
    "interactions": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/interactionEntry"
      },
      "description": "Array of hardware interaction entries"
    }
  },
  "$defs": {
    "source": {
      "type": "object",
      "required": ["name", "type"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Source name or title"
        },
        "type": {
          "type": "string",
          "enum": ["gemini-research", "official-docs", "benchmark", "user-report", "derived", "measured"],
          "description": "Type of data source"
        },
        "url": {
          "type": "string",
          "format": "uri",
          "description": "URL to source if available"
        },
        "date": {
          "type": "string",
          "format": "date",
          "description": "Date of source material"
        }
      }
    },
    "interactionEntry": {
      "type": "object",
      "required": ["id", "type", "components", "relationship", "confidence"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "description": "Unique identifier (kebab-case, e.g., 'gpu-cpu-unified-memory-bottleneck')"
        },
        "type": {
          "type": "string",
          "enum": ["bottleneck", "synergy", "neutral", "dependency"],
          "description": "Type of component interaction"
        },
        "components": {
          "type": "array",
          "minItems": 2,
          "items": {
            "type": "string",
            "pattern": "^[a-z]+:[a-z0-9-]+$",
            "description": "Component reference in format 'category:identifier' (e.g., 'cpu:m4-pro', 'gpu:m4-pro-gpu', 'memory:unified')"
          },
          "description": "Array of component references involved in this interaction"
        },
        "relationship": {
          "type": "string",
          "description": "Human-readable description of how components interact"
        },
        "formula": {
          "$ref": "#/$defs/impactFormula",
          "description": "Optional mathematical formula for calculating impact"
        },
        "conditions": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/condition"
          },
          "description": "Conditions under which this interaction applies"
        },
        "impact": {
          "$ref": "#/$defs/impactMetrics",
          "description": "Quantified impact on performance, thermal, and power"
        },
        "confidence": {
          "type": "string",
          "enum": ["high", "medium", "low"],
          "description": "Confidence level for this specific interaction"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Searchable tags for this interaction"
        },
        "applicableTo": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Chips/devices this interaction applies to (e.g., ['M3', 'M3 Pro', 'M4 Max'])"
        },
        "source": {
          "type": "string",
          "description": "Source reference for this specific entry"
        },
        "sourceDate": {
          "type": "string",
          "description": "Year or date of source"
        },
        "relatedInteractions": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "IDs of related interaction entries"
        },
        "mitigations": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Potential mitigations or optimizations for bottlenecks"
        }
      }
    },
    "condition": {
      "type": "object",
      "required": ["parameter", "operator", "value"],
      "properties": {
        "parameter": {
          "type": "string",
          "description": "What's being checked (e.g., 'memory_usage', 'gpu_utilization', 'cpu_temperature')"
        },
        "operator": {
          "type": "string",
          "enum": ["gt", "lt", "eq", "gte", "lte", "range", "in"],
          "description": "Comparison operator"
        },
        "value": {
          "oneOf": [
            {
              "type": "number"
            },
            {
              "type": "string"
            },
            {
              "type": "array",
              "items": {
                "oneOf": [
                  { "type": "number" },
                  { "type": "string" }
                ]
              }
            },
            {
              "$ref": "#/$defs/rangeValue"
            }
          ],
          "description": "Value to compare against (number, string, array for 'in', or range object)"
        },
        "unit": {
          "type": "string",
          "description": "Unit of measurement (e.g., 'percent', 'GB', 'MHz', 'celsius')"
        }
      }
    },
    "rangeValue": {
      "type": "object",
      "required": ["min", "max"],
      "properties": {
        "min": {
          "type": "number",
          "description": "Minimum value of range"
        },
        "max": {
          "type": "number",
          "description": "Maximum value of range"
        }
      },
      "description": "Range value for 'range' operator conditions"
    },
    "impactMetrics": {
      "type": "object",
      "properties": {
        "performance": {
          "$ref": "#/$defs/numericValue",
          "description": "Performance impact (-100 to +100 scale, negative = degradation)"
        },
        "thermal": {
          "$ref": "#/$defs/numericValue",
          "description": "Thermal impact (-100 to +100 scale, negative = better cooling)"
        },
        "power": {
          "$ref": "#/$defs/numericValue",
          "description": "Power impact (-100 to +100 scale, negative = less power usage)"
        }
      },
      "description": "Impact metrics on a -100 to +100 scale"
    },
    "numericValue": {
      "type": "object",
      "required": ["value"],
      "properties": {
        "value": {
          "type": "number",
          "minimum": -100,
          "maximum": 100,
          "description": "Impact value on -100 to +100 scale"
        },
        "unit": {
          "type": "string",
          "description": "Unit if not on standard scale (e.g., 'percent', 'fps')"
        },
        "min": {
          "type": "number",
          "description": "Minimum observed value"
        },
        "max": {
          "type": "number",
          "description": "Maximum observed value"
        },
        "typical": {
          "type": "number",
          "description": "Typical/median observed value"
        }
      }
    },
    "impactFormula": {
      "type": "object",
      "required": ["expression", "variables"],
      "properties": {
        "expression": {
          "type": "string",
          "description": "Mathematical expression string (e.g., '(memory_bandwidth / max_bandwidth) * 100')"
        },
        "variables": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Map of variable names to their descriptions"
        },
        "outputUnit": {
          "type": "string",
          "description": "What the formula produces (e.g., 'percent', 'bottleneck_score')"
        }
      },
      "description": "Formula for calculating interaction impact dynamically"
    }
  }
}
