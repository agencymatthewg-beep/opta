---
phase: 04-app-controls
plan: 01
subsystem: services
requires: [app-registry, process-monitor, polished-ui]
provides: [app-launch, app-stop, bulk-actions]
affects: [05-preferences]
tags: [nsworkspace, nsrunningapplication, app-lifecycle]
discovery-level: 0
discovery-reason: NSWorkspace.open and NSRunningApplication.terminate are well-documented APIs
---

# Phase 04-01 Plan: App Controls

## Overview

Add launch, stop, and restart controls for Opta ecosystem apps. Users can click an app row to launch stopped apps or access controls for running apps. Include "Quit All" bulk action in the footer.

## Tasks

### Task 1: Add app paths to OptaApp model

**Files to modify:**
- `OptaMini/Models/OptaApp.swift`

**Implementation:**

Add app URL paths for launching:
```swift
import Foundation

struct OptaApp: Identifiable, Hashable {
    let id: String
    let name: String
    let bundleIdentifier: String
    let icon: String

    /// URL to the app bundle (for launching)
    var appURL: URL? {
        NSWorkspace.shared.urlForApplication(withBundleIdentifier: bundleIdentifier)
    }
}
```

**Verification:**
- [ ] `appURL` returns valid URL for installed apps
- [ ] Returns nil for apps not installed

---

### Task 2: Add app control methods to ProcessMonitor

**Files to modify:**
- `OptaMini/Services/ProcessMonitor.swift`

**Implementation:**

Add launch, stop, and restart methods:
```swift
/// Launch an Opta app
func launch(_ app: OptaApp) {
    guard let url = app.appURL else { return }
    NSWorkspace.shared.openApplication(at: url, configuration: NSWorkspace.OpenConfiguration())
}

/// Stop a running Opta app
func stop(_ app: OptaApp) {
    guard let runningApp = NSWorkspace.shared.runningApplications.first(where: {
        $0.bundleIdentifier == app.bundleIdentifier
    }) else { return }
    runningApp.terminate()
}

/// Restart an Opta app (stop then launch)
func restart(_ app: OptaApp) {
    stop(app)
    // Delay launch slightly to allow clean termination
    DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) { [weak self] in
        self?.launch(app)
    }
}

/// Stop all running Opta apps
func stopAll() {
    for app in OptaApp.allApps where isRunning(app) {
        stop(app)
    }
}
```

**Verification:**
- [ ] `launch()` opens the app
- [ ] `stop()` terminates the app gracefully
- [ ] `restart()` stops and relaunches
- [ ] `stopAll()` terminates all running Opta apps

---

### Task 3: Add control buttons to AppRowView

**Files to modify:**
- `OptaMini/ContentView.swift`

**Implementation:**

Update AppRowView to show action buttons on hover:
```swift
struct AppRowView: View {
    let app: OptaApp
    let isRunning: Bool
    let onLaunch: () -> Void
    let onStop: () -> Void
    @State private var isHovered = false

    var body: some View {
        HStack(spacing: 12) {
            // Status indicator
            Circle()
                .fill(isRunning ? Color.green : Color.gray.opacity(0.3))
                .frame(width: 8, height: 8)

            // App icon
            Image(systemName: app.icon)
                .font(.system(size: 18))
                .foregroundColor(isRunning ? .primary : .secondary)
                .frame(width: 24)

            // App name
            Text(app.name)
                .font(.system(size: 13))
                .foregroundColor(isRunning ? .primary : .secondary)

            Spacer()

            // Action button (shown on hover)
            if isHovered {
                Button(action: isRunning ? onStop : onLaunch) {
                    Image(systemName: isRunning ? "stop.fill" : "play.fill")
                        .font(.system(size: 10))
                        .foregroundColor(isRunning ? .red : .green)
                }
                .buttonStyle(.plain)
                .help(isRunning ? "Stop" : "Launch")
            } else {
                // Status text when not hovered
                Text(isRunning ? "Running" : "Stopped")
                    .font(.system(size: 11))
                    .foregroundColor(.secondary)
            }
        }
        .padding(.horizontal, 8)
        .padding(.vertical, 6)
        .background(
            RoundedRectangle(cornerRadius: 6)
                .fill(isHovered ? Color.primary.opacity(0.1) : Color.clear)
        )
        .contentShape(Rectangle())
        .onTapGesture {
            if !isRunning {
                onLaunch()
            }
        }
        .onHover { hovering in
            isHovered = hovering
        }
        .padding(.horizontal, 4)
    }
}
```

Update ContentView to pass actions:
```swift
ForEach(OptaApp.allApps) { app in
    AppRowView(
        app: app,
        isRunning: processMonitor.isRunning(app),
        onLaunch: { processMonitor.launch(app) },
        onStop: { processMonitor.stop(app) }
    )
}
```

**Verification:**
- [ ] Play button appears on hover for stopped apps
- [ ] Stop button appears on hover for running apps
- [ ] Clicking row launches stopped app
- [ ] Buttons trigger correct actions

---

### Task 4: Add "Quit All" to footer

**Files to modify:**
- `OptaMini/ContentView.swift`

**Implementation:**

Update FooterView to include Quit All:
```swift
struct FooterView: View {
    let runningCount: Int
    let onQuitAll: () -> Void

    var body: some View {
        HStack {
            if runningCount > 0 {
                Button("Quit All") {
                    onQuitAll()
                }
                .buttonStyle(.plain)
                .font(.system(size: 12))
                .foregroundColor(.red.opacity(0.8))
            }

            Spacer()

            Button("Quit") {
                NSApplication.shared.terminate(nil)
            }
            .buttonStyle(.plain)
            .font(.system(size: 12))
            .foregroundColor(.secondary)
        }
    }
}
```

Update ContentView:
```swift
FooterView(
    runningCount: processMonitor.runningCount,
    onQuitAll: { processMonitor.stopAll() }
)
```

**Verification:**
- [ ] "Quit All" appears only when apps are running
- [ ] "Quit All" stops all running Opta apps
- [ ] "Quit" still terminates Opta Mini

---

## Commit Strategy

1. `feat(04-01): add appURL to OptaApp model for launching`
2. `feat(04-01): add launch, stop, restart methods to ProcessMonitor`
3. `feat(04-01): add control buttons to app rows`
4. `feat(04-01): add Quit All to footer`

## Success Criteria

- [ ] Build succeeds with no warnings
- [ ] Clicking stopped app row launches it
- [ ] Stop button terminates running apps
- [ ] "Quit All" stops all running Opta apps
- [ ] UI updates in real-time after actions
- [ ] No crashes or hangs on app lifecycle operations
