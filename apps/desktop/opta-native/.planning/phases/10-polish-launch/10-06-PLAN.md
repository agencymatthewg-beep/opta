---
phase: 10-polish-launch
plan: 06
type: execute
wave: 2
depends_on: [10-04]
files_modified: [src/components/InvestigationMode.tsx, src/components/InvestigationPanel.tsx, src/pages/Settings.tsx, mcp-server/src/opta_mcp/investigation.py, mcp-server/src/opta_mcp/server.py]
autonomous: true
---

<objective>
Implement Investigation Mode for power users - full transparency into what Opta is doing under the hood.

Purpose: Fulfill the transparency promise for power users. Investigation Mode reveals the actual changes (registry keys, config files, exact commands), impact analysis (dependencies, what else this affects), and rollback implications. Nothing hidden.

Output: Investigation Mode panel with detailed change visibility.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/MUST_HAVE.md
@.planning/phases/10-polish-launch/10-CONTEXT.md
@DESIGN_SYSTEM.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create investigation data types</name>
  <files>src/types/investigation.ts</files>
  <action>
Define TypeScript types for investigation data:

```typescript
// src/types/investigation.ts

export type ChangeType = 'registry' | 'config' | 'command' | 'service' | 'file';
export type ChangePlatform = 'windows' | 'macos' | 'linux' | 'all';

export interface InvestigationChange {
  id: string;
  type: ChangeType;
  platform: ChangePlatform;
  location: string;  // Registry path, file path, or command
  description: string;
  before: string | null;  // Previous value (null if new)
  after: string;  // New value
  technical: string;  // Full technical detail
  reversible: boolean;
  rollbackCommand?: string;
}

export interface InvestigationDependency {
  name: string;
  type: 'requires' | 'conflicts' | 'affects';
  description: string;
  status: 'ok' | 'warning' | 'blocked';
}

export interface InvestigationImpact {
  category: 'performance' | 'stability' | 'compatibility' | 'security';
  severity: 'low' | 'medium' | 'high';
  description: string;
  mitigation?: string;
}

export interface InvestigationReport {
  optimizationId: string;
  optimizationName: string;
  timestamp: number;
  changes: InvestigationChange[];
  dependencies: InvestigationDependency[];
  impacts: InvestigationImpact[];
  rollback: {
    available: boolean;
    steps: string[];
    warnings: string[];
  };
}
```
  </action>
  <verify>Types compile correctly</verify>
  <done>Investigation data types defined</done>
</task>

<task type="auto">
  <name>Task 2: Create investigation backend</name>
  <files>mcp-server/src/opta_mcp/investigation.py, mcp-server/src/opta_mcp/server.py</files>
  <action>
Create Python module for generating investigation reports:

```python
# mcp-server/src/opta_mcp/investigation.py
"""Investigation mode - full transparency for power users."""

import platform
import time
from dataclasses import dataclass, asdict
from typing import Optional
from pathlib import Path

@dataclass
class InvestigationChange:
    id: str
    type: str  # registry, config, command, service, file
    platform: str  # windows, macos, linux, all
    location: str
    description: str
    before: Optional[str]
    after: str
    technical: str
    reversible: bool
    rollback_command: Optional[str] = None

@dataclass
class InvestigationDependency:
    name: str
    type: str  # requires, conflicts, affects
    description: str
    status: str  # ok, warning, blocked

@dataclass
class InvestigationImpact:
    category: str  # performance, stability, compatibility, security
    severity: str  # low, medium, high
    description: str
    mitigation: Optional[str] = None


def get_investigation_report(optimization_id: str, optimization_name: str) -> dict:
    """
    Generate a full investigation report for an optimization.

    Returns complete transparency about what will change.
    """
    changes = []
    dependencies = []
    impacts = []

    # Example: Game config optimization
    if "game" in optimization_id.lower():
        changes.append(InvestigationChange(
            id=f"{optimization_id}_config",
            type="config",
            platform="all",
            location=get_game_config_path(optimization_id),
            description="Game graphics settings file",
            before="ResolutionScale=100",
            after="ResolutionScale=85",
            technical="Modifies the internal render resolution. "
                     "Game renders at 85% resolution then upscales. "
                     "File format: INI/XML depending on game engine.",
            reversible=True,
            rollback_command=f"Restore from backup: ~/.opta/backups/{optimization_id}/"
        ))

        # Windows-specific registry changes
        if platform.system() == "Windows":
            changes.append(InvestigationChange(
                id=f"{optimization_id}_nvidia_profile",
                type="registry",
                platform="windows",
                location="HKEY_LOCAL_MACHINE\\SOFTWARE\\NVIDIA Corporation\\Global\\NVTweak",
                description="NVIDIA driver profile settings",
                before="PowerMgtMode=0",
                after="PowerMgtMode=1",
                technical="Sets NVIDIA power management to 'Prefer Maximum Performance'. "
                         "Prevents GPU from downclocking during gameplay. "
                         "Requires admin privileges to modify.",
                reversible=True,
                rollback_command="reg delete ... /v PowerMgtMode"
            ))

    # Process optimization changes
    if "process" in optimization_id.lower() or "stealth" in optimization_id.lower():
        changes.append(InvestigationChange(
            id=f"{optimization_id}_processes",
            type="command",
            platform="all",
            location="System processes",
            description="Terminate non-essential background processes",
            before="Running: Chrome, Spotify, Discord",
            after="Terminated: Chrome, Spotify",
            technical="Uses psutil to terminate processes by PID. "
                     "Sends SIGTERM first (graceful), then SIGKILL after 0.5s. "
                     "Protected processes (system, antivirus) are skipped.",
            reversible=False,
            rollback_command="Processes will restart on next boot or manual launch"
        ))

    # Add dependencies
    dependencies.append(InvestigationDependency(
        name="Backup System",
        type="requires",
        description="Original config backed up before changes",
        status="ok"
    ))

    # Add impacts
    impacts.append(InvestigationImpact(
        category="performance",
        severity="low",
        description="Resolution reduction may be visible on large monitors",
        mitigation="Use DLSS/FSR for better upscaling quality"
    ))

    return {
        "optimizationId": optimization_id,
        "optimizationName": optimization_name,
        "timestamp": int(time.time() * 1000),
        "changes": [asdict(c) for c in changes],
        "dependencies": [asdict(d) for d in dependencies],
        "impacts": [asdict(i) for i in impacts],
        "rollback": {
            "available": all(c.reversible for c in changes),
            "steps": [c.rollback_command for c in changes if c.rollback_command],
            "warnings": ["Some processes may need manual restart"]
        }
    }


def get_game_config_path(game_id: str) -> str:
    """Get the config file path for a game."""
    system = platform.system()

    # Example paths - would be populated from game detection
    paths = {
        "valorant": {
            "Windows": "%LOCALAPPDATA%\\VALORANT\\Saved\\Config\\Windows\\GameUserSettings.ini",
            "Darwin": "Not supported on macOS",
            "Linux": "Not supported on Linux"
        }
    }

    return paths.get(game_id.lower(), {}).get(system, "Unknown location")


def get_registry_changes_preview(optimization_id: str) -> list:
    """Get preview of registry changes (Windows only)."""
    if platform.system() != "Windows":
        return []

    # Would query actual planned registry modifications
    return [
        {
            "key": "HKEY_LOCAL_MACHINE\\SOFTWARE\\...",
            "value": "...",
            "type": "DWORD",
            "current": "0x00000000",
            "proposed": "0x00000001"
        }
    ]


def get_command_trace(optimization_id: str) -> list:
    """Get trace of commands that will be executed."""
    return [
        {
            "command": "taskkill /F /PID 1234",
            "purpose": "Terminate background process",
            "requires_admin": False
        }
    ]
```

Add MCP tool in server.py:
```python
Tool(
    name="get_investigation_report",
    description="Get full transparency report for an optimization",
    inputSchema={
        "type": "object",
        "properties": {
            "optimization_id": {"type": "string"},
            "optimization_name": {"type": "string"}
        },
        "required": ["optimization_id"]
    }
)
```
  </action>
  <verify>Python imports work, MCP tool registered</verify>
  <done>Investigation backend created</done>
</task>

<task type="auto">
  <name>Task 3: Create Investigation Panel component</name>
  <files>src/components/InvestigationPanel.tsx</files>
  <action>
Create the main Investigation Panel UI:

```tsx
// src/components/InvestigationPanel.tsx
import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Eye, FileCode, Terminal, AlertTriangle,
  CheckCircle, XCircle, ChevronDown, ChevronRight,
  Undo2, Copy, ExternalLink
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { cn } from '@/lib/utils';
import type { InvestigationReport, InvestigationChange } from '@/types/investigation';

interface InvestigationPanelProps {
  report: InvestigationReport;
  onClose: () => void;
}

export function InvestigationPanel({ report, onClose }: InvestigationPanelProps) {
  const [expandedChanges, setExpandedChanges] = useState<Set<string>>(new Set());
  const [copied, setCopied] = useState<string | null>(null);

  const toggleChange = (id: string) => {
    const next = new Set(expandedChanges);
    if (next.has(id)) {
      next.delete(id);
    } else {
      next.add(id);
    }
    setExpandedChanges(next);
  };

  const copyToClipboard = (text: string, id: string) => {
    navigator.clipboard.writeText(text);
    setCopied(id);
    setTimeout(() => setCopied(null), 2000);
  };

  const changeTypeIcons = {
    registry: FileCode,
    config: FileCode,
    command: Terminal,
    service: Terminal,
    file: FileCode,
  };

  return (
    <motion.div
      initial={{ opacity: 0, x: 300 }}
      animate={{ opacity: 1, x: 0 }}
      exit={{ opacity: 0, x: 300 }}
      className="fixed right-0 top-0 bottom-0 w-[480px] glass border-l border-border/30 z-50 overflow-y-auto"
    >
      <div className="p-4 border-b border-border/30 sticky top-0 glass-strong">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Eye className="w-5 h-5 text-primary" />
            <h2 className="text-lg font-semibold">Investigation Mode</h2>
          </div>
          <Button variant="ghost" size="sm" onClick={onClose}>
            <XCircle className="w-4 h-4" />
          </Button>
        </div>
        <p className="text-sm text-muted-foreground mt-1">
          {report.optimizationName}
        </p>
      </div>

      <div className="p-4 space-y-6">
        {/* Changes Section */}
        <section>
          <h3 className="text-sm font-semibold mb-3 flex items-center gap-2">
            <FileCode className="w-4 h-4" />
            Changes ({report.changes.length})
          </h3>
          <div className="space-y-2">
            {report.changes.map((change) => {
              const Icon = changeTypeIcons[change.type];
              const isExpanded = expandedChanges.has(change.id);

              return (
                <motion.div
                  key={change.id}
                  className="glass-subtle rounded-lg overflow-hidden"
                  layout
                >
                  <button
                    className="w-full p-3 flex items-center gap-2 text-left hover:bg-primary/5"
                    onClick={() => toggleChange(change.id)}
                  >
                    {isExpanded ? (
                      <ChevronDown className="w-4 h-4 text-muted-foreground" />
                    ) : (
                      <ChevronRight className="w-4 h-4 text-muted-foreground" />
                    )}
                    <Icon className="w-4 h-4 text-primary" />
                    <span className="flex-1 text-sm font-medium">{change.description}</span>
                    <Badge variant={change.reversible ? "default" : "secondary"}>
                      {change.reversible ? "Reversible" : "One-way"}
                    </Badge>
                  </button>

                  <AnimatePresence>
                    {isExpanded && (
                      <motion.div
                        initial={{ height: 0, opacity: 0 }}
                        animate={{ height: 'auto', opacity: 1 }}
                        exit={{ height: 0, opacity: 0 }}
                        className="px-3 pb-3"
                      >
                        {/* Location */}
                        <div className="mb-2">
                          <div className="text-xs text-muted-foreground mb-1">Location</div>
                          <div className="flex items-center gap-2">
                            <code className="text-xs bg-card p-1.5 rounded flex-1 overflow-x-auto">
                              {change.location}
                            </code>
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => copyToClipboard(change.location, `${change.id}_loc`)}
                            >
                              {copied === `${change.id}_loc` ? (
                                <CheckCircle className="w-3 h-3 text-success" />
                              ) : (
                                <Copy className="w-3 h-3" />
                              )}
                            </Button>
                          </div>
                        </div>

                        {/* Before/After */}
                        <div className="grid grid-cols-2 gap-2 mb-2">
                          <div>
                            <div className="text-xs text-muted-foreground mb-1">Before</div>
                            <code className="text-xs bg-danger/10 text-danger p-1.5 rounded block">
                              {change.before || 'N/A'}
                            </code>
                          </div>
                          <div>
                            <div className="text-xs text-muted-foreground mb-1">After</div>
                            <code className="text-xs bg-success/10 text-success p-1.5 rounded block">
                              {change.after}
                            </code>
                          </div>
                        </div>

                        {/* Technical Detail */}
                        <div className="mb-2">
                          <div className="text-xs text-muted-foreground mb-1">Technical Detail</div>
                          <p className="text-xs text-muted-foreground bg-card/50 p-2 rounded">
                            {change.technical}
                          </p>
                        </div>

                        {/* Rollback */}
                        {change.rollbackCommand && (
                          <div>
                            <div className="text-xs text-muted-foreground mb-1">Rollback Command</div>
                            <div className="flex items-center gap-2">
                              <code className="text-xs bg-warning/10 p-1.5 rounded flex-1">
                                {change.rollbackCommand}
                              </code>
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => copyToClipboard(change.rollbackCommand!, `${change.id}_rb`)}
                              >
                                {copied === `${change.id}_rb` ? (
                                  <CheckCircle className="w-3 h-3 text-success" />
                                ) : (
                                  <Copy className="w-3 h-3" />
                                )}
                              </Button>
                            </div>
                          </div>
                        )}
                      </motion.div>
                    )}
                  </AnimatePresence>
                </motion.div>
              );
            })}
          </div>
        </section>

        {/* Dependencies Section */}
        <section>
          <h3 className="text-sm font-semibold mb-3 flex items-center gap-2">
            <AlertTriangle className="w-4 h-4" />
            Dependencies ({report.dependencies.length})
          </h3>
          <div className="space-y-2">
            {report.dependencies.map((dep, i) => (
              <div key={i} className="glass-subtle rounded-lg p-3 flex items-center gap-3">
                <div className={cn(
                  "w-2 h-2 rounded-full",
                  dep.status === 'ok' && "bg-success",
                  dep.status === 'warning' && "bg-warning",
                  dep.status === 'blocked' && "bg-danger"
                )} />
                <div className="flex-1">
                  <div className="text-sm font-medium">{dep.name}</div>
                  <div className="text-xs text-muted-foreground">{dep.description}</div>
                </div>
                <Badge variant="outline">{dep.type}</Badge>
              </div>
            ))}
          </div>
        </section>

        {/* Impact Analysis */}
        <section>
          <h3 className="text-sm font-semibold mb-3 flex items-center gap-2">
            <AlertTriangle className="w-4 h-4" />
            Impact Analysis ({report.impacts.length})
          </h3>
          <div className="space-y-2">
            {report.impacts.map((impact, i) => (
              <div key={i} className={cn(
                "glass-subtle rounded-lg p-3 border-l-2",
                impact.severity === 'low' && "border-success",
                impact.severity === 'medium' && "border-warning",
                impact.severity === 'high' && "border-danger"
              )}>
                <div className="flex items-center justify-between mb-1">
                  <Badge variant="outline">{impact.category}</Badge>
                  <span className={cn(
                    "text-xs font-medium",
                    impact.severity === 'low' && "text-success",
                    impact.severity === 'medium' && "text-warning",
                    impact.severity === 'high' && "text-danger"
                  )}>
                    {impact.severity} impact
                  </span>
                </div>
                <p className="text-sm">{impact.description}</p>
                {impact.mitigation && (
                  <p className="text-xs text-muted-foreground mt-1">
                    Mitigation: {impact.mitigation}
                  </p>
                )}
              </div>
            ))}
          </div>
        </section>

        {/* Rollback Section */}
        <section>
          <h3 className="text-sm font-semibold mb-3 flex items-center gap-2">
            <Undo2 className="w-4 h-4" />
            Rollback
          </h3>
          <div className="glass-subtle rounded-lg p-3">
            <div className="flex items-center gap-2 mb-2">
              {report.rollback.available ? (
                <CheckCircle className="w-4 h-4 text-success" />
              ) : (
                <XCircle className="w-4 h-4 text-warning" />
              )}
              <span className="text-sm font-medium">
                {report.rollback.available
                  ? "Full rollback available"
                  : "Partial rollback only"}
              </span>
            </div>
            {report.rollback.warnings.length > 0 && (
              <div className="text-xs text-warning">
                {report.rollback.warnings.map((w, i) => (
                  <div key={i}>âš  {w}</div>
                ))}
              </div>
            )}
          </div>
        </section>
      </div>
    </motion.div>
  );
}
```
  </action>
  <verify>Investigation Panel renders with all sections</verify>
  <done>Investigation Panel component created</done>
</task>

<task type="auto">
  <name>Task 4: Add Investigation Mode toggle and integration</name>
  <files>src/components/InvestigationMode.tsx, src/pages/Settings.tsx, src/pages/Games.tsx</files>
  <action>
Create Investigation Mode context and integrate:

```tsx
// src/components/InvestigationMode.tsx
import { createContext, useContext, useState, ReactNode } from 'react';

interface InvestigationModeContextType {
  isInvestigationMode: boolean;
  setInvestigationMode: (enabled: boolean) => void;
  currentReport: InvestigationReport | null;
  showReport: (report: InvestigationReport) => void;
  hideReport: () => void;
}

const InvestigationModeContext = createContext<InvestigationModeContextType | undefined>(undefined);

export function InvestigationModeProvider({ children }: { children: ReactNode }) {
  const [isInvestigationMode, setIsInvestigationMode] = useState(() => {
    const saved = localStorage.getItem('opta_investigation_mode');
    return saved ? JSON.parse(saved) : false;
  });
  const [currentReport, setCurrentReport] = useState<InvestigationReport | null>(null);

  const showReport = (report: InvestigationReport) => setCurrentReport(report);
  const hideReport = () => setCurrentReport(null);

  return (
    <InvestigationModeContext.Provider value={{
      isInvestigationMode,
      setInvestigationMode: (enabled) => {
        setIsInvestigationMode(enabled);
        localStorage.setItem('opta_investigation_mode', JSON.stringify(enabled));
      },
      currentReport,
      showReport,
      hideReport,
    }}>
      {children}
      {currentReport && (
        <InvestigationPanel report={currentReport} onClose={hideReport} />
      )}
    </InvestigationModeContext.Provider>
  );
}

export function useInvestigationMode() {
  const context = useContext(InvestigationModeContext);
  if (!context) {
    throw new Error('useInvestigationMode must be used within InvestigationModeProvider');
  }
  return context;
}
```

Add toggle in Settings.tsx:
```tsx
// In Settings Privacy section
<div className="flex items-center justify-between p-4 glass-subtle rounded-lg">
  <div>
    <div className="font-medium">Investigation Mode</div>
    <div className="text-sm text-muted-foreground">
      Show detailed technical information about what Opta is doing
    </div>
  </div>
  <Switch
    checked={isInvestigationMode}
    onCheckedChange={setInvestigationMode}
  />
</div>
```

Add "Investigate" button in Games optimization preview:
```tsx
// In Games.tsx optimization section
{isInvestigationMode && (
  <Button
    variant="outline"
    size="sm"
    onClick={() => showReport(optimizationReport)}
  >
    <Eye className="w-4 h-4 mr-2" />
    Investigate
  </Button>
)}
```
  </action>
  <verify>Investigation Mode toggle works, panel opens with report data</verify>
  <done>Investigation Mode integrated into app</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Investigation types defined
- [ ] Backend generates investigation reports
- [ ] Investigation Panel displays all sections (changes, dependencies, impacts, rollback)
- [ ] Changes are expandable with full technical detail
- [ ] Copy-to-clipboard works for locations and commands
- [ ] Toggle in Settings enables Investigation Mode
- [ ] "Investigate" button appears in optimization preview when enabled
- [ ] `npm run build` succeeds
</verification>

<success_criteria>
- All tasks completed
- Power users can see exact registry keys, config files, commands
- Dependencies and impacts clearly listed
- Rollback steps visible
- Technical details available for each change
- Nothing hidden - complete transparency
</success_criteria>

<output>
After completion, create `.planning/phases/10-polish-launch/10-06-SUMMARY.md`
</output>
