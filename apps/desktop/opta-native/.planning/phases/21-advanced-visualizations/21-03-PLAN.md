---
phase: 21-advanced-visualizations
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/components/charts/DiskSpaceTreemap.tsx, src/components/charts/index.ts, src/hooks/useDiskAnalysis.ts, mcp-server/hardware_telemetry.py]
autonomous: true
---

<objective>
Implement disk space treemap visualization using Visx for hierarchical storage breakdown by folder/file type.

Purpose: Help users understand disk usage visually with an interactive treemap showing where storage is consumed (applications, documents, system, cache, etc.).
Output: DiskSpaceTreemap component showing storage breakdown with drill-down navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Research findings (from 20-RESEARCH.md):**
- Visx for treemaps
- >5000 SVG nodes = performance death (aggregate small files)
- Use Canvas for very large datasets

**Existing disk data:**
@src/hooks/useTelemetry.ts (basic disk usage only)
@mcp-server/hardware_telemetry.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add disk analysis to MCP server</name>
  <files>mcp-server/hardware_telemetry.py</files>
  <action>
Add disk analysis function to Python MCP server:

```python
def get_disk_analysis(path: str = "/", max_depth: int = 2) -> dict:
    """
    Analyze disk usage by directory.
    Returns hierarchical structure suitable for treemap visualization.

    Args:
        path: Root path to analyze (default "/")
        max_depth: How deep to traverse (default 2 levels)

    Returns:
        {
            "name": "root",
            "path": "/",
            "size": 500000000000,  # bytes
            "children": [
                {"name": "Applications", "path": "/Applications", "size": 50000000000, "children": [...]},
                {"name": "Users", "path": "/Users", "size": 200000000000, "children": [...]},
                ...
            ]
        }
    """
```

Implementation requirements:
- Use os.scandir() for efficient traversal (not os.walk for top levels)
- Handle permission errors gracefully (skip inaccessible directories)
- Aggregate files smaller than 10MB into "Other" node per directory
- Limit to top 20 items per level (aggregate rest into "Other")
- Cache results for 30 seconds (disk analysis is expensive)
- Add Tauri command to expose this via IPC

Safety:
- Never follow symlinks (prevent infinite loops)
- Skip system directories that require root (/private/var/db, etc.)
- Timeout after 10 seconds to prevent hanging on large filesystems
  </action>
  <verify>Call get_disk_analysis() from Python REPL and verify hierarchical output</verify>
  <done>MCP server returns hierarchical disk usage data suitable for treemap</done>
</task>

<task type="auto">
  <name>Task 2: Create disk analysis hook</name>
  <files>src/hooks/useDiskAnalysis.ts</files>
  <action>
Create hook that fetches and manages disk analysis data:

```typescript
interface DiskNode {
  name: string;
  path: string;
  size: number; // bytes
  children?: DiskNode[];
}

interface UseDiskAnalysisReturn {
  root: DiskNode | null;
  loading: boolean;
  error: string | null;
  refresh: () => Promise<void>;
  currentPath: string;
  navigateTo: (path: string) => void;
  navigateUp: () => void;
}
```

Requirements:
- Call MCP server's get_disk_analysis on mount
- Support navigation into directories (fetch children on demand)
- Maintain breadcrumb trail of visited paths
- Format sizes for display (KB, MB, GB)
- Cache fetched directories in memory
- Show loading state during fetch
- Handle errors gracefully (permission denied, etc.)
  </action>
  <verify>Hook fetches disk data and navigateTo changes current path</verify>
  <done>useDiskAnalysis hook manages disk analysis data with navigation support</done>
</task>

<task type="auto">
  <name>Task 3: Create DiskSpaceTreemap component</name>
  <files>src/components/charts/DiskSpaceTreemap.tsx, src/components/charts/index.ts</files>
  <action>
Create treemap component using Visx:

```typescript
interface DiskSpaceTreemapProps {
  height?: number; // Default 400
  onNavigate?: (path: string) => void;
  className?: string;
}
```

Implementation requirements:
- Use @visx/hierarchy treemap with "squarify" layout
- Color by file type category:
  - Applications: primary (purple)
  - Documents: chart-2 (blue)
  - Media: chart-3 (green)
  - System: chart-4 (orange)
  - Cache/Temp: muted
  - Other: muted-foreground
- Rectangle size = storage size
- Labels show name + formatted size if rect > 80px
- Tooltip shows: full path, exact size, file count
- Double-click to navigate into directory
- Breadcrumb trail above treemap for navigation
- "Back" button to navigate up
- Apply glass background
- Animate layout changes with Framer Motion

Performance:
- Limit to 100 visible rectangles max
- Aggregate small items into "Other" on client side
- Use memo to prevent re-renders
  </action>
  <verify>npm run build succeeds, treemap renders with disk data</verify>
  <done>DiskSpaceTreemap component renders hierarchical disk usage with navigation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] MCP server returns disk analysis data
- [ ] Treemap renders with real disk data
- [ ] Colors distinguish file type categories
- [ ] Double-click navigates into directories
- [ ] Breadcrumb trail shows current path
- [ ] Back button works
- [ ] Tooltip shows details on hover
- [ ] Glass styling applied
</verification>

<success_criteria>
- All tasks completed
- DiskSpaceTreemap component functional
- Hierarchical disk visualization works
- Navigation (drill-down, breadcrumb, back) works
- Performance acceptable with large directories
</success_criteria>

<output>
After completion, create `.planning/phases/21-advanced-visualizations/21-03-SUMMARY.md`
</output>
