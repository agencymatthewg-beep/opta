# Plan 60-01: wgpu Instance and Surface

## Wave: 1 (No dependencies within phase)

## Objective

Create wgpu instance with Metal backend and configure surface for SwiftUI integration.

## Execution Context

**Reference Documents:**
- `Gemini Deep Research/Hardware & Platform Knowledge/wgpu-SwiftUI-iOS-macOS-Integration.md`
- `opta-native/opta-core/` - Existing Crux core

**Key Insights from Research:**
- Metal is the ONLY viable backend for Apple platforms (avoid MoltenVK)
- Surface requires CAMetalLayer-backed view
- Use MTKView for automatic resize/color space handling
- Unified Memory Architecture means staging buffers are redundant on Apple Silicon

## Context

**Existing Code:**
- `opta-native/` workspace with opta-core and opta-shared crates
- UniFFI bindings configured (Phase 59)
- Cross-compilation setup ready

**New Dependencies:**
```toml
wgpu = "24.0"
raw-window-handle = "0.6"
pollster = "0.4"  # For blocking on async in sync context
```

## Tasks

### Task 1: Add wgpu dependencies to workspace

**File:** `opta-native/Cargo.toml`

Add wgpu and related dependencies:
```toml
[workspace.dependencies]
wgpu = "24.0"
raw-window-handle = "0.6"
pollster = "0.4"
```

### Task 2: Create opta-render crate

**Files to create:**
- `opta-native/opta-render/Cargo.toml`
- `opta-native/opta-render/src/lib.rs`
- `opta-native/opta-render/src/instance.rs`
- `opta-native/opta-render/src/surface.rs`

**Cargo.toml:**
```toml
[package]
name = "opta-render"
version = "0.1.0"
edition = "2021"

[dependencies]
wgpu = { workspace = true }
raw-window-handle = { workspace = true }
pollster = { workspace = true }
tracing = "0.1"
thiserror = "2.0"

[target.'cfg(target_os = "macos")'.dependencies]
objc2 = "0.6"
```

### Task 3: Implement GPU instance creation

**File:** `opta-native/opta-render/src/instance.rs`

Create `GpuContext` struct:
- `wgpu::Instance` with Metal backend preference
- `wgpu::Adapter` with power preference (high performance)
- `wgpu::Device` with Apple Silicon optimized limits
- `wgpu::Queue` for command submission

```rust
pub struct GpuContext {
    pub instance: wgpu::Instance,
    pub adapter: wgpu::Adapter,
    pub device: wgpu::Device,
    pub queue: wgpu::Queue,
    pub capabilities: GpuCapabilities,
}

pub struct GpuCapabilities {
    pub max_texture_size: u32,
    pub max_compute_workgroup_size: [u32; 3],
    pub supports_120hz: bool,
    pub unified_memory: bool,
}
```

### Task 4: Implement surface configuration

**File:** `opta-native/opta-render/src/surface.rs`

Create `RenderSurface` struct:
- Surface creation from raw window handle
- Physical pixel size management (Retina scaling)
- Reconfigure on resize
- Swapchain texture acquisition

```rust
pub struct RenderSurface {
    surface: wgpu::Surface<'static>,
    config: wgpu::SurfaceConfiguration,
    scale_factor: f64,
}

impl RenderSurface {
    pub fn new(
        instance: &wgpu::Instance,
        window: impl HasWindowHandle + HasDisplayHandle,
        physical_size: (u32, u32),
        scale_factor: f64,
    ) -> Result<Self, SurfaceError>;

    pub fn resize(&mut self, device: &wgpu::Device, new_size: (u32, u32));

    pub fn get_current_texture(&self) -> Result<wgpu::SurfaceTexture, wgpu::SurfaceError>;
}
```

### Task 5: Add FFI exports for Swift

**File:** `opta-native/opta-render/src/ffi.rs`

Create C-compatible interface for Swift:
```rust
#[no_mangle]
pub extern "C" fn opta_render_init(view_ptr: *mut c_void) -> *mut GpuContext;

#[no_mangle]
pub extern "C" fn opta_render_resize(ctx: *mut GpuContext, width: u32, height: u32);

#[no_mangle]
pub extern "C" fn opta_render_destroy(ctx: *mut GpuContext);
```

### Task 6: Update workspace members

**File:** `opta-native/Cargo.toml`

Add opta-render to workspace members.

## Verification

```bash
cd opta-native
cargo check -p opta-render
cargo clippy -p opta-render -- -D warnings
cargo test -p opta-render
```

## Success Criteria

- [ ] opta-render crate compiles for macOS (aarch64-apple-darwin)
- [ ] opta-render crate compiles for iOS (aarch64-apple-ios)
- [ ] GpuContext successfully creates wgpu instance with Metal backend
- [ ] GpuCapabilities correctly detects Apple Silicon features
- [ ] FFI exports are visible in generated header

## Output

- `opta-native/opta-render/` crate with wgpu instance and surface management
- C-compatible FFI for Swift integration
- Ready for render pipeline implementation (Plan 60-02)
