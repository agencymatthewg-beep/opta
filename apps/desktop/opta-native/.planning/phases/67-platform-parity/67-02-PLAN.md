# Plan 67-02: Linux Vulkan Backend

## Wave: 1 (Independent)

## Objective

Enable wgpu Vulkan backend for Linux with Wayland and X11 support.

## Execution Context

**Reference Documents:**
- wgpu Linux documentation
- Wayland/X11 surface creation

**Key Insights:**
- Vulkan is the primary Linux graphics API
- Support both Wayland and X11 window systems
- Use XDG desktop integration

## Context

**Depends on:**
- Phase 60-66 (Rust core complete)

**Builds foundation for:**
- Linux distribution
- Steam Deck support

## Tasks

### Task 1: Configure wgpu for Vulkan

**Update:** `opta-native/opta-render/Cargo.toml`

```toml
[target.'cfg(target_os = "linux")'.dependencies]
wgpu = { version = "24.0", default-features = false, features = [
    "wgsl",
    "vulkan",
] }

# Linux windowing
wayland-client = { version = "0.31", optional = true }
x11 = { version = "2.21", optional = true }

[target.'cfg(target_os = "linux")'.features]
wayland = ["wayland-client"]
x11-backend = ["x11"]
linux-full = ["wayland", "x11-backend"]
```

### Task 2: Create Linux surface provider

**File:** `opta-native/opta-render/src/platform/linux.rs`

```rust
//! Linux-specific rendering integration.

#[cfg(target_os = "linux")]
use raw_window_handle::{HasRawWindowHandle, RawWindowHandle, RawDisplayHandle};

/// Linux display server type.
#[cfg(target_os = "linux")]
#[derive(Debug, Clone, Copy)]
pub enum DisplayServer {
    Wayland,
    X11,
}

#[cfg(target_os = "linux")]
impl DisplayServer {
    /// Detect current display server.
    pub fn detect() -> Self {
        if std::env::var("WAYLAND_DISPLAY").is_ok() {
            DisplayServer::Wayland
        } else {
            DisplayServer::X11
        }
    }
}

/// Linux surface configuration.
#[cfg(target_os = "linux")]
pub struct LinuxSurface {
    display_server: DisplayServer,
    width: u32,
    height: u32,
    // Platform-specific handles stored here
}

#[cfg(target_os = "linux")]
impl LinuxSurface {
    pub fn new(width: u32, height: u32) -> Self {
        Self {
            display_server: DisplayServer::detect(),
            width,
            height,
        }
    }

    pub fn display_server(&self) -> DisplayServer {
        self.display_server
    }

    pub fn resize(&mut self, width: u32, height: u32) {
        self.width = width;
        self.height = height;
    }

    pub fn size(&self) -> (u32, u32) {
        (self.width, self.height)
    }
}

/// Check Vulkan availability.
#[cfg(target_os = "linux")]
pub fn is_vulkan_available() -> bool {
    let instance = wgpu::Instance::new(wgpu::InstanceDescriptor {
        backends: wgpu::Backends::VULKAN,
        ..Default::default()
    });

    let adapters: Vec<_> = instance.enumerate_adapters(wgpu::Backends::VULKAN).collect();
    !adapters.is_empty()
}

/// Get recommended backend for Linux.
#[cfg(target_os = "linux")]
pub fn recommended_backend() -> wgpu::Backends {
    wgpu::Backends::VULKAN
}
```

### Task 3: Create Linux build script

**File:** `opta-native/scripts/build-linux.sh`

```bash
#!/bin/bash
# Linux build script for Opta

set -e

cd "$(dirname "$0")/.."

echo "Installing dependencies..."
# Debian/Ubuntu
if command -v apt-get &> /dev/null; then
    sudo apt-get update
    sudo apt-get install -y \
        libvulkan-dev \
        libwayland-dev \
        libxkbcommon-dev \
        libx11-dev \
        libxcursor-dev \
        libxrandr-dev \
        libxi-dev
fi

# Fedora
if command -v dnf &> /dev/null; then
    sudo dnf install -y \
        vulkan-loader-devel \
        wayland-devel \
        libxkbcommon-devel \
        libX11-devel \
        libXcursor-devel \
        libXrandr-devel \
        libXi-devel
fi

echo "Building Opta for Linux..."
cargo build --release --features linux-full

echo "Creating AppImage..."
# AppImage packaging here

echo "Build complete!"
ls -la target/release/opta
```

## Verification

```bash
cd opta-native
./scripts/build-linux.sh

# Test Vulkan backend
cargo test -p opta-render
```

## Success Criteria

- [ ] wgpu initializes with Vulkan backend
- [ ] Works on Wayland and X11
- [ ] Build script handles dependencies
- [ ] AppImage package created

## Output

- Linux Vulkan backend configuration
- Wayland/X11 surface provider
- Linux build and packaging scripts
