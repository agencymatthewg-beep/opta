# Plan 78-01: HD Glass Panel System

## Metadata

```yaml
phase: 78
plan: 01
name: HD Glass Panel System
status: ready
wave: 1
autonomous: true
estimated_effort: medium
```

## Objective

Upgrade the glass panel system to use HD glass materials with Cook-Torrance BRDF, add premium glow and neon effects, and establish the foundation for app-wide visual consistency.

## Execution Context

Reference files:
- `opta-native/opta-render/src/components/glass_panel.rs` - Existing glass panel component
- `opta-native/opta-render/shaders/glass_panel.wgsl` - Basic glass panel shader
- `opta-native/opta-render/shaders/includes/glass_hd.wgsl` - HD glass material from Phase 77
- `opta-native/opta-render/shaders/includes/noise_hd.wgsl` - HD noise for effects
- `opta-native/opta-render/shaders/bloom_hd.wgsl` - HD bloom pipeline

## Context

Phase 77 established HD shaders for the ring (glass_hd.wgsl, noise_hd.wgsl, bloom_hd.wgsl). Phase 78 extends this HD aesthetic to glass panels used throughout the app. The existing glass_panel.rs uses basic Poisson disk blur. We'll upgrade it to use the Cook-Torrance BRDF from glass_hd.wgsl and add premium glow/neon effects.

## Tasks

### Task 1: HD Glass Panel Shader
**Goal**: Create glass_panel_hd.wgsl integrating Cook-Torrance BRDF and depth hierarchy

**Implementation**:
1. Create `opta-native/opta-render/shaders/glass_panel_hd.wgsl`
2. Import glass_hd.wgsl utilities (inline dependencies for standalone shader)
3. Add `HDPanelUniforms` struct with:
   - Base panel properties (position, size, corner_radius)
   - HD glass properties (ior, roughness, tint, dispersion)
   - Depth layer with blur intensity scaling
   - Fresnel edge highlight parameters
   - Ambient glow color and intensity
4. Implement HD blur sampling (Kawase or improved Poisson)
5. Add soft fresnel edge highlights using Cook-Torrance
6. Add subtle inner glow effect for depth
7. Support configurable depth blur falloff

**Files**:
- Create: `opta-native/opta-render/shaders/glass_panel_hd.wgsl`

**Verification**: Shader compiles without WGSL errors when loaded

---

### Task 2: Glass Panel Quality Levels
**Goal**: Add quality levels to GlassPanel matching ring's RingQualityLevel pattern

**Implementation**:
1. Add `PanelQualityLevel` enum (Low, Medium, High, Ultra)
2. Define blur sample counts per level:
   - Low: 8 samples, basic fresnel
   - Medium: 16 samples, standard fresnel (current)
   - High: 32 samples, HD fresnel + inner glow
   - Ultra: 64 samples, full Cook-Torrance + dispersion
3. Add `quality_level` field to `GlassPanelConfig`
4. Update `GlassPanel::new()` to accept quality
5. Add `set_quality()` method for runtime changes
6. Add blur kernel regeneration based on quality

**Files**:
- Modify: `opta-native/opta-render/src/components/glass_panel.rs`
- Modify: `opta-native/opta-render/src/components/mod.rs` (exports)

**Verification**: `cargo build -p opta-render` succeeds

---

### Task 3: Premium Glow Shader Include
**Goal**: Create glow_hd.wgsl with premium glow and neon effects

**Implementation**:
1. Create `opta-native/opta-render/shaders/includes/glow_hd.wgsl`
2. Add `GlowConfig` struct with:
   - Base color and intensity
   - Falloff curve (linear, quadratic, exponential)
   - Inner glow vs outer glow
   - Pulse animation parameters
3. Implement `soft_glow()` - smooth radial falloff
4. Implement `neon_glow()` - sharp edge with soft spread
5. Implement `energy_pulse()` - animated glow variation
6. Add `glow_from_sdf()` - distance field based glow
7. Add `panel_edge_glow()` - fresnel-aware panel glow

**Files**:
- Create: `opta-native/opta-render/shaders/includes/glow_hd.wgsl`

**Verification**: WGSL syntax validates

---

### Task 4: Neon Trail Effects
**Goal**: Create neon_hd.wgsl for energy trail and line effects

**Implementation**:
1. Create `opta-native/opta-render/shaders/includes/neon_hd.wgsl`
2. Add `NeonLineConfig` struct with:
   - Line color and width
   - Glow radius and intensity
   - Motion blur strength
   - Pulse frequency
3. Implement `neon_line()` - glowing line segment
4. Implement `neon_curve()` - bezier curve with glow
5. Implement `neon_trail()` - fading trail with motion blur
6. Implement `neon_pulse()` - energy pulse along path
7. Add chromatic aberration option for enhanced effect

**Files**:
- Create: `opta-native/opta-render/shaders/includes/neon_hd.wgsl`

**Verification**: WGSL syntax validates

---

### Task 5: Depth Hierarchy System
**Goal**: Implement proper glass depth hierarchy with blur scaling

**Implementation**:
1. Add `DepthHierarchy` struct in glass_panel.rs:
   - `foreground: f32` (0.0 = front, typically panels/modals)
   - `content: f32` (0.5 = mid, typical content cards)
   - `background: f32` (1.0 = far, ambient elements)
2. Add blur multiplier per depth level
3. Add opacity falloff per depth level
4. Implement `depth_adjusted_blur()` function
5. Update glass panel shader to use depth-scaled blur
6. Add z-ordering helpers for panel sorting

**Files**:
- Modify: `opta-native/opta-render/src/components/glass_panel.rs`
- Modify: `opta-native/opta-render/shaders/glass_panel_hd.wgsl`

**Verification**: Tests pass, visual depth distinction visible

---

### Task 6: Glass Panel Tests
**Goal**: Add comprehensive tests for HD glass panel features

**Implementation**:
1. Create test module in glass_panel.rs if not exists
2. Add `test_panel_quality_level` - verify enum values
3. Add `test_panel_quality_blur_samples` - verify sample counts
4. Add `test_panel_config_with_quality` - config construction
5. Add `test_depth_hierarchy_blur_scaling` - depth affects blur
6. Add `test_panel_hd_uniforms_size` - 16-byte alignment
7. Add `test_quality_level_conversion` - quality adapters
8. Verify all tests pass with `cargo test -p opta-render`

**Files**:
- Modify: `opta-native/opta-render/src/components/glass_panel.rs`
- Create: `opta-native/opta-render/tests/glass_panel_test.rs` (if needed)

**Verification**: `cargo test -p opta-render` passes

---

## Verification

```bash
# Build the library
cargo build --release -p opta-render

# Run all tests
cargo test -p opta-render

# Verify shaders compile (via Rust include)
cargo build -p opta-render 2>&1 | grep -i "shader\|wgsl"
```

## Success Criteria

- [ ] `glass_panel_hd.wgsl` created with Cook-Torrance BRDF
- [ ] `PanelQualityLevel` enum matches ring pattern
- [ ] `glow_hd.wgsl` provides soft glow and neon effects
- [ ] `neon_hd.wgsl` provides energy trail effects
- [ ] Depth hierarchy with blur scaling implemented
- [ ] All tests pass (expect ~10 new tests)
- [ ] `cargo build --release -p opta-render` succeeds

## Output

On completion:
1. Create `78-01-SUMMARY.md` with commits and verification results
2. HD glass panel shader ready for integration
3. Glow and neon effect shaders available for app-wide use
4. Quality level system consistent with ring implementation
