---
phase: 42-hardware-synergy-database
plan: 02
type: execute
wave: 2
depends_on: ["42-01"]
files_modified: [.planning/research/knowledge/synergies/bottlenecks/gpu-cpu-bottlenecks.json]
autonomous: true
---

<objective>
Create GPU-CPU bottleneck calculation models for the Hardware Synergy Database.

Purpose: Document when and how GPU and CPU create bottlenecks for each other across different Apple Silicon configurations. This enables Opta to predict and explain performance limitations.

Output:
- `gpu-cpu-bottlenecks.json` - Comprehensive bottleneck interaction data for M-series chips
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/knowledge/schema/synergy-schema.json
@.planning/research/knowledge/synergies/README.md
@.planning/research/knowledge/t2-architecture/apple-silicon.json
@.planning/research/knowledge/t3-specs/m-series.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GPU-CPU bottleneck data file</name>
  <files>.planning/research/knowledge/synergies/bottlenecks/gpu-cpu-bottlenecks.json</files>
  <action>
Create a JSON file following synergy-schema.json with GPU-CPU bottleneck interactions.

Include entries for:

1. **CPU-bound scenarios** (GPU waiting on CPU):
   - Draw call overhead bottleneck
   - Physics simulation bottleneck
   - AI/game logic bottleneck
   - Asset loading/decompression bottleneck

2. **GPU-bound scenarios** (CPU waiting on GPU):
   - Shader complexity bottleneck
   - Resolution/render target bottleneck
   - Post-processing bottleneck
   - Ray tracing bottleneck (M3+)

3. **Balanced scenarios**:
   - Optimal GPU-CPU utilization ranges
   - P-core vs E-core impact on bottlenecks

For each entry include:
- Clear conditions when bottleneck occurs (e.g., "cpu_utilization > 90% AND gpu_utilization < 60%")
- Impact formula where applicable (e.g., "fps_impact = (100 - gpu_utilization) * 0.8")
- Applicable chips (M1, M1 Pro, M1 Max, M2, M2 Pro, M2 Max, M3, M3 Pro, M3 Max, M4, M4 Pro, M4 Max)
- Confidence level based on source reliability

Reference the extracted knowledge from:
- t2-architecture/apple-silicon.json (TBDR, UMA, P/E cores)
- t3-specs/m-series.json (core counts, GPU cores)

Target: 15-20 bottleneck interaction entries covering the common scenarios.
  </action>
  <verify>cat .planning/research/knowledge/synergies/bottlenecks/gpu-cpu-bottlenecks.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(f'Valid JSON with {len(d.get(\"entries\", []))} entries')"</verify>
  <done>gpu-cpu-bottlenecks.json exists with 15+ bottleneck interaction entries</done>
</task>

<task type="auto">
  <name>Task 2: Add bottleneck detection heuristics</name>
  <files>.planning/research/knowledge/synergies/bottlenecks/gpu-cpu-bottlenecks.json</files>
  <action>
Add a `heuristics` section to the JSON file (sibling to `entries`) with practical detection rules:

```json
"heuristics": [
  {
    "id": "cpu-bottleneck-detection",
    "name": "CPU Bottleneck Detection",
    "description": "How to detect when CPU is limiting GPU",
    "indicators": [
      "GPU utilization < 70% while CPU > 85%",
      "Frame times inconsistent (high variance)",
      "Low draw calls per frame",
      "High CPU wait time in Metal diagnostics"
    ],
    "remediation": [
      "Reduce physics quality",
      "Lower AI/simulation complexity",
      "Enable game's multi-threading options",
      "Close background applications"
    ]
  },
  ...
]
```

Include heuristics for:
- CPU bottleneck detection
- GPU bottleneck detection
- Memory bandwidth bottleneck detection
- Thermal throttling detection

Each heuristic should have indicators (what to look for) and remediation (what Opta can suggest).
  </action>
  <verify>cat .planning/research/knowledge/synergies/bottlenecks/gpu-cpu-bottlenecks.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(f'Has heuristics: {\"heuristics\" in d}')"</verify>
  <done>gpu-cpu-bottlenecks.json includes heuristics section with detection rules and remediation suggestions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] gpu-cpu-bottlenecks.json is valid JSON
- [ ] Contains 15+ bottleneck interaction entries
- [ ] Includes heuristics for bottleneck detection
- [ ] Entries reference appropriate M-series chips
- [ ] Impact formulas included where applicable
</verification>

<success_criteria>
- All tasks completed
- Bottleneck data covers CPU-bound, GPU-bound, and balanced scenarios
- Heuristics provide actionable detection and remediation
- Data structured for use by Phase 47 (Configuration Calculator)
</success_criteria>

<output>
After completion, create `.planning/phases/42-hardware-synergy-database/42-02-SUMMARY.md`
</output>
