---
phase: 93
plan: 01
title: Command Palette Implementation
type: feature
wave: 1
depends_on: []
files_modified:
  - opta-native/OptaApp/OptaApp/Models/CommandPaletteModels.swift
  - opta-native/OptaApp/OptaApp/Views/Components/CommandPaletteView.swift
  - opta-native/OptaApp/OptaApp/OptaAppApp.swift
  - opta-native/OptaApp/OptaApp.xcodeproj/project.pbxproj
autonomous: true
---

<objective>
Create a global command palette (Cmd+K) for power user navigation and quick actions.
The palette appears as a floating overlay with fuzzy search across pages, actions, and settings.
Supports keyboard-first navigation (arrow keys, Enter, Escape) and remembers recent commands.
</objective>

<execution_context>
- Architecture: SwiftUI overlay presented modally over the main content
- Trigger: Cmd+K keyboard shortcut registered in .commands { } block
- Design: Obsidian panel with violet border glow, semi-transparent backdrop
- Pattern: Similar to VS Code/Raycast command palette UX
- Navigation: Uses existing coreManager.navigate(to:) for page actions
- Actions: Quick Optimize, Toggle FPS, Pause Rendering, Toggle Agent Mode, quality levels
- Pages: Dashboard, Games, Settings, Optimize, AI Chat, Processes
</execution_context>

<context>
@opta-native/OptaApp/OptaApp/OptaAppApp.swift (keyboard shortcuts, navigation switch)
@opta-native/OptaApp/OptaApp/Navigation/CircularMenuNavigation.swift (page destinations, icons)
@opta-native/OptaApp/OptaApp/Models/OptaViewModel.swift (PageViewModel enum, events)
@opta-native/OptaApp/OptaApp/Views/OptimizeView.swift (obsidian styling pattern)
</context>

<tasks>

<task id="1" type="auto">
<title>Create Command Palette Models and Action Registry</title>
<description>
Define the command types, action registry, and fuzzy search logic.
The registry pre-populates with all known pages and actions.
Recent commands are persisted via UserDefaults.
</description>
<files>
  - CREATE: opta-native/OptaApp/OptaApp/Models/CommandPaletteModels.swift
</files>
<action>
Create CommandPaletteModels.swift with:

1. `CommandAction` struct (Identifiable):
   - `id: String` (unique action identifier)
   - `title: String` (display name, e.g. "Go to Dashboard")
   - `subtitle: String?` (optional description)
   - `icon: String` (SF Symbol name)
   - `category: CommandCategory`
   - `shortcut: String?` (display shortcut, e.g. "Cmd+Shift+O")
   - `action: () -> Void` (closure to execute, not Codable)

2. `CommandCategory` enum:
   - `.navigation` - Page navigation commands
   - `.action` - Quick actions (optimize, toggle)
   - `.settings` - Settings toggles
   - `.quality` - Render quality levels

3. `@Observable class CommandPaletteViewModel`:
   - `isPresented: Bool = false`
   - `searchText: String = ""`
   - `selectedIndex: Int = 0`
   - `recentCommandIds: [String]` (loaded from UserDefaults, max 5)
   - `private let registry: [CommandAction]` - all registered commands

   Methods:
   - `var filteredCommands: [CommandAction]` - computed, fuzzy-filtered by searchText
     - If searchText empty, show recents first then all by category
     - Fuzzy matching: case-insensitive, checks if all search chars appear in order
   - `func execute(_ command: CommandAction)` - runs action, adds to recents, dismisses
   - `func toggle()` - toggles isPresented, resets search
   - `func moveSelection(_ direction: Int)` - up/down navigation
   - `func executeSelected()` - runs command at selectedIndex
   - `private func fuzzyMatch(_ query: String, in text: String) -> Bool`
   - `private func saveRecents()` / `private func loadRecents()`

4. Registration helper (called at init):
   ```swift
   func registerDefaults(navigate: @escaping (PageViewModel) -> Void,
                         post: @escaping (Notification.Name) -> Void)
   ```
   Registers:
   - Navigation: "Go to Dashboard" (.dashboard, house.fill), "Go to Games" (.games, gamecontroller.fill),
     "Go to Settings" (.settings, gearshape.fill), "Go to Optimize" (.optimize, bolt.fill),
     "Go to AI Chat" (.aiChat, message.fill), "Go to Processes" (.processes, cpu)
   - Actions: "Quick Optimize" (bolt.circle.fill), "Toggle FPS Overlay" (speedometer),
     "Pause Rendering" (pause.circle), "Toggle Agent Mode" (eye.slash),
     "Check for Updates" (arrow.triangle.2.circlepath)
   - Quality: "Quality: Low", "Quality: Medium", "Quality: High", "Quality: Ultra", "Quality: Adaptive"
</action>
<verify>
File compiles. CommandPaletteViewModel can be instantiated. Fuzzy search filters correctly.
</verify>
<done>CommandPaletteModels.swift exists with CommandAction, CommandCategory, CommandPaletteViewModel with fuzzy search and recent commands.</done>
</task>

<task id="2" type="auto">
<title>Create CommandPaletteView Overlay</title>
<description>
Build the visual command palette as a floating overlay.
Features: search field with auto-focus, scrollable results list,
keyboard navigation highlights, category headers, shortcut badges.
</description>
<files>
  - CREATE: opta-native/OptaApp/OptaApp/Views/Components/CommandPaletteView.swift
</files>
<action>
Create CommandPaletteView.swift:

**Layout:**
- Semi-transparent backdrop (Color.black.opacity(0.5)) covering full screen
- Centered floating panel: 500pt wide, max 400pt tall
- Panel: obsidian background (0A0A0F), rounded corners (16pt), violet border glow
- Drop shadow for depth

**Search Field:**
- Top of panel, auto-focused on appear
- Placeholder: "Type a command..."
- Magnifying glass icon left, Escape hint right ("Esc")
- Clear button when text present
- Immediate filtering as user types

**Results List:**
- ScrollView with LazyVStack
- Each row: icon + title + subtitle (faded) + shortcut badge (if any)
- Selected row: violet background highlight (8B5CF6 at 0.15 opacity)
- Category headers when multiple categories present (small, uppercase, faded)
- Max visible: ~8 items before scroll
- Empty state: "No matching commands" when filter returns empty

**Row Design (CommandRow):**
- HStack: SF Symbol icon (20pt, violet) + VStack(title, subtitle) + Spacer + shortcut badge
- Selected state: background highlight, slight scale
- Hover effect: subtle background

**Keyboard Handling:**
- Use `.onKeyPress` (macOS 14+) or NSEvent monitor for:
  - Arrow Up/Down: move selectedIndex
  - Enter/Return: execute selected command
  - Escape: dismiss palette
- Reset selectedIndex to 0 when search text changes

**Animations:**
- Appear: opacity 0→1 + scale 0.95→1.0 (spring, 0.2s)
- Dismiss: opacity 1→0 + scale 1.0→0.95
- Use withAnimation for smooth transitions

**Recent Commands Section:**
- When search is empty, show "Recent" header with last 5 used commands
- Star icon for recent items
- Below recents, show all commands grouped by category
</action>
<verify>
File compiles. CommandPaletteView renders as overlay with search and results.
Keyboard navigation works (arrow keys, enter, escape).
</verify>
<done>CommandPaletteView.swift exists with search field, results list, keyboard navigation, and obsidian+violet styling.</done>
</task>

<task id="3" type="auto">
<title>Wire Cmd+K Shortcut and Register in Xcode Project</title>
<description>
Add Cmd+K keyboard shortcut to trigger the command palette, overlay the palette
on the main content view, and register all new files in the Xcode project.
</description>
<files>
  - MODIFY: opta-native/OptaApp/OptaApp/OptaAppApp.swift
  - MODIFY: opta-native/OptaApp/OptaApp.xcodeproj/project.pbxproj
</files>
<action>
**OptaAppApp.swift modifications:**

1. Add CommandPaletteViewModel as @State in OptaAppApp:
   ```swift
   @State private var commandPalette = CommandPaletteViewModel()
   ```

2. In the WindowGroup body, wrap mainContentView with ZStack and overlay:
   ```swift
   WindowGroup(id: "main") {
       ZStack {
           mainContentView
               .withColorTemperature()
               .frame(minWidth: 800, minHeight: 600)
               .preferredColorScheme(.dark)
               .environment(\.optaCoreManager, coreManager)
               .environment(\.agentModeManager, agentModeManager)

           if commandPalette.isPresented {
               CommandPaletteView(viewModel: commandPalette)
           }
       }
   }
   ```

3. Add Cmd+K in the .commands { } block:
   ```swift
   CommandGroup(after: .textEditing) {
       Button("Command Palette") {
           commandPalette.toggle()
       }
       .keyboardShortcut("k", modifiers: [.command])
   }
   ```

4. Initialize command palette with navigation and notification actions:
   Add `.onAppear` or `.task` to register commands with closures that call
   `coreManager.navigate(to:)` and `NotificationCenter.default.post(name:)`.

**project.pbxproj:**
- Add CommandPaletteModels.swift to Models group
- Add CommandPaletteView.swift to Views/Components group
- PBXBuildFile, PBXFileReference, PBXGroup entries
- Use unique IDs (start from 5501B0822C5D000100000160 or similar, avoiding collisions)

Verify build: `xcodebuild -project ... -scheme OptaApp build`
</action>
<verify>
Build passes. Cmd+K opens the command palette overlay.
Typing filters commands. Enter executes. Escape dismisses.
Navigation commands correctly switch pages.
</verify>
<done>Cmd+K triggers CommandPaletteView overlay. All files in Xcode project. Build passes.</done>
</task>

</tasks>

<verification>
1. Build passes: `xcodebuild -project opta-native/OptaApp/OptaApp.xcodeproj -scheme OptaApp build`
2. Cmd+K opens command palette overlay
3. Typing filters commands with fuzzy matching
4. Arrow keys navigate, Enter executes, Escape dismisses
5. Navigation commands switch pages correctly
6. Recent commands persist across sessions
7. Design matches obsidian+violet aesthetic
</verification>

<success_criteria>
- [ ] CommandPaletteModels.swift with action types, registry, fuzzy search
- [ ] CommandPaletteView.swift with overlay, search, results, keyboard nav
- [ ] Cmd+K shortcut registered and triggers palette
- [ ] All pages and actions discoverable via palette
- [ ] Recent commands tracked and shown
- [ ] Files registered in Xcode project
- [ ] Build passes without errors
</success_criteria>

<output>
SUMMARY.md documenting:
- Files created and architecture
- Action registry contents
- Keyboard handling approach
- Build verification results
</output>
