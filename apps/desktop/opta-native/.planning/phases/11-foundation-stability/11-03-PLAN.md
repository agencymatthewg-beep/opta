# Plan 11-03: State Persistence Improvements

## Overview

Improve state persistence for better user experience across sessions.

## Tasks

### 1. Persist Dismissed Recommendations to localStorage
**File**: `src/pages/Games.tsx` (line 320)

**Problem**: Dismissed recommendations reset on page refresh/game change.

**Current**:
```tsx
const [dismissedRecommendations, setDismissedRecommendations] = useState<Set<string>>(new Set());
```

**Fix**:
```tsx
const DISMISSED_KEY = 'opta-dismissed-recommendations';

const [dismissedRecommendations, setDismissedRecommendations] = useState<Set<string>>(() => {
  const saved = localStorage.getItem(DISMISSED_KEY);
  return saved ? new Set(JSON.parse(saved)) : new Set();
});

// Save to localStorage when changed
useEffect(() => {
  localStorage.setItem(DISMISSED_KEY, JSON.stringify([...dismissedRecommendations]));
}, [dismissedRecommendations]);
```

### 2. Persist Game Selection to URL/History
**File**: `src/pages/Games.tsx`

**Problem**: Selected game is lost on refresh.

**Fix**: Use URL search params for game selection:
```tsx
// Read from URL on mount
useEffect(() => {
  const params = new URLSearchParams(window.location.search);
  const gameId = params.get('game');
  if (gameId && games.length > 0) {
    const game = games.find(g => g.id === gameId);
    if (game) setSelectedGame(game);
  }
}, [games]);

// Update URL when selection changes
useEffect(() => {
  if (selectedGame) {
    const url = new URL(window.location.href);
    url.searchParams.set('game', selectedGame.id);
    window.history.replaceState({}, '', url.toString());
  }
}, [selectedGame]);
```

### 3. Add Confirmation Dialog for Profile Deletion
**File**: `src/pages/Settings.tsx` (lines 68-75)

**Problem**: Delete profile action has no confirmation, one click deletes all data.

**Fix**: Add confirmation dialog requiring typed confirmation:

```tsx
const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
const [deleteConfirmText, setDeleteConfirmText] = useState('');

const handleDeleteProfile = async () => {
  if (deleteConfirmText !== 'DELETE') return;
  setDeleteLoading(true);
  try {
    await deleteProfile();
    setShowDeleteConfirm(false);
  } finally {
    setDeleteLoading(false);
    setDeleteConfirmText('');
  }
};
```

Add Dialog component:
```tsx
<Dialog open={showDeleteConfirm} onOpenChange={setShowDeleteConfirm}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Delete Profile Data?</DialogTitle>
      <DialogDescription>
        This will permanently delete all your preferences, learned patterns, and history.
        Type DELETE to confirm.
      </DialogDescription>
    </DialogHeader>
    <Input
      value={deleteConfirmText}
      onChange={(e) => setDeleteConfirmText(e.target.value.toUpperCase())}
      placeholder="Type DELETE to confirm"
    />
    <DialogFooter>
      <Button variant="outline" onClick={() => setShowDeleteConfirm(false)}>Cancel</Button>
      <Button
        variant="destructive"
        disabled={deleteConfirmText !== 'DELETE'}
        onClick={handleDeleteProfile}
      >
        Delete All Data
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

## Verification

1. Dismiss a recommendation → Refresh page → Recommendation stays dismissed
2. Select a game → Copy URL → Open in new tab → Same game selected
3. Click delete profile → Verify confirmation dialog appears
4. Type "DELETE" → Verify button enables
5. Type something else → Verify button stays disabled

## Files Modified

- `src/pages/Games.tsx`
- `src/pages/Settings.tsx`

## Estimated Duration

15-20 minutes
