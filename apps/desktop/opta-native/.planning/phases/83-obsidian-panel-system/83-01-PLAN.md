# Plan 83-01: Obsidian Panel System

## Metadata

```yaml
phase: 83
plan: 01
name: Obsidian Panel System
wave: 1
autonomous: true
estimated_tasks: 4
```

## Objective

Replace the frosted-glass panel material with an opaque obsidian panel system. Panels become dark, opaque surfaces with Cook-Torrance specular highlights matching the ring's obsidian material. The glass blur/transmission model is removed entirely. Edge borders gain subtle branch-energy veins (thin purple glow at panel edges). The depth hierarchy is preserved (foreground/content/background) but now controls specular intensity and edge branch density rather than blur amount.

## Design Spec

```
Material: Opaque obsidian (no transmission, no backdrop blur)
  - Base color: Near-black (0.02, 0.02, 0.03) matching ring
  - IOR: 1.85 (volcanic glass, f0 ≈ 0.085)
  - Roughness: 0.05 (slightly rougher than ring's 0.03 for subtle panel differentiation)
  - Specular: Cook-Torrance BRDF from obsidian.wgsl (environment-based, not backdrop)

Edge Branches:
  - Thin branch-energy veins along panel border (inner ~4px band)
  - Color: Electric Violet (0.545, 0.361, 0.965)
  - Density scales with energy_level
  - Uses simplified 2D branch pattern (no 3D noise needed for flat panels)
  - Per-edge phase offset for organic timing

Depth Hierarchy (preserved, reinterpreted):
  - FOREGROUND (0.0): Highest specular intensity, brightest edge branches
  - CONTENT (0.5): Medium specular, standard branches
  - BACKGROUND (1.0): Minimal specular, dim/no branches

Quality Tiers:
  - Low: Flat obsidian color + simple fresnel edge, no branch computation
  - Medium: Cook-Torrance specular + simple fresnel border glow
  - High: Full Cook-Torrance + edge branch energy pattern
  - Ultra: High + domain-warped branches for organic feel
```

## Execution Context

```
@opta-native/opta-render/shaders/includes/obsidian.wgsl        (obsidian BRDF - REFERENCE, reuse functions)
@opta-native/opta-render/shaders/includes/branch_energy.wgsl   (branch energy - REFERENCE for edge adaptation)
@opta-native/opta-render/shaders/includes/math.wgsl            (math utilities - REFERENCE)
@opta-native/opta-render/shaders/includes/noise.wgsl           (2D noise - REFERENCE)
@opta-native/opta-render/shaders/glass_panel.wgsl              (LQ panel shader - REWRITE to obsidian)
@opta-native/opta-render/shaders/glass_panel_hd.wgsl           (HD panel shader - REWRITE to obsidian)
@opta-native/opta-render/src/components/glass_panel.rs         (Rust component - MODIFY uniforms, config, pipeline)
@opta-native/opta-render/src/components/mod.rs                 (exports - UPDATE if type names change)
```

## Tasks

### Task 1: Create edge_branch.wgsl shader include

**Action**: Create a 2D edge-branch pattern function optimized for flat panel borders. Adapts branch_energy concepts for rectangular SDF edges rather than torus surfaces.

**File**: `opta-native/opta-render/shaders/includes/edge_branch.wgsl`

**Implementation**:

1. Create `EdgeBranchParams` struct:
   ```wgsl
   struct EdgeBranchParams {
       /// How far from edge the branches extend inward (pixels).
       reach: f32,
       /// Branch animation speed.
       speed: f32,
       /// Number of branches per edge unit length.
       density: f32,
       /// Energy level [0,1] controlling branch visibility.
       energy: f32,
       /// Animation time.
       time: f32,
   }
   ```

2. Create `edge_branch_mask(edge_dist: f32, reach: f32) -> f32`:
   - Branches live in the inner border band (0 to reach pixels from edge)
   - Return: `1.0 - smoothstep(0.0, reach, edge_dist)`
   - Strongest AT the edge, fading inward

3. Create `edge_branch_pattern(edge_pos: f32, time: f32, params: EdgeBranchParams) -> f32`:
   - `edge_pos` is the linear position along the panel edge (perimeter coordinate)
   - Compute branch cell: `cell = floor(edge_pos * params.density)`
   - Per-branch phase: `phase = fract(sin(cell * 127.1) * 43758.5453) * TAU`
   - Noise value: `sin((edge_pos * params.density + (time + phase) * params.speed) * TAU) * 0.5 + 0.5`
   - Width concentration: use `fract(edge_pos * params.density)` centered
   - Apply energy-based threshold revelation
   - Return branch intensity [0,1]

4. Create `edge_branch_intensity(local_pos: vec2<f32>, half_size: vec2<f32>, corner_radius: f32, params: EdgeBranchParams) -> f32`:
   - Main entry point for panel fragment shaders
   - Compute SDF distance to edge (reuse sd_rounded_box_2d result passed in)
   - Compute perimeter position from local_pos (approximate: use atan2 for corners, linear for edges)
   - Combine edge mask * pattern
   - Return final intensity [0,1]

5. Create `edge_branch_color(intensity: f32, energy: f32) -> vec3<f32>`:
   - Same Electric Violet base as ring branches
   - Subtle white-hot at very high intensity (>0.9)
   - `mix(vec3(0.545, 0.361, 0.965) * intensity, vec3(1.0, 0.9, 1.0), smoothstep(0.9, 1.3, intensity) * energy)`

**Dependencies**: None (self-contained 2D pattern, no noise_hd dependency)

**Verification**: File exists, valid WGSL syntax patterns

---

### Task 2: Rewrite glass_panel_hd.wgsl as obsidian panel shader

**Action**: Replace the HD frosted glass material with an opaque obsidian surface. Remove all backdrop blur sampling, dispersion, and glass transmission. Add Cook-Torrance obsidian specular and edge branch energy.

**File**: `opta-native/opta-render/shaders/glass_panel_hd.wgsl`

**Implementation**:

1. Update shader header comment:
   - "Obsidian panel shader for premium UI overlays"
   - Remove references to blur, backdrop, dispersion, frosted glass

2. Keep inlined utilities:
   - `PI`, `TAU`, `saturate()`, `saturate3()`
   - `sd_rounded_box_2d()`
   - Cook-Torrance BRDF functions (already present, rename prefix from glass to obsidian_panel):
     - `distribution_ggx()` → keep as-is (same math)
     - `geometry_schlick_ggx()` → keep as-is
     - `geometry_smith()` → keep as-is
     - `fresnel_schlick_roughness()` → keep as-is
     - Remove `fresnel_multi_scatter()` (not needed for opaque)
     - Keep `f0_from_ior()`

3. Rewrite `HDPanelUniforms` → `ObsidianPanelUniforms`:
   ```wgsl
   struct ObsidianPanelUniforms {
       // Base panel properties
       position: vec2<f32>,
       size: vec2<f32>,
       corner_radius: f32,
       opacity: f32,

       // Obsidian material
       roughness: f32,
       ior: f32,
       base_color: vec4<f32>,       // RGB + padding (near-black)

       // Depth hierarchy
       depth_layer: f32,
       specular_intensity: f32,     // Replaces blur_intensity
       _pad_depth: vec2<f32>,

       // Edge branches
       branch_reach: f32,           // Pixels from edge for branch band
       branch_density: f32,         // Branches per 100px
       branch_speed: f32,           // Animation speed
       branch_energy: f32,          // Energy level [0,1]

       // Fresnel edge highlight
       fresnel_color: vec3<f32>,
       fresnel_intensity: f32,
       fresnel_power: f32,
       _padding1: vec3<f32>,

       // Border
       border_width: f32,
       _padding3: vec3<f32>,
       border_color: vec4<f32>,

       // Resolution/quality/time
       resolution: vec2<f32>,
       quality_level: u32,
       time: f32,
   }
   ```
   Total: 192 bytes (12 * 16-byte groups)

4. Remove all backdrop sampling:
   - Remove `@group(0) @binding(1) backdrop_texture`
   - Remove `@group(0) @binding(2) backdrop_sampler`
   - Remove `kawase_offset()`, `depth_adjusted_blur()`, `sample_backdrop_hd()`, `sample_backdrop_dispersed()`
   - Remove `SAMPLES_*` constants

5. Add edge branch functions (inline from edge_branch.wgsl concept, or use `#include "edge_branch.wgsl"` if include system supports it):
   - Since the HD panel shader is standalone (no include system), inline the edge branch functions directly

6. Rewrite `fs_main()`:
   ```wgsl
   @fragment
   fn fs_main(in: VertexOutput) -> @location(0) vec4<f32> {
       // SDF for rounded rectangle
       let half_size = uniforms.size * 0.5;
       let center = uniforms.position + half_size;
       let local_pos = in.pixel_pos - center;
       let dist = sd_rounded_box_2d(local_pos, half_size, uniforms.corner_radius);

       if dist > 0.0 { discard; }

       let edge_dist = -dist;

       // --- Obsidian Base Color ---
       var panel_color = uniforms.base_color.rgb;

       // --- Cook-Torrance Specular ---
       // Simulate environment reflection based on edge angle
       let normalized_edge = saturate(edge_dist / (uniforms.corner_radius * 2.0 + 1.0));
       let simulated_cos_theta = normalized_edge;

       let base_f0 = f0_from_ior(uniforms.ior);
       let f0 = vec3<f32>(base_f0);
       let fresnel = fresnel_schlick_roughness(simulated_cos_theta, f0, uniforms.roughness);

       // Specular highlight (depth-scaled)
       let depth_specular = uniforms.specular_intensity * (1.0 - uniforms.depth_layer * 0.6);
       let specular_contribution = fresnel * depth_specular;
       panel_color += specular_contribution;

       // --- Fresnel Edge Highlight ---
       let fresnel_strength = pow(1.0 - simulated_cos_theta, uniforms.fresnel_power);
       panel_color += uniforms.fresnel_color * fresnel_strength * uniforms.fresnel_intensity;

       // --- Edge Branch Energy (High/Ultra quality only) ---
       if uniforms.quality_level >= 2u && uniforms.branch_energy > 0.001 {
           let branch_intensity = edge_branch_compute(
               local_pos, half_size, uniforms.corner_radius,
               edge_dist, uniforms.branch_reach,
               uniforms.branch_density, uniforms.branch_speed,
               uniforms.branch_energy, uniforms.time
           );
           let branch_col = edge_branch_color(branch_intensity, uniforms.branch_energy);
           panel_color += branch_col;
       }

       // --- Border ---
       let border_alpha = 1.0 - smoothstep(0.0, uniforms.border_width, edge_dist);
       panel_color = mix(panel_color, uniforms.border_color.rgb, border_alpha * uniforms.border_color.a);

       // --- Final Alpha (opaque with soft edge AA) ---
       let edge_softness = 1.0;
       let shape_alpha = saturate(-dist / edge_softness);
       let alpha = uniforms.opacity * shape_alpha;
       let final_alpha = max(alpha, border_alpha * uniforms.border_color.a);

       return vec4<f32>(panel_color, final_alpha);
   }
   ```

7. Rewrite `fs_glow_only()`:
   - Output only edge branch glow + fresnel edge glow for bloom pass
   - Remove inner glow (no glass glow concept in obsidian)

**Verification**:
- No `backdrop_texture` or `sample_backdrop` references remain
- No blur-related functions remain
- Cook-Torrance specular is applied
- Edge branches computed for High/Ultra quality
- Output is opaque (no glass transmission)

---

### Task 3: Rewrite glass_panel.wgsl as obsidian LQ fallback

**Action**: Simplify the base panel shader to a flat obsidian panel (no Cook-Torrance, no branches). Just opaque dark surface with simple Fresnel edge highlight.

**File**: `opta-native/opta-render/shaders/glass_panel.wgsl`

**Implementation**:

1. Update header comment:
   - "Obsidian panel shader (low quality) for UI overlays"

2. Keep: `sd_rounded_box_2d()`, `saturate()`, vertex shader

3. Rewrite `GlassPanelUniforms` → simplified struct:
   ```wgsl
   struct ObsidianPanelLQUniforms {
       position: vec2<f32>,
       size: vec2<f32>,
       corner_radius: f32,
       opacity: f32,
       roughness: f32,
       depth_layer: f32,
       base_color: vec4<f32>,      // RGB + pad
       border_width: f32,
       _padding1: vec3<f32>,
       border_color: vec4<f32>,
       resolution: vec2<f32>,
       _padding2: vec2<f32>,
   }
   ```
   Total: 96 bytes (matches current GlassPanelUniforms size)

4. Remove all backdrop texture bindings and blur sampling:
   - Remove `@group(0) @binding(1)` and `@group(0) @binding(2)`
   - Remove `BLUR_SAMPLES`, `BLUR_OFFSETS`

5. Rewrite `fs_main()`:
   ```wgsl
   @fragment
   fn fs_main(in: VertexOutput) -> @location(0) vec4<f32> {
       let half_size = uniforms.size * 0.5;
       let center = uniforms.position + half_size;
       let local_pos = in.pixel_pos - center;
       let dist = sd_rounded_box_2d(local_pos, half_size, uniforms.corner_radius);

       if dist > 0.0 { discard; }

       // Flat obsidian base
       var panel_color = uniforms.base_color.rgb;

       // Simple Fresnel edge highlight
       let edge_dist = -dist;
       let fresnel = pow(saturate(1.0 - edge_dist / 20.0), 3.0) * 0.08;
       panel_color += vec3<f32>(fresnel);

       // Border
       let border_alpha = 1.0 - smoothstep(0.0, uniforms.border_width, edge_dist);
       panel_color = mix(panel_color, uniforms.border_color.rgb, border_alpha * uniforms.border_color.a);

       // Opaque with soft edge
       let edge_softness = 1.0;
       let alpha = uniforms.opacity * saturate(-dist / edge_softness);
       let final_alpha = max(alpha, border_alpha * uniforms.border_color.a);

       return vec4<f32>(panel_color, final_alpha);
   }
   ```

6. The bind group changes: only uniforms buffer needed (no backdrop texture/sampler for LQ)

**Verification**:
- No backdrop texture references
- No blur computation
- Flat obsidian color with Fresnel edge
- Struct is 96 bytes (same alignment as before)

---

### Task 4: Update Rust component (glass_panel.rs) and tests

**Action**: Update uniforms structs for the new obsidian panel material, remove backdrop texture from the render pipeline, update config defaults, and fix all tests.

**File**: `opta-native/opta-render/src/components/glass_panel.rs`

**Implementation**:

1. Update `GlassPanelUniforms` (LQ uniforms, matches new `ObsidianPanelLQUniforms`):
   - Remove `blur` field
   - Remove `tint` field (replaced by base_color)
   - Add `roughness: f32` (default 0.05)
   - Add `base_color: [f32; 4]` (default [0.02, 0.02, 0.03, 1.0])
   - Keep `position`, `size`, `corner_radius`, `opacity`, `depth_layer`
   - Keep `border_width`, `border_color`, `resolution`, paddings
   - Size stays 96 bytes

2. Update `HDPanelUniforms` → rename struct to `ObsidianPanelUniforms`:
   - Remove blur fields: `blur_intensity`, `blur_falloff`, `dispersion`
   - Remove glass fields: `ior` → keep (obsidian IOR), `tint` → replace with `base_color`
   - Remove glow fields: `glow_color`, `glow_intensity`, `glow_radius`
   - Add branch fields: `branch_reach`, `branch_density`, `branch_speed`, `branch_energy`
   - Add: `specular_intensity: f32` (replaces blur_intensity for depth scaling)
   - New size: 192 bytes (12 * 16 byte groups)

3. Update `GlassPanelConfig`:
   - Remove: `blur`, `tint`, `dispersion`, `blur_falloff`, `glow_color`, `glow_intensity`, `glow_radius`
   - Add: `base_color: [f32; 3]` (default [0.02, 0.02, 0.03])
   - Add: `specular_intensity: f32` (default 0.15)
   - Add: `branch_reach: f32` (default 4.0 pixels)
   - Add: `branch_density: f32` (default 0.08 branches per pixel)
   - Add: `branch_speed: f32` (default 0.2)
   - Add: `branch_energy: f32` (default 0.3)
   - Keep: `position`, `size`, `corner_radius`, `opacity`, `border_width`, `border_color`, `depth_layer`, `quality_level`, `ior`, `roughness`, `fresnel_color`, `fresnel_intensity`, `fresnel_power`

4. Update `GlassPanelConfig::default()`:
   ```rust
   roughness: 0.05,                    // Slightly rougher than ring
   ior: 1.85,                          // Volcanic glass
   base_color: [0.02, 0.02, 0.03],    // Near-black obsidian
   specular_intensity: 0.15,
   branch_reach: 4.0,
   branch_density: 0.08,
   branch_speed: 0.2,
   branch_energy: 0.3,
   fresnel_color: [0.545, 0.361, 0.965],  // Electric Violet (was white)
   fresnel_intensity: 0.1,
   fresnel_power: 3.0,
   ```

5. Update depth hierarchy factory methods:
   - `foreground()`: `specular_intensity: 0.2, branch_energy: 0.5, opacity: 0.95`
   - `content()`: `specular_intensity: 0.15, branch_energy: 0.3, opacity: 0.9`
   - `background()`: `specular_intensity: 0.08, branch_energy: 0.1, opacity: 0.85`

6. Update `effective_blur()` → rename to `effective_specular()`:
   - Returns `specular_intensity * (1.0 - depth_layer * 0.6)`

7. Update `PanelQualityLevel`:
   - Remove `blur_samples()` → replace with `specular_enabled()`
   - Remove `blur_enabled()` and `blur_intensity_multiplier()`
   - Add `branch_enabled()`: High/Ultra only
   - Keep `inner_glow_enabled()` → rename to `branch_enabled()`
   - Keep `hd_fresnel_enabled()` (Cook-Torrance at High/Ultra)
   - Remove `dispersion_enabled()` (no dispersion in obsidian)

8. Update `GlassPanel` struct and `new()`:
   - Remove `sampler` field (no backdrop sampling)
   - Update bind group layout: only binding 0 (uniforms), remove bindings 1 and 2
   - Update pipeline: remove texture/sampler from bind group layout
   - The shader source changes from `glass_panel.wgsl` (which is now LQ obsidian)

9. Update `render()` method:
   - Remove `backdrop_view` parameter
   - Update bind group creation: only uniform buffer binding
   - Update uniform construction for new struct layout

10. Update `from_config()` methods on both uniform structs:
    - `GlassPanelUniforms::from_config()` → map new fields
    - `ObsidianPanelUniforms::from_config()` → map new fields including branches

11. Update `mod.rs` exports:
    - Add `ObsidianPanelUniforms` to the pub use list
    - Keep all existing exports (backwards compatible names can stay for now)

12. Update ALL tests:
    - `test_glass_panel_uniforms_size()`: Still 96 bytes
    - `test_hd_panel_uniforms_size()`: Update to 192 bytes
    - `test_glass_panel_config_default()`: Update assertions for new fields (no blur, has base_color, etc.)
    - `test_config_with_quality()`: Update — High enables branches not glow
    - `test_config_set_quality()`: Update — Ultra doesn't enable dispersion
    - `test_panel_quality_feature_flags()`: Update for branch_enabled, remove dispersion
    - `test_panel_quality_blur_samples()` → rewrite as `test_panel_quality_specular_levels()`
    - `test_panel_quality_blur_intensity_multiplier()` → remove
    - `test_hd_panel_uniforms_from_config()`: Update assertions (no dispersion, has branches)
    - `test_hd_uniforms_quality_gating()`: Update — gating is now branch energy not dispersion
    - `test_config_foreground/content/background()`: Update — specular not blur
    - `test_config_effective_blur()` → `test_config_effective_specular()`
    - Keep depth hierarchy tests unchanged (logic preserved)

13. Run `cargo build --release -p opta-render` and `cargo test -p opta-render`

**Verification**:
- `cargo build --release -p opta-render` succeeds
- `cargo test -p opta-render` all pass
- No references to `blur` or `backdrop` in uniforms
- `ObsidianPanelUniforms` is 192 bytes
- `GlassPanelUniforms` (LQ) is 96 bytes
- Branch fields present in config and HD uniforms
- Depth hierarchy tests pass unchanged
- Render pipeline has no backdrop texture bindings

## Verification

```bash
# Build check
cargo build --release -p opta-render

# All tests pass
cargo test -p opta-render

# Edge branch include exists
test -f opta-native/opta-render/shaders/includes/edge_branch.wgsl

# No backdrop/blur references in panel shaders
! grep -q "backdrop_texture\|sample_backdrop\|blur_radius\|BLUR_SAMPLES" opta-native/opta-render/shaders/glass_panel.wgsl
! grep -q "backdrop_texture\|sample_backdrop\|SAMPLES_LOW\|kawase_offset" opta-native/opta-render/shaders/glass_panel_hd.wgsl

# Obsidian base color present
grep -q "base_color" opta-native/opta-render/shaders/glass_panel_hd.wgsl

# Edge branches present in HD shader
grep -q "edge_branch" opta-native/opta-render/shaders/glass_panel_hd.wgsl

# Cook-Torrance specular preserved in HD
grep -q "f0_from_ior\|fresnel_schlick" opta-native/opta-render/shaders/glass_panel_hd.wgsl

# Rust struct sizes
grep -q "96" opta-native/opta-render/src/components/glass_panel.rs
grep -q "192" opta-native/opta-render/src/components/glass_panel.rs
```

## Success Criteria

- [ ] `edge_branch.wgsl` created with 2D edge branch pattern for panels
- [ ] `glass_panel_hd.wgsl` rewritten as obsidian panel (no glass/blur/transmission)
- [ ] `glass_panel.wgsl` rewritten as obsidian LQ fallback (flat dark + fresnel)
- [ ] Cook-Torrance specular applied for environment-like reflections
- [ ] Edge branch energy at High/Ultra quality (thin purple veins at borders)
- [ ] Depth hierarchy preserved (specular + branch intensity scale with depth)
- [ ] Panel quality tiers maintained (Low/Medium/High/Ultra)
- [ ] No backdrop texture or blur sampling in any panel shader
- [ ] Rust `ObsidianPanelUniforms` struct (192 bytes) replaces HD uniforms
- [ ] Rust `GlassPanelUniforms` (96 bytes, LQ) updated for obsidian
- [ ] `GlassPanelConfig` has branch_reach/density/speed/energy + specular_intensity
- [ ] Depth factories (foreground/content/background) use specular not blur
- [ ] `cargo build --release -p opta-render` succeeds
- [ ] `cargo test -p opta-render` all pass
- [ ] Electric Violet color for edge branches and fresnel
- [ ] Panel render pipeline has no backdrop texture bindings

## Output

```yaml
files_created:
  - opta-native/opta-render/shaders/includes/edge_branch.wgsl

files_modified:
  - opta-native/opta-render/shaders/glass_panel.wgsl
  - opta-native/opta-render/shaders/glass_panel_hd.wgsl
  - opta-native/opta-render/src/components/glass_panel.rs
  - opta-native/opta-render/src/components/mod.rs

files_removed: []

apis_added:
  - EdgeBranchParams (WGSL struct)
  - edge_branch_mask() (WGSL function)
  - edge_branch_pattern() (WGSL function)
  - edge_branch_intensity() (WGSL function)
  - edge_branch_color() (WGSL function)
  - ObsidianPanelUniforms (Rust struct, 192 bytes)

apis_modified:
  - HDPanelUniforms → ObsidianPanelUniforms (192 bytes, +branch fields, -blur/glow/dispersion)
  - GlassPanelUniforms (96 bytes, -blur/-tint, +roughness/+base_color)
  - GlassPanelConfig (-blur/-tint/-dispersion/-glow, +base_color/+specular_intensity/+branch_*)
  - PanelQualityLevel (-blur_samples/-blur_intensity_multiplier/-dispersion_enabled, +branch_enabled)
  - GlassPanel::render() (-backdrop_view parameter)
  - GlassPanel::new() (simplified bind group, no texture/sampler)

apis_removed:
  - All backdrop blur sampling functions from both shaders
  - sample_backdrop_hd(), sample_backdrop_dispersed(), kawase_offset()
  - depth_adjusted_blur() from WGSL
  - fresnel_multi_scatter() from HD shader
  - dispersion_enabled() from PanelQualityLevel
  - blur_samples(), blur_intensity_multiplier(), blur_enabled() from PanelQualityLevel
  - effective_blur() from GlassPanelConfig
  - glow_color, glow_intensity, glow_radius from GlassPanelConfig
```
