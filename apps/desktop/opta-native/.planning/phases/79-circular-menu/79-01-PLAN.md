# Plan 79-01: Circular Menu wgpu Component

## Metadata

```yaml
phase: 79
plan: 01
name: Circular Menu wgpu Component
status: ready
wave: 1
autonomous: true
estimated_effort: medium
```

## Objective

Create a GPU-rendered circular (radial) menu component with sectors, glow effects, and spring-physics animations for the Opta native app.

## Execution Context

Reference files:
- `opta-native/opta-render/src/components/glass_panel.rs` - Component pattern, PanelQualityLevel
- `opta-native/opta-render/src/animation/spring.rs` - Spring physics for animations
- `opta-native/opta-render/shaders/includes/glow_hd.wgsl` - Premium glow effects
- `opta-native/opta-render/shaders/includes/sdf.wgsl` - SDF primitives
- `opta-native/opta-render/src/theme/color_temperature.rs` - Color theming

## Context

Phase 78 established the HD visual system with glass panels, glow effects, and theming. This plan creates a circular menu component that leverages these systems for a premium radial navigation experience. The menu will be rendered via wgpu with sectors defined using signed distance fields and animated with spring physics.

## Tasks

### Task 1: Circular Menu Shader
**Goal**: Create circular_menu.wgsl with radial sector rendering and glow effects

**Implementation**:
1. Create `opta-native/opta-render/shaders/circular_menu.wgsl`
2. Define `CircularMenuUniforms` struct with:
   - `center: vec2<f32>` - Menu center position
   - `radius: f32` - Outer radius
   - `inner_radius: f32` - Inner radius (ring thickness)
   - `sector_count: u32` - Number of sectors
   - `highlighted_sector: i32` - Currently highlighted sector (-1 = none)
   - `open_progress: f32` - Animation progress (0.0-1.0)
   - `time: f32` - Animation time
   - `resolution: vec2<f32>` - Render resolution
3. Implement SDF for ring sector: `sdf_ring_sector()`
4. Implement sector divider lines with anti-aliasing
5. Add soft glow on highlighted sector using glow_hd patterns
6. Add glass background blur for menu body
7. Support color temperature from theme system

**Files**:
- Create: `opta-native/opta-render/shaders/circular_menu.wgsl`

**Verification**: WGSL compiles without errors

---

### Task 2: Circular Menu Rust Component
**Goal**: Create CircularMenu component following glass_panel.rs patterns

**Implementation**:
1. Create `opta-native/opta-render/src/components/circular_menu.rs`
2. Define `CircularMenuConfig` struct with:
   - `position: [f32; 2]` - Center position
   - `radius: f32` - Outer radius (default: 150.0)
   - `inner_radius: f32` - Inner radius (default: 50.0)
   - `sector_count: u32` - Number of sectors
   - `quality_level: PanelQualityLevel` - Visual quality
   - `glow_color: [f32; 3]` - Highlight glow color
   - `glow_intensity: f32` - Glow brightness
3. Define `CircularMenuSector` struct with:
   - `id: String` - Sector identifier
   - `icon: String` - SF Symbol name
   - `label: String` - Sector label
   - `color: [f32; 3]` - Sector accent color
4. Define `CircularMenuUniforms` (matching shader)
5. Implement `CircularMenu::new()` with device/pipeline setup
6. Implement `CircularMenu::render()` following glass_panel pattern
7. Add `set_highlighted_sector()` method
8. Add `set_open_progress()` for animation state

**Files**:
- Create: `opta-native/opta-render/src/components/circular_menu.rs`
- Modify: `opta-native/opta-render/src/components/mod.rs` (exports)

**Verification**: `cargo build -p opta-render` succeeds

---

### Task 3: Sector Geometry Calculation
**Goal**: Implement angle and position calculations for sectors

**Implementation**:
1. Add `calculate_sector_angles()` function:
   - Divide 360Â° equally among sectors
   - Optional offset for rotation
2. Add `point_to_sector()` function:
   - Convert mouse position to sector index
   - Return -1 if outside menu ring
3. Add `sector_center_position()` function:
   - Return center point of sector arc
   - Used for icon positioning
4. Add `is_point_in_menu()` function:
   - Check if point is within menu ring
5. Support for non-equal sector sizes (optional weight array)

**Files**:
- Modify: `opta-native/opta-render/src/components/circular_menu.rs`

**Verification**: Unit tests for geometry calculations pass

---

### Task 4: Spring Animation Integration
**Goal**: Add spring-physics animations for open/close and highlight

**Implementation**:
1. Add `AnimatedCircularMenu` struct wrapping `CircularMenu`:
   - `open_spring: Spring` - 0.0 (closed) to 1.0 (open)
   - `highlight_spring: Spring` - For smooth highlight transitions
   - `rotation_spring: Spring` - Optional rotation animation
2. Use `SpringConfig::RESPONSIVE` for snappy menu open
3. Use `SpringConfig::STIFF` for highlight transitions
4. Add `open()` and `close()` methods that set spring targets
5. Add `update(dt: f32)` to step animations
6. Add `is_animating()` to check if still in motion

**Files**:
- Modify: `opta-native/opta-render/src/components/circular_menu.rs`

**Verification**: Animation springs converge to targets

---

### Task 5: FFI Bindings
**Goal**: Expose circular menu to Swift via FFI

**Implementation**:
1. Add to `opta-native/opta-render/src/ffi.rs`:
   - `circular_menu_create()` - Create menu instance
   - `circular_menu_set_sectors()` - Set sector configuration
   - `circular_menu_set_highlighted()` - Update highlight
   - `circular_menu_set_open()` - Set open/close target
   - `circular_menu_update()` - Step animation
   - `circular_menu_render()` - Render to texture
   - `circular_menu_point_to_sector()` - Hit testing
   - `circular_menu_destroy()` - Cleanup
2. Use C-compatible types (raw pointers, primitives)
3. Add safety checks for null pointers

**Files**:
- Modify: `opta-native/opta-render/src/ffi.rs`
- Modify: `opta-native/opta-render/src/lib.rs` (exports)

**Verification**: FFI functions compile and link

---

### Task 6: Circular Menu Tests
**Goal**: Comprehensive tests for menu component

**Implementation**:
1. Add geometry tests:
   - `test_sector_angle_calculation` - Equal division
   - `test_point_to_sector` - Hit testing accuracy
   - `test_point_outside_menu` - Returns -1
2. Add config tests:
   - `test_menu_config_default` - Sensible defaults
   - `test_menu_uniforms_size` - 16-byte alignment
3. Add animation tests:
   - `test_open_animation_spring` - Converges to 1.0
   - `test_close_animation_spring` - Converges to 0.0
   - `test_highlight_transition` - Smooth sector change

**Files**:
- Create: `opta-native/opta-render/tests/circular_menu_test.rs`

**Verification**: `cargo test -p opta-render` passes

---

## Verification

```bash
# Build the library
cargo build --release -p opta-render

# Run all tests
cargo test -p opta-render

# Check FFI symbols
nm target/release/libopta_render.a | grep circular_menu
```

## Success Criteria

- [ ] `circular_menu.wgsl` shader renders radial sectors with glow
- [ ] `CircularMenu` Rust component follows established patterns
- [ ] Sector geometry calculations are accurate
- [ ] Spring animations for open/close/highlight working
- [ ] FFI bindings expose all necessary functions
- [ ] All tests pass (~8 new tests)
- [ ] `cargo build --release -p opta-render` succeeds

## Output

On completion:
1. Create `79-01-SUMMARY.md` with commits and verification results
2. Circular menu wgpu component ready for SwiftUI integration
3. FFI bindings available for Swift bridge
