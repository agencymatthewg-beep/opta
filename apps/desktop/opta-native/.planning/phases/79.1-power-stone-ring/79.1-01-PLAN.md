# Plan 79.1-01: Power Stone Obsidian Ring

## Metadata

```yaml
phase: 79.1
plan: 01
name: Power Stone Obsidian Ring
wave: 1
autonomous: true
scope: large
estimated_tasks: 8
```

## Objective

Redesign the Opta Ring to match the reference image (`Opta Vision/50%Opta.png`): a 3D obsidian torus with a deeply embedded purple energy glow, resembling Marvel's Power Stone encased in polished obsidian glass. The ring must appear as a physical object with mass and depth—a dark, reflective obsidian shell containing a volatile internal energy source that bleeds through the material.

## Reference Image Analysis

The reference image (`Opta MacOS/Opta Vision/50%Opta.png`) defines the target aesthetic:

### Visual Properties Observed

| Property | Description |
|----------|-------------|
| **Shell Material** | Extremely dark, polished obsidian with deep reflections |
| **Shell Transparency** | Semi-translucent—internal glow bleeds through, not sits on top |
| **Internal Energy** | Deep purple (#5B21B6 to #7C3AED) plasma trapped within the torus volume |
| **Glow Character** | Volumetric, embedded, organic—like the Power Stone from Marvel |
| **Inner Rim** | Concentrated bright purple edge light at the torus hole |
| **Outer Surface** | Darker, more reflective—catches environment with sharp highlights |
| **Caustics** | Internal light creates caustic-like purple reflections on the obsidian |
| **Atmosphere** | Deep purple/black fog emanating from the ring into the background |
| **Depth** | Strong 3D presence—the ring has mass, weight, physical substance |
| **Color Palette** | Near-black obsidian (#0A0510), deep violet (#3B0764), electric purple (#7C3AED) |

### Key Differences from Current Implementation

| Aspect | Current | Target |
|--------|---------|--------|
| **Glow source** | Surface-oriented plasma | Deeply embedded volumetric energy |
| **Shell opacity** | Semi-transparent glass | Dark obsidian with translucent windows |
| **Fresnel** | Uniform rim glow | Inner-rim-concentrated glow |
| **Reflections** | Subtle procedural | High-contrast obsidian mirror with caustics |
| **Depth illusion** | 2D noise on surface | True volumetric depth (parallax + layered sampling) |
| **Color temperature** | Bright violet surface | Deep embedded purple bleeding through dark shell |
| **Inner hole** | Standard geometry edge | Bright concentrated energy edge (power source visible) |

## Execution Context

```
@.planning/ROADMAP.md
@.planning/STATE.md
@opta-native/opta-render/src/components/ring.rs
@opta-native/opta-render/shaders/ring.wgsl
@opta-native/opta-render/shaders/includes/glass_hd.wgsl
@opta-native/opta-render/shaders/includes/noise_hd.wgsl
@Opta MacOS/src/components/OptaRing3D/shaders/RingShader.ts
```

## Context

### Platforms

This affects BOTH rendering backends:
1. **Rust/wgpu** (native macOS app): `opta-native/opta-render/shaders/ring.wgsl`
2. **Three.js/WebGL** (Tauri app): `Opta MacOS/src/components/OptaRing3D/shaders/RingShader.ts`

Both must converge on the same visual output. The wgpu shader is the primary target; Three.js shader updated for parity.

### Foundation (Phase 77 Assets Available)

- Cook-Torrance BRDF (`glass_hd.wgsl`)
- 3D Simplex/Perlin noise with derivatives (`noise_hd.wgsl`)
- Domain warping and curl noise
- Volumetric plasma sampling (multi-layer)
- Spring physics for state transitions
- Adaptive quality system (120Hz target)

## Tasks

### Task 1: Obsidian Shell Material

**Objective**: Replace the current glass material with a dark obsidian shell that is mostly opaque but allows internal glow to bleed through at controlled points.

**Visual Target**: The outer surface should look like polished black obsidian (think volcanic glass)—extremely dark, highly reflective, with depth. The internal purple energy should only be visible where the obsidian is "thinnest" or where viewing angle allows transmission.

**Implementation (ring.wgsl)**:
1. Add new obsidian material parameters to `RingUniforms`:
   ```wgsl
   /// Obsidian shell opacity (0.0 = transparent, 1.0 = fully opaque)
   shell_opacity: f32,
   /// Shell darkness factor (how dark the obsidian base is)
   shell_darkness: f32,
   /// Transmission depth (how deep glow penetrates the shell)
   transmission_depth: f32,
   /// Obsidian IOR (higher than glass: ~1.8-2.0 for volcanic glass)
   obsidian_ior: f32,
   ```
2. Create `obsidian_shell()` function:
   - Base color: Near-black (#0A0510) with subtle purple undertone
   - Opacity varies with view angle (fresnel-based transmission)
   - Thinner at inner rim of torus (geometry-based thickness map)
   - Surface has micro-roughness variation for realistic obsidian look
3. Implement thickness-based transmission:
   - Calculate approximate shell thickness from torus geometry
   - Thinner regions (inner rim, edges) allow more glow through
   - Thicker regions (outer convex surface) block most light
4. Default values:
   - `shell_opacity`: 0.92 (mostly opaque, slight transmission)
   - `shell_darkness`: 0.95 (very dark base)
   - `transmission_depth`: 0.35 (moderate bleed-through)
   - `obsidian_ior`: 1.85 (volcanic glass)

**Files**:
- `opta-native/opta-render/shaders/ring.wgsl`
- `opta-native/opta-render/src/components/ring.rs` (uniform updates)

**Verification**:
- Ring appears as dark, solid obsidian rather than transparent glass
- Internal glow only bleeds through at thinner regions
- Surface has weight and physical presence

---

### Task 2: Power Stone Energy Core

**Objective**: Create a deeply embedded volumetric energy source inside the torus that resembles the Power Stone—organic, volatile, plasma-like energy trapped within the obsidian.

**Visual Target**: Looking at the ring should feel like looking at a cosmic energy source trapped inside dark stone. The energy churns slowly, with organic cloud-like movements. Bright violet hotspots drift through deeper purple base energy.

**Implementation**:
1. Create `power_stone_energy()` function:
   ```wgsl
   fn power_stone_energy(
       world_pos: vec3<f32>,
       view_dir: vec3<f32>,
       uv: vec2<f32>,
       time: f32,
       energy_level: f32
   ) -> vec3<f32>
   ```
2. Multi-layer volumetric sampling (5 depth layers):
   - Layer 0 (deepest): Slow, large-scale energy clouds (#3B0764)
   - Layer 1: Medium turbulence, domain-warped (#5B21B6)
   - Layer 2: Active swirling plasma (#7C3AED)
   - Layer 3: Hot spots and energy knots (#A855F7)
   - Layer 4 (surface): Faint surface shimmer (#C084FC at low opacity)
3. View-angle parallax for depth illusion:
   - Each layer offset by `view_dir * depth * parallax_strength`
   - Creates real volumetric depth perception
4. Energy hotspot system:
   - 2-3 drifting bright spots per ring quadrant
   - Hotspots use concentrated noise peaks
   - Brightness: 2-4x base energy intensity
   - Drift speed tied to `energy_level`
5. Color palette (embedded, not surface):
   ```wgsl
   let core_deep = vec3<f32>(0.231, 0.027, 0.392);     // #3B0764
   let core_mid = vec3<f32>(0.357, 0.129, 0.714);      // #5B21B6
   let core_bright = vec3<f32>(0.486, 0.228, 0.929);   // #7C3AED
   let core_hot = vec3<f32>(0.659, 0.333, 0.969);      // #A855F7
   ```
6. Domain warping for organic movement:
   - Warp strength: 0.4-0.8 based on energy level
   - 2-pass warping for complex turbulence
   - Curl noise for swirl patterns around the torus axis

**Files**:
- `opta-native/opta-render/shaders/ring.wgsl`
- `opta-native/opta-render/shaders/includes/noise_hd.wgsl` (if additions needed)

**Verification**:
- Energy appears deeply embedded, not on the surface
- Visible depth through parallax when viewing angle changes
- Organic, cloud-like movement with drifting hotspots
- Color range matches reference (deep purple to bright violet)

---

### Task 3: Inner Rim Concentrated Glow

**Objective**: The inner hole of the torus should be the brightest point—where the obsidian is thinnest and the Power Stone energy is most visible. This creates the impression of looking into the energy source.

**Visual Target**: The inner edge of the ring glows with concentrated purple light, like peering into the mouth of a forge. The glow is brighter, more saturated, and has a slight bloom/bleed.

**Implementation**:
1. Calculate inner-rim proximity in fragment shader:
   ```wgsl
   fn inner_rim_factor(world_pos: vec3<f32>, normal: vec3<f32>) -> f32 {
       // Points on inner rim face toward torus center
       // Normal points away from torus center on inner surface
       let to_center = normalize(-world_pos);
       let rim_dot = max(0.0, dot(normal, to_center));
       return smoothstep(0.3, 0.9, rim_dot);
   }
   ```
2. Inner rim glow intensification:
   - Shell opacity reduces by 60-80% on inner rim
   - Energy intensity multiplied by 2.5-3.5x on inner rim
   - Color shifts toward brighter violet (#A855F7 → #C084FC)
3. Inner rim edge light:
   - Thin, bright edge emission at the geometric boundary
   - Width: 2-3px equivalent at standard viewing distance
   - Color: Pure bright violet (#A855F7) with additive blend
4. Rim bloom contribution:
   - Inner rim writes to bloom buffer at 2x intensity
   - Creates visible glow halo around the hole

**Files**:
- `opta-native/opta-render/shaders/ring.wgsl`

**Verification**:
- Inner hole of torus is clearly the brightest region
- Creates impression of looking into an energy source
- Bloom creates visible purple halo around the hole
- Matches reference image inner-rim intensity

---

### Task 4: Obsidian Surface Reflections & Caustics

**Objective**: The obsidian shell should have realistic sharp reflections with purple caustics from the internal energy leaking onto the surface.

**Visual Target**: The dark surface should catch light with sharp, moving specular highlights. Internal energy creates caustic-like purple light patterns on the obsidian surface—subtle, animated, organic.

**Implementation**:
1. Enhanced specular system:
   - GGX BRDF with roughness 0.05-0.15 (very smooth obsidian)
   - Multiple light sources (3-point lighting for cinematic look)
   - Anisotropic specular stretched along torus curvature
2. Internal caustics simulation:
   ```wgsl
   fn internal_caustics(
       uv: vec2<f32>,
       normal: vec3<f32>,
       time: f32,
       energy: f32
   ) -> vec3<f32> {
       // Simulate caustic patterns from internal refraction
       let caustic_uv = uv + normal.xy * 0.1;
       let c1 = voronoi_noise(caustic_uv * 4.0 + time * 0.1);
       let c2 = voronoi_noise(caustic_uv * 6.0 - time * 0.07);
       let caustic = pow(c1 * c2, 2.0);
       return vec3<f32>(0.4, 0.15, 0.7) * caustic * energy * 0.3;
   }
   ```
3. Environment reflection enhancement:
   - Fake HDR environment map (procedural gradient sky)
   - Reflection sharpness tied to obsidian roughness
   - Purple-tinted reflections (obsidian tints reflected light)
4. Surface micro-detail:
   - Subtle normal perturbation for obsidian surface imperfections
   - Very low amplitude (0.01-0.02) for polished stone feel
   - Adds realism without breaking the smooth silhouette

**Files**:
- `opta-native/opta-render/shaders/ring.wgsl`
- `opta-native/opta-render/shaders/includes/glass_hd.wgsl` (voronoi addition if needed)

**Verification**:
- Sharp specular highlights visible on obsidian surface
- Purple caustic patterns drift across the surface
- Reflections are tinted with purple from internal energy
- Surface appears polished and physically convincing

---

### Task 5: Atmospheric Purple Fog

**Objective**: The ring should emanate a subtle purple atmospheric fog, grounding it in space and adding to the Power Stone mystique.

**Visual Target**: A subtle dark purple haze surrounds the ring, stronger on the side where internal energy is brightest. The fog should feel like energy bleeding into the surrounding space.

**Implementation**:
1. Ring-local fog emission:
   - Radial distance-based fog around ring center
   - Color: Deep purple (#1E0533) with low opacity
   - Intensity tied to `energy_level` uniform
   - Falloff: Exponential from ring surface outward
2. Directional bias:
   - Fog is denser near inner rim (energy leaks more there)
   - Slight vertical drift (fog rises slowly)
3. Integration with existing atmospheric system:
   - Fog contribution written as additional post-process pass
   - Blends with existing bloom pipeline
4. Performance consideration:
   - Fog calculated in fragment shader as screen-space effect
   - Distance-based LOD (skip at Low quality)

**Files**:
- `opta-native/opta-render/shaders/ring.wgsl` (fog emission contribution)
- `opta-native/opta-render/shaders/bloom_composite.wgsl` (fog composite)

**Verification**:
- Purple haze visible around ring, especially near inner rim
- Fog intensity responds to energy level
- No visible banding or hard edges
- Matches reference image atmospheric quality

---

### Task 6: Energy State Mapping

**Objective**: Map the existing ring states (dormant → exploding) to the new Power Stone visual language.

**Visual Target**:
- **Dormant**: Nearly invisible glow, obsidian looks like pure dark stone. Only the faintest purple hint at inner rim.
- **Waking**: Energy stirs within—slow brightening from the core outward.
- **Active**: Full Power Stone look matching reference image (~50% energy).
- **Processing**: Energy pulses rhythmically, hotspots intensify cyclically.
- **Exploding**: Energy overwhelms the obsidian—shell becomes translucent, energy floods out.

**Implementation**:
1. Update state-to-uniform mapping:
   ```rust
   match state {
       Dormant => {
           shell_opacity: 0.98,
           transmission_depth: 0.08,
           energy_level: 0.03,
           inner_rim_glow: 0.1,
       },
       Waking => {
           shell_opacity: 0.94,
           transmission_depth: 0.25,
           energy_level: 0.3,  // Ramping
           inner_rim_glow: 0.5,
       },
       Active => {
           shell_opacity: 0.88,
           transmission_depth: 0.4,
           energy_level: 0.55,
           inner_rim_glow: 1.0,
       },
       Exploding => {
           shell_opacity: 0.5,  // Shell becomes translucent
           transmission_depth: 0.9,
           energy_level: 1.0,
           inner_rim_glow: 2.5,  // Over-bright
       },
   }
   ```
2. Transition interpolation using spring physics (from Phase 77)
3. Shell opacity animation: smooth 300ms transitions between states
4. Energy core animation: organic ramp using eased interpolation
5. Explosion: shell "shatters" visually—opacity drops rapidly, energy floods

**Files**:
- `opta-native/opta-render/src/components/ring.rs`

**Verification**:
- Each state has distinct, appropriate energy visibility
- Dormant ring is essentially dark obsidian with no visible glow
- Active ring matches reference image at ~50% energy
- Transitions feel organic and spring-driven

---

### Task 7: Three.js Shader Parity (WebGL)

**Objective**: Port the Power Stone obsidian ring visual to the Three.js/GLSL shader for the Tauri web app.

**Visual Target**: Identical appearance to the wgpu shader—same obsidian shell, embedded energy, inner rim glow, and caustics.

**Implementation**:
1. Update `RingShader.ts` fragment shader with:
   - Obsidian shell opacity system (replacing transparent glass)
   - Multi-layer volumetric energy (5 depth samples with parallax)
   - Inner rim concentration factor
   - Caustic simulation via Voronoi
   - Enhanced reflections
2. Update uniforms:
   - Add `uShellOpacity`, `uTransmissionDepth`, `uInnerRimGlow`
   - Add `uObsidianIOR`, `uShellDarkness`
   - Update color constants to new palette
3. Update `RingShaderConfig` and presets
4. Update `RING_COLORS` constant to Power Stone palette:
   ```typescript
   export const RING_COLORS = {
     dormant: '#0A0510',      // Pure dark obsidian
     active: '#7C3AED',       // Deep embedded violet (not surface bright)
     explode: '#C084FC',      // Bright violet (energy overwhelming shell)
     rim: '#A855F7',          // Inner rim concentrated glow
     core_deep: '#3B0764',    // Deepest energy layer
   } as const;
   ```

**Files**:
- `Opta MacOS/src/components/OptaRing3D/shaders/RingShader.ts`

**Verification**:
- WebGL ring matches wgpu ring visual output
- All states render correctly in browser
- Performance maintains 60fps in development build

---

### Task 8: Reference Image Calibration

**Objective**: Fine-tune all shader parameters until the ring matches the reference image (`50%Opta.png`) as closely as possible at the "Active" (~50% energy) state.

**Visual Target**: Side-by-side comparison with the reference image should show near-identical:
- Obsidian darkness and reflectivity
- Purple glow depth and color
- Inner rim brightness ratio
- Caustic pattern density
- Overall atmosphere and mood

**Implementation**:
1. Create calibration debug mode (uniform flag):
   - Renders ring at fixed 50% energy
   - Disables animation (static frame for comparison)
   - Outputs intermediate layers (shell only, energy only, caustics only)
2. Parameter sweep and lock:
   - Shell opacity: Target matching reference darkness
   - Energy color balance: Deep purple (not bright/neon)
   - Inner rim ratio: Reference shows ~3-4x brighter than outer surface
   - Caustic density: ~4-6 visible patterns per quadrant
   - Fog intensity: Subtle, not overwhelming
3. A/B comparison values (to be tuned during execution):
   - Obsidian base luminance: <5% (very dark)
   - Active energy peak luminance: ~30-40% (embedded, not overpowering)
   - Inner rim peak: ~60-70% (brightest point)
   - Specular highlights: ~80-90% (sharp, brief flashes)
4. Document final tuned values in a `CALIBRATION.md`

**Files**:
- `opta-native/opta-render/shaders/ring.wgsl` (debug flag)
- `opta-native/opta-render/src/components/ring.rs` (calibration values)
- `Opta MacOS/src/components/OptaRing3D/shaders/RingShader.ts` (matching values)
- `.planning/phases/79.1-power-stone-ring/CALIBRATION.md` (new, documents final values)

**Verification**:
- Visual comparison with reference image passes human review
- Active state at 50% energy closely matches `50%Opta.png`
- Dormant state is darker and less visible than reference (ring at rest)
- Ring conveys "power contained within obsidian" aesthetic

---

## Verification

After all tasks complete:

```bash
# Build opta-render crate
cd /Users/matthewbyrden/Documents/Opta/opta-native && cargo build --release -p opta-render

# Run tests
cargo test -p opta-render

# Check clippy
cargo clippy -p opta-render -- -D warnings

# Three.js build (if applicable)
cd "/Users/matthewbyrden/Documents/Opta/Opta MacOS" && npm run build
```

**Visual Verification** (requires app launch):
- [ ] Ring appears as dark obsidian, not transparent glass
- [ ] Purple energy is deeply embedded within the torus volume
- [ ] Inner rim is clearly the brightest point (Power Stone viewport)
- [ ] Sharp specular highlights on obsidian surface
- [ ] Caustic patterns drift across surface from internal energy
- [ ] Purple atmospheric fog emanates from ring
- [ ] Dormant state is near-invisible (pure dark obsidian)
- [ ] Active state matches reference image (`50%Opta.png`)
- [ ] State transitions are smooth and spring-driven
- [ ] 120Hz maintained on ProMotion display

## Success Criteria

- [ ] All 8 tasks complete
- [ ] `cargo build --release -p opta-render` succeeds
- [ ] `cargo test -p opta-render` passes
- [ ] Ring matches reference image at Active state
- [ ] Power Stone "energy trapped in obsidian" aesthetic achieved
- [ ] Both wgpu and Three.js shaders produce matching output
- [ ] Performance: 120fps on M1+ hardware

## Output

Upon completion:
1. Create `79.1-01-SUMMARY.md` with execution details
2. Create `CALIBRATION.md` with final tuned shader values
3. Update `STATE.md` with Phase 79.1 progress
4. Update `ROADMAP.md` marking Phase 79.1 complete
5. Commit with: `feat(79.1): power stone obsidian ring redesign`

## Design Philosophy

> The Opta Ring is not a glowing circle. It is an obsidian artifact containing a volatile cosmic energy source. The Power Stone lives within—barely contained, always threatening to overwhelm its dark prison. When dormant, you can't tell it's anything but polished stone. When active, the stone reveals its true nature: a vessel for something far more powerful than it appears.
