---
phase: 94
plan: 01
title: Score Detail and History Views
type: feature
wave: 1
depends_on: []
files_modified:
  - opta-native/OptaApp/OptaApp/Models/ScoreModels.swift
  - opta-native/OptaApp/OptaApp/Views/Score/ScoreDetailView.swift
  - opta-native/OptaApp/OptaApp/Views/Score/ScoreCategoryCard.swift
  - opta-native/OptaApp/OptaApp/Views/Score/ScoreHistoryChart.swift
  - opta-native/OptaApp/OptaApp/Models/OptaViewModel.swift
  - opta-native/OptaApp/OptaApp/OptaAppApp.swift
  - opta-native/OptaApp/OptaApp.xcodeproj/project.pbxproj
autonomous: true
---

<objective>
Create a full Score Detail page with category breakdown, history chart, and before/after
comparison. Accessible from the optimize page's score section and command palette.
Uses SwiftUI Charts for sparkline history and the obsidian+violet design language.
</objective>

<execution_context>
- Existing: ScoreDisplay.swift (ring component), optaScore/scoreGrade in ViewModel
- Existing: `import Charts` already in OptaAppApp.swift
- Charts: Use SwiftUI Charts framework (LineMark, AreaMark) for history sparkline
- Navigation: Add `.score` case to PageViewModel enum
- Categories: Performance (CPU/GPU efficiency), Stability (thermal/memory), Gaming (latency/FPS)
- History: @Observable ScoreHistoryManager persisting to UserDefaults or file
- Design: Obsidian base (0A0A0F), Electric Violet (8B5CF6), dark bg (09090B)
</execution_context>

<context>
@opta-native/OptaApp/OptaApp/Models/OptaViewModel.swift (PageViewModel enum, score fields, events)
@opta-native/OptaApp/OptaApp/Views/Components/ScoreDisplay.swift (existing ring component)
@opta-native/OptaApp/OptaApp/Views/OptimizeView.swift (score section to link from)
@opta-native/OptaApp/OptaApp/OptaAppApp.swift (navigation switch, Charts import)
</context>

<tasks>

<task id="1" type="auto">
<title>Create Score Models and History Manager</title>
<description>
Define score breakdown types, category scoring, history tracking, and a manager
that persists score snapshots over time. Add `.score` page to PageViewModel.
</description>
<files>
  - CREATE: opta-native/OptaApp/OptaApp/Models/ScoreModels.swift
  - MODIFY: opta-native/OptaApp/OptaApp/Models/OptaViewModel.swift
</files>
<action>
**ScoreModels.swift:**

1. `ScoreCategory` enum:
   - `.performance` - CPU/GPU/process efficiency
   - `.stability` - Thermal management, memory pressure
   - `.gaming` - Game optimization, latency readiness
   - Properties: `displayName: String`, `icon: String` (SF Symbol), `description: String`

2. `CategoryScore` struct (Identifiable):
   - `category: ScoreCategory`
   - `score: Int` (0-100)
   - `grade: String` (S/A/B/C/D/F)
   - `details: [ScoreDetail]` (individual factors)

3. `ScoreDetail` struct (Identifiable):
   - `id: UUID`
   - `name: String` (e.g. "CPU Idle Efficiency")
   - `value: Int` (0-100)
   - `impact: ScoreImpact` (.positive, .neutral, .negative)

4. `ScoreImpact` enum: `.positive`, `.neutral`, `.negative`

5. `ScoreSnapshot` struct (Codable, Identifiable):
   - `id: UUID`
   - `date: Date`
   - `totalScore: Int`
   - `categoryScores: [ScoreCategory: Int]` (simplified for storage)
   - `afterOptimization: Bool` (whether this was taken post-optimize)

6. `@Observable class ScoreHistoryManager`:
   - `static let shared = ScoreHistoryManager()`
   - `var history: [ScoreSnapshot]` (loaded from file)
   - `var currentBreakdown: ScoreBreakdown?`
   - `func recordScore(total: Int, categories: [ScoreCategory: Int], afterOptimization: Bool)`
   - `func loadHistory()` / `func saveHistory()`
   - `var lastOptimizationDelta: Int?` (score improvement from last optimize)
   - Storage: JSON file at `~/Library/Application Support/OptaApp/score-history.json`
   - Max 90 entries (trim oldest)

7. `ScoreBreakdown` struct:
   - `totalScore: Int`
   - `totalGrade: String`
   - `categories: [CategoryScore]`
   - `static func calculate(from viewModel: OptaViewModel) -> ScoreBreakdown`
     - Performance: based on CPU usage (lower = better), process count efficiency
     - Stability: based on thermal state, memory pressure
     - Gaming: based on GPU availability, memory headroom

**OptaViewModel.swift modification:**
- Add `.score` case to PageViewModel enum:
  ```swift
  case score = "Score"
  ```
</action>
<verify>
Files compile. ScoreHistoryManager can record and retrieve snapshots.
ScoreBreakdown.calculate() produces reasonable category scores from telemetry.
PageViewModel now includes .score case.
</verify>
<done>ScoreModels.swift with all types and ScoreHistoryManager. PageViewModel has .score case.</done>
</task>

<task id="2" type="auto">
<title>Create ScoreDetailView, ScoreCategoryCard, and ScoreHistoryChart</title>
<description>
Build the full score detail page with category breakdown cards, a history sparkline
chart, before/after comparison, and export button.
</description>
<files>
  - CREATE: opta-native/OptaApp/OptaApp/Views/Score/ScoreDetailView.swift
  - CREATE: opta-native/OptaApp/OptaApp/Views/Score/ScoreCategoryCard.swift
  - CREATE: opta-native/OptaApp/OptaApp/Views/Score/ScoreHistoryChart.swift
</files>
<action>
**ScoreDetailView.swift:**
Main score page layout:
- Header: "Score" title + back button (same pattern as OptimizeView)
- Hero: Large ScoreDisplay ring (reuse existing component) centered
- Category Grid: 3 ScoreCategoryCard in a row (Performance, Stability, Gaming)
- History Section: ScoreHistoryChart sparkline
- Comparison Section: Before/after delta card (if lastOptimizationDelta available)
- Action: "Recalculate Score" button (triggers calculateScore event)
- Export: "Share Score" button (renders score card image for sharing)
- ScrollView + VStack layout, background Color(hex: "09090B")
- @Environment(\.colorTemperature) for violet accents
- Takes @Bindable var coreManager: OptaCoreManager
- Uses ScoreHistoryManager.shared for history data
- Computes breakdown on appear via ScoreBreakdown.calculate()

**ScoreCategoryCard.swift:**
Individual category display:
- Vertical card: icon + category name + score number + grade badge + progress bar
- Background: obsidian panel (0A0A0F) with violet border on high scores
- Progress bar: gradient fill (red→yellow→green→violet based on score)
- Grade badge: colored pill (same gradeColor logic as ScoreDisplay)
- Tappable: expands to show ScoreDetail items (animated disclosure)
- When expanded: list of detail items with name + value + impact indicator

**ScoreHistoryChart.swift:**
History sparkline using SwiftUI Charts:
- `import Charts`
- LineMark + AreaMark for score over time
- X axis: dates (last 30 days or all history)
- Y axis: 0-100 score range
- Line color: Electric Violet gradient
- Area fill: violet at 0.1 opacity
- Optimization markers: dots on afterOptimization=true entries (green)
- Time range picker: "7D" / "30D" / "All" segmented control
- Empty state: "No history yet" when no snapshots
- Chart height: 160pt
- Dark themed axes (.white.opacity(0.3))
</action>
<verify>
All files compile. ScoreDetailView renders with mock data.
History chart displays sparkline with correct styling.
Category cards show scores with expandable details.
</verify>
<done>ScoreDetailView.swift, ScoreCategoryCard.swift, ScoreHistoryChart.swift exist with complete UI.</done>
</task>

<task id="3" type="auto">
<title>Wire Navigation, Score Link, and Register in Xcode</title>
<description>
Add .score navigation case in OptaAppApp.swift, make the score section in OptimizeView
tappable to navigate to score detail, add to command palette, and register files in Xcode.
</description>
<files>
  - MODIFY: opta-native/OptaApp/OptaApp/OptaAppApp.swift
  - MODIFY: opta-native/OptaApp/OptaApp/Views/OptimizeView.swift
  - MODIFY: opta-native/OptaApp/OptaApp/Models/CommandPaletteModels.swift
  - MODIFY: opta-native/OptaApp/OptaApp.xcodeproj/project.pbxproj
</files>
<action>
1. **OptaAppApp.swift:**
   Add `.score` case in the navigation switch:
   ```swift
   case .score:
       ScoreDetailView(coreManager: coreManager)
   ```

2. **OptimizeView.swift:**
   Make the scoreSection tappable - wrap in Button or add onTapGesture:
   ```swift
   private var scoreSection: some View {
       Button {
           coreManager.navigate(to: .score)
       } label: {
           // existing score section content
       }
       .buttonStyle(.plain)
   }
   ```
   Add a small chevron.right indicator to hint it's tappable.

3. **CommandPaletteModels.swift:**
   Add "View Score Details" command in the navigation section:
   ```swift
   CommandAction(id: "nav-score", title: "View Score Details", subtitle: "Score breakdown & history",
                 icon: "chart.bar.fill", category: .navigation, shortcut: nil) {
       navigate(.score)
   }
   ```

4. **project.pbxproj:**
   - Add ScoreModels.swift to Models group
   - Create Score group under Views
   - Add ScoreDetailView.swift, ScoreCategoryCard.swift, ScoreHistoryChart.swift to Score group
   - PBXBuildFile, PBXFileReference, PBXGroup entries with unique IDs

Verify build: `xcodebuild -project ... -scheme OptaApp build`
</action>
<verify>
Build passes. Tapping score in OptimizeView navigates to ScoreDetailView.
Score page shows category breakdown and history chart.
Command palette includes "View Score Details" command.
</verify>
<done>Navigation wired. Score section tappable. Command palette updated. All files in Xcode project.</done>
</task>

</tasks>

<verification>
1. Build passes: `xcodebuild -project opta-native/OptaApp/OptaApp.xcodeproj -scheme OptaApp build`
2. Score page accessible from OptimizeView score section tap
3. Score page accessible from command palette ("View Score Details")
4. Category breakdown shows 3 categories with expandable details
5. History chart renders sparkline (or empty state)
6. Recalculate button triggers score event
7. Design matches obsidian+violet aesthetic
</verification>

<success_criteria>
- [ ] ScoreModels.swift with ScoreCategory, CategoryScore, ScoreSnapshot, ScoreHistoryManager
- [ ] ScoreDetailView.swift with hero ring, categories, history, comparison
- [ ] ScoreCategoryCard.swift with expandable category details
- [ ] ScoreHistoryChart.swift with SwiftUI Charts sparkline
- [ ] PageViewModel.score case added and navigation wired
- [ ] OptimizeView score section tappable → ScoreDetailView
- [ ] Command palette includes score navigation
- [ ] Files registered in Xcode project
- [ ] Build passes
</success_criteria>

<output>
SUMMARY.md documenting:
- Files created and architecture
- Score calculation logic
- History persistence approach
- Build verification results
</output>
