name: Build and Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # MCP Server Tests - runs Python tests on all platforms
  mcp-tests:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: ubuntu-22.04
            name: Linux
          - os: macos-latest
            name: macOS
          - os: windows-latest
            name: Windows

    runs-on: ${{ matrix.platform.os }}
    name: MCP Tests (${{ matrix.platform.name }})

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install MCP dependencies
        working-directory: mcp-server
        run: uv sync

      - name: Set PYTHONPATH (Unix)
        if: runner.os != 'Windows'
        run: echo "PYTHONPATH=${{ github.workspace }}/mcp-server/src" >> $GITHUB_ENV

      - name: Set PYTHONPATH (Windows)
        if: runner.os == 'Windows'
        run: echo "PYTHONPATH=${{ github.workspace }}\mcp-server\src" >> $env:GITHUB_ENV

      - name: Test telemetry module
        working-directory: mcp-server
        run: |
          uv run python -c "
          from opta_mcp.telemetry import get_system_snapshot
          r = get_system_snapshot()
          print('Telemetry OK:', 'cpu' in r and 'memory' in r)
          "

      - name: Test process module
        working-directory: mcp-server
        run: |
          uv run python -c "
          from opta_mcp.processes import get_process_list
          procs = get_process_list()
          print(f'Found {len(procs)} processes')
          "

      - name: Test conflict detection
        working-directory: mcp-server
        run: |
          uv run python -c "
          from opta_mcp.conflicts import get_conflict_summary, get_current_platform
          print(f'Platform: {get_current_platform()}')
          r = get_conflict_summary()
          print(f'Conflicts: {r[\"total_count\"]}')
          "

      - name: Test game detection
        working-directory: mcp-server
        run: |
          uv run python -c "
          from opta_mcp.games import detect_all_games
          r = detect_all_games()
          print(f'Total games: {r[\"total_games\"]}')
          "

      - name: Test scoring module
        working-directory: mcp-server
        run: |
          uv run python -c "
          from opta_mcp.scoring import get_hardware_tier
          tier = get_hardware_tier()
          print(f'Hardware tier: {tier.get(\"tier\", \"unknown\")}')
          "

  # Frontend Build Test
  frontend-build:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: ubuntu-22.04
            name: Linux
          - os: macos-latest
            name: macOS
          - os: windows-latest
            name: Windows

    runs-on: ${{ matrix.platform.os }}
    name: Frontend Build (${{ matrix.platform.name }})

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-${{ matrix.platform.name }}
          path: dist/
          retention-days: 7

  # Tauri Build - full application build
  tauri-build:
    needs: [mcp-tests, frontend-build]
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            name: Linux
          - os: macos-latest
            target: x86_64-apple-darwin
            name: macOS-Intel
          - os: macos-latest
            target: aarch64-apple-darwin
            name: macOS-ARM
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: Windows

    runs-on: ${{ matrix.platform.os }}
    name: Tauri Build (${{ matrix.platform.name }})

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Install dependencies (Ubuntu)
        if: matrix.platform.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: --target ${{ matrix.platform.target }}

      - name: Upload Tauri artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-${{ matrix.platform.name }}
          path: |
            src-tauri/target/${{ matrix.platform.target }}/release/bundle/
          retention-days: 7
          if-no-files-found: ignore

  # Summary job for PR status
  build-summary:
    needs: [mcp-tests, frontend-build, tauri-build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check job statuses
        run: |
          echo "MCP Tests: ${{ needs.mcp-tests.result }}"
          echo "Frontend Build: ${{ needs.frontend-build.result }}"
          echo "Tauri Build: ${{ needs.tauri-build.result }}"

          if [ "${{ needs.mcp-tests.result }}" != "success" ] || \
             [ "${{ needs.frontend-build.result }}" != "success" ] || \
             [ "${{ needs.tauri-build.result }}" != "success" ]; then
            echo "One or more jobs failed"
            exit 1
          fi

          echo "All builds passed!"
